@page "/clients/add"
@page "/clients/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared
@using MrWho.Shared.Models
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IClientsApiService ClientsApiService
@inject IRealmsApiService RealmsApiService
@inject IScopesApiService ScopesApiService
@inject ILogger<EditClient> Logger

<PageTitle>@(IsEdit ? "Edit Client" : "Add Client") - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/clients" Text="Clients" />
        <RadzenBreadCrumbItem Text="@(IsEdit ? "Edit" : "Add")" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="@(IsEdit ? "edit" : "add_circle")" class="rz-me-1" />
        @(IsEdit ? "Edit Client" : "Add New Client")
    </RadzenText>
    
    @if (IsEdit && !string.IsNullOrEmpty(model.ClientId))
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-4">
            <RadzenText TextStyle="TextStyle.Body1">
                <strong>Dynamic Configuration:</strong> This client now supports dynamic parameterization. 
                Configure session timeouts, security policies, MFA requirements, and more without code changes.
            </RadzenText>
        </RadzenAlert>
    }
</RadzenStack>

<RadzenCard class="rz-my-4">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading client data...</RadzenText>
    }
    else
    {
        <RadzenTemplateForm Data="@model" TItem="CreateClientRequest" Submit="@OnSave">
            <!-- Enhanced Tabs with Dynamic Configuration -->
            <RadzenTabs @bind-SelectedIndex="@selectedTabIndex" TabPosition="TabPosition.Top" RenderMode="TabRenderMode.Client" 
                       Style="width: 100%; min-height: 600px;">
                <Tabs>
                    <!-- Basic Information Tab -->
                    <RadzenTabsItem Text="Basic Information" Icon="info">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Basic Information</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Client ID" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.ClientId" 
                                                              Placeholder="Enter unique client ID" 
                                                              Style="width: 100%;" 
                                                              Disabled="@IsEdit" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    @(IsEdit ? "Client ID cannot be changed after creation" : "Must be unique across all realms")
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Name" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.Name" 
                                                              Placeholder="Enter client display name" 
                                                              Style="width: 100%;" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Human-readable name for administration
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Realm" Variant="Variant.Outlined">
                                                <RadzenDropDown @bind-Value="@model.RealmId" 
                                                               Data="@realms" 
                                                               TextProperty="Name" 
                                                               ValueProperty="Id" 
                                                               Style="width: 100%;" 
                                                               Placeholder="Select realm..." />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Realm provides default configuration values
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Client Type" Variant="Variant.Outlined">
                                                <RadzenDropDown @bind-Value="@model.ClientType" 
                                                               Data="@clientTypes" 
                                                               TextProperty="Text" 
                                                               ValueProperty="Value" 
                                                               Style="width: 100%;" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Determines security requirements and available flows
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenFormField Text="Description" Variant="Variant.Outlined">
                                        <RadzenTextArea @bind-Value="@model.Description" 
                                                       Placeholder="Brief description of the client application" 
                                                       Style="width: 100%; height: 80px;" />
                                    </RadzenFormField>

                                    <RadzenFormField Text="Status" Variant="Variant.Outlined">
                                        <RadzenSwitch @bind-Value="@model.IsEnabled" OnLabel="Enabled" OffLabel="Disabled" />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Toggle to enable or disable this client
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Session & Cookie Configuration Tab -->
                    <RadzenTabsItem Text="Session & Cookies" Icon="schedule">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Session Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Session Timeout (Hours)" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.SessionTimeoutHours" 
                                                              Min="0" Max="168" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Leave empty to use realm default" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    How long user sessions remain active (0-168 hours)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Remember Me Duration (Days)" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.RememberMeDurationDays" 
                                                              Min="0" Max="365" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Leave empty to use realm default" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Duration for "Remember Me" functionality (0-365 days)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenFormField Text="Session Expiration Type" Variant="Variant.Outlined">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-top: 0.5rem;">
                                            <RadzenCheckBox @bind-Value="@model.UseSlidingSessionExpiration" TriState="true" />
                                            <RadzenLabel Text="Use sliding expiration (extends session on activity)" />
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            When enabled, session timeout resets on user activity (leave unset to use default)
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Cookie Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Cookie SameSite Policy" Variant="Variant.Outlined">
                                        <RadzenDropDown @bind-Value="@model.CookieSameSitePolicy" 
                                                       Data="@sameSitePolicies" 
                                                       TextProperty="Text" 
                                                       ValueProperty="Value" 
                                                       Style="width: 100%;" 
                                                       Placeholder="Select policy..." />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Controls when cookies are sent with cross-site requests
                                        </RadzenText>
                                    </RadzenFormField>

                                    <RadzenFormField Text="HTTPS Cookie Requirement" Variant="Variant.Outlined">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-top: 0.5rem;">
                                            <RadzenCheckBox @bind-Value="@model.RequireHttpsForCookies" TriState="true" />
                                            <RadzenLabel Text="Require HTTPS for secure cookies" />
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Force secure flag on cookies (recommended for production; leave unset to use default)
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Token Configuration Tab -->
                    <RadzenTabsItem Text="Token Lifecycle" Icon="token">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Token Lifetimes</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="ID Token Lifetime (Minutes)" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.IdTokenLifetimeMinutes" 
                                                              Min="1" Max="1440" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Leave empty to use default" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    How long ID tokens remain valid (1-1440 minutes)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Device Code Lifetime (Minutes)" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.DeviceCodeLifetimeMinutes" 
                                                              Min="1" Max="60" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Leave empty to use default" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Device flow code validity period (1-60 minutes)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Access Token Type" Variant="Variant.Outlined">
                                                <RadzenDropDown @bind-Value="@model.AccessTokenType" 
                                                               Data="@accessTokenTypes" 
                                                               TextProperty="Text" 
                                                               ValueProperty="Value" 
                                                               Style="width: 100%;" 
                                                               Placeholder="Select token type..." />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    JWT (self-contained) vs Reference (database lookup)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Refresh Token Behavior</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Max Refresh Tokens Per User" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.MaxRefreshTokensPerUser" 
                                                              Min="0" Max="100" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Leave empty for unlimited" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Limit concurrent refresh tokens per user (0 = unlimited)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Token Security" Variant="Variant.Outlined">
                                                <RadzenStack Gap="0.75rem" Style="max-width: 480px;">
                                                    <RadzenStack Gap="0.25rem">
                                                        <RadzenLabel Text="One-time refresh tokens (rotation)" />
                                                        <RadzenDropDown @bind-Value="@model.UseOneTimeRefreshTokens"
                                                                       Data="@triStateOptions"
                                                                       TextProperty="Text"
                                                                       ValueProperty="Value"
                                                                       Style="width: 100%;"
                                                                       Placeholder="Use realm default" />
                                                    </RadzenStack>
                                                    <RadzenStack Gap="0.25rem">
                                                        <RadzenLabel Text="Hash access tokens in database" />
                                                        <RadzenDropDown @bind-Value="@model.HashAccessTokens"
                                                                       Data="@triStateOptions"
                                                                       TextProperty="Text"
                                                                       ValueProperty="Value"
                                                                       Style="width: 100%;"
                                                                       Placeholder="Use realm default" />
                                                    </RadzenStack>
                                                    <RadzenStack Gap="0.25rem">
                                                        <RadzenLabel Text="Update claims on token refresh" />
                                                        <RadzenDropDown @bind-Value="@model.UpdateAccessTokenClaimsOnRefresh"
                                                                       Data="@triStateOptions"
                                                                       TextProperty="Text"
                                                                       ValueProperty="Value"
                                                                       Style="width: 100%;"
                                                                       Placeholder="Use realm default" />
                                                    </RadzenStack>
                                                </RadzenStack>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Security & Compliance Tab -->
                    <RadzenTabsItem Text="Security & Compliance" Icon="security">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">User Consent</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Consent Requirements" Variant="Variant.Outlined">
                                        <RadzenStack Gap="0.5rem" Style="margin-top: 0.5rem;">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.RequireConsent" TriState="true" />
                                                <RadzenLabel Text="Require user consent for authorization" />
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.AllowRememberConsent" TriState="true" />
                                                <RadzenLabel Text="Allow users to remember consent" />
                                            </RadzenStack>
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Controls when users must explicitly approve authorization
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Endpoint Access</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="API Endpoint Access" Variant="Variant.Outlined">
                                        <RadzenStack Gap="0.5rem" Style="margin-top: 0.5rem;">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.AllowAccessToUserInfoEndpoint" TriState="true" />
                                                <RadzenLabel Text="Allow access to UserInfo endpoint" />
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.AllowAccessToIntrospectionEndpoint" TriState="true" />
                                                <RadzenLabel Text="Allow token introspection" />
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.AllowAccessToRevocationEndpoint" TriState="true" />
                                                <RadzenLabel Text="Allow token revocation" />
                                            </RadzenStack>
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Controls access to OIDC standard endpoints
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Claims Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Client Claims Behavior" Variant="Variant.Outlined">
                                        <RadzenStack Gap="0.5rem" Style="margin-top: 0.5rem;">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.IncludeJwtId" TriState="true" />
                                                <RadzenLabel Text="Include JWT ID in tokens" />
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.AlwaysSendClientClaims" TriState="true" />
                                                <RadzenLabel Text="Always send client claims" />
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.AlwaysIncludeUserClaimsInIdToken" TriState="true" />
                                                <RadzenLabel Text="Always include user claims in ID token" />
                                            </RadzenStack>
                                        </RadzenStack>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Client Claims Prefix" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@model.ClientClaimsPrefix" 
                                                      Style="width: 100%;" 
                                                      Placeholder="e.g., client_" />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Prefix for client-specific claims (optional)
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- MFA Configuration Tab -->
                    <RadzenTabsItem Text="Multi-Factor Auth" Icon="verified_user">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">MFA Requirements</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="MFA Enforcement" Variant="Variant.Outlined">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-top: 0.5rem;">
                                            <RadzenCheckBox @bind-Value="@model.RequireMfa" TriState="true" />
                                            <RadzenLabel Text="Require multi-factor authentication" />
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            When enabled, users must complete MFA to access this client
                                        </RadzenText>
                                    </RadzenFormField>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="MFA Grace Period (Minutes)" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.MfaGracePeriodMinutes" 
                                                              Min="0" Max="1440" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Leave empty to use default" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Time before requiring MFA again (0-1440 minutes)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Session MFA Memory" Variant="Variant.Outlined">
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-top: 0.5rem;">
                                                    <RadzenCheckBox @bind-Value="@model.RememberMfaForSession" TriState="true" />
                                                    <RadzenLabel Text="Remember MFA for session duration" />
                                                </RadzenStack>
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Skip MFA if already completed this session
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenFormField Text="Allowed MFA Methods" Variant="Variant.Outlined">
                                        <RadzenStack Gap="0.5rem" Style="margin-top: 0.5rem;">
                                            @foreach (var method in availableMfaMethods)
                                            {
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenCheckBox Value="@IsMethodSelected(method.Value)" 
                                                                   ValueChanged="@((bool selected) => ToggleMfaMethod(method.Value, selected))" />
                                                    <RadzenLabel Text="@method.Text" />
                                                </RadzenStack>
                                            }
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Select which MFA methods users can use for this client
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Rate Limiting Tab -->
                    <RadzenTabsItem Text="Rate Limiting" Icon="speed">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">API Rate Limits</RadzenText>
                                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-4">
                                    <RadzenText>Configure rate limits to prevent abuse and ensure fair usage. Leave empty to use realm defaults.</RadzenText>
                                </RadzenAlert>

                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="4">
                                            <RadzenFormField Text="Per Minute Limit" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.RateLimitRequestsPerMinute" 
                                                              Min="0" Max="10000" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Requests per minute" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Maximum requests per minute (0 = unlimited)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="4">
                                            <RadzenFormField Text="Per Hour Limit" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.RateLimitRequestsPerHour" 
                                                              Min="0" Max="1000000" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Requests per hour" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Maximum requests per hour (0 = unlimited)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="4">
                                            <RadzenFormField Text="Per Day Limit" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.RateLimitRequestsPerDay" 
                                                              Min="0" Max="10000000" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Requests per day" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Maximum requests per day (0 = unlimited)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Branding & Customization Tab -->
                    <RadzenTabsItem Text="Branding & UI" Icon="palette">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Visual Customization</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Theme Name" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@model.ThemeName" 
                                                      Style="width: 100%;" 
                                                      Placeholder="e.g., dark, light, corporate" />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Name of the UI theme to use for this client
                                        </RadzenText>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Custom CSS URL" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@model.CustomCssUrl" 
                                                      Style="width: 100%;" 
                                                      Placeholder="https://cdn.example.com/client-theme.css" />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            URL to custom CSS stylesheet for client-specific styling
                                        </RadzenText>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Custom JavaScript URL" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@model.CustomJavaScriptUrl" 
                                                      Style="width: 100%;" 
                                                      Placeholder="https://cdn.example.com/client-scripts.js" />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            URL to custom JavaScript file for client-specific functionality
                                        </RadzenText>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Page Title Prefix" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@model.PageTitlePrefix" 
                                                      Style="width: 100%;" 
                                                      Placeholder="e.g., Company Name - " />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Text to prepend to page titles for this client
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Client Information URLs</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Logo URI" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.LogoUri" 
                                                              Style="width: 100%;" 
                                                              Placeholder="https://example.com/logo.png" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    URL to client logo image
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Client URI" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.ClientUri" 
                                                              Style="width: 100%;" 
                                                              Placeholder="https://example.com" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    URL to client homepage
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Privacy Policy URI" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.PolicyUri" 
                                                              Style="width: 100%;" 
                                                              Placeholder="https://example.com/privacy" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    URL to privacy policy
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Terms of Service URI" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.TosUri" 
                                                              Style="width: 100%;" 
                                                              Placeholder="https://example.com/terms" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    URL to terms of service
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                            </div>
                        </RadzenTabsItem>

                        <!-- Logout & Integration Tab -->
                        <RadzenTabsItem Text="Logout & Integration" Icon="logout">
                            <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                                <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Back-Channel Logout</RadzenText>
                                    <RadzenStack Gap="1rem">
                                        <RadzenFormField Text="Back-Channel Logout URI" Variant="Variant.Outlined">
                                            <RadzenTextBox @bind-Value="@model.BackChannelLogoutUri" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://client.example.com/logout" />
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Server-to-server logout notification endpoint
                                            </RadzenText>
                                        </RadzenFormField>

                                        <RadzenFormField Text="Back-Channel Settings" Variant="Variant.Outlined">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-top: 0.5rem;">
                                                <RadzenCheckBox @bind-Value="@model.BackChannelLogoutSessionRequired" TriState="true" />
                                                <RadzenLabel Text="Include session ID in logout tokens" />
                                            </RadzenStack>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Whether to include session_id in logout tokens
                                            </RadzenText>
                                        </RadzenFormField>
                                    </RadzenStack>
                                </RadzenStack>

                                <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Front-Channel Logout</RadzenText>
                                    <RadzenStack Gap="1rem">
                                        <RadzenFormField Text="Front-Channel Logout URI" Variant="Variant.Outlined">
                                            <RadzenTextBox @bind-Value="@model.FrontChannelLogoutUri" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://client.example.com/logout-iframe" />
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Browser-based logout notification endpoint
                                            </RadzenText>
                                        </RadzenFormField>

                                        <RadzenFormField Text="Front-Channel Settings" Variant="Variant.Outlined">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem" Style="margin-top: 0.5rem;">
                                                <RadzenCheckBox @bind-Value="@model.FrontChannelLogoutSessionRequired" TriState="true" />
                                                <RadzenLabel Text="Require session ID for front-channel logout" />
                                            </RadzenStack>
                                        </RadzenFormField>
                                    </RadzenStack>
                                </RadzenStack>

                                <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">External Integrations</RadzenText>
                                    <RadzenStack Gap="1rem">
                                        <RadzenFormField Text="Allowed CORS Origins" Variant="Variant.Outlined">
                                            <RadzenTextArea @bind-Value="@model.AllowedCorsOrigins" 
                                                           Style="width: 100%; height: 80px;" 
                                                           Placeholder="https://app1.example.com&#10;https://app2.example.com" />
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                One origin per line. Required for browser-based applications.
                                            </RadzenText>
                                        </RadzenFormField>

                                        <RadzenFormField Text="Allowed Identity Providers" Variant="Variant.Outlined">
                                            <RadzenTextArea @bind-Value="@model.AllowedIdentityProviders" 
                                                           Style="width: 100%; height: 60px;" 
                                                           Placeholder="google&#10;azure&#10;facebook" />
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Restrict which external IdPs this client can use (one per line)
                                            </RadzenText>
                                        </RadzenFormField>
                                    </RadzenStack>
                                </RadzenStack>
                            </div>
                        </RadzenTabsItem>

                        <!-- Advanced Configuration Tab -->
                        <RadzenTabsItem Text="Advanced" Icon="settings_applications">
                            <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                                <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Protocol Configuration</RadzenText>
                                    <RadzenStack Gap="1rem">
                                        <RadzenFormField Text="Protocol Type" Variant="Variant.Outlined">
                                            <RadzenTextBox @bind-Value="@model.ProtocolType" 
                                                          Style="width: 100%;" 
                                                          Disabled="true" />
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Protocol type (currently only OIDC is supported)
                                            </RadzenText>
                                        </RadzenFormField>

                                        <RadzenFormField Text="Development Settings" Variant="Variant.Outlined">
                                            <RadzenStack Gap="0.5rem">
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenCheckBox @bind-Value="@model.EnableDetailedErrors" TriState="true" />
                                                    <RadzenLabel Text="Enable detailed error responses" />
                                                </RadzenStack>
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenCheckBox @bind-Value="@model.LogSensitiveData" TriState="true" />
                                                    <RadzenLabel Text="Log sensitive data (development only)" />
                                                </RadzenStack>
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenCheckBox @bind-Value="@model.EnableLocalLogin" TriState="true" />
                                                    <RadzenLabel Text="Enable local login (username/password)" />
                                                </RadzenStack>
                                            </RadzenStack>
                                            <RadzenAlert AlertStyle="AlertStyle.Warning" ShowIcon="true" class="rz-mt-2">
                                                <RadzenText TextStyle="TextStyle.Caption">
                                                    Warning: Detailed errors and sensitive data logging should not be enabled in production.
                                                </RadzenText>
                                            </RadzenAlert>
                                        </RadzenFormField>
                                    </RadzenStack>
                                </RadzenStack>

                                <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Custom Page URLs</RadzenText>
                                    <RadzenStack Gap="1rem">
                                        <RadzenFormField Text="Custom Login Page" Variant="Variant.Outlined">
                                            <RadzenTextBox @bind-Value="@model.CustomLoginPageUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://custom.example.com/login" />
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Override default login page for this client
                                            </RadzenText>
                                        </RadzenFormField>

                                        <RadzenFormField Text="Custom Logout Page" Variant="Variant.Outlined">
                                            <RadzenTextBox @bind-Value="@model.CustomLogoutPageUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://custom.example.com/logout" />
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Override default logout page for this client
                                            </RadzenText>
                                        </RadzenFormField>

                                        <RadzenFormField Text="Custom Error Page" Variant="Variant.Outlined">
                                            <RadzenTextBox @bind-Value="@model.CustomErrorPageUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://custom.example.com/error" />
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Override default error page for this client
                                            </RadzenText>
                                        </RadzenFormField>
                                    </RadzenStack>
                                </RadzenStack>
                            </div>
                        </RadzenTabsItem>

                        <!-- Existing OAuth Flows and Scopes tabs remain the same -->
                        <!-- ... (keep existing OAuth flows and scopes tabs) ... -->
                    </Tabs>
                </RadzenTabs>

                <!-- Sticky Action Bar with Validation Summary -->
                <div class="rz-mt-4" style="position: sticky; bottom: 0; background: var(--rz-base-background); border-top: 1px solid var(--rz-panel-border); padding: 0.75rem 1rem; z-index: 10;">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                        <ValidationSummary />

                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" 
                                          Click="@CancelEdit" />
                            @if (IsEdit)
                            {
                                <RadzenButton Text="Reset to Defaults" Icon="restore" ButtonStyle="ButtonStyle.Warning" 
                                              Click="@(async () => await ResetToDefaults())" />
                            }
                            <RadzenButton Text="@(IsEdit ? "Update Client" : "Create Client")" 
                                          Icon="@(IsEdit ? "save" : "add_circle")" 
                                          ButtonStyle="ButtonStyle.Primary" 
                                          ButtonType="ButtonType.Submit" />
                        </RadzenStack>
                    </RadzenStack>
                </div>
            </RadzenTemplateForm>
        }
    </RadzenCard>

    @code {
        [Parameter] public string? Id { get; set; }

        private CreateClientRequest model = new();
        private List<RealmDto> realms = new();
        private List<ScopeDto> availableScopes = new();
        private bool isLoading = false;
        private int selectedTabIndex = 0;
        
        // Dropdown data
        private List<DropdownItem<ClientType>> clientTypes = new();
        private List<DropdownItem<string>> sameSitePolicies = new();
        private List<DropdownItem<string>> accessTokenTypes = new();
        private List<DropdownItem<string>> availableMfaMethods = new();
    private List<DropdownItem<bool?>> triStateOptions = new();

        private bool IsEdit => !string.IsNullOrEmpty(Id);

        protected override async Task OnInitializedAsync()
        {
            await LoadRealms();
            await LoadScopes();
            InitializeDropdownData();
            
            if (IsEdit && !string.IsNullOrEmpty(Id))
            {
                await LoadClient();
            }
            else
            {
                // Set defaults for new client
                model.IsEnabled = true;
                model.UseSlidingSessionExpiration = true;
                model.AllowAccessToUserInfoEndpoint = true;
                model.AllowAccessToRevocationEndpoint = true;
                model.RememberMfaForSession = true;
                model.EnableLocalLogin = true;
            }
        }

        private void InitializeDropdownData()
        {
            clientTypes = new()
            {
                new("Confidential", ClientType.Confidential),
                new("Public", ClientType.Public),
                new("Machine", ClientType.Machine)
            };

            sameSitePolicies = new()
            {
                new("None (Cross-site requests allowed)", "None"),
                new("Lax (Some cross-site requests)", "Lax"),
                new("Strict (No cross-site requests)", "Strict")
            };

            accessTokenTypes = new()
            {
                new("JWT (Self-contained)", "JWT"),
                new("Reference (Database lookup)", "Reference")
            };

            availableMfaMethods = new()
            {
                new("Time-based OTP (TOTP)", "totp"),
                new("SMS Verification", "sms"),
                new("Email Verification", "email"),
                new("Push Notifications", "push"),
                new("Hardware Token", "hardware"),
                new("Biometric", "biometric")
            };

            triStateOptions = new()
            {
                new("Use realm default", null),
                new("Enabled", true),
                new("Disabled", false)
            };
        }

        private async Task LoadRealms()
        {
            try
            {
                var result = await RealmsApiService.GetRealmsAsync(1, 100);
                realms = result?.Items ?? new List<RealmDto>();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading realms");
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load realms");
            }
        }

        private async Task LoadScopes()
        {
            try
            {
                var result = await ScopesApiService.GetScopesAsync(1, 100);
                availableScopes = result?.Items ?? new List<ScopeDto>();
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading scopes");
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load scopes");
            }
        }

        private async Task LoadClient()
        {
            isLoading = true;
            try
            {
                var client = await ClientsApiService.GetClientAsync(Id!);
                if (client != null)
                {
                    // Map from ClientDto to CreateClientRequest with all new dynamic parameters
                    model = MapClientToRequest(client);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error loading client {ClientId}", Id);
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load client");
            }
            finally
            {
                isLoading = false;
            }
        }

        private CreateClientRequest MapClientToRequest(ClientDto client)
        {
            return new CreateClientRequest
            {
                ClientId = client.ClientId,
                Name = client.Name,
                Description = client.Description,
                IsEnabled = client.IsEnabled,
                RealmId = client.RealmId,
                ClientType = client.ClientType,
                
                // Dynamic Configuration Parameters
                SessionTimeoutHours = client.SessionTimeoutHours,
                UseSlidingSessionExpiration = client.UseSlidingSessionExpiration,
                RememberMeDurationDays = client.RememberMeDurationDays,
                RequireHttpsForCookies = client.RequireHttpsForCookies,
                CookieSameSitePolicy = client.CookieSameSitePolicy,
                
                IdTokenLifetimeMinutes = client.IdTokenLifetimeMinutes,
                DeviceCodeLifetimeMinutes = client.DeviceCodeLifetimeMinutes,
                AccessTokenType = client.AccessTokenType,
                UseOneTimeRefreshTokens = client.UseOneTimeRefreshTokens,
                MaxRefreshTokensPerUser = client.MaxRefreshTokensPerUser,
                HashAccessTokens = client.HashAccessTokens,
                UpdateAccessTokenClaimsOnRefresh = client.UpdateAccessTokenClaimsOnRefresh,
                
                RequireConsent = client.RequireConsent,
                AllowRememberConsent = client.AllowRememberConsent,
                AllowAccessToUserInfoEndpoint = client.AllowAccessToUserInfoEndpoint,
                AllowAccessToIntrospectionEndpoint = client.AllowAccessToIntrospectionEndpoint,
                AllowAccessToRevocationEndpoint = client.AllowAccessToRevocationEndpoint,
                IncludeJwtId = client.IncludeJwtId,
                AlwaysSendClientClaims = client.AlwaysSendClientClaims,
                AlwaysIncludeUserClaimsInIdToken = client.AlwaysIncludeUserClaimsInIdToken,
                ClientClaimsPrefix = client.ClientClaimsPrefix,
                
                RequireMfa = client.RequireMfa,
                MfaGracePeriodMinutes = client.MfaGracePeriodMinutes,
                AllowedMfaMethods = client.AllowedMfaMethods,
                RememberMfaForSession = client.RememberMfaForSession,
                
                RateLimitRequestsPerMinute = client.RateLimitRequestsPerMinute,
                RateLimitRequestsPerHour = client.RateLimitRequestsPerHour,
                RateLimitRequestsPerDay = client.RateLimitRequestsPerDay,
                
                ThemeName = client.ThemeName,
                CustomCssUrl = client.CustomCssUrl,
                CustomJavaScriptUrl = client.CustomJavaScriptUrl,
                PageTitlePrefix = client.PageTitlePrefix,
                LogoUri = client.LogoUri,
                ClientUri = client.ClientUri,
                PolicyUri = client.PolicyUri,
                TosUri = client.TosUri,
                
                BackChannelLogoutUri = client.BackChannelLogoutUri,
                BackChannelLogoutSessionRequired = client.BackChannelLogoutSessionRequired,
                FrontChannelLogoutUri = client.FrontChannelLogoutUri,
                FrontChannelLogoutSessionRequired = client.FrontChannelLogoutSessionRequired,
                AllowedCorsOrigins = client.AllowedCorsOrigins,
                AllowedIdentityProviders = client.AllowedIdentityProviders,
                
                ProtocolType = client.ProtocolType,
                EnableDetailedErrors = client.EnableDetailedErrors,
                LogSensitiveData = client.LogSensitiveData,
                EnableLocalLogin = client.EnableLocalLogin,
                CustomLoginPageUrl = client.CustomLoginPageUrl,
                CustomLogoutPageUrl = client.CustomLogoutPageUrl,
                CustomErrorPageUrl = client.CustomErrorPageUrl
            };
        }

        private bool IsMethodSelected(string method)
        {
            if (string.IsNullOrEmpty(model.AllowedMfaMethods))
                return false;
                
            try
            {
                var methods = System.Text.Json.JsonSerializer.Deserialize<string[]>(model.AllowedMfaMethods);
                return methods?.Contains(method) == true;
            }
            catch
            {
                return false;
            }
        }

        private void ToggleMfaMethod(string method, bool selected)
        {
            var methods = new List<string>();
            
            if (!string.IsNullOrEmpty(model.AllowedMfaMethods))
            {
                try
                {
                    var existing = System.Text.Json.JsonSerializer.Deserialize<string[]>(model.AllowedMfaMethods);
                    if (existing != null)
                        methods.AddRange(existing);
                }
                catch { }
            }

            if (selected)
            {
                if (!methods.Contains(method))
                    methods.Add(method);
            }
            else
            {
                methods.Remove(method);
            }

            model.AllowedMfaMethods = methods.Any() ? 
                System.Text.Json.JsonSerializer.Serialize(methods.ToArray()) : 
                null;
        }

        private async Task OnSave(CreateClientRequest formModel)
        {
            try
            {
                if (IsEdit)
                {
                    // For updates, use the CreateClientRequest directly since UpdateClientAsync should accept it
                    var result = await ClientsApiService.UpdateClientAsync(Id!, formModel);
                    if (result != null)
                    {
                        NotificationService.Notify(NotificationSeverity.Success, "Success", "Client updated successfully");
                        Navigation.NavigateTo("/clients");
                    }
                }
                else
                {
                    var result = await ClientsApiService.CreateClientAsync(formModel);
                    if (result != null)
                    {
                        NotificationService.Notify(NotificationSeverity.Success, "Success", "Client created successfully");
                        Navigation.NavigateTo("/clients");
                    }
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error saving client");
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save client");
            }
        }

        private async Task ResetToDefaults()
        {
            var result = await DialogService.Confirm("Reset all dynamic configuration to realm/system defaults?", 
                "Reset Configuration", 
                new ConfirmOptions() { OkButtonText = "Reset", CancelButtonText = "Cancel" });
            
            if (result == true)
            {
                // Reset nullable dynamic parameters to null (will use defaults)
                model.SessionTimeoutHours = null;
                model.RememberMeDurationDays = null;
                model.IdTokenLifetimeMinutes = null;
                model.DeviceCodeLifetimeMinutes = null;
                model.MaxRefreshTokensPerUser = null;
                model.MfaGracePeriodMinutes = null;
                model.RateLimitRequestsPerMinute = null;
                model.RateLimitRequestsPerHour = null;
                model.RateLimitRequestsPerDay = null;
                
                // Reset strings to null
                model.CookieSameSitePolicy = null;
                model.AccessTokenType = null;
                model.AllowedMfaMethods = null;
                model.ThemeName = null;
                model.CustomCssUrl = null;
                model.CustomJavaScriptUrl = null;
                model.PageTitlePrefix = null;
                model.ClientClaimsPrefix = null;
                
                NotificationService.Notify(NotificationSeverity.Info, "Reset", "Configuration reset to defaults");
                StateHasChanged();
            }
        }

        private void CancelEdit()
        {
            Navigation.NavigateTo("/clients");
        }

        // Helper class for dropdown items
        private record DropdownItem<T>(string Text, T Value);
    }