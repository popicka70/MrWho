@page "/clients/add"
@page "/clients/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared
@using MrWho.Shared.Models
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IClientsApiService ClientsApiService
@inject IRealmsApiService RealmsApiService
@inject IScopesApiService ScopesApiService
@inject ILogger<EditClient> Logger

<PageTitle>@(IsEdit ? "Edit Client" : "Add Client") - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/clients" Text="Clients" />
        <RadzenBreadCrumbItem Text="@(IsEdit ? "Edit" : "Add")" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="@(IsEdit ? "edit" : "add_circle")" class="rz-me-1" />
        @(IsEdit ? "Edit Client" : "Add New Client")
    </RadzenText>
    
    @if (IsEdit && !string.IsNullOrEmpty(model.ClientId))
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-4">
            <RadzenText TextStyle="TextStyle.Body1">
                <strong>Dynamic Configuration:</strong> This client now supports dynamic parameterization. 
                Configure session timeouts, security policies, MFA requirements, and more without code changes.
            </RadzenText>
        </RadzenAlert>
    }
</RadzenStack>

<RadzenCard class="rz-my-4">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading client data...</RadzenText>
    }
    else
    {
        <RadzenTemplateForm Data="@model" TItem="CreateClientRequest" Submit="@OnSave">
            <!-- Enhanced Tabs with Dynamic Configuration -->
            <RadzenTabs @bind-SelectedIndex="@selectedTabIndex" TabPosition="TabPosition.Top" RenderMode="TabRenderMode.Client" 
                       Style="width: 100%; min-height: 600px;">
                <Tabs>
                    <!-- Basic Information Tab -->
                    <RadzenTabsItem Text="Basic Information" Icon="info">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Basic Information</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Client ID" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.ClientId" 
                                                                  Placeholder="Enter unique client ID" 
                                                                  Style="width: 100%;" 
                                                                  Disabled="@IsEdit" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        @(IsEdit ? "Client ID cannot be changed after creation" : "Must be unique across all realms")
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Name" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.Name" 
                                                                  Placeholder="Enter client display name" 
                                                                  Style="width: 100%;" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Human-readable name for administration
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Realm" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.RealmId" 
                                                                   Data="@realms" 
                                                                   TextProperty="Name" 
                                                                   ValueProperty="Id" 
                                                                   Style="width: 100%;" 
                                                                   Placeholder="Select realm..." />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Realm provides default configuration values
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Client Type" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.ClientType" 
                                                                   Data="@clientTypes" 
                                                                   TextProperty="Text" 
                                                                   ValueProperty="Value" 
                                                                   Style="width: 100%;" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Determines security requirements and available flows
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenFormField Text="Description" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextArea @bind-Value="@model.Description" 
                                                           Placeholder="Brief description of the client application" 
                                                           Style="width: 100%; height: 80px;" />
                                        </ChildContent>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Status" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenSwitch @bind-Value="@model.IsEnabled" OnLabel="Enabled" OffLabel="Disabled" />
                                        </Start>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Toggle to enable or disable this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Redirect URIs Tab -->
                    <RadzenTabsItem Text="Redirect URIs" Icon="link">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Authorization & Logout Redirects</RadzenText>

                                <RadzenFormField Text="Redirect URIs" Variant="Variant.Outlined">
                                    <ChildContent>
                                        <RadzenTextArea @bind-Value="@redirectUrisText"
                                                       Style="width: 100%; height: 140px;"
                                                       Placeholder="One URI per line, e.g. https://localhost:7257/signin-oidc" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            URIs allowed to receive authorization responses (signin-oidc/callback). One per line.
                                        </RadzenText>
                                    </Helper>
                                </RadzenFormField>

                                <RadzenFormField Text="Post-logout Redirect URIs" Variant="Variant.Outlined">
                                    <ChildContent>
                                        <RadzenTextArea @bind-Value="@postLogoutUrisText"
                                                       Style="width: 100%; height: 120px;"
                                                       Placeholder="One URI per line, e.g. https://localhost:7257/signout-callback-oidc or https://localhost:7257/" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            URIs the user can be redirected to after logout. One per line.
                                        </RadzenText>
                                    </Helper>
                                </RadzenFormField>

                                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true">
                                    <RadzenText TextStyle="TextStyle.Caption">
                                        Changes here will update OpenIddict application settings immediately after saving.
                                    </RadzenText>
                                </RadzenAlert>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Session & Cookie Configuration Tab -->
                    <RadzenTabsItem Text="Session & Cookies" Icon="schedule">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Session Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Session Timeout (Hours)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.SessionTimeoutHours" 
                                                                  Min="0" Max="168" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use realm default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        How long user sessions remain active (0-168 hours)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Remember Me Duration (Days)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.RememberMeDurationDays" 
                                                                  Min="0" Max="365" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use realm default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Duration for "Remember Me" functionality (0-365 days)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="4">
                                            <RadzenFormField Text="Session Expiration Type" Variant="Variant.Outlined">
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="@model.UseSlidingSessionExpiration" TriState="true" Name="useSliding" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Use sliding expiration (extends session on activity)" Component="useSliding" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        When enabled, session timeout resets on user activity (leave unset to use default)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Cookie Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Cookie SameSite Policy" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenDropDown @bind-Value="@model.CookieSameSitePolicy" 
                                                           Data="@sameSitePolicies" 
                                                           TextProperty="Text" 
                                                           ValueProperty="Value" 
                                                           Style="width: 100%;" 
                                                           Placeholder="Select policy..." />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Controls when cookies are sent with cross-site requests
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="HTTPS Cookie Requirement" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.RequireHttpsForCookies" TriState="true" Name="requireHttpsCookies" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require HTTPS for secure cookies" Component="requireHttpsCookies" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Force secure flag on cookies (recommended for production; leave unset to use default)
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Token Configuration Tab -->
                    <RadzenTabsItem Text="Token Lifecycle" Icon="token">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Token Lifetimes</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="ID Token Lifetime (Minutes)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.IdTokenLifetimeMinutes" 
                                                                  Min="1" Max="1440" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        How long ID tokens remain valid (1-1440 minutes)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Device Code Lifetime (Minutes)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.DeviceCodeLifetimeMinutes" 
                                                                  Min="1" Max="60" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Device flow code validity period (1-60 minutes)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Access Token Type" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.AccessTokenType" 
                                                                   Data="@accessTokenTypes" 
                                                                   TextProperty="Text" 
                                                                   ValueProperty="Value" 
                                                                   Style="width: 100%;" 
                                                                   Placeholder="Select token type..." />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        JWT (self-contained) vs Reference (database lookup)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Refresh Token Behavior</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Max Refresh Tokens Per User" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.MaxRefreshTokensPerUser" 
                                                                  Min="0" Max="100" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty for unlimited" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Limit concurrent refresh tokens per user (0 = unlimited)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <!-- Split Token Security into separate form fields -->
                                            <RadzenFormField Text="One-time refresh tokens (rotation)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.UseOneTimeRefreshTokens"
                                                                   Data="@triStateOptions"
                                                                   TextProperty="Text"
                                                                   ValueProperty="Value"
                                                                   Style="width: 100%;"
                                                                   Placeholder="Use realm default" />
                                                </ChildContent>
                                            </RadzenFormField>
                                            <RadzenFormField Text="Hash access tokens in database" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.HashAccessTokens"
                                                                   Data="@triStateOptions"
                                                                   TextProperty="Text"
                                                                   ValueProperty="Value"
                                                                   Style="width: 100%;"
                                                                   Placeholder="Use realm default" />
                                                </ChildContent>
                                            </RadzenFormField>
                                            <RadzenFormField Text="Update claims on token refresh" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.UpdateAccessTokenClaimsOnRefresh"
                                                                   Data="@triStateOptions"
                                                                   TextProperty="Text"
                                                                   ValueProperty="Value"
                                                                   Style="width: 100%;"
                                                                   Placeholder="Use realm default" />
                                                </ChildContent>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Security & Compliance Tab -->
                    <RadzenTabsItem Text="Security & Compliance" Icon="security">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">User Consent</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Consent Requirements" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.RequireConsent" TriState="true" Name="requireConsent" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require user consent for authorization" Component="requireConsent" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Controls when users must explicitly approve authorization
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Allow users to remember consent" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowRememberConsent" TriState="true" Name="rememberConsent" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow users to remember consent" Component="rememberConsent" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Endpoint Access</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Allow access to UserInfo endpoint" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowAccessToUserInfoEndpoint" TriState="true" Name="allowUserInfo" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow access to UserInfo endpoint" Component="allowUserInfo" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Controls access to OIDC standard endpoints
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Allow token introspection" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowAccessToIntrospectionEndpoint" TriState="true" Name="allowIntrospection" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow token introspection" Component="allowIntrospection" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Allow token revocation" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowAccessToRevocationEndpoint" TriState="true" Name="allowRevocation" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow token revocation" Component="allowRevocation" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Claims Configuration Tab -->
                    <RadzenTabsItem Text="Claims Configuration" Icon="verified_user">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Token Claims</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Include JWT ID in tokens" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.IncludeJwtId" TriState="true" Name="includeJti" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Include JWT ID in tokens" Component="includeJti" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Always send client claims" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AlwaysSendClientClaims" TriState="true" Name="alwaysSendClientClaims" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Always send client claims" Component="alwaysSendClientClaims" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Always include user claims in ID token" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AlwaysIncludeUserClaimsInIdToken" TriState="true" Name="alwaysIncludeUserClaimsInIdToken" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Always include user claims in ID token" Component="alwaysIncludeUserClaimsInIdToken" />
                                        </ChildContent>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Client Claims Prefix" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.ClientClaimsPrefix" 
                                                          Style="width: 100%;" 
                                                          Placeholder="e.g., client_" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Prefix for client-specific claims (optional)
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Multi-Factor Auth Tab -->
                    <RadzenTabsItem Text="Multi-Factor Auth" Icon="verified_user">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">MFA Requirements</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="MFA Enforcement" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.RequireMfa" TriState="true" Name="requireMfa" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require multi-factor authentication" Component="requireMfa" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                When enabled, users must complete MFA to access this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="MFA Grace Period (Minutes)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.MfaGracePeriodMinutes" 
                                                                  Min="0" Max="1440" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Time before requiring MFA again (0-1440 minutes)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Session MFA Memory" Variant="Variant.Outlined">
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="@model.RememberMfaForSession" TriState="true" Name="rememberMfa" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Remember MFA for session duration" Component="rememberMfa" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Skip MFA if already completed this session
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-font-weight-600">Allowed MFA Methods</RadzenText>
                                    @foreach (var method in availableMfaMethods)
                                    {
                                        var name = $"mfa_{method.Value}";
                                        <RadzenFormField Variant="Variant.Outlined">
                                            <Start>
                                                <RadzenCheckBox Value="@IsMethodSelected(method.Value)" 
                                                               ValueChanged="@((bool selected) => ToggleMfaMethod(method.Value, selected))"
                                                               Name="@name" />
                                            </Start>
                                            <ChildContent>
                                                <RadzenLabel Text="@method.Text" Component="@name" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    }
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Select which MFA methods users can use for this client
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Rate Limiting Tab -->
                    <RadzenTabsItem Text="Rate Limiting" Icon="speed">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">API Rate Limits</RadzenText>
                                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-4">
                                    <RadzenText>Configure rate limits to prevent abuse and ensure fair usage. Leave empty to use realm defaults.</RadzenText>
                                </RadzenAlert>

                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="4">
                                            <RadzenFormField Text="Per Minute Limit" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.RateLimitRequestsPerMinute" 
                                                                  Min="0" Max="10000" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Requests per minute" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Maximum requests per minute (0 = unlimited)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="4">
                                            <RadzenFormField Text="Per Hour Limit" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.RateLimitRequestsPerHour" 
                                                                  Min="0" Max="1000000" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Requests per hour" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Maximum requests per hour (0 = unlimited)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="4">
                                            <RadzenFormField Text="Per Day Limit" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.RateLimitRequestsPerDay" 
                                                                  Min="0" Max="10000000" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Requests per day" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Maximum requests per day (0 = unlimited)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Branding & Customization Tab -->
                    <RadzenTabsItem Text="Branding & UI" Icon="palette">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Visual Customization</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Theme Name" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.ThemeName" 
                                                          Style="width: 100%;" 
                                                          Placeholder="e.g., dark, light, corporate" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Name of the UI theme to use for this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Custom CSS URL" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomCssUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://cdn.example.com/client-theme.css" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                URL to custom CSS stylesheet for client-specific styling
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Custom JavaScript URL" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomJavaScriptUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://cdn.example.com/client-scripts.js" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                URL to custom JavaScript file for client-specific functionality
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Page Title Prefix" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.PageTitlePrefix" 
                                                          Style="width: 100%;" 
                                                          Placeholder="e.g., Company Name - " />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Text to prepend to page titles for this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Client Information URLs</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Logo URI" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.LogoUri" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="https://example.com/logo.png" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        URL to client logo image
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Client URI" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.ClientUri" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="https://example.com" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        URL to client homepage
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Privacy Policy URI" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.PolicyUri" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="https://example.com/privacy" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        URL to privacy policy
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Terms of Service URI" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.TosUri" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="https://example.com/terms" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        URL to terms of service
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Logout & Integration Tab -->
                    <RadzenTabsItem Text="Logout & Integration" Icon="logout">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Back-Channel Logout</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Back-Channel Logout URI" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.BackChannelLogoutUri" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://client.example.com/logout" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Server-to-server logout notification endpoint
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Back-Channel Settings" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.BackChannelLogoutSessionRequired" TriState="true" Name="bclSessionRequired" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Include session ID in logout tokens" Component="bclSessionRequired" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Whether to include session_id in logout tokens
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Front-Channel Logout</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Front-Channel Logout URI" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.FrontChannelLogoutUri" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://client.example.com/logout-iframe" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Browser-based logout notification endpoint
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Front-Channel Settings" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.FrontChannelLogoutSessionRequired" TriState="true" Name="fclSessionRequired" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require session ID for front-channel logout" Component="fclSessionRequired" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">External Integrations</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Allowed CORS Origins" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextArea @bind-Value="@model.AllowedCorsOrigins" 
                                                           Style="width: 100%; height: 80px;" 
                                                           Placeholder="https://app1.example.com&#10;https://app2.example.com" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                One origin per line. Required for browser-based applications.
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Allowed Identity Providers" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextArea @bind-Value="@model.AllowedIdentityProviders" 
                                                           Style="width: 100%; height: 60px;" 
                                                           Placeholder="google&#10;azure&#10;facebook" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Restrict which external IdPs this client can use (one per line)
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Advanced Configuration Tab -->
                    <RadzenTabsItem Text="Advanced" Icon="settings_applications">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Protocol Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Protocol Type" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.ProtocolType" 
                                                          Style="width: 100%;" 
                                                          Disabled="true" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Protocol type (currently only OIDC is supported)
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Development Settings</RadzenText>

                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.EnableDetailedErrors" TriState="true" Name="enableDetailedErrors" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Enable detailed error responses" Component="enableDetailedErrors" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.LogSensitiveData" TriState="true" Name="logSensitiveData" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Log sensitive data (development only)" Component="logSensitiveData" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.EnableLocalLogin" TriState="true" Name="enableLocalLogin" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Enable local login (username/password)" Component="enableLocalLogin" />
                                        </ChildContent>
                                    </RadzenFormField>

                                    <RadzenAlert AlertStyle="AlertStyle.Warning" ShowIcon="true" class="rz-mt-2">
                                        <RadzenText TextStyle="TextStyle.Caption">
                                            Warning: Detailed errors and sensitive data logging should not be enabled in production.
                                        </RadzenText>
                                    </RadzenAlert>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Custom Page URLs</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Custom Login Page" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomLoginPageUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://custom.example.com/login" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Override default login page for this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Custom Logout Page" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomLogoutPageUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://custom.example.com/logout" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Override default logout page for this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Custom Error Page" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomErrorPageUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://custom.example.com/error" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Override default error page for this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>

            <div class="rz-mt-4" style="position: sticky; bottom: 0; background: var(--rz-base-background); border-top: 1px solid var(--rz-panel-border); padding: 0.75rem 1rem; z-index: 10;">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <ValidationSummary />
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Click="@CancelEdit" />
                        @if (IsEdit)
                        {
                            <RadzenButton Text="Reset to Defaults" Icon="restore" ButtonStyle="ButtonStyle.Warning" Click="@(async () => await ResetToDefaults())" />
                        }
                        <RadzenButton Text="@(IsEdit ? "Update Client" : "Create Client")" Icon="@(IsEdit ? "save" : "add_circle")" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        </RadzenTemplateForm>
    }
</RadzenCard>

@code {
    [Parameter] public string? Id { get; set; }

    private CreateClientRequest model = new();
    private List<RealmDto> realms = new();
    private List<ScopeDto> availableScopes = new();
    private bool isLoading = false;
    private int selectedTabIndex = 0;

    // Dropdown data
    private List<DropdownItem<ClientType>> clientTypes = new();
    private List<DropdownItem<string>> sameSitePolicies = new();
    private List<DropdownItem<string>> accessTokenTypes = new();
    private List<DropdownItem<bool?>> triStateOptions = new();
    private List<DropdownItem<string>> availableMfaMethods = new();

    // Selections
    private List<string> selectedScopes = new();
    private List<string> selectedPermissions = new();

    // Multi-line text backing for URIs
    private string redirectUrisText = string.Empty;
    private string postLogoutUrisText = string.Empty;

    // Convenience binding for MFA methods serialization (use model's value)
    private string? allowedMfaMethodsSerialized => model.AllowedMfaMethods;

    private bool IsEdit => !string.IsNullOrEmpty(Id);

    protected override async Task OnInitializedAsync()
    {
        await LoadRealms();
        await LoadScopes();
        InitializeDropdownData();

        if (IsEdit && !string.IsNullOrEmpty(Id))
        {
            await LoadClient();
        }
        else
        {
            // Set defaults for new client
            model.IsEnabled = true;
            model.UseSlidingSessionExpiration = true;
            model.AllowAccessToUserInfoEndpoint = true;
            model.AllowAccessToRevocationEndpoint = true;
            model.RememberMfaForSession = true;
            model.EnableLocalLogin = true;
        }
    }

    private void InitializeDropdownData()
    {
        clientTypes = new()
        {
            new("Confidential", ClientType.Confidential),
            new("Public", ClientType.Public),
            new("Machine", ClientType.Machine)
        };

        sameSitePolicies = new()
        {
            new("None (Cross-site requests allowed)", "None"),
            new("Lax (Some cross-site requests)", "Lax"),
            new("Strict (No cross-site requests)", "Strict")
        };

        accessTokenTypes = new()
        {
            new("JWT (Self-contained)", "JWT"),
            new("Reference (Database lookup)", "Reference")
        };

        triStateOptions = new()
        {
            new("Use realm default", null),
            new("Enabled", true),
            new("Disabled", false)
        };

        availableMfaMethods = new()
        {
            new("Time-based OTP (TOTP)", "totp"),
            new("SMS Verification", "sms"),
            new("Email Verification", "email"),
            new("Push Notifications", "push"),
            new("Hardware Token", "hardware"),
            new("Biometric", "biometric")
        };
    }

    private async Task LoadRealms()
    {
        try
        {
            var result = await RealmsApiService.GetRealmsAsync(1, 100);
            realms = result?.Items ?? new List<RealmDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading realms");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load realms");
        }
    }

    private async Task LoadScopes()
    {
        try
        {
            var result = await ScopesApiService.GetScopesAsync(1, 100);
            availableScopes = result?.Items ?? new List<ScopeDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading scopes");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load scopes");
        }
    }

    private async Task LoadClient()
    {
        isLoading = true;
        try
        {
            var client = await ClientsApiService.GetClientAsync(Id!);
            if (client != null)
            {
                // Map from ClientDto to CreateClientRequest with all new dynamic parameters
                model = MapClientToRequest(client);
                redirectUrisText = string.Join("\n", client.RedirectUris ?? new());
                postLogoutUrisText = string.Join("\n", client.PostLogoutUris ?? new());
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading client {ClientId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load client");
        }
        finally
        {
            isLoading = false;
        }
    }

    private CreateClientRequest MapClientToRequest(ClientDto client)
    {
        return new CreateClientRequest
        {
            ClientId = client.ClientId,
            Name = client.Name,
            Description = client.Description,
            IsEnabled = client.IsEnabled,
            RealmId = client.RealmId,
            ClientType = client.ClientType,
            SessionTimeoutHours = client.SessionTimeoutHours,
            UseSlidingSessionExpiration = client.UseSlidingSessionExpiration,
            RememberMeDurationDays = client.RememberMeDurationDays,
            RequireHttpsForCookies = client.RequireHttpsForCookies,
            CookieSameSitePolicy = client.CookieSameSitePolicy,
            IdTokenLifetimeMinutes = client.IdTokenLifetimeMinutes,
            DeviceCodeLifetimeMinutes = client.DeviceCodeLifetimeMinutes,
            AccessTokenType = client.AccessTokenType,
            UseOneTimeRefreshTokens = client.UseOneTimeRefreshTokens,
            MaxRefreshTokensPerUser = client.MaxRefreshTokensPerUser,
            HashAccessTokens = client.HashAccessTokens,
            UpdateAccessTokenClaimsOnRefresh = client.UpdateAccessTokenClaimsOnRefresh,
            RequireConsent = client.RequireConsent,
            AllowRememberConsent = client.AllowRememberConsent,
            AllowAccessToUserInfoEndpoint = client.AllowAccessToUserInfoEndpoint,
            AllowAccessToIntrospectionEndpoint = client.AllowAccessToIntrospectionEndpoint,
            AllowAccessToRevocationEndpoint = client.AllowAccessToRevocationEndpoint,
            IncludeJwtId = client.IncludeJwtId,
            AlwaysSendClientClaims = client.AlwaysSendClientClaims,
            AlwaysIncludeUserClaimsInIdToken = client.AlwaysIncludeUserClaimsInIdToken,
            ClientClaimsPrefix = client.ClientClaimsPrefix,
            RequireMfa = client.RequireMfa,
            MfaGracePeriodMinutes = client.MfaGracePeriodMinutes,
            AllowedMfaMethods = client.AllowedMfaMethods,
            RememberMfaForSession = client.RememberMfaForSession,
            RateLimitRequestsPerMinute = client.RateLimitRequestsPerMinute,
            RateLimitRequestsPerHour = client.RateLimitRequestsPerHour,
            RateLimitRequestsPerDay = client.RateLimitRequestsPerDay,
            ThemeName = client.ThemeName,
            CustomCssUrl = client.CustomCssUrl,
            CustomJavaScriptUrl = client.CustomJavaScriptUrl,
            PageTitlePrefix = client.PageTitlePrefix,
            LogoUri = client.LogoUri,
            ClientUri = client.ClientUri,
            PolicyUri = client.PolicyUri,
            TosUri = client.TosUri,
            BackChannelLogoutUri = client.BackChannelLogoutUri,
            BackChannelLogoutSessionRequired = client.BackChannelLogoutSessionRequired,
            FrontChannelLogoutUri = client.FrontChannelLogoutUri,
            FrontChannelLogoutSessionRequired = client.FrontChannelLogoutSessionRequired,
            AllowedCorsOrigins = client.AllowedCorsOrigins,
            AllowedIdentityProviders = client.AllowedIdentityProviders,
            ProtocolType = client.ProtocolType,
            EnableDetailedErrors = client.EnableDetailedErrors,
            LogSensitiveData = client.LogSensitiveData,
            EnableLocalLogin = client.EnableLocalLogin,
            CustomLoginPageUrl = client.CustomLoginPageUrl,
            CustomLogoutPageUrl = client.CustomLogoutPageUrl,
            CustomErrorPageUrl = client.CustomErrorPageUrl
        };
    }

    private bool IsMethodSelected(string method)
    {
        if (string.IsNullOrEmpty(model.AllowedMfaMethods))
            return false;

        try
        {
            var methods = System.Text.Json.JsonSerializer.Deserialize<string[]>(model.AllowedMfaMethods);
            return methods?.Contains(method) == true;
        }
        catch
        {
            return false;
        }
    }

    private void ToggleMfaMethod(string method, bool selected)
    {
        var methods = new List<string>();

        if (!string.IsNullOrEmpty(model.AllowedMfaMethods))
        {
            try
            {
                var existing = System.Text.Json.JsonSerializer.Deserialize<string[]>(model.AllowedMfaMethods);
                if (existing != null)
                    methods.AddRange(existing);
            }
            catch { }
        }

        if (selected)
        {
            if (!methods.Contains(method))
                methods.Add(method);
        }
        else
        {
            methods.Remove(method);
        }

        model.AllowedMfaMethods = methods.Any()
            ? System.Text.Json.JsonSerializer.Serialize(methods.ToArray())
            : null;
    }

    private async Task OnSave(CreateClientRequest args)
    {
        ClientDto? result;
        if (IsEdit)
        {
            var update = BuildUpdateRequestFromModel();
            result = await ClientsApiService.UpdateClientAsync(Id!, update);
            if (result != null)
            {
                var fresh = await ClientsApiService.GetClientAsync(result.Id);
                if (fresh != null)
                {
                    result = fresh;
                }
            }
        }
        else
        {
            result = await ClientsApiService.CreateClientAsync(BuildCreateRequestFromModel());
        }

        if (result != null)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Client '{result.Name}' has been {(IsEdit ? "updated" : "created")} successfully");
            Navigation.NavigateTo("/clients");
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save client");
        }
    }

    private UpdateClientRequest BuildUpdateRequestFromModel()
    {
        var update = new UpdateClientRequest
        {
            // map fields from 'model' to update request
            Name = model.Name,
            Description = model.Description,
            IsEnabled = model.IsEnabled,
            ClientType = model.ClientType,
            AllowAuthorizationCodeFlow = true,
            AllowClientCredentialsFlow = model.ClientType == ClientType.Machine,
            AllowPasswordFlow = false,
            AllowRefreshTokenFlow = true,
            RequirePkce = model.ClientType != ClientType.Machine,
            RequireClientSecret = model.ClientType != ClientType.Public,
            RedirectUris = redirectUrisText?.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList() ?? new(),
            PostLogoutUris = postLogoutUrisText?.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList() ?? new(),
            Scopes = selectedScopes,
            Permissions = selectedPermissions,

            // dynamic fields mapping
            SessionTimeoutHours = model.SessionTimeoutHours,
            UseSlidingSessionExpiration = model.UseSlidingSessionExpiration,
            RememberMeDurationDays = model.RememberMeDurationDays,
            RequireHttpsForCookies = model.RequireHttpsForCookies,
            CookieSameSitePolicy = model.CookieSameSitePolicy,
            IdTokenLifetimeMinutes = model.IdTokenLifetimeMinutes,
            DeviceCodeLifetimeMinutes = model.DeviceCodeLifetimeMinutes,
            AccessTokenType = model.AccessTokenType,
            UseOneTimeRefreshTokens = model.UseOneTimeRefreshTokens,
            MaxRefreshTokensPerUser = model.MaxRefreshTokensPerUser,
            HashAccessTokens = model.HashAccessTokens,
            UpdateAccessTokenClaimsOnRefresh = model.UpdateAccessTokenClaimsOnRefresh,
            RequireConsent = model.RequireConsent,
            AllowRememberConsent = model.AllowRememberConsent,
            AllowAccessToUserInfoEndpoint = model.AllowAccessToUserInfoEndpoint,
            AllowAccessToIntrospectionEndpoint = model.AllowAccessToIntrospectionEndpoint,
            AllowAccessToRevocationEndpoint = model.AllowAccessToRevocationEndpoint,
            IncludeJwtId = model.IncludeJwtId,
            AlwaysSendClientClaims = model.AlwaysSendClientClaims,
            AlwaysIncludeUserClaimsInIdToken = model.AlwaysIncludeUserClaimsInIdToken,
            ClientClaimsPrefix = model.ClientClaimsPrefix,
            RequireMfa = model.RequireMfa,
            MfaGracePeriodMinutes = model.MfaGracePeriodMinutes,
            AllowedMfaMethods = allowedMfaMethodsSerialized,
            RememberMfaForSession = model.RememberMfaForSession,
            RateLimitRequestsPerMinute = model.RateLimitRequestsPerMinute,
            RateLimitRequestsPerHour = model.RateLimitRequestsPerHour,
            RateLimitRequestsPerDay = model.RateLimitRequestsPerDay,
            ThemeName = model.ThemeName,
            CustomCssUrl = model.CustomCssUrl,
            CustomJavaScriptUrl = model.CustomJavaScriptUrl,
            PageTitlePrefix = model.PageTitlePrefix,
            LogoUri = model.LogoUri,
            ClientUri = model.ClientUri,
            PolicyUri = model.PolicyUri,
            TosUri = model.TosUri,
            BackChannelLogoutUri = model.BackChannelLogoutUri,
            BackChannelLogoutSessionRequired = model.BackChannelLogoutSessionRequired,
            FrontChannelLogoutUri = model.FrontChannelLogoutUri,
            FrontChannelLogoutSessionRequired = model.FrontChannelLogoutSessionRequired,
            AllowedCorsOrigins = model.AllowedCorsOrigins,
            AllowedIdentityProviders = model.AllowedIdentityProviders,
            ProtocolType = model.ProtocolType,
            EnableDetailedErrors = model.EnableDetailedErrors,
            LogSensitiveData = model.LogSensitiveData,
            EnableLocalLogin = model.EnableLocalLogin,
            CustomLoginPageUrl = model.CustomLoginPageUrl,
            CustomLogoutPageUrl = model.CustomLogoutPageUrl,
            CustomErrorPageUrl = model.CustomErrorPageUrl
        };

        return update;
    }

    private CreateClientRequest BuildCreateRequestFromModel() => model;

    private void CancelEdit() => Navigation.NavigateTo("/clients");

    private Task ResetToDefaults()
    {
        // Reset dynamic fields to use realm defaults (nulls)
        model.SessionTimeoutHours = null;
        model.UseSlidingSessionExpiration = null;
        model.RememberMeDurationDays = null;
        model.RequireHttpsForCookies = null;
        model.CookieSameSitePolicy = null;
        model.IdTokenLifetimeMinutes = null;
        model.DeviceCodeLifetimeMinutes = null;
        model.AccessTokenType = null;
        model.UseOneTimeRefreshTokens = null;
        model.MaxRefreshTokensPerUser = null;
        model.HashAccessTokens = null;
        model.UpdateAccessTokenClaimsOnRefresh = null;
        model.RequireConsent = null;
        model.AllowRememberConsent = null;
        model.AllowAccessToUserInfoEndpoint = null;
        model.AllowAccessToIntrospectionEndpoint = null;
        model.AllowAccessToRevocationEndpoint = null;
        model.IncludeJwtId = null;
        model.AlwaysSendClientClaims = null;
        model.AlwaysIncludeUserClaimsInIdToken = null;
        model.ClientClaimsPrefix = null;
        model.RequireMfa = null;
        model.MfaGracePeriodMinutes = null;
        model.AllowedMfaMethods = null;
        model.RememberMfaForSession = null;
        model.RateLimitRequestsPerMinute = null;
        model.RateLimitRequestsPerHour = null;
        model.RateLimitRequestsPerDay = null;
        model.ThemeName = null;
        model.CustomCssUrl = null;
        model.CustomJavaScriptUrl = null;
        model.PageTitlePrefix = null;
        model.LogoUri = null;
        model.ClientUri = null;
        model.PolicyUri = null;
        model.TosUri = null;
        model.BackChannelLogoutUri = null;
        model.BackChannelLogoutSessionRequired = null;
        model.FrontChannelLogoutUri = null;
        model.FrontChannelLogoutSessionRequired = null;
        model.AllowedCorsOrigins = null;
        model.AllowedIdentityProviders = null;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private record DropdownItem<T>(string Text, T Value);
}