@page "/clients/add"
@page "/clients/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared
@using MrWho.Shared.Models
@using Radzen
@using Radzen.Blazor
@using Microsoft.AspNetCore.Authorization
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IClientsApiService ClientsApiService
@inject IRealmsApiService RealmsApiService
@inject IScopesApiService ScopesApiService
@inject ILogger<EditClient> Logger
@inject IIdentityProvidersApiService IdentityProvidersApi

<PageTitle>@(IsEdit ? "Edit Client" : "Add Client") - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/clients" Text="Clients" />
        <RadzenBreadCrumbItem Text="@(IsEdit ? "Edit" : "Add")" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="@(IsEdit ? "edit" : "add_circle")" class="rz-me-1" />
        @(IsEdit ? $"Edit Client {model.ClientId}" : $"Add New Client  {model.ClientId}")
    </RadzenText>
</RadzenStack>

<RadzenCard class="rz-my-4">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading client data...</RadzenText>
    }
    else
    {
        <RadzenTemplateForm Data="@model" TItem="CreateClientRequest" Submit="@OnSave">
            <!-- Enhanced Tabs with Dynamic Configuration -->
            <RadzenTabs @bind-SelectedIndex="@selectedTabIndex" TabPosition="TabPosition.Left" RenderMode="TabRenderMode.Server" 
                       Style="width: 100%; min-height: 600px;">
                <Tabs>
                    <!-- Basic Information Tab -->
                    <RadzenTabsItem Text="Basic Information" Icon="info">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.BasicInformation editClient="this" />
                    </RadzenTabsItem>

                    <!-- NEW: Flows & Grants Tab -->
                    <RadzenTabsItem Text="Flows & Grants" Icon="account_tree">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.FlowsAndGrants editClient="this" />
                    </RadzenTabsItem>

                    <!-- Redirect URIs Tab -->
                    <RadzenTabsItem Text="Redirect URIs" Icon="link">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.RedirectUris editClient="this" />
                    </RadzenTabsItem>

                    <!-- Scopes Tab -->
                    <RadzenTabsItem Text="Scopes" Icon="policy">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.Scopes editClient="this" />
                    </RadzenTabsItem>

                    <!-- Session & Cookies Tab -->
                    <RadzenTabsItem Text="Session & Cookies" Icon="schedule">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.SessionCookies editClient="this" />
                    </RadzenTabsItem>

                    <!-- Token Lifecycle Tab -->
                    <RadzenTabsItem Text="Token Lifecycle" Icon="token">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.TokenLifecycle editClient="this" />
                    </RadzenTabsItem>

                    <!-- Security & Compliance Tab -->
                    <RadzenTabsItem Text="Security & Compliance" Icon="security">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.SecurityCompliance editClient="this" />
                    </RadzenTabsItem>

                    <!-- Claims Configuration Tab -->
                    <RadzenTabsItem Text="Claims Configuration" Icon="verified_user">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.ClaimsConfiguration editClient="this" />
                    </RadzenTabsItem>

                    <!-- Multi-Factor Auth Tab -->
                    <RadzenTabsItem Text="Multi-Factor Auth" Icon="verified_user">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.MultiFactorAuth editClient="this" />
                    </RadzenTabsItem>

                    <!-- Rate Limiting Tab -->
                    <RadzenTabsItem Text="Rate Limiting" Icon="speed">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.RateLimiting editClient="this" />
                    </RadzenTabsItem>

                    <!-- Branding & Customization Tab -->
                    <RadzenTabsItem Text="Branding & UI" Icon="palette">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.BrandingUi editClient="this" />
                    </RadzenTabsItem>

                    <!-- Logout & Integration Tab -->
                    <RadzenTabsItem Text="Logout & Integration" Icon="logout">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.LogoutIntegration editClient="this" />
                    </RadzenTabsItem>

                    <!-- Identity Providers Tab -->
                    <RadzenTabsItem Text="Identity Providers" Icon="link">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.IdentityProviders editClient="this" />
                    </RadzenTabsItem>

                    <!-- Development Tab -->
                    <RadzenTabsItem Text="Development" Icon="bug_report">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.Development editClient="this" />
                    </RadzenTabsItem>

                    <!-- Audiences Tab -->
                    <RadzenTabsItem Text="Audiences" Icon="groups">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.Audiences editClient="this" />
                    </RadzenTabsItem>

                    <!-- Advanced Tab -->
                    <RadzenTabsItem Text="Advanced" Icon="settings_applications">
                        <MrWhoAdmin.Web.Components.Pages.EditClientPages.Advanced editClient="this" />
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>

            <div class="rz-mt-4" style="position: sticky; bottom: 0; background: var(--rz-base-background); border-top: 1px solid var(--rz-panel-border); padding: 0.75rem 1rem; z-index: 10;">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <ValidationSummary />
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Click="@CancelEdit" />
                        @if (IsEdit)
                        {
                            <RadzenButton Text="Reset to Defaults" Icon="restore" ButtonStyle="ButtonStyle.Warning" Click="@(async () => await ResetToDefaults())" />
                        }
                        <RadzenButton Text="@(IsEdit ? "Update Client" : "Create Client")" Icon="@(IsEdit ? "save" : "add_circle")" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        </RadzenTemplateForm>
    }
</RadzenCard>

@code {
    [Parameter] public string? Id { get; set; }
}