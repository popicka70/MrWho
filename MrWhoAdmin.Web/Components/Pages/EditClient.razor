@page "/clients/add"
@page "/clients/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared
@using MrWho.Shared.Models
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IClientsApiService ClientsApiService
@inject IRealmsApiService RealmsApiService
@inject IScopesApiService ScopesApiService
@inject ILogger<EditClient> Logger
@inject IIdentityProvidersApiService IdentityProvidersApi

<PageTitle>@(IsEdit ? "Edit Client" : "Add Client") - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/clients" Text="Clients" />
        <RadzenBreadCrumbItem Text="@(IsEdit ? "Edit" : "Add")" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="@(IsEdit ? "edit" : "add_circle")" class="rz-me-1" />
        @(IsEdit ? "Edit Client" : "Add New Client")
    </RadzenText>
    
    @if (IsEdit && !string.IsNullOrEmpty(model.ClientId))
    {
        <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-4">
            <RadzenText TextStyle="TextStyle.Body1">
                <strong>Dynamic Configuration:</strong> This client now supports dynamic parameterization. 
                Configure session timeouts, security policies, MFA requirements, and more without code changes.
            </RadzenText>
        </RadzenAlert>
    }
</RadzenStack>

<RadzenCard class="rz-my-4">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading client data...</RadzenText>
    }
    else
    {
        <RadzenTemplateForm Data="@model" TItem="CreateClientRequest" Submit="@OnSave">
            <!-- Enhanced Tabs with Dynamic Configuration -->
            <RadzenTabs @bind-SelectedIndex="@selectedTabIndex" TabPosition="TabPosition.Top" RenderMode="TabRenderMode.Client" 
                       Style="width: 100%; min-height: 600px;">
                <Tabs>
                    <!-- Basic Information Tab -->
                    <RadzenTabsItem Text="Basic Information" Icon="info">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Basic Information</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Client ID" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.ClientId" 
                                                                  Placeholder="Enter unique client ID" 
                                                                  Style="width: 100%;" 
                                                                  Disabled="@IsEdit" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        @(IsEdit ? "Client ID cannot be changed after creation" : "Must be unique across all realms")
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Name" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.Name" 
                                                                  Placeholder="Enter client display name" 
                                                                  Style="width: 100%;" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Human-readable name for administration
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Realm" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.RealmId" 
                                                                   Data="@realms" 
                                                                   TextProperty="Name" 
                                                                   ValueProperty="Id" 
                                                                   Style="width: 100%;" 
                                                                   Placeholder="Select realm..." />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Realm provides default configuration values
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Client Type" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.ClientType" 
                                                                   Data="@clientTypes" 
                                                                   TextProperty="Text" 
                                                                   ValueProperty="Value" 
                                                                   Style="width: 100%;" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Determines security requirements and available flows
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenFormField Text="Description" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextArea @bind-Value="@model.Description" 
                                                           Placeholder="Brief description of the client application" 
                                                           Style="width: 100%; height: 80px;" />
                                        </ChildContent>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Status" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenSwitch @bind-Value="@model.IsEnabled" OnLabel="Enabled" OffLabel="Disabled" />
                                        </Start>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Toggle to enable or disable this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Allowed Login Methods</RadzenText>
                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.EnableLocalLogin" TriState="true" Name="allowLocal" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow local login (username/password)" Component="allowLocal" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowPasskeyLogin" TriState="true" Name="allowPasskey" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow passkey (WebAuthn)" Component="allowPasskey" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowQrLoginQuick" TriState="true" Name="allowQrQuick" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow Quick QR login" Component="allowQrQuick" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowQrLoginSecure" TriState="true" Name="allowQrSecure" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow Secure QR login" Component="allowQrSecure" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowCodeLogin" TriState="true" Name="allowCode" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow authenticator code login option" Component="allowCode" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Redirect URIs Tab -->
                    <RadzenTabsItem Text="Redirect URIs" Icon="link">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Authorization & Logout Redirects</RadzenText>

                                <RadzenFormField Text="Redirect URIs" Variant="Variant.Outlined">
                                    <ChildContent>
                                        <RadzenTextArea @bind-Value="@redirectUrisText"
                                                       Style="width: 100%; height: 140px;"
                                                       Placeholder="One URI per line, e.g. https://localhost:7257/signin-oidc" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            URIs allowed to receive authorization responses (signin-oidc/callback). One per line.
                                        </RadzenText>
                                    </Helper>
                                </RadzenFormField>

                                <RadzenFormField Text="Post-logout Redirect URIs" Variant="Variant.Outlined">
                                    <ChildContent>
                                        <RadzenTextArea @bind-Value="@postLogoutUrisText"
                                                       Style="width: 100%; height: 120px;"
                                                       Placeholder="One URI per line, e.g. https://localhost:7257/signout-callback-oidc or https://localhost:7257/" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            URIs the user can be redirected to after logout. One per line.
                                        </RadzenText>
                                    </Helper>
                                </RadzenFormField>

                                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true">
                                    <RadzenText TextStyle="TextStyle.Caption">
                                        Changes here will update OpenIddict application settings immediately after saving.
                                    </RadzenText>
                                </RadzenAlert>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Scopes Tab -->
                    <RadzenTabsItem Text="Scopes" Icon="policy">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-3">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Allowed Scopes</RadzenText>

                                <RadzenRow class="rz-mb-2">
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Search" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenTextBox @bind-Value="@scopeSearch" Placeholder="Filter by name or description" Style="width: 100%;" Change="@(args => ApplyScopeFilter())" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.End">
                                            <RadzenButton Text="Select All (filtered)" Icon="playlist_add_check" Click="@(() => SelectAllFilteredScopes(true))" />
                                            <RadzenButton Text="Clear All (filtered)" Icon="playlist_remove" ButtonStyle="ButtonStyle.Secondary" Click="@(() => SelectAllFilteredScopes(false))" />
                                        </RadzenStack>
                                    </RadzenColumn>
                                </RadzenRow>

                                <RadzenDataGrid TItem="ScopeSelection" Data="@FilteredScopeItems" AllowFiltering="false" AllowSorting="true" AllowPaging="true" PageSize="10" Responsive="true">
                                    <Columns>
                                        <RadzenDataGridColumn TItem="ScopeSelection" Title="Allow" Width="90px">
                                            <Template Context="s">
                                                <RadzenCheckBox Value="@s.Selected" ValueChanged="@((bool v) => ToggleScopeSelection(s.Name, v))" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="ScopeSelection" Property="Name" Title="Scope" Width="220px" />
                                        <RadzenDataGridColumn TItem="ScopeSelection" Property="DisplayName" Title="Display Name" Width="220px" />
                                        <RadzenDataGridColumn TItem="ScopeSelection" Property="Type" Title="Type" Width="120px">
                                            <Template Context="s">
                                                <RadzenBadge Text="@s.Type.ToString()" BadgeStyle="@(s.Type == ScopeType.Identity ? BadgeStyle.Info : BadgeStyle.Primary)" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="ScopeSelection" Property="IsStandard" Title="Std" Width="80px">
                                            <Template Context="s">
                                                <RadzenBadge Text="@(s.IsStandard ? "Yes" : "No")" BadgeStyle="@(s.IsStandard ? BadgeStyle.Info : BadgeStyle.Light)" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="ScopeSelection" Property="IsEnabled" Title="Status" Width="100px">
                                            <Template Context="s">
                                                <RadzenBadge Text="@(s.IsEnabled ? "Enabled" : "Disabled")" BadgeStyle="@(s.IsEnabled ? BadgeStyle.Success : BadgeStyle.Danger)" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                        <RadzenDataGridColumn TItem="ScopeSelection" Property="Description" Title="Description">
                                            <Template Context="s">
                                                <RadzenText Text="@(s.Description ?? "-")" Style="max-width: 400px; overflow: hidden; text-overflow: ellipsis; display: inline-block; white-space: nowrap;" />
                                            </Template>
                                        </RadzenDataGridColumn>
                                    </Columns>
                                </RadzenDataGrid>

                                @if (selectedScopes?.Any() == true)
                                {
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary rz-mt-2">
                                        Selected (@selectedScopes.Count): @string.Join(", ", selectedScopes)
                                    </RadzenText>
                                }
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Session & Cookie Configuration Tab -->
                    <RadzenTabsItem Text="Session & Cookies" Icon="schedule">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Session Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Session Timeout (Hours)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.SessionTimeoutHours" 
                                                                  Min="0" Max="168" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use realm default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        How long user sessions remain active (0-168 hours)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Remember Me Duration (Days)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.RememberMeDurationDays" 
                                                                  Min="0" Max="365" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use realm default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Duration for "Remember Me" functionality (0-365 days)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="4">
                                            <RadzenFormField Text="Session Expiration Type" Variant="Variant.Outlined">
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="@model.UseSlidingSessionExpiration" TriState="true" Name="useSliding" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Use sliding expiration (extends session on activity)" Component="useSliding" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        When enabled, session timeout resets on user activity (leave unset to use default)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Cookie Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Cookie SameSite Policy" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenDropDown @bind-Value="@model.CookieSameSitePolicy" 
                                                           Data="@sameSitePolicies" 
                                                           TextProperty="Text" 
                                                           ValueProperty="Value" 
                                                           Style="width: 100%;" 
                                                           Placeholder="Select policy..." />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Controls when cookies are sent with cross-site requests
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="HTTPS Cookie Requirement" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.RequireHttpsForCookies" TriState="true" Name="requireHttpsCookies" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require HTTPS for secure cookies" Component="requireHttpsCookies" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Force secure flag on cookies (recommended for production; leave unset to use default)
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Token Configuration Tab -->
                    <RadzenTabsItem Text="Token Lifecycle" Icon="token">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Token Lifetimes</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="ID Token Lifetime (Minutes)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.IdTokenLifetimeMinutes" 
                                                                  Min="1" Max="1440" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        How long ID tokens remain valid (1-1440 minutes)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Device Code Lifetime (Minutes)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.DeviceCodeLifetimeMinutes" 
                                                                  Min="1" Max="60" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Device flow code validity period (1-60 minutes)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Access Token Type" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.AccessTokenType" 
                                                                   Data="@accessTokenTypes" 
                                                                   TextProperty="Text" 
                                                                   ValueProperty="Value" 
                                                                   Style="width: 100%;" 
                                                                   Placeholder="Select token type..." />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        JWT (self-contained) vs Reference (database lookup)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Refresh Token Behavior</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Max Refresh Tokens Per User" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.MaxRefreshTokensPerUser" 
                                                                  Min="0" Max="100" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty for unlimited" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Limit concurrent refresh tokens per user (0 = unlimited)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <!-- Split Token Security into separate form fields -->
                                            <RadzenFormField Text="One-time refresh tokens (rotation)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.UseOneTimeRefreshTokens"
                                                                   Data="@triStateOptions"
                                                                   TextProperty="Text"
                                                                   ValueProperty="Value"
                                                                   Style="width: 100%;"
                                                                   Placeholder="Use realm default" />
                                                </ChildContent>
                                            </RadzenFormField>
                                            <RadzenFormField Text="Hash access tokens in database" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.HashAccessTokens"
                                                                   Data="@triStateOptions"
                                                                   TextProperty="Text"
                                                                   ValueProperty="Value"
                                                                   Style="width: 100%;"
                                                                   Placeholder="Use realm default" />
                                                </ChildContent>
                                            </RadzenFormField>
                                            <RadzenFormField Text="Update claims on token refresh" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenDropDown @bind-Value="@model.UpdateAccessTokenClaimsOnRefresh"
                                                                   Data="@triStateOptions"
                                                                   TextProperty="Text"
                                                                   ValueProperty="Value"
                                                                   Style="width: 100%;"
                                                                   Placeholder="Use realm default" />
                                                </ChildContent>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Security & Compliance Tab -->
                    <RadzenTabsItem Text="Security & Compliance" Icon="security">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">User Consent</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Consent Requirements" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.RequireConsent" TriState="true" Name="requireConsent" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require user consent for authorization" Component="requireConsent" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Controls when users must explicitly approve authorization
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Allow users to remember consent" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowRememberConsent" TriState="true" Name="rememberConsent" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow users to remember consent" Component="rememberConsent" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Endpoint Access</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Allow access to UserInfo endpoint" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowAccessToUserInfoEndpoint" TriState="true" Name="allowUserInfo" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow access to UserInfo endpoint" Component="allowUserInfo" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Controls access to OIDC standard endpoints
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Allow token introspection" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowAccessToIntrospectionEndpoint" TriState="true" Name="allowIntrospection" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow token introspection" Component="allowIntrospection" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Allow token revocation" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AllowAccessToRevocationEndpoint" TriState="true" Name="allowRevocation" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow token revocation" Component="allowRevocation" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Claims Configuration Tab -->
                    <RadzenTabsItem Text="Claims Configuration" Icon="verified_user">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Token Claims</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Include JWT ID in tokens" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.IncludeJwtId" TriState="true" Name="includeJti" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Include JWT ID in tokens" Component="includeJti" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Always send client claims" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AlwaysSendClientClaims" TriState="true" Name="alwaysSendClientClaims" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Always send client claims" Component="alwaysSendClientClaims" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Always include user claims in ID token" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.AlwaysIncludeUserClaimsInIdToken" TriState="true" Name="alwaysIncludeUserClaimsInIdToken" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Always include user claims in ID token" Component="alwaysIncludeUserClaimsInIdToken" />
                                        </ChildContent>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Client Claims Prefix" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.ClientClaimsPrefix" 
                                                          Style="width: 100%;" 
                                                          Placeholder="e.g., client_" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Prefix for client-specific claims (optional)
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Multi-Factor Auth Tab -->
                    <RadzenTabsItem Text="Multi-Factor Auth" Icon="verified_user">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">MFA Requirements</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="MFA Enforcement" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.RequireMfa" TriState="true" Name="requireMfa" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require multi-factor authentication" Component="requireMfa" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                When enabled, users must complete MFA to access this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="MFA Grace Period (Minutes)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="@model.MfaGracePeriodMinutes" 
                                                                  Min="0" Max="1440" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="Leave empty to use default" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Time before requiring MFA again (0-1440 minutes)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Session MFA Memory" Variant="Variant.Outlined">
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="@model.RememberMfaForSession" TriState="true" Name="rememberMfa" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Remember MFA for session duration" Component="rememberMfa" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Skip MFA if already completed this session
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-font-weight-600">Allowed MFA Methods</RadzenText>
                                    @foreach (var method in availableMfaMethods)
                                    {
                                        var name = $"mfa_{method.Value}";
                                        <RadzenFormField Variant="Variant.Outlined">
                                            <Start>
                                                <RadzenCheckBox Value="@IsMethodSelected(method.Value)" 
                                                               ValueChanged="@((bool selected) => ToggleMfaMethod(method.Value, selected))"
                                                               Name="@name" />
                                            </Start>
                                            <ChildContent>
                                                <RadzenLabel Text="@method.Text" Component="@name" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    }
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Select which MFA methods users can use for this client
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Rate Limiting Tab -->
                    <RadzenTabsItem Text="Rate Limiting" Icon="speed">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">API Rate Limits</RadzenText>
                                <RadzenRow>
                                    <RadzenColumn Size="12" SizeMD="4">
                                        <RadzenFormField Text="Per Minute Limit" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="@model.RateLimitRequestsPerMinute" Min="0" Max="10000" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="4">
                                        <RadzenFormField Text="Per Hour Limit" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="@model.RateLimitRequestsPerHour" Min="0" Max="1000000" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="4">
                                        <RadzenFormField Text="Per Day Limit" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="@model.RateLimitRequestsPerDay" Min="0" Max="10000000" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Branding & Customization Tab -->
                    <RadzenTabsItem Text="Branding & UI" Icon="palette">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Visual Customization</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Theme" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenDropDown @bind-Value="@model.ThemeName" Data="@availableThemes" TextProperty="Text" ValueProperty="Value" Style="width: 100%;" Placeholder="Use realm default..." AllowClear="true" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Select a predefined theme. Precedence: Client ? Realm ? Server.
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="Radzen.FlexWrap.Wrap">
                                        @foreach (var t in availableThemes)
                                        {
                                            <RadzenButton ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" Click="@(() => model.ThemeName = t.Value)">
                                                <RadzenIcon Icon="palette" class="rz-me-1" /> @t.Text
                                            </RadzenButton>
                                        }
                                        <RadzenButton ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Small" Click="@(() => model.ThemeName = null)">
                                            <RadzenIcon Icon="restore" class="rz-me-1" /> Use realm default
                                        </RadzenButton>
                                    </RadzenStack>

                                    <RadzenFormField Text="Custom CSS URI" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomCssUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://cdn.example.com/client-theme.css" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Optional: custom stylesheet loaded after theme for overrides.
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Custom JavaScript URL" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomJavaScriptUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://cdn.example.com/client-scripts.js" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                URL to custom JavaScript file for client-specific functionality
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Page Title Prefix" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.PageTitlePrefix" 
                                                          Style="width: 100%;" 
                                                          Placeholder="e.g., Company Name - " />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Text to prepend to page titles for this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Client Information URLs</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Logo URI" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.LogoUri" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="https://example.com/logo.png" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        URL to client logo image
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Client URI" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.ClientUri" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="https://example.com" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        URL to client homepage
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Privacy Policy URI" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.PolicyUri" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="https://example.com/privacy" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        URL to privacy policy
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Terms of Service URI" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenTextBox @bind-Value="@model.TosUri" 
                                                                  Style="width: 100%;" 
                                                                  Placeholder="https://example.com/terms" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        URL to terms of service
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Logout & Integration Tab -->
                    <RadzenTabsItem Text="Logout & Integration" Icon="logout">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Back-Channel Logout</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Back-Channel Logout URI" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.BackChannelLogoutUri" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://client.example.com/logout" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Server-to-server logout notification endpoint
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Back-Channel Settings" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.BackChannelLogoutSessionRequired" TriState="true" Name="bclSessionRequired" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Include session ID in logout tokens" Component="bclSessionRequired" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Whether to include session_id in logout tokens
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Front-Channel Logout</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Front-Channel Logout URI" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.FrontChannelLogoutUri" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://client.example.com/logout-iframe" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Browser-based logout notification endpoint
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Front-Channel Settings" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.FrontChannelLogoutSessionRequired" TriState="true" Name="fclSessionRequired" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require session ID for front-channel logout" Component="fclSessionRequired" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">External Integrations</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Allowed CORS Origins" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextArea @bind-Value="@model.AllowedCorsOrigins" 
                                                           Style="width: 100%; height: 80px;" 
                                                           Placeholder="https://app1.example.com&#10;https://app2.example.com" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                One origin per line. Required for browser-based applications.
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Allowed Identity Providers" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextArea @bind-Value="@model.AllowedIdentityProviders" 
                                                           Style="width: 100%; height: 60px;" 
                                                           Placeholder="google&#10;azure&#10;facebook" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Restrict which external IdPs this client can use (one per line)
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Identity Providers (Links) Tab -->
                    <RadzenTabsItem Text="Identity Providers" Icon="link">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            @if (!IsEdit)
                            {
                                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true">
                                    <RadzenText TextStyle="TextStyle.Body1">Save the client first to manage identity provider links.</RadzenText>
                                </RadzenAlert>
                            }
                            else
                            {
                                <RadzenStack Gap="1rem">
                                    <RadzenCard>
                                        <RadzenText TextStyle="TextStyle.Subtitle2">Add Link</RadzenText>
                                        <RadzenRow Gap="1rem" class="rz-mt-2">
                                            <RadzenColumn Size="12" SizeMD="6">
                                                <RadzenFormField Text="Provider" Variant="Variant.Outlined">
                                                    <ChildContent>
                                                        <RadzenDropDown Data="@FilteredProviders" @bind-Value="selectedProviderId" Style="width:100%"
                                                                        TextProperty="DisplayName" ValueProperty="Id" AllowClear="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" />
                                                    </ChildContent>
                                                </RadzenFormField>
                                            </RadzenColumn>
                                            <RadzenColumn Size="12" SizeMD="6">
                                                <RadzenFormField Text="Search Providers" Variant="Variant.Outlined">
                                                    <ChildContent>
                                                        <RadzenTextBox @bind-Value="providerSearch" Style="width:100%" Placeholder="type to search..." Change="@(async _ => await ReloadProviders())" />
                                                    </ChildContent>
                                                </RadzenFormField>
                                            </RadzenColumn>
                                        </RadzenRow>
                                        <RadzenRow Gap="1rem">
                                            <RadzenColumn Size="12" SizeMD="6">
                                                <RadzenFormField Text="Display Name Override" Variant="Variant.Outlined">
                                                    <ChildContent>
                                                        <RadzenTextBox @bind-Value="linkDisplayOverride" Style="width:100%" />
                                                    </ChildContent>
                                                </RadzenFormField>
                                            </RadzenColumn>
                                            <RadzenColumn Size="12" SizeMD="3">
                                                <RadzenFormField Text="Order" Variant="Variant.Outlined">
                                                    <ChildContent>
                                                        <RadzenNumeric TValue="int?" @bind-Value="linkOrder" Style="width:100%" />
                                                    </ChildContent>
                                                </RadzenFormField>
                                            </RadzenColumn>
                                            <RadzenColumn Size="12" SizeMD="3">
                                                <RadzenFormField Text="Enabled" Variant="Variant.Outlined">
                                                    <Start>
                                                        <RadzenSwitch @bind-Value="linkEnabled" OnLabel="Yes" OffLabel="No" />
                                                    </Start>
                                                </RadzenFormField>
                                            </RadzenColumn>
                                        </RadzenRow>
                                        <RadzenRow>
                                            <RadzenColumn Size="12" class="rz-display-flex rz-justify-content-end">
                                                <RadzenButton Icon="link" Text="Add Link" ButtonStyle="ButtonStyle.Primary" Click="@(async ()=> await AddIdentityLink())" Disabled="@(!IsEdit || string.IsNullOrEmpty(selectedProviderId))" />
                                            </RadzenColumn>
                                        </RadzenRow>
                                    </RadzenCard>

                                    <RadzenCard>
                                        <RadzenText TextStyle="TextStyle.Subtitle2">Linked Providers</RadzenText>
                                        <RadzenDataGrid TItem="ClientIdentityProviderDto" Data="@identityLinks" AllowPaging="true" PageSize="10" class="rz-mt-2">
                                            <Columns>
                                                <RadzenDataGridColumn TItem="ClientIdentityProviderDto" Title="Provider">
                                                    <Template Context="row">
                                                        @GetProviderName(row.IdentityProviderId)
                                                    </Template>
                                                </RadzenDataGridColumn>
                                                <RadzenDataGridColumn TItem="ClientIdentityProviderDto" Property="DisplayNameOverride" Title="Display Name" />
                                                <RadzenDataGridColumn TItem="ClientIdentityProviderDto" Property="Order" Title="Order" Width="100px" />
                                                <RadzenDataGridColumn TItem="ClientIdentityProviderDto" Title="Enabled" Width="120px">
                                                    <Template Context="row">
                                                        <RadzenBadge Text="@(row.IsEnabled == false ? "No" : "Yes")" BadgeStyle="@(row.IsEnabled == false ? BadgeStyle.Danger : BadgeStyle.Success)" />
                                                    </Template>
                                                </RadzenDataGridColumn>
                                                <RadzenDataGridColumn TItem="ClientIdentityProviderDto" Context="row" Title="Actions" Width="160px">
                                                    <Template Context="row">
                                                        <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Text="Remove"
                                                                      Click="@(async ()=> await RemoveIdentityLink(row))" />
                                                    </Template>
                                                </RadzenDataGridColumn>
                                            </Columns>
                                        </RadzenDataGrid>
                                    </RadzenCard>
                                </RadzenStack>
                            }
                        </div>
                    </RadzenTabsItem>

                    <!-- Advanced Configuration Tab -->
                    <RadzenTabsItem Text="Advanced" Icon="settings_applications">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Protocol Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Protocol Type" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.ProtocolType" 
                                                          Style="width: 100%;" 
                                                          Disabled="true" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Protocol type (currently only OIDC is supported)
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Development Settings</RadzenText>

                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.EnableDetailedErrors" TriState="true" Name="enableDetailedErrors" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Enable detailed error responses" Component="enableDetailedErrors" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.LogSensitiveData" TriState="true" Name="logSensitiveData" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Log sensitive data (development only)" Component="logSensitiveData" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="@model.EnableLocalLogin" TriState="true" Name="enableLocalLogin" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Enable local login (username/password)" Component="enableLocalLogin" />
                                        </ChildContent>
                                    </RadzenFormField>

                                    <RadzenAlert AlertStyle="AlertStyle.Warning" ShowIcon="true" class="rz-mt-2">
                                        <RadzenText TextStyle="TextStyle.Caption">
                                            Warning: Detailed errors and sensitive data logging should not be enabled in production.
                                        </RadzenText>
                                    </RadzenAlert>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Custom Page URLs</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Custom Login Page" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomLoginPageUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://custom.example.com/login" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Override default login page for this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Custom Logout Page" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomLogoutPageUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://custom.example.com/logout" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Override default logout page for this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Custom Error Page" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.CustomErrorPageUrl" 
                                                          Style="width: 100%;" 
                                                          Placeholder="https://custom.example.com/error" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Override default error page for this client
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>

            <div class="rz-mt-4" style="position: sticky; bottom: 0; background: var(--rz-base-background); border-top: 1px solid var(--rz-panel-border); padding: 0.75rem 1rem; z-index: 10;">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <ValidationSummary />
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Click="@CancelEdit" />
                        @if (IsEdit)
                        {
                            <RadzenButton Text="Reset to Defaults" Icon="restore" ButtonStyle="ButtonStyle.Warning" Click="@(async () => await ResetToDefaults())" />
                        }
                        <RadzenButton Text="@(IsEdit ? "Update Client" : "Create Client")" Icon="@(IsEdit ? "save" : "add_circle")" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        </RadzenTemplateForm>
    }
</RadzenCard>

@code {
    [Parameter] public string? Id { get; set; }

    private CreateClientRequest model = new();
    private List<RealmDto> realms = new();
    private List<ScopeDto> availableScopes = new();
    private List<ScopeSelection> scopeItems = new();
    private string? scopeSearch;
    private bool isLoading = false;
    private int selectedTabIndex = 0;

    // Dropdown data
    private List<DropdownItem<ClientType>> clientTypes = new();
    private List<DropdownItem<string>> sameSitePolicies = new();
    private List<DropdownItem<string>> accessTokenTypes = new();
    private List<DropdownItem<bool?>> triStateOptions = new();
    private List<DropdownItem<string>> availableMfaMethods = new();
    private List<DropdownItem<string>> availableThemes = new()
    {
        new("Light", "light"),
        new("Dark", "dark"),
        new("Ocean", "ocean"),
        new("Forest", "forest"),
        new("Corporate", "corporate"),
        new("Sunset", "sunset"),
        new("Purple", "purple")
    };

    // Selections
    private List<string> selectedScopes = new();
    private List<string> selectedPermissions = new();

    // Multi-line text backing for URIs
    private string redirectUrisText = string.Empty;
    private string postLogoutUrisText = string.Empty;

    // Convenience binding for MFA methods serialization (use model's value)
    private string? allowedMfaMethodsSerialized => model.AllowedMfaMethods;

    // Identity Provider links state
    private List<ClientIdentityProviderDto> identityLinks = new();
    private List<IdentityProviderDto> providers = new();
    private string? selectedProviderId;
    private string providerSearch = string.Empty;
    private string? linkDisplayOverride;
    private int? linkOrder;
    private bool linkEnabled = true;

    private bool IsEdit => !string.IsNullOrEmpty(Id);

    protected override async Task OnInitializedAsync()
    {
        await LoadRealms();
        await LoadScopes();
        InitializeDropdownData();

        if (IsEdit && !string.IsNullOrEmpty(Id))
        {
            await LoadClient();
            await ReloadProviders();
            await LoadIdentityLinksAsync();
        }
        else
        {
            // Set defaults for new client
            model.IsEnabled = true;
            model.UseSlidingSessionExpiration = true;
            model.AllowAccessToUserInfoEndpoint = true;
            model.AllowAccessToRevocationEndpoint = true;
            model.RememberMfaForSession = true;
            model.EnableLocalLogin = true;
            // Login option defaults
            model.AllowPasskeyLogin = true;
            model.AllowQrLoginQuick = true;
            model.AllowQrLoginSecure = true;
            model.AllowCodeLogin = true;
            // Reasonable default scopes for new client
            selectedScopes = new() { "openid", "profile", "email", "roles", "offline_access" };
        }
    }

    private void InitializeDropdownData()
    {
        clientTypes = new()
        {
            new("Confidential", ClientType.Confidential),
            new("Public", ClientType.Public),
            new("Machine", ClientType.Machine)
        };

        sameSitePolicies = new()
        {
            new("None (Cross-site requests allowed)", "None"),
            new("Lax (Some cross-site requests)", "Lax"),
            new("Strict (No cross-site requests)", "Strict")
        };

        accessTokenTypes = new()
        {
            new("JWT (Self-contained)", "JWT"),
            new("Reference (Database lookup)", "Reference")
        };

        triStateOptions = new()
        {
            new("Use realm default", null),
            new("Enabled", true),
            new("Disabled", false)
        };

        availableMfaMethods = new()
        {
            new("Time-based OTP (TOTP)", "totp"),
            new("SMS Verification", "sms"),
            new("Email Verification", "email"),
            new("Push Notifications", "push"),
            new("Hardware Token", "hardware"),
            new("Biometric", "biometric")
        };
    }

    private async Task LoadRealms()
    {
        try
        {
            var result = await RealmsApiService.GetRealmsAsync(1, 100);
            realms = result?.Items ?? new List<RealmDto>();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading realms");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load realms");
        }
    }

    private async Task LoadScopes()
    {
        try
        {
            var result = await ScopesApiService.GetScopesAsync(1, 1000);
            availableScopes = result?.Items ?? new List<ScopeDto>();
            BuildScopeSelections();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading scopes");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load scopes");
        }
    }

    private async Task LoadClient()
    {
        isLoading = true;
        try
        {
            var client = await ClientsApiService.GetClientAsync(Id!);
            if (client != null)
            {
                // Map from ClientDto to CreateClientRequest with all new dynamic parameters
                model = MapClientToRequest(client);
                redirectUrisText = string.Join("\n", client.RedirectUris ?? new());
                postLogoutUrisText = string.Join("\n", client.PostLogoutUris ?? new());
                selectedScopes = client.Scopes?.ToList() ?? new();
                selectedPermissions = client.Permissions?.ToList() ?? new();
                BuildScopeSelections();
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading client {ClientId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load client");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task ReloadProviders()
    {
        try
        {
            // Load providers optionally filtered by realm
            providers = await IdentityProvidersApi.GetIdentityProvidersAsync(model.RealmId) ?? new();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading identity providers for realm {RealmId}", model.RealmId);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load identity providers");
        }
    }

    private IEnumerable<IdentityProviderDto> FilteredProviders => string.IsNullOrWhiteSpace(providerSearch)
        ? providers
        : providers.Where(p => (p.DisplayName ?? p.Name).Contains(providerSearch, StringComparison.OrdinalIgnoreCase)
                            || p.Name.Contains(providerSearch, StringComparison.OrdinalIgnoreCase));

    private string GetProviderName(string providerId)
    {
        var p = providers.FirstOrDefault(x => x.Id == providerId);
        return p?.DisplayName ?? p?.Name ?? providerId;
    }

    private async Task LoadIdentityLinksAsync()
    {
        try
        {
            identityLinks = await ClientsApiService.GetIdentityLinksAsync(Id!);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading identity links for client {ClientId}", Id);
            identityLinks = new();
        }
    }

    private async Task AddIdentityLink()
    {
        if (!IsEdit || string.IsNullOrEmpty(selectedProviderId)) return;
        try
        {
            var dto = new ClientIdentityProviderDto
            {
                DisplayNameOverride = linkDisplayOverride,
                Order = linkOrder,
                IsEnabled = linkEnabled
            };
            var created = await ClientsApiService.AddIdentityLinkAsync(Id!, selectedProviderId!, dto);
            if (created is not null)
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Success, Summary = "Linked" });
                linkDisplayOverride = null;
                linkOrder = null;
                linkEnabled = true;
                selectedProviderId = null;
                await LoadIdentityLinksAsync();
            }
            else
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Link failed" });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "AddIdentityLink failed for client {ClientId}", Id);
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Link failed" });
        }
    }

    private async Task RemoveIdentityLink(ClientIdentityProviderDto link)
    {
        try
        {
            var ok = await ClientsApiService.RemoveIdentityLinkAsync(Id!, link.Id);
            if (ok)
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Info, Summary = "Removed" });
                await LoadIdentityLinksAsync();
            }
            else
            {
                NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Remove failed" });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "RemoveIdentityLink failed for client {ClientId}", Id);
            NotificationService.Notify(new NotificationMessage { Severity = NotificationSeverity.Error, Summary = "Remove failed" });
        }
    }

    private CreateClientRequest MapClientToRequest(ClientDto client)
    {
        return new CreateClientRequest
        {
            ClientId = client.ClientId,
            Name = client.Name,
            Description = client.Description,
            IsEnabled = client.IsEnabled,
            RealmId = client.RealmId,
            ClientType = client.ClientType,
            SessionTimeoutHours = client.SessionTimeoutHours,
            UseSlidingSessionExpiration = client.UseSlidingSessionExpiration,
            RememberMeDurationDays = client.RememberMeDurationDays,
            RequireHttpsForCookies = client.RequireHttpsForCookies,
            CookieSameSitePolicy = client.CookieSameSitePolicy,
            IdTokenLifetimeMinutes = client.IdTokenLifetimeMinutes,
            DeviceCodeLifetimeMinutes = client.DeviceCodeLifetimeMinutes,
            AccessTokenType = client.AccessTokenType,
            UseOneTimeRefreshTokens = client.UseOneTimeRefreshTokens,
            MaxRefreshTokensPerUser = client.MaxRefreshTokensPerUser,
            HashAccessTokens = client.HashAccessTokens,
            UpdateAccessTokenClaimsOnRefresh = client.UpdateAccessTokenClaimsOnRefresh,
            RequireConsent = client.RequireConsent,
            AllowRememberConsent = client.AllowRememberConsent,
            AllowAccessToUserInfoEndpoint = client.AllowAccessToUserInfoEndpoint,
            AllowAccessToIntrospectionEndpoint = client.AllowAccessToIntrospectionEndpoint,
            AllowAccessToRevocationEndpoint = client.AllowAccessToRevocationEndpoint,
            IncludeJwtId = client.IncludeJwtId,
            AlwaysSendClientClaims = client.AlwaysSendClientClaims,
            AlwaysIncludeUserClaimsInIdToken = client.AlwaysIncludeUserClaimsInIdToken,
            ClientClaimsPrefix = client.ClientClaimsPrefix,
            RequireMfa = client.RequireMfa,
            MfaGracePeriodMinutes = client.MfaGracePeriodMinutes,
            AllowedMfaMethods = client.AllowedMfaMethods,
            RememberMfaForSession = client.RememberMfaForSession,
            RateLimitRequestsPerMinute = client.RateLimitRequestsPerMinute,
            RateLimitRequestsPerHour = client.RateLimitRequestsPerHour,
            RateLimitRequestsPerDay = client.RateLimitRequestsPerDay,
            ThemeName = client.ThemeName,
            CustomCssUrl = client.CustomCssUrl,
            CustomJavaScriptUrl = client.CustomJavaScriptUrl,
            PageTitlePrefix = client.PageTitlePrefix,
            LogoUri = client.LogoUri,
            ClientUri = client.ClientUri,
            PolicyUri = client.PolicyUri,
            TosUri = client.TosUri,
            BackChannelLogoutUri = client.BackChannelLogoutUri,
            BackChannelLogoutSessionRequired = client.BackChannelLogoutSessionRequired,
            FrontChannelLogoutUri = client.FrontChannelLogoutUri,
            FrontChannelLogoutSessionRequired = client.FrontChannelLogoutSessionRequired,
            AllowedCorsOrigins = client.AllowedCorsOrigins,
            AllowedIdentityProviders = client.AllowedIdentityProviders,
            ProtocolType = client.ProtocolType,
            EnableDetailedErrors = client.EnableDetailedErrors,
            LogSensitiveData = client.LogSensitiveData,
            EnableLocalLogin = client.EnableLocalLogin,
            CustomLoginPageUrl = client.CustomLoginPageUrl,
            CustomLogoutPageUrl = client.CustomLogoutPageUrl,
            CustomErrorPageUrl = client.CustomErrorPageUrl,
            // New login options
            AllowPasskeyLogin = client.AllowPasskeyLogin,
            AllowQrLoginQuick = client.AllowQrLoginQuick,
            AllowQrLoginSecure = client.AllowQrLoginSecure,
            AllowCodeLogin = client.AllowCodeLogin
        };
    }

    private UpdateClientRequest BuildUpdateRequestFromModel()
    {
        var update = new UpdateClientRequest
        {
            // map fields from 'model' to update request
            Name = model.Name,
            Description = model.Description,
            IsEnabled = model.IsEnabled,
            ClientType = model.ClientType,
            AllowAuthorizationCodeFlow = true,
            AllowClientCredentialsFlow = model.ClientType == ClientType.Machine,
            AllowPasswordFlow = false,
            AllowRefreshTokenFlow = true,
            RequirePkce = model.ClientType != ClientType.Machine,
            RequireClientSecret = model.ClientType != ClientType.Public,
            RedirectUris = redirectUrisText?.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList() ?? new(),
            PostLogoutUris = postLogoutUrisText?.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList() ?? new(),
            Scopes = selectedScopes,
            Permissions = selectedPermissions,

            // dynamic fields mapping
            SessionTimeoutHours = model.SessionTimeoutHours,
            UseSlidingSessionExpiration = model.UseSlidingSessionExpiration,
            RememberMeDurationDays = model.RememberMeDurationDays,
            RequireHttpsForCookies = model.RequireHttpsForCookies,
            CookieSameSitePolicy = model.CookieSameSitePolicy,
            IdTokenLifetimeMinutes = model.IdTokenLifetimeMinutes,
            DeviceCodeLifetimeMinutes = model.DeviceCodeLifetimeMinutes,
            AccessTokenType = model.AccessTokenType,
            UseOneTimeRefreshTokens = model.UseOneTimeRefreshTokens,
            MaxRefreshTokensPerUser = model.MaxRefreshTokensPerUser,
            HashAccessTokens = model.HashAccessTokens,
            UpdateAccessTokenClaimsOnRefresh = model.UpdateAccessTokenClaimsOnRefresh,
            RequireConsent = model.RequireConsent,
            AllowRememberConsent = model.AllowRememberConsent,
            AllowAccessToUserInfoEndpoint = model.AllowAccessToUserInfoEndpoint,
            AllowAccessToIntrospectionEndpoint = model.AllowAccessToIntrospectionEndpoint,
            AllowAccessToRevocationEndpoint = model.AllowAccessToRevocationEndpoint,
            IncludeJwtId = model.IncludeJwtId,
            AlwaysSendClientClaims = model.AlwaysSendClientClaims,
            AlwaysIncludeUserClaimsInIdToken = model.AlwaysIncludeUserClaimsInIdToken,
            ClientClaimsPrefix = model.ClientClaimsPrefix,
            RequireMfa = model.RequireMfa,
            MfaGracePeriodMinutes = model.MfaGracePeriodMinutes,
            AllowedMfaMethods = model.AllowedMfaMethods,
            RememberMfaForSession = model.RememberMfaForSession,
            RateLimitRequestsPerMinute = model.RateLimitRequestsPerMinute,
            RateLimitRequestsPerHour = model.RateLimitRequestsPerHour,
            RateLimitRequestsPerDay = model.RateLimitRequestsPerDay,
            ThemeName = model.ThemeName,
            CustomCssUrl = model.CustomCssUrl,
            CustomJavaScriptUrl = model.CustomJavaScriptUrl,
            PageTitlePrefix = model.PageTitlePrefix,
            LogoUri = model.LogoUri,
            ClientUri = model.ClientUri,
            PolicyUri = model.PolicyUri,
            TosUri = model.TosUri,
            BackChannelLogoutUri = model.BackChannelLogoutUri,
            BackChannelLogoutSessionRequired = model.BackChannelLogoutSessionRequired,
            FrontChannelLogoutUri = model.FrontChannelLogoutUri,
            FrontChannelLogoutSessionRequired = model.FrontChannelLogoutSessionRequired,
            AllowedCorsOrigins = model.AllowedCorsOrigins,
            AllowedIdentityProviders = model.AllowedIdentityProviders,
            ProtocolType = model.ProtocolType,
            EnableDetailedErrors = model.EnableDetailedErrors,
            LogSensitiveData = model.LogSensitiveData,
            EnableLocalLogin = model.EnableLocalLogin,
            CustomLoginPageUrl = model.CustomLoginPageUrl,
            CustomLogoutPageUrl = model.CustomLogoutPageUrl,
            CustomErrorPageUrl = model.CustomErrorPageUrl,
            // New login options
            AllowPasskeyLogin = model.AllowPasskeyLogin,
            AllowQrLoginQuick = model.AllowQrLoginQuick,
            AllowQrLoginSecure = model.AllowQrLoginSecure,
            AllowCodeLogin = model.AllowCodeLogin
        };

        return update;
    }

    private CreateClientRequest BuildCreateRequestFromModel()
    {
        return new CreateClientRequest
        {
            ClientId = model.ClientId,
            ClientSecret = model.ClientSecret,
            Name = model.Name,
            Description = model.Description,
            RealmId = model.RealmId,
            IsEnabled = model.IsEnabled,
            ClientType = model.ClientType,
            AllowAuthorizationCodeFlow = true,
            AllowClientCredentialsFlow = model.ClientType == ClientType.Machine,
            AllowPasswordFlow = false,
            AllowRefreshTokenFlow = true,
            RequirePkce = model.ClientType != ClientType.Machine,
            RequireClientSecret = model.ClientType != ClientType.Public,
            RedirectUris = redirectUrisText?.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList() ?? new(),
            PostLogoutUris = postLogoutUrisText?.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries).ToList() ?? new(),
            Scopes = selectedScopes,
            Permissions = selectedPermissions,

            // dynamic fields
            SessionTimeoutHours = model.SessionTimeoutHours,
            UseSlidingSessionExpiration = model.UseSlidingSessionExpiration,
            RememberMeDurationDays = model.RememberMeDurationDays,
            RequireHttpsForCookies = model.RequireHttpsForCookies,
            CookieSameSitePolicy = model.CookieSameSitePolicy,
            IdTokenLifetimeMinutes = model.IdTokenLifetimeMinutes,
            DeviceCodeLifetimeMinutes = model.DeviceCodeLifetimeMinutes,
            AccessTokenType = model.AccessTokenType,
            UseOneTimeRefreshTokens = model.UseOneTimeRefreshTokens,
            MaxRefreshTokensPerUser = model.MaxRefreshTokensPerUser,
            HashAccessTokens = model.HashAccessTokens,
            UpdateAccessTokenClaimsOnRefresh = model.UpdateAccessTokenClaimsOnRefresh,
            RequireConsent = model.RequireConsent,
            AllowRememberConsent = model.AllowRememberConsent,
            AllowAccessToUserInfoEndpoint = model.AllowAccessToUserInfoEndpoint,
            AllowAccessToIntrospectionEndpoint = model.AllowAccessToIntrospectionEndpoint,
            AllowAccessToRevocationEndpoint = model.AllowAccessToRevocationEndpoint,
            IncludeJwtId = model.IncludeJwtId,
            AlwaysSendClientClaims = model.AlwaysSendClientClaims,
            AlwaysIncludeUserClaimsInIdToken = model.AlwaysIncludeUserClaimsInIdToken,
            ClientClaimsPrefix = model.ClientClaimsPrefix,
            RequireMfa = model.RequireMfa,
            MfaGracePeriodMinutes = model.MfaGracePeriodMinutes,
            AllowedMfaMethods = model.AllowedMfaMethods,
            RememberMfaForSession = model.RememberMfaForSession,
            RateLimitRequestsPerMinute = model.RateLimitRequestsPerMinute,
            RateLimitRequestsPerHour = model.RateLimitRequestsPerHour,
            RateLimitRequestsPerDay = model.RateLimitRequestsPerDay,
            ThemeName = model.ThemeName,
            CustomCssUrl = model.CustomCssUrl,
            CustomJavaScriptUrl = model.CustomJavaScriptUrl,
            PageTitlePrefix = model.PageTitlePrefix,
            LogoUri = model.LogoUri,
            ClientUri = model.ClientUri,
            PolicyUri = model.PolicyUri,
            TosUri = model.TosUri,
            BackChannelLogoutUri = model.BackChannelLogoutUri,
            BackChannelLogoutSessionRequired = model.BackChannelLogoutSessionRequired,
            FrontChannelLogoutUri = model.FrontChannelLogoutUri,
            FrontChannelLogoutSessionRequired = model.FrontChannelLogoutSessionRequired,
            AllowedCorsOrigins = model.AllowedCorsOrigins,
            AllowedIdentityProviders = model.AllowedIdentityProviders,
            ProtocolType = model.ProtocolType,
            EnableDetailedErrors = model.EnableDetailedErrors,
            LogSensitiveData = model.LogSensitiveData,
            EnableLocalLogin = model.EnableLocalLogin,
            CustomLoginPageUrl = model.CustomLoginPageUrl,
            CustomLogoutPageUrl = model.CustomLogoutPageUrl,
            CustomErrorPageUrl = model.CustomErrorPageUrl,
            // New login options
            AllowPasskeyLogin = model.AllowPasskeyLogin,
            AllowQrLoginQuick = model.AllowQrLoginQuick,
            AllowQrLoginSecure = model.AllowQrLoginSecure,
            AllowCodeLogin = model.AllowCodeLogin
        };
    }

    private bool IsMethodSelected(string method)
    {
        if (string.IsNullOrEmpty(model.AllowedMfaMethods))
            return false;

        try
        {
            var methods = System.Text.Json.JsonSerializer.Deserialize<string[]>(model.AllowedMfaMethods);
            return methods?.Contains(method) == true;
        }
        catch
        {
            return false;
        }
    }

    private void ToggleMfaMethod(string method, bool selected)
    {
        var methods = new List<string>();

        if (!string.IsNullOrEmpty(model.AllowedMfaMethods))
        {
            try
            {
                var existing = System.Text.Json.JsonSerializer.Deserialize<string[]>(model.AllowedMfaMethods);
                if (existing != null)
                    methods.AddRange(existing);
            }
            catch { }
        }

        if (selected)
        {
            if (!methods.Contains(method))
                methods.Add(method);
        }
        else
        {
            methods.Remove(method);
        }

        model.AllowedMfaMethods = methods.Any()
            ? System.Text.Json.JsonSerializer.Serialize(methods.ToArray())
            : null;
    }

    private async Task OnSave(CreateClientRequest args)
    {
        ClientDto? result;
        if (IsEdit)
        {
            var update = BuildUpdateRequestFromModel();
            result = await ClientsApiService.UpdateClientAsync(Id!, update);
            if (result != null)
            {
                var fresh = await ClientsApiService.GetClientAsync(result.Id);
                if (fresh != null)
                {
                    result = fresh;
                }
            }
        }
        else
        {
            result = await ClientsApiService.CreateClientAsync(BuildCreateRequestFromModel());
        }

        if (result != null)
        {
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Client '{result.Name}' has been {(IsEdit ? "updated" : "created")} successfully");
            Navigation.NavigateTo("/clients");
        }
        else
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save client");
        }
    }

    private void CancelEdit() => Navigation.NavigateTo("/clients");

    private Task ResetToDefaults()
    {
        // Reset dynamic fields to use realm defaults (nulls)
        model.SessionTimeoutHours = null;
        model.UseSlidingSessionExpiration = null;
        model.RememberMeDurationDays = null;
        model.RequireHttpsForCookies = null;
        model.CookieSameSitePolicy = null;
        model.IdTokenLifetimeMinutes = null;
        model.DeviceCodeLifetimeMinutes = null;
        model.AccessTokenType = null;
        model.UseOneTimeRefreshTokens = null;
        model.MaxRefreshTokensPerUser = null;
        model.HashAccessTokens = null;
        model.UpdateAccessTokenClaimsOnRefresh = null;
        model.RequireConsent = null;
        model.AllowRememberConsent = null;
        model.AllowAccessToUserInfoEndpoint = null;
        model.AllowAccessToIntrospectionEndpoint = null;
        model.AllowAccessToRevocationEndpoint = null;
        model.IncludeJwtId = null;
        model.AlwaysSendClientClaims = null;
        model.AlwaysIncludeUserClaimsInIdToken = null;
        model.ClientClaimsPrefix = null;
        model.RequireMfa = null;
        model.MfaGracePeriodMinutes = null;
        model.AllowedMfaMethods = null;
        model.RememberMfaForSession = null;
        model.RateLimitRequestsPerMinute = null;
        model.RateLimitRequestsPerHour = null;
        model.RateLimitRequestsPerDay = null;
        model.ThemeName = null;
        model.CustomCssUrl = null;
        model.CustomJavaScriptUrl = null;
        model.PageTitlePrefix = null;
        model.LogoUri = null;
        model.ClientUri = null;
        model.PolicyUri = null;
        model.TosUri = null;
        model.BackChannelLogoutUri = null;
        model.BackChannelLogoutSessionRequired = null;
        model.FrontChannelLogoutUri = null;
        model.FrontChannelLogoutSessionRequired = null;
        model.AllowedCorsOrigins = null;
        model.AllowedIdentityProviders = null;
        // Reset login options to null (realm/server default)
        model.EnableLocalLogin = null;
        model.AllowPasskeyLogin = null;
        model.AllowQrLoginQuick = null;
        model.AllowQrLoginSecure = null;
        model.AllowCodeLogin = null;
        StateHasChanged();
        return Task.CompletedTask;
    }

    private void BuildScopeSelections()
    {
        scopeItems = availableScopes
            .OrderBy(s => s.IsStandard ? 0 : 1)
            .ThenBy(s => s.Name)
            .Select(s => new ScopeSelection
            {
                Name = s.Name,
                DisplayName = s.DisplayName,
                Description = s.Description,
                Type = s.Type,
                IsEnabled = s.IsEnabled,
                IsStandard = s.IsStandard,
                Selected = selectedScopes?.Contains(s.Name) == true
            })
            .ToList();
    }

    private void ApplyScopeFilter()
    {
        StateHasChanged();
    }

    private void ToggleScopeSelection(string scopeName, bool selected)
    {
        var item = scopeItems.FirstOrDefault(i => i.Name == scopeName);
        if (item != null)
        {
            item.Selected = selected;
        }

        if (selected)
        {
            if (!selectedScopes.Contains(scopeName))
                selectedScopes.Add(scopeName);
        }
        else
        {
            selectedScopes.Remove(scopeName);
        }
    }

    private void SelectAllFilteredScopes(bool select)
    {
        foreach (var item in FilteredScopeItems.ToList())
        {
            item.Selected = select;
            if (select)
            {
                if (!selectedScopes.Contains(item.Name))
                    selectedScopes.Add(item.Name);
            }
            else
            {
                selectedScopes.Remove(item.Name);
            }
        }
    }

    private IEnumerable<ScopeSelection> FilteredScopeItems => string.IsNullOrWhiteSpace(scopeSearch)
        ? scopeItems
        : scopeItems.Where(s => (s.Name?.Contains(scopeSearch, StringComparison.OrdinalIgnoreCase) ?? false)
                             || (s.DisplayName?.Contains(scopeSearch, StringComparison.OrdinalIgnoreCase) ?? false)
                             || (s.Description?.Contains(scopeSearch, StringComparison.OrdinalIgnoreCase) ?? false));

    private record DropdownItem<T>(string Text, T Value);

    private class ScopeSelection
     {
         public string Name { get; set; } = string.Empty;
         public string? DisplayName { get; set; }
         public string? Description { get; set; }
         public ScopeType Type { get; set; }
         public bool IsEnabled { get; set; }
         public bool IsStandard { get; set; }
         public bool Selected { get; set; }
     }
}