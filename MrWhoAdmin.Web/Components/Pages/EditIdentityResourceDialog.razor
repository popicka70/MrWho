@inject IIdentityResourcesApiService IdentityResourcesApi
@inject IUsersApiService UsersApi
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ILogger<EditIdentityResourceDialog> Logger
@using MrWho.Shared.Models

<RadzenStack Gap="1rem">
    <RadzenFormField Text="Scope Name" Variant="Variant.Outlined">
        <RadzenTextBox Value="@IdentityResource.Name" Disabled="true" Style="width: 100%;" />
        <RadzenText TextStyle="TextStyle.Caption" class="rz-text-disabled-color">OIDC scope identifier (immutable).</RadzenText>
    </RadzenFormField>

    <RadzenFormField Text="Display Name" Variant="Variant.Outlined">
        <RadzenTextBox @bind-Value="@request.DisplayName" MaxLength="200" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenFormField Text="Description" Variant="Variant.Outlined">
        <RadzenTextArea @bind-Value="@request.Description" MaxLength="1000" Rows="3" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenRow Gap="1rem">
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenFormField Text="Enabled" Variant="Variant.Outlined">
                <Start>
                    <RadzenCheckBox @bind-Value="@isEnabled" Name="isEnabled" />
                </Start>
                <ChildContent>
                    <RadzenLabel Text="Identity resource is enabled and will be available to clients" Component="isEnabled" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenFormField Text="Required" Variant="Variant.Outlined">
                <Start>
                    <RadzenCheckBox @bind-Value="@isRequired" Name="isRequired" />
                </Start>
                <ChildContent>
                    <RadzenLabel Text="Always include in tokens and consent when applicable" Component="isRequired" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenFormField Text="Show in Discovery" Variant="Variant.Outlined">
                <Start>
                    <RadzenCheckBox @bind-Value="@showInDiscoveryDocument" Name="showInDiscovery" />
                </Start>
                <ChildContent>
                    <RadzenLabel Text="List in the OpenID Connect discovery document" Component="showInDiscovery" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="3">
            <RadzenFormField Text="Emphasize" Variant="Variant.Outlined">
                <Start>
                    <RadzenCheckBox @bind-Value="@emphasize" Name="emphasize" />
                </Start>
                <ChildContent>
                    <RadzenLabel Text="Highlight this resource on the consent screen" Component="emphasize" />
                </ChildContent>
            </RadzenFormField>
        </RadzenColumn>
    </RadzenRow>

    <RadzenStack Gap="0.75rem">
        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">User Claims</RadzenText>
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenDropDown @bind-Value="@selectedClaimType" Data="@availableClaimTypes" 
                               Placeholder="@ClaimTypePlaceholder" 
                               Style="width: 400px;" AllowClear="true" AllowFiltering="true" 
                               FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                               Disabled="@isLoadingClaimTypes">
                    <Template Context="item">
                        <RadzenStack Gap="0.25rem">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenText Text="@($"{item.Type}")" Style="font-weight: 500; font-family: monospace;" />
                                @if (IsCustomClaimType(item))
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="Custom" />
                                }
                                else
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Standard" />
                                }
                            </RadzenStack>
                            <RadzenText Text="@item.DisplayName" TextStyle="TextStyle.Caption" class="rz-text-secondary-color" />
                        </RadzenStack>
                    </Template>
                    <ValueTemplate Context="item">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenText Text="@($"{item?.Type}")" Style="font-family: monospace;" />
                            @if (item != null && IsCustomClaimType(item))
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="Custom" Size="BadgeSize.ExtraSmall" />
                            }
                        </RadzenStack>
                    </ValueTemplate>
                </RadzenDropDown>
                <RadzenButton Text="Add Claim" Icon="add" ButtonStyle="ButtonStyle.Light" 
                            Click="@(async () => await AddSelectedClaim())" 
                            Disabled="@(isLoadingClaimTypes || selectedClaimType == null || userClaims.Contains(selectedClaimType?.Type ?? ""))" />
            </RadzenStack>
            
            @if (isLoadingClaimTypes)
            {
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                    <RadzenProgressBarCircular Value="100" ShowValue="false" Size="ProgressBarCircularSize.Small" />
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color">
                        Loading claim types from database...
                    </RadzenText>
                </RadzenStack>
            }
            else
            {
                <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color">
                    @if (selectedClaimType != null)
                    {
                        @selectedClaimType.Description
                    }
                    else
                    {
                        <text>Select a claim type to see its description. Showing @availableClaimTypes.Count available claim types.</text>
                    }
                </RadzenText>
            }

            <!-- Custom claim input for advanced users -->
            <RadzenStack Gap="0.5rem">
                <RadzenButton Text="@(showCustomClaimInput ? "Hide Custom Claim Type" : "Add Custom Claim Type")" 
                             Icon="@(showCustomClaimInput ? "expand_less" : "expand_more")" 
                             ButtonStyle="ButtonStyle.Light" 
                             Variant="Variant.Text" 
                             Click="@(async () => await ToggleCustomClaimInput())" 
                             Style="justify-content: flex-start; padding: 8px;" />
                
                @if (showCustomClaimInput)
                {
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" class="rz-mt-2" Style="padding-left: 24px;">
                        <RadzenIcon Icon="code" />
                        <RadzenTextBox @bind-Value="@customClaimType" Placeholder="Enter custom claim type" Style="width: 300px;" />
                        <RadzenButton Text="Add Custom" Icon="add" ButtonStyle="ButtonStyle.Light" 
                                    Click="@(async () => await AddCustomClaim())" 
                                    Disabled="@(string.IsNullOrWhiteSpace(customClaimType) || userClaims.Contains(customClaimType))" />
                    </RadzenStack>
                }
            </RadzenStack>

            @if (userClaims?.Any() == true)
            {
                <RadzenDataList Data="@userClaims" TItem="string" WrapItems="true">
                    <Template Context="claim">
                        <RadzenCard class="rz-p-2" Style="margin: 4px;">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText Text="@claim" Style="font-weight: 500; font-family: monospace;" />
                                    <RadzenText Text="@GetClaimDescription(claim)" TextStyle="TextStyle.Caption" 
                                               class="rz-text-secondary-color" />
                                </RadzenStack>
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" 
                                            Click="@(async () => await RemoveClaim(claim))" />
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="false">
                    <RadzenText>No claims added yet. Add claims that will be included in this identity resource.</RadzenText>
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenStack>

    <RadzenStack Gap="0.75rem">
        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Properties</RadzenText>
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenTextBox @bind-Value="@newPropertyKey" Placeholder="Property key" Style="width: 200px;" />
                <RadzenTextBox @bind-Value="@newPropertyValue" Placeholder="Property value" Style="width: 200px;" />
                <RadzenButton Text="Add Property" Icon="add" ButtonStyle="ButtonStyle.Light" 
                            Click="@(async () => await AddProperty())" 
                            Disabled="@(string.IsNullOrWhiteSpace(newPropertyKey) || string.IsNullOrWhiteSpace(newPropertyValue))" />
            </RadzenStack>

            @if (properties?.Any() == true)
            {
                <RadzenDataList Data="@properties" TItem="KeyValuePair<string, string>" WrapItems="true">
                    <Template Context="property">
                        <RadzenCard class="rz-p-2" Style="margin: 4px;">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenText Text="@($"{property.Key}: {property.Value}")" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" 
                                            Click="@(async () => await RemoveProperty(property.Key))" />
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="false">
                    <RadzenText>No properties added yet. Properties are optional metadata for this identity resource.</RadzenText>
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenStack>

    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mt-4">
        <RadzenButton Text="Update" Icon="save" ButtonStyle="ButtonStyle.Primary" 
                    Click="@(async () => await UpdateIdentityResource())" IsBusy="@isUpdating" />
        <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Secondary" 
                    Click="@(async () => await Cancel())" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public IdentityResourceDto IdentityResource { get; set; } = new();

    private UpdateIdentityResourceRequest request = new();
    private List<string> userClaims = new();
    private Dictionary<string, string> properties = new();
    private string newPropertyKey = string.Empty;
    private string newPropertyValue = string.Empty;
    private bool isUpdating = false;

    // Claim type selection
    private ClaimTypeInfo? selectedClaimType;
    private string customClaimType = string.Empty;
    private List<ClaimTypeInfo> availableClaimTypes = new();
    private bool isLoadingClaimTypes = true;
    private bool showCustomClaimInput = false;

    // Computed properties
    private string ClaimTypePlaceholder => isLoadingClaimTypes ? "Loading claim types..." : "Select a claim type...";

    // Individual properties for checkboxes
    private bool isEnabled;
    private bool isRequired;
    private bool showInDiscoveryDocument;
    private bool emphasize;

    protected override void OnInitialized()
    {
        request = new UpdateIdentityResourceRequest
        {
            DisplayName = IdentityResource.DisplayName,
            Description = IdentityResource.Description
        };

        // Convert IdentityResourceClaimDto list to string list for editing
        userClaims = IdentityResource.UserClaims?.Select(c => c.ClaimType).ToList() ?? new List<string>();
        properties = new Dictionary<string, string>(IdentityResource.Properties ?? new Dictionary<string, string>());

        isEnabled = IdentityResource.IsEnabled;
        isRequired = IdentityResource.IsRequired;
        showInDiscoveryDocument = IdentityResource.ShowInDiscoveryDocument;
        emphasize = IdentityResource.Emphasize;

        // Load available claim types from database
        _ = LoadClaimTypesAsync();
    }

    private async Task LoadClaimTypesAsync()
    {
        try
        {
            isLoadingClaimTypes = true;
            StateHasChanged();

            var claimTypes = await UsersApi.GetDistinctClaimTypesAsync();
            if (claimTypes != null)
            {
                availableClaimTypes = claimTypes;
            }
            else
            {
                // Fallback to standard claims if API call fails
                availableClaimTypes = CommonClaimTypes.StandardClaims.ToList();
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading claim types");
            // Fallback to standard claims if error occurs
            availableClaimTypes = CommonClaimTypes.StandardClaims.ToList();
        }
        finally
        {
            isLoadingClaimTypes = false;
            StateHasChanged();
        }
    }

    private async Task AddSelectedClaim()
    {
        if (selectedClaimType != null && userClaims != null && !userClaims.Contains(selectedClaimType.Type))
        {
            userClaims.Add(selectedClaimType.Type);
            selectedClaimType = null; // Clear selection
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task AddCustomClaim()
    {
        if (!string.IsNullOrWhiteSpace(customClaimType) && userClaims != null && !userClaims.Contains(customClaimType.Trim()))
        {
            userClaims.Add(customClaimType.Trim());
            customClaimType = string.Empty;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task RemoveClaim(string claim)
    {
        userClaims?.Remove(claim);
        StateHasChanged();
        await Task.CompletedTask;
    }

    private string GetClaimDescription(string claimType)
    {
        var claimInfo = availableClaimTypes.FirstOrDefault(c => c.Type == claimType);
        return claimInfo?.Description ?? "Custom claim type";
    }

    private bool IsCustomClaimType(ClaimTypeInfo claimType)
    {
        return !CommonClaimTypes.StandardClaims.Any(s => s.Type == claimType.Type);
    }

    private async Task AddProperty()
    {
        if (!string.IsNullOrWhiteSpace(newPropertyKey) && !string.IsNullOrWhiteSpace(newPropertyValue) 
            && properties != null && !properties.ContainsKey(newPropertyKey.Trim()))
        {
            properties[newPropertyKey.Trim()] = newPropertyValue.Trim();
            newPropertyKey = string.Empty;
            newPropertyValue = string.Empty;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task RemoveProperty(string key)
    {
        properties?.Remove(key);
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task UpdateIdentityResource()
    {
        try
        {
            // Validate required services
            if (IdentityResourcesApi == null)
            {
                Logger?.LogError("IdentityResourcesApi service is null");
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Service Error",
                    Detail = "Identity Resources API service is not available",
                    Duration = 5000
                });
                return;
            }

            if (request == null)
            {
                Logger?.LogError("Request object is null");
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Request data is not initialized",
                    Duration = 5000
                });
                return;
            }

            isUpdating = true;
            StateHasChanged();

            // Update the request with current values
            request.IsEnabled = isEnabled;
            request.IsRequired = isRequired;
            request.ShowInDiscoveryDocument = showInDiscoveryDocument;
            request.Emphasize = emphasize;
            request.UserClaims = userClaims;
            request.Properties = properties;

            var result = await IdentityResourcesApi.UpdateIdentityResourceAsync(IdentityResource.Id, request);
            if (result != null)
            {
                DialogService?.Close(true);
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Identity resource updated successfully",
                    Duration = 5000
                });
            }
            else
            {
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Failed to update identity resource - API returned null",
                    Duration = 5000
                });
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error updating identity resource");
            NotificationService?.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to update identity resource: {ex.Message}",
                Duration = 5000
            });
        }
        finally
        {
            isUpdating = false;
            StateHasChanged();
        }
    }

    private async Task Cancel()
    {
        DialogService?.Close(false);
        await Task.CompletedTask;
    }

    private async Task ToggleCustomClaimInput()
    {
        showCustomClaimInput = !showCustomClaimInput;
        StateHasChanged();
        await Task.CompletedTask;
    }
}