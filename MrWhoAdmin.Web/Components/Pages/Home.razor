@page "/"
@attribute [Authorize]
@rendermode InteractiveServer
@inherits AuthenticatedComponentBase
@inject NavigationManager Navigation
@inject IRealmsApiService RealmsApi
@inject IClientsApiService ClientsApi
@inject IUsersApiService UsersApi
@inject IRegistrationsApiService RegistrationsApi
@inject ISessionsApiService SessionsApi

<PageTitle>Dashboard - MrWho Administration</PageTitle>

@if (IsLoading)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;">
        <div class="text-center">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            <RadzenText class="rz-mt-2">Loading dashboard...</RadzenText>
        </div>
    </div>
}
else if (!IsAuthenticated)
{
    @RenderAuthenticationStatus()
}
else
{
    <RadzenText TextStyle="TextStyle.H2" class="rz-mb-4">
        <RadzenIcon Icon="dashboard" class="rz-me-2" />
        MrWho Administration Dashboard
    </RadzenText>

    @if (!string.IsNullOrEmpty(AuthErrorMessage))
    {
        <RadzenAlert AlertStyle="AlertStyle.Warning" class="rz-mb-4">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenText>@AuthErrorMessage</RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Text="Retry Login" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small" 
                                  Click="@(async () => await TriggerReauthenticationAsync())" />
                    <RadzenButton Text="Dismiss" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                                  Click="@(() => ClearAuthError())" />
                </RadzenStack>
            </RadzenStack>
        </RadzenAlert>
    }

    <RadzenRow Gap="2rem">
        <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
            <RadzenCard class="rz-text-align-center rz-p-4 kpi-card kpi-indigo" Style="min-height: 150px;">
                <RadzenIcon Icon="domain" Style="font-size: 3rem;" />
                <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">@totalRealms</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">Active Realms</RadzenText>
                <RadzenButton Click="@(() => Navigation.NavigateTo("/realms"))" 
                             ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                             Text="Manage" class="rz-mt-2" />
            </RadzenCard>
        </RadzenColumn>
        
        <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
            <RadzenCard class="rz-text-align-center rz-p-4 kpi-card kpi-greenblue" Style="min-height: 150px;">
                <RadzenIcon Icon="apps" Style="font-size: 3rem;" />
                <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">@totalClients</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">OIDC Clients</RadzenText>
                <RadzenButton Click="@(() => Navigation.NavigateTo("/clients"))" 
                             ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                             Text="Manage" class="rz-mt-2" />
            </RadzenCard>
        </RadzenColumn>
        
        <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
            <RadzenCard class="rz-text-align-center rz-p-4 kpi-card kpi-pink" Style="min-height: 150px;">
                <RadzenIcon Icon="people" Style="font-size: 3rem;" />
                <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">@totalUsers</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">Registered Users</RadzenText>
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.Center" class="rz-mt-2">
                    <RadzenButton Click="@(() => Navigation.NavigateTo("/users"))" 
                                 ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                                 Text="Manage" />
                    <RadzenButton Click="@(() => Navigation.NavigateTo("/users/registrations"))" 
                                 Icon="how_to_reg" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Small" 
                                 Text="Pending" />
                </RadzenStack>
                @if (pendingRegistrationsCount > 0)
                {
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-warning rz-mt-1">@pendingRegistrationsCount pending</RadzenText>
                }
            </RadzenCard>
        </RadzenColumn>
        
        <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
            <RadzenCard class="rz-text-align-center rz-p-4 kpi-card kpi-sunset" Style="min-height: 150px;">
                <RadzenIcon Icon="verified_user" Style="font-size: 3rem;" />
                <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">Online</RadzenText>
                <RadzenText TextStyle="TextStyle.Body2">System Status</RadzenText>
                <RadzenButton Click="@(() => Navigation.NavigateTo("/debug-api"))" 
                             ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                             Text="Debug API" class="rz-mt-2" />
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <!-- Quick Access Row -->
    <RadzenRow Gap="2rem" class="rz-mt-2">
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="how_to_reg" class="rz-color-primary" Style="font-size: 2rem;" />
                        <RadzenStack>
                            <RadzenText TextStyle="TextStyle.Subtitle1">Pending User Registrations</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@pendingRegistrationsCount pending</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                    <RadzenButton Text="Review" Icon="open_in_new" ButtonStyle="ButtonStyle.Primary" Size="ButtonSize.Small"
                                  Click="@(() => Navigation.NavigateTo("/users/registrations"))" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
        <RadzenColumn Size="12" SizeMD="6">
            <RadzenCard class="rz-p-4">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="people_outline" class="rz-color-success" Style="font-size: 2rem;" />
                        <RadzenStack>
                            <RadzenText TextStyle="TextStyle.Subtitle1">Active Sessions</RadzenText>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@activeSessionsCount active</RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                    <RadzenButton Text="View" Icon="visibility" ButtonStyle="ButtonStyle.Secondary" Size="ButtonSize.Small"
                                  Click="@(() => Navigation.NavigateTo("/monitoring/sessions"))" />
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>

    <RadzenRow Gap="2rem" class="rz-mt-4">
        <RadzenColumn Size="12" SizeMD="8">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">
                    <RadzenIcon Icon="timeline" class="rz-me-1" />
                    Recent Activity
                </RadzenText>
                
                @if (isLoadingActivity)
                {
                    <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                    <RadzenText class="rz-ml-2">Loading recent activity...</RadzenText>
                }
                else if (hasApiError)
                {
                    <RadzenAlert AlertStyle="AlertStyle.Warning">
                        <RadzenText>Unable to load recent activity. API connection may be unavailable.</RadzenText>
                        <RadzenButton Click="@(async () => await LoadDashboardData())" Text="Retry" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" class="rz-mt-2" />
                    </RadzenAlert>
                }
                else
                {
                    <RadzenDataList Data="@recentActivity" TItem="ActivityItem">
                        <Template>
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center" class="rz-py-2">
                                <RadzenIcon Icon="@context.Icon" Style="@($"color: {context.Color}")" />
                                <RadzenStack Gap="0.2rem">
                                    <RadzenText>@context.Description</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@context.Timestamp.ToString("MMM dd, yyyy HH:mm")</RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </Template>
                    </RadzenDataList>
                }
            </RadzenCard>
        </RadzenColumn>
        
        <RadzenColumn Size="12" SizeMD="4">
            <RadzenCard>
                <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">
                    <RadzenIcon Icon="info" class="rz-me-1" />
                    System Information
                </RadzenText>
                
                <RadzenStack Gap="1rem">
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>API Status:</RadzenText>
                        <RadzenBadge BadgeStyle="@(hasApiError ? BadgeStyle.Danger : BadgeStyle.Success)" 
                                    Text="@(hasApiError ? "Offline" : "Online")" />
                    </RadzenStack>
                    
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Version:</RadzenText>
                        <RadzenText>1.0.0</RadzenText>
                    </RadzenStack>
                    
                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Environment:</RadzenText>
                        <RadzenText>Development</RadzenText>
                    </RadzenStack>

                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                        <RadzenText>Auth Status:</RadzenText>
                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Authenticated" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenCard>
        </RadzenColumn>
    </RadzenRow>
}

@code {
    [Inject] 
    protected new ILogger<Home> Logger { get; set; } = default!;
    
    private int totalRealms = 0;
    private int totalClients = 0;
    private int totalUsers = 0;
    private int pendingRegistrationsCount = 0;
    private int activeSessionsCount = 0;
    private bool isLoadingActivity = true;
    private bool hasApiError = false;
    private List<ActivityItem> recentActivity = new();

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync(); // This calls CheckAuthenticationAsync()
        
        if (IsAuthenticated)
        {
            await OnAuthenticatedAsync();
        }
    }

    protected override async Task OnAuthenticatedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoadingActivity = true;
        hasApiError = false;
        StateHasChanged();
        
        try
        {
            Logger.LogInformation("Starting to load dashboard data");
            
            // Load dashboard statistics from APIs (parallel)
            var realmsTask = RealmsApi.GetRealmsAsync(page: 1, pageSize: 1);
            var clientsTask = ClientsApi.GetClientsAsync(page: 1, pageSize: 1);
            var usersTask = UsersApi.GetUsersAsync(page: 1, pageSize: 1);
            var pendingTask = RegistrationsApi.GetPendingAsync();
            var sessionsStatsTask = SessionsApi.GetSessionStatisticsAsync();

            await Task.WhenAll(realmsTask, clientsTask, usersTask, pendingTask, sessionsStatsTask);

            var realmsResult = await realmsTask;
            var clientsResult = await clientsTask;
            var usersResult = await usersTask;
            var pendingList = await pendingTask;
            var sessionsStats = await sessionsStatsTask;

            if (realmsResult != null)
                totalRealms = realmsResult.TotalCount;
            else
                hasApiError = true;

            if (clientsResult != null)
                totalClients = clientsResult.TotalCount;
            else
                hasApiError = true;

            if (usersResult != null)
                totalUsers = usersResult.TotalCount;
            else
                hasApiError = true;

            pendingRegistrationsCount = pendingList?.Count ?? 0;
            activeSessionsCount = sessionsStats?.TotalActiveSessions ?? 0;

            // Generate some mock recent activity for now
            recentActivity = new List<ActivityItem>
            {
                new() { Icon = "domain", Color = "var(--rz-primary)", Description = $"Loaded {totalRealms} realms from API", Timestamp = DateTime.Now.AddMinutes(-5) },
                new() { Icon = "apps", Color = "var(--rz-success)", Description = $"Found {totalClients} OIDC clients", Timestamp = DateTime.Now.AddMinutes(-10) },
                new() { Icon = "people", Color = "var(--rz-info)", Description = $"{totalUsers} users in system", Timestamp = DateTime.Now.AddMinutes(-15) },
                new() { Icon = "login", Color = "var(--rz-warning)", Description = "Admin user logged in", Timestamp = DateTime.Now.AddMinutes(-20) }
            };

            Logger.LogInformation("Dashboard loaded successfully - Realms: {Realms}, Clients: {Clients}, Users: {Users}, Pending: {Pending}, Sessions: {Sessions}, HasError: {HasError}", 
                totalRealms, totalClients, totalUsers, pendingRegistrationsCount, activeSessionsCount, hasApiError);
        }
        catch (HttpRequestException httpEx) when (httpEx.Message.Contains("Unauthorized") || httpEx.Message.Contains("401"))
        {
            Logger.LogWarning("Authentication required for dashboard data: {Message}", httpEx.Message);
            AuthErrorMessage = "Authentication expired. Please log in again.";
            hasApiError = true;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dashboard data");
            hasApiError = true;
            
            // Set fallback values
            totalRealms = 0;
            totalClients = 0;
            totalUsers = 0;
            pendingRegistrationsCount = 0;
            activeSessionsCount = 0;
            
            recentActivity = new List<ActivityItem>
            {
                new() { Icon = "error", Color = "var(--rz-danger)", Description = "Failed to load data from API", Timestamp = DateTime.Now }
            };
        }
        finally
        {
            isLoadingActivity = false;
            StateHasChanged();
        }
    }

    private class ActivityItem
    {
        public string Icon { get; set; } = "";
        public string Color { get; set; } = "";
        public string Description { get; set; } = "";
        public DateTime Timestamp { get; set; }
    }
}
