@page "/realms"
@attribute [Authorize]
@rendermode InteractiveServer
@inherits MrWhoAdmin.Web.Components.AuthenticatedComponentBase
@using MrWho.Shared.Models
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IRealmsApiService RealmsApi
@inject IJSRuntime JS

<PageTitle>Realms - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Text="Realms" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="domain" class="rz-me-1" />
        Realms Management
    </RadzenText>
</RadzenStack>

<RadzenCard class="rz-my-4">
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mb-4">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
            <RadzenTextBox @bind-Value="@searchTerm" Placeholder="Search realms..." Style="width: 300px;" />
            <RadzenButton Click="@LoadRealms" Icon="search" ButtonStyle="ButtonStyle.Secondary" />
        </RadzenStack>
        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
            <RadzenButton Click="@(async () => await OpenImportRealmDialog())" Icon="file_upload" ButtonStyle="ButtonStyle.Light" Text="Import" />
            <RadzenButton Click="@(() => Navigation.NavigateTo("/realms/add"))" Icon="add" ButtonStyle="ButtonStyle.Primary" Text="Add Realm" />
        </RadzenStack>
    </RadzenStack>

    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else if (realms.Any())
    {
        <RadzenDataGrid Data="@realms" TItem="RealmDto" AllowPaging="true" PageSize="10" AllowSorting="true">
            <Columns>
                <RadzenDataGridColumn TItem="RealmDto" Property="Name" Title="Name" />
                <RadzenDataGridColumn TItem="RealmDto" Property="DisplayName" Title="Display Name" />
                <RadzenDataGridColumn TItem="RealmDto" Property="IsEnabled" Title="Status" Width="120px">
                    <Template Context="realm">
                        <RadzenBadge BadgeStyle="@(realm.IsEnabled ? BadgeStyle.Success : BadgeStyle.Danger)" Text="@(realm.IsEnabled ? "Enabled" : "Disabled")" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RealmDto" Property="ClientCount" Title="Clients" Width="80px">
                    <Template Context="realm">
                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@realm.ClientCount.ToString()" />
                    </Template>
                </RadzenDataGridColumn>
                <RadzenDataGridColumn TItem="RealmDto" Title="Actions" Width="480px" Sortable="false">
                    <Template Context="realm">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Click="@(async () => await EditRealm(realm.Id))" Icon="edit" Size="ButtonSize.Medium" 
                                         ButtonStyle="ButtonStyle.Light" Text="Edit" />
                            <RadzenButton Click="@(async () => await ViewClients(realm.Id))" Icon="apps" Size="ButtonSize.Medium" 
                                         ButtonStyle="ButtonStyle.Info" Text="Clients" />
                            <RadzenButton Click="@(async () => await ToggleRealmStatus(realm))" Icon="@(realm.IsEnabled ? "toggle_on" : "toggle_off")" 
                                         Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Warning" Text="Toggle" />
                            <RadzenButton Click="@(async () => await ExportRealm(realm))" Icon="file_download" 
                                         Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Secondary" Text="Export" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Info">
            <RadzenText>No realms found. Click "Add Realm" to create your first realm.</RadzenText>
        </RadzenAlert>
    }
</RadzenCard>

@code {
    private List<RealmDto> realms = new();
    private bool isLoading = false;
    private string searchTerm = "";

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync(); // This calls CheckAuthenticationAsync()
        
        if (IsAuthenticated)
        {
            await OnAuthenticatedAsync();
        }
    }

    protected override async Task OnAuthenticatedAsync()
    {
        await LoadRealms();
    }

    private async Task LoadRealms()
    {
        isLoading = true;
        StateHasChanged();
        
        try
        {
            Logger.LogInformation("Loading realms with search term: '{SearchTerm}'", searchTerm);
            
            var result = await RealmsApi.GetRealmsAsync(page: 1, pageSize: 50, search: searchTerm);
            
            if (result != null)
            {
                realms = result.Items;
                Logger.LogInformation("Loaded {RealmCount} realms from API", realms.Count);
            }
            else
            {
                // Fallback to empty list if API call fails
                realms = new List<RealmDto>();
                NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Failed to load realms from API");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading realms from API");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load realms");
            realms = new List<RealmDto>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task EditRealm(string realmId)
    {
        Navigation.NavigateTo($"/realms/edit/{realmId}");
        await Task.CompletedTask;
    }

    private async Task ViewClients(string realmId)
    {
        Navigation.NavigateTo($"/clients?realmId={realmId}");
        await Task.CompletedTask;
    }

    private async Task ToggleRealmStatus(RealmDto realm)
    {
        try
        {
            var result = await RealmsApi.ToggleRealmAsync(realm.Id);
            if (result != null)
            {
                realm.IsEnabled = result.IsEnabled;
                realm.UpdatedAt = result.UpdatedAt;
                var msg = $"Realm '{realm.Name}' has been {(realm.IsEnabled ? "enabled" : "disabled")}";
                NotificationService.Notify(NotificationSeverity.Success, "Realm Updated", msg);
                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to toggle realm status");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling realm status for {Realm}", realm.Name);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to toggle realm status");
        }
    }

    private async Task ExportRealm(RealmDto realm)
    {
        try
        {
            var export = await RealmsApi.ExportRealmAsync(realm.Id);
            if (export == null)
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to export realm");
                return;
            }

            // Serialize and trigger download via JS interop
            var json = System.Text.Json.JsonSerializer.Serialize(export, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            var b64 = Convert.ToBase64String(System.Text.Encoding.UTF8.GetBytes(json));
            var fileName = $"realm-{realm.Name}.json";
            await JS.InvokeVoidAsync("mrwho.downloadFile", fileName, "application/json", b64);
            NotificationService.Notify(NotificationSeverity.Success, "Export", $"Exported {fileName}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting realm {Realm}", realm.Name);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to export realm");
        }
    }

    private async Task OpenImportRealmDialog()
    {
        var result = await DialogService.OpenAsync<ImportRealmDialog>("Import Realm", new Dictionary<string, object?>(), new DialogOptions { Width = "700px", Height = "450px" });
        if (result is bool ok && ok)
        {
            await LoadRealms();
        }
    }
}