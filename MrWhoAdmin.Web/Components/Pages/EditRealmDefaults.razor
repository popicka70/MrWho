@page "/realms/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared.Models
@using MrWho.Shared

<PageTitle>Realm Default Configuration - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/realms" Text="Realms" />
        <RadzenBreadCrumbItem Path="@($"/realms/edit/{Id}")" Text="Edit Realm" />
        <RadzenBreadCrumbItem Text="Default Configuration" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="settings" class="rz-me-1" />
        Realm Default Configuration @if(!string.IsNullOrWhiteSpace(realmDisplayName)){<text>- @realmDisplayName</text>}
    </RadzenText>
    
    <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.Body1">
            <strong>Default Configuration:</strong> These settings provide fallback values for clients in this realm. 
            Clients can override these defaults with their own specific configuration.
        </RadzenText>
    </RadzenAlert>
</RadzenStack>

<RadzenCard class="rz-my-4">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading realm default configuration...</RadzenText>
    }
    else
    {
        <RadzenTemplateForm Data="@model" TItem="UpdateRealmDefaultsRequest" Submit="@OnSave">
            <RadzenTabs @bind-SelectedIndex="selectedTabIndex" TabPosition="TabPosition.Left" RenderMode="TabRenderMode.Server" Style="width:100%; min-height:600px;">
                <Tabs>
                    <!-- Token Lifetimes -->
                    <RadzenTabsItem Text="Token Lifetimes" Icon="token">
                        <div style="padding:1rem; max-height:550px; overflow-y:auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Token Lifetimes</RadzenText>
                                <RadzenRow>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Access Token Lifetime (Minutes)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="accessTokenMinutes" Min="1" Max="1440" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Refresh Token Lifetime (Days)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="refreshTokenDays" Min="1" Max="365" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Authorization Code Lifetime (Minutes)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="authorizationCodeMinutes" Min="1" Max="60" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="ID Token Lifetime (Minutes)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="idTokenMinutes" Min="1" Max="1440" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Device Code Lifetime (Minutes)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="deviceCodeMinutes" Min="1" Max="60" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Session & Cookies -->
                    <RadzenTabsItem Text="Session & Cookies" Icon="schedule">
                        <div style="padding:1rem; max-height:550px; overflow-y:auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Session Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Default Session Timeout (Hours)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="model.DefaultSessionTimeoutHours" Min="1" Max="168" Style="width: 100%;" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default session duration for clients in this realm (1-168 hours)</RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Default Remember Me Duration (Days)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="model.DefaultRememberMeDurationDays" Min="1" Max="365" Style="width: 100%;" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default "Remember Me" duration (1-365 days)</RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                    <RadzenFormField Text="Default Session Behavior" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultUseSlidingSessionExpiration" Name="defaultUseSliding" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Use sliding expiration by default (extend session on user activity)" Component="defaultUseSliding" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">When enabled, session timeout resets on user activity for all clients</RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Cookie Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Default Cookie SameSite Policy" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenDropDown @bind-Value="model.DefaultCookieSameSitePolicy" Data="@(sameSitePolicies ?? new List<DropdownItem<string>>())" TextProperty="Text" ValueProperty="Value" Style="width: 100%;" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Default HTTPS Requirement" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultRequireHttpsForCookies" Name="defaultRequireHttpsCookies" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require HTTPS for cookies by default (secure flag)" Component="defaultRequireHttpsCookies" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- Security Defaults -->
                    <RadzenTabsItem Text="Security Defaults" Icon="security">
                        <div style="padding:1rem; max-height:550px; overflow-y:auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Consent Settings</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Default Consent Requirement" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultRequireConsent" Name="defaultRequireConsent" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require user consent by default" Component="defaultRequireConsent" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Remember Consent Option" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultAllowRememberConsent" Name="defaultAllowRememberConsent" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow remembering consent by default" Component="defaultAllowRememberConsent" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Token Security</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Max Refresh Tokens Per User" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="model.DefaultMaxRefreshTokensPerUser" Min="0" Max="100" Style="width: 100%;" Placeholder="Leave empty for unlimited" />
                                                </ChildContent>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Use One-Time Refresh Tokens" Variant="Variant.Outlined">
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="model.DefaultUseOneTimeRefreshTokens" Name="defaultUseOneTimeRefreshTokens" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Use one-time refresh tokens by default (rotation)" Component="defaultUseOneTimeRefreshTokens" />
                                                </ChildContent>
                                            </RadzenFormField>
                                            <RadzenFormField Text="Include JWT ID" Variant="Variant.Outlined">
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="model.DefaultIncludeJwtId" Name="defaultIncludeJwtId" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Include JWT ID (jti) in tokens by default" Component="defaultIncludeJwtId" />
                                                </ChildContent>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- MFA Defaults -->
                    <RadzenTabsItem Text="MFA Defaults" Icon="verified_user">
                        <div style="padding:1rem; max-height:550px; overflow-y:auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default MFA Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="MFA Enforcement Default" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultRequireMfa" Name="defaultRequireMfa" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require MFA by default for all clients" Component="defaultRequireMfa" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">When enabled, all clients in this realm will require MFA unless overridden</RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="MFA Grace Period (Minutes)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="model.DefaultMfaGracePeriodMinutes" Min="0" Max="1440" Style="width:100%;" Placeholder="Leave empty for no grace period" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Default time before requiring MFA again (0-1440 minutes)</RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Session MFA Memory" Variant="Variant.Outlined">
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="model.DefaultRememberMfaForSession" Name="defaultRememberMfaForSession" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Remember MFA for session by default" Component="defaultRememberMfaForSession" />
                                                </ChildContent>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-font-weight-600">Default Allowed MFA Methods</RadzenText>
                                    @foreach (var method in availableMfaMethods)
                                    {
                                        var name = $"mfa_default_{method.Value}";
                                        <RadzenFormField Variant="Variant.Outlined">
                                            <Start>
                                                <RadzenCheckBox Value="@IsMethodSelected(method.Value)" ValueChanged="@((bool selected) => ToggleMfaMethod(method.Value, selected))" Name="@name" />
                                            </Start>
                                            <ChildContent>
                                                <RadzenLabel Text="@method.Text" Component="@name" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    }
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <!-- JAR / JARM -->
                    <RadzenTabsItem Text="JAR / JARM" Icon="gpp_maybe">
                        <div style="padding:1rem; max-height:550px; overflow-y:auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Request Object (JAR) Defaults</RadzenText>
                                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true">
                                    <RadzenText TextStyle="TextStyle.Caption"><strong>Precedence:</strong> Client override &gt; Realm default &gt; System. HS256 &gt;=32B, HS384 &gt;=48B, HS512 &gt;=64B secrets recommended.</RadzenText>
                                </RadzenAlert>
                                <RadzenFormField Text="Default JAR Mode" Variant="Variant.Outlined">
                                    <ChildContent>
                                        <RadzenDropDown @bind-Value="model.DefaultJarMode" TValue="JarMode?" Data="jarModes" TextProperty="Text" ValueProperty="Value" Style="width:100%;" />
                                    </ChildContent>
                                </RadzenFormField>
                                <RadzenFormField Text="Require Signed Request Objects (Default)" Variant="Variant.Outlined">
                                    <Start>
                                        <RadzenCheckBox @bind-Value="model.DefaultRequireSignedRequestObject" TriState="true" Name="defReqSignedJar" />
                                    </Start>
                                    <ChildContent>
                                        <RadzenLabel Text="Disallow unsigned (alg=none) request objects by default" Component="defReqSignedJar" />
                                    </ChildContent>
                                </RadzenFormField>
                                <RadzenFormField Text="Allowed Request Object Algs (Default)" Variant="Variant.Outlined">
                                    <ChildContent>
                                        <RadzenDropDown Multiple="true" AllowClear="true" @bind-Value="defaultSelectedJarAlgs" Data="defaultAllowedJarAlgs" TextProperty="Value" ValueProperty="Value" Style="width:100%;" Change="@(args => OnDefaultJarAlgsChanged())" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Leave empty for system defaults (RS256, HS256). Only add HS384/512 if secrets meet length guidance.</RadzenText>
                                    </Helper>
                                </RadzenFormField>
                            </RadzenStack>
                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Authorization Response (JARM) Defaults</RadzenText>
                                <RadzenFormField Text="Default JARM Mode" Variant="Variant.Outlined">
                                    <ChildContent>
                                        <RadzenDropDown @bind-Value="model.DefaultJarmMode" TValue="JarmMode?" Data="jarmModes" TextProperty="Text" ValueProperty="Value" Style="width:100%;" />
                                    </ChildContent>
                                    <Helper>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Optional = response_mode=jwt allowed; Required = always JWT; Disabled = no JWT packaging.</RadzenText>
                                    </Helper>
                                </RadzenFormField>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mt-4" JustifyContent="JustifyContent.SpaceBetween">
                <RadzenButton Text="Back to Realms" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Click="@BackToRealm" />
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Text="Reset to System Defaults" Icon="restore" ButtonStyle="ButtonStyle.Warning" Click="@(async () => await ResetToSystemDefaults())" />
                    <RadzenButton Text="Save Default Configuration" Icon="save" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    }
</RadzenCard>

@code {
    private IEnumerable<object> jarModes => new[]
    {
        new { Text = "Use system default", Value = (JarMode?)null },
        new { Text = "Disabled", Value = (JarMode?)JarMode.Disabled },
        new { Text = "Optional", Value = (JarMode?)JarMode.Optional },
        new { Text = "Required", Value = (JarMode?)JarMode.Required }
    };
    private IEnumerable<object> jarmModes => new[]
    {
        new { Text = "Use system default", Value = (JarmMode?)null },
        new { Text = "Disabled", Value = (JarmMode?)JarmMode.Disabled },
        new { Text = "Optional", Value = (JarmMode?)JarmMode.Optional },
        new { Text = "Required", Value = (JarmMode?)JarmMode.Required }
    };

    private class AlgItem { public string Value { get; set; } = string.Empty; }
    private List<AlgItem> defaultAllowedJarAlgs = new() { new() { Value = "RS256" }, new() { Value = "HS256" }, new() { Value = "HS384" }, new() { Value = "HS512" } };
    private IList<string> defaultSelectedJarAlgs = new List<string>();

    protected override void OnParametersSet()
    {
        defaultSelectedJarAlgs = string.IsNullOrWhiteSpace(model.DefaultAllowedRequestObjectAlgs)
            ? new List<string>()
            : model.DefaultAllowedRequestObjectAlgs.Split(',', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
                .Distinct(StringComparer.OrdinalIgnoreCase)
                .ToList();
    }

    private void OnDefaultJarAlgsChanged()
    {
        model.DefaultAllowedRequestObjectAlgs = defaultSelectedJarAlgs.Any() ? string.Join(',', defaultSelectedJarAlgs) : null;
    }
}