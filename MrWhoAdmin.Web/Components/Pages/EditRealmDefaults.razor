@page "/realms/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared.Models

<PageTitle>Realm Default Configuration - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/realms" Text="Realms" />
        <RadzenBreadCrumbItem Path="@($"/realms/edit/{Id}")" Text="Edit Realm" />
        <RadzenBreadCrumbItem Text="Default Configuration" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="settings" class="rz-me-1" />
        Realm Default Configuration @if(!string.IsNullOrWhiteSpace(realmDisplayName)){<text>- @realmDisplayName</text>}
    </RadzenText>
    
    <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.Body1">
            <strong>Default Configuration:</strong> These settings provide fallback values for clients in this realm. 
            Clients can override these defaults with their own specific configuration.
        </RadzenText>
    </RadzenAlert>
</RadzenStack>

<RadzenCard class="rz-my-4">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading realm default configuration...</RadzenText>
    }
    else
    {
        <RadzenTemplateForm Data="@model" TItem="UpdateRealmDefaultsRequest" Submit="@OnSave">
            <RadzenTabs @bind-SelectedIndex="selectedTabIndex" TabPosition="TabPosition.Left" RenderMode="TabRenderMode.Client" 
                        Style="width: 100%; min-height: 600px;">
                <Tabs>
                    <RadzenTabsItem Text="Token Lifetimes" Icon="token">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Token Lifetimes</RadzenText>
                                <RadzenRow>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Access Token Lifetime (Minutes)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="accessTokenMinutes" Min="1" Max="1440" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Refresh Token Lifetime (Days)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="refreshTokenDays" Min="1" Max="365" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Authorization Code Lifetime (Minutes)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="authorizationCodeMinutes" Min="1" Max="60" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="ID Token Lifetime (Minutes)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="idTokenMinutes" Min="1" Max="1440" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                                <RadzenRow>
                                    <RadzenColumn Size="12" SizeMD="6">
                                        <RadzenFormField Text="Device Code Lifetime (Minutes)" Variant="Variant.Outlined">
                                            <ChildContent>
                                                <RadzenNumeric @bind-Value="deviceCodeMinutes" Min="1" Max="60" Style="width: 100%;" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    </RadzenColumn>
                                </RadzenRow>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <RadzenTabsItem Text="Session & Cookies" Icon="schedule">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Session Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Default Session Timeout (Hours)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="model.DefaultSessionTimeoutHours" Min="1" Max="168" Style="width: 100%;" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Default session duration for clients in this realm (1-168 hours)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Default Remember Me Duration (Days)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="model.DefaultRememberMeDurationDays" Min="1" Max="365" Style="width: 100%;" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Default "Remember Me" duration (1-365 days)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenFormField Text="Default Session Behavior" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultUseSlidingSessionExpiration" Name="defaultUseSliding" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Use sliding expiration by default (extend session on user activity)" Component="defaultUseSliding" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                When enabled, session timeout resets on user activity for all clients
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Cookie Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Default Cookie SameSite Policy" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenDropDown @bind-Value="model.DefaultCookieSameSitePolicy" Data="@sameSitePolicies" TextProperty="Text" ValueProperty="Value" Style="width: 100%;" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Default SameSite policy for client cookies
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Default HTTPS Requirement" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultRequireHttpsForCookies" Name="defaultRequireHttpsCookies" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require HTTPS for cookies by default (secure flag)" Component="defaultRequireHttpsCookies" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Default HTTPS requirement for client cookies
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <RadzenTabsItem Text="Security Defaults" Icon="security">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Consent Settings</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Default Consent Requirement" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultRequireConsent" Name="defaultRequireConsent" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require user consent by default" Component="defaultRequireConsent" />
                                        </ChildContent>
                                    </RadzenFormField>
                                    <RadzenFormField Text="Remember Consent Option" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultAllowRememberConsent" Name="defaultAllowRememberConsent" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Allow remembering consent by default" Component="defaultAllowRememberConsent" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenStack>

                            <RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default Token Security</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Max Refresh Tokens Per User" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="model.DefaultMaxRefreshTokensPerUser" Min="0" Max="100" Style="width: 100%;" Placeholder="Leave empty for unlimited" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Default limit for concurrent refresh tokens per user
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Token Behavior Defaults" Variant="Variant.Outlined">
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="model.DefaultUseOneTimeRefreshTokens" Name="defaultUseOneTimeRefreshTokens" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Use one-time refresh tokens by default (rotation)" Component="defaultUseOneTimeRefreshTokens" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Enforce refresh token rotation to improve security
                                                    </RadzenText>
                                                </Helper>
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="model.DefaultIncludeJwtId" Name="defaultIncludeJwtId" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Include JWT ID (jti) in tokens by default" Component="defaultIncludeJwtId" />
                                                </ChildContent>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>

                    <RadzenTabsItem Text="MFA Defaults" Icon="verified_user">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenStack Gap="0.75rem" class="rz-mb-4">
                                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Default MFA Configuration</RadzenText>
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="MFA Enforcement Default" Variant="Variant.Outlined">
                                        <Start>
                                            <RadzenCheckBox @bind-Value="model.DefaultRequireMfa" Name="defaultRequireMfa" />
                                        </Start>
                                        <ChildContent>
                                            <RadzenLabel Text="Require MFA by default for all clients" Component="defaultRequireMfa" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                When enabled, all clients in this realm will require MFA unless overridden
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="MFA Grace Period (Minutes)" Variant="Variant.Outlined">
                                                <ChildContent>
                                                    <RadzenNumeric @bind-Value="model.DefaultMfaGracePeriodMinutes" Min="0" Max="1440" Style="width: 100%;" Placeholder="Leave empty for no grace period" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Default time before requiring MFA again (0-1440 minutes)
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Session MFA Memory" Variant="Variant.Outlined">
                                                <Start>
                                                    <RadzenCheckBox @bind-Value="model.DefaultRememberMfaForSession" Name="defaultRememberMfaForSession" />
                                                </Start>
                                                <ChildContent>
                                                    <RadzenLabel Text="Remember MFA for session by default" Component="defaultRememberMfaForSession" />
                                                </ChildContent>
                                                <Helper>
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        Skip MFA if already completed this session
                                                    </RadzenText>
                                                </Helper>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenText TextStyle="TextStyle.Subtitle2" class="rz-font-weight-600">Default Allowed MFA Methods</RadzenText>
                                    @foreach (var method in availableMfaMethods)
                                    {
                                        var name = $"mfa_default_{method.Value}";
                                        <RadzenFormField Variant="Variant.Outlined">
                                            <Start>
                                                <RadzenCheckBox Value="@IsMethodSelected(method.Value)" 
                                                               ValueChanged="@((bool selected) => ToggleMfaMethod(method.Value, selected))"
                                                               Name="@name" />
                                            </Start>
                                            <ChildContent>
                                                <RadzenLabel Text="@method.Text" Component="@name" />
                                            </ChildContent>
                                        </RadzenFormField>
                                    }
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Select default MFA methods available to clients in this realm
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenStack>
                        </div>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mt-4" JustifyContent="JustifyContent.SpaceBetween">
                <RadzenButton Text="Back to Realms" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" Click="@BackToRealm" />
                
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Text="Reset to System Defaults" Icon="restore" ButtonStyle="ButtonStyle.Warning" Click="@(async () => await ResetToSystemDefaults())" />
                    <RadzenButton Text="Save Default Configuration" Icon="save" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    }
</RadzenCard>