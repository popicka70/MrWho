@page "/realms/edit/{Id}/defaults"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared.Models
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IRealmsApiService RealmsApiService
@inject ILogger<EditRealmDefaults> Logger

<PageTitle>Realm Default Configuration - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/realms" Text="Realms" />
        <RadzenBreadCrumbItem Path="@($"/realms/edit/{Id}")" Text="Edit Realm" />
        <RadzenBreadCrumbItem Text="Default Configuration" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="settings" class="rz-me-1" />
        Realm Default Configuration
    </RadzenText>
    
    <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-4">
        <RadzenText TextStyle="TextStyle.Body1">
            <strong>Default Configuration:</strong> These settings provide fallback values for clients in this realm. 
            Clients can override these defaults with their own specific configuration.
        </RadzenText>
    </RadzenAlert>
</RadzenStack>

<RadzenCard class="rz-my-4">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading realm default configuration...</RadzenText>
    }
    else
    {
        <RadzenTemplateForm Data="@model" TItem="UpdateRealmDefaultsRequest" Submit="@OnSave">
            <RadzenTabs @bind-SelectedIndex="@selectedTabIndex" TabPosition="TabPosition.Top" RenderMode="TabRenderMode.Client" 
                       Style="width: 100%; min-height: 600px;">
                <Tabs>
                    <!-- Session & Cookie Defaults -->
                    <RadzenTabsItem Text="Session & Cookies" Icon="schedule">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenFieldset Text="Default Session Configuration">
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Default Session Timeout (Hours)" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.DefaultSessionTimeoutHours" 
                                                              Min="1" Max="168" 
                                                              Style="width: 100%;" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default session duration for clients in this realm (1-168 hours)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Default Remember Me Duration (Days)" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.DefaultRememberMeDurationDays" 
                                                              Min="1" Max="365" 
                                                              Style="width: 100%;" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default "Remember Me" duration (1-365 days)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenFormField Text="Default Session Behavior" Variant="Variant.Outlined">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                            <RadzenCheckBox @bind-Value="@model.DefaultUseSlidingSessionExpiration" />
                                            <RadzenLabel Text="Use sliding expiration by default" />
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            When enabled, session timeout resets on user activity for all clients
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenFieldset>

                            <RadzenFieldset Text="Default Cookie Configuration" class="rz-mt-4">
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Default Cookie SameSite Policy" Variant="Variant.Outlined">
                                        <RadzenDropDown @bind-Value="@model.DefaultCookieSameSitePolicy" 
                                                       Data="@sameSitePolicies" 
                                                       TextProperty="Text" 
                                                       ValueProperty="Value" 
                                                       Style="width: 100%;" />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Default SameSite policy for client cookies
                                        </RadzenText>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Default HTTPS Requirement" Variant="Variant.Outlined">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                            <RadzenCheckBox @bind-Value="@model.DefaultRequireHttpsForCookies" />
                                            <RadzenLabel Text="Require HTTPS for cookies by default" />
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Default HTTPS requirement for client cookies
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenFieldset>
                        </div>
                    </RadzenTabsItem>

                    <!-- Security & Compliance Defaults -->
                    <RadzenTabsItem Text="Security Defaults" Icon="security">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenFieldset Text="Default Consent Settings">
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Default Consent Requirements" Variant="Variant.Outlined">
                                        <RadzenStack Gap="0.5rem">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.DefaultRequireConsent" />
                                                <RadzenLabel Text="Require user consent by default" />
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.DefaultAllowRememberConsent" />
                                                <RadzenLabel Text="Allow remembering consent by default" />
                                            </RadzenStack>
                                        </RadzenStack>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenFieldset>

                            <RadzenFieldset Text="Default Token Security" class="rz-mt-4">
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Max Refresh Tokens Per User" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.DefaultMaxRefreshTokensPerUser" 
                                                              Min="0" Max="100" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Leave empty for unlimited" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default limit for concurrent refresh tokens per user
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Default Token Behavior" Variant="Variant.Outlined">
                                                <RadzenStack Gap="0.5rem">
                                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                        <RadzenCheckBox @bind-Value="@model.DefaultUseOneTimeRefreshTokens" />
                                                        <RadzenLabel Text="One-time refresh tokens" />
                                                    </RadzenStack>
                                                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                        <RadzenCheckBox @bind-Value="@model.DefaultIncludeJwtId" />
                                                        <RadzenLabel Text="Include JWT ID in tokens" />
                                                    </RadzenStack>
                                                </RadzenStack>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenFieldset>
                        </div>
                    </RadzenTabsItem>

                    <!-- MFA Defaults -->
                    <RadzenTabsItem Text="MFA Defaults" Icon="verified_user">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenFieldset Text="Default MFA Configuration">
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Default MFA Enforcement" Variant="Variant.Outlined">
                                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                            <RadzenCheckBox @bind-Value="@model.DefaultRequireMfa" />
                                            <RadzenLabel Text="Require MFA by default for all clients" />
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            When enabled, all clients in this realm will require MFA unless overridden
                                        </RadzenText>
                                    </RadzenFormField>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Default MFA Grace Period (Minutes)" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.DefaultMfaGracePeriodMinutes" 
                                                              Min="0" Max="1440" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Leave empty for no grace period" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default time before requiring MFA again (0-1440 minutes)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Default MFA Session Memory" Variant="Variant.Outlined">
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="1rem">
                                                    <RadzenCheckBox @bind-Value="@model.DefaultRememberMfaForSession" />
                                                    <RadzenLabel Text="Remember MFA for session by default" />
                                                </RadzenStack>
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Skip MFA if already completed this session
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenFormField Text="Default Allowed MFA Methods" Variant="Variant.Outlined">
                                        <RadzenStack Gap="0.5rem">
                                            @foreach (var method in availableMfaMethods)
                                            {
                                                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                    <RadzenCheckBox Value="@IsMethodSelected(method.Value)" 
                                                                   ValueChanged="@((bool selected) => ToggleMfaMethod(method.Value, selected))" />
                                                    <RadzenLabel Text="@method.Text" />
                                                </RadzenStack>
                                            }
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Select default MFA methods available to clients in this realm
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenFieldset>
                        </div>
                    </RadzenTabsItem>

                    <!-- Rate Limiting Defaults -->
                    <RadzenTabsItem Text="Rate Limiting" Icon="speed">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenFieldset Text="Default Rate Limits">
                                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="true" class="rz-mb-4">
                                    <RadzenText>Configure default rate limits for all clients in this realm. Clients can override these settings.</RadzenText>
                                </RadzenAlert>

                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="4">
                                            <RadzenFormField Text="Default Per Minute Limit" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.DefaultRateLimitRequestsPerMinute" 
                                                              Min="0" Max="10000" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Requests per minute" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default requests per minute (0 = unlimited)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="4">
                                            <RadzenFormField Text="Default Per Hour Limit" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.DefaultRateLimitRequestsPerHour" 
                                                              Min="0" Max="1000000" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Requests per hour" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default requests per hour (0 = unlimited)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="4">
                                            <RadzenFormField Text="Default Per Day Limit" Variant="Variant.Outlined">
                                                <RadzenNumeric @bind-Value="@model.DefaultRateLimitRequestsPerDay" 
                                                              Min="0" Max="10000000" 
                                                              Style="width: 100%;" 
                                                              Placeholder="Requests per day" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default requests per day (0 = unlimited)
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenFieldset>
                        </div>
                    </RadzenTabsItem>

                    <!-- Error Handling & Logging Defaults -->
                    <RadzenTabsItem Text="Logging & Errors" Icon="bug_report">
                        <div style="padding: 1rem; max-height: 550px; overflow-y: auto;">
                            <RadzenFieldset Text="Default Error Handling">
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Default Error Response Settings" Variant="Variant.Outlined">
                                        <RadzenStack Gap="0.5rem">
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.DefaultEnableDetailedErrors" />
                                                <RadzenLabel Text="Enable detailed error responses by default" />
                                            </RadzenStack>
                                            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                                                <RadzenCheckBox @bind-Value="@model.DefaultLogSensitiveData" />
                                                <RadzenLabel Text="Log sensitive data by default (development only)" />
                                            </RadzenStack>
                                        </RadzenStack>
                                        <RadzenAlert AlertStyle="AlertStyle.Warning" ShowIcon="true" class="rz-mt-2">
                                            <RadzenText TextStyle="TextStyle.Caption">
                                                Warning: Detailed errors and sensitive data logging should not be enabled in production environments.
                                            </RadzenText>
                                        </RadzenAlert>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenFieldset>

                            <RadzenFieldset Text="Default Branding Configuration" class="rz-mt-4">
                                <RadzenStack Gap="1rem">
                                    <RadzenFormField Text="Default Theme" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@model.DefaultThemeName" 
                                                      Style="width: 100%;" 
                                                      Placeholder="e.g., dark, light, corporate" />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Default UI theme for clients in this realm
                                        </RadzenText>
                                    </RadzenFormField>

                                    <RadzenFormField Text="Realm Custom CSS URL" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@model.RealmCustomCssUrl" 
                                                      Style="width: 100%;" 
                                                      Placeholder="https://cdn.example.com/realm-theme.css" />
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Realm-wide custom CSS that applies to all clients unless overridden
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenStack>
                            </RadzenFieldset>

                            <RadzenFieldset Text="Realm Information URLs" class="rz-mt-4">
                                <RadzenStack Gap="1rem">
                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Realm Logo URI" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.RealmLogoUri" 
                                                              Style="width: 100%;" 
                                                              Placeholder="https://example.com/realm-logo.png" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default logo for the realm
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Realm Homepage URI" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.RealmUri" 
                                                              Style="width: 100%;" 
                                                              Placeholder="https://example.com" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default homepage for the realm
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>

                                    <RadzenRow>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Realm Privacy Policy URI" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.RealmPolicyUri" 
                                                              Style="width: 100%;" 
                                                              Placeholder="https://example.com/privacy" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default privacy policy URL
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                        <RadzenColumn Size="12" SizeMD="6">
                                            <RadzenFormField Text="Realm Terms of Service URI" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@model.RealmTosUri" 
                                                              Style="width: 100%;" 
                                                              Placeholder="https://example.com/terms" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                    Default terms of service URL
                                                </RadzenText>
                                            </RadzenFormField>
                                        </RadzenColumn>
                                    </RadzenRow>
                                </RadzenStack>
                            </RadzenFieldset>
                        </div>
                    </RadzenTabsItem>
                </Tabs>
            </RadzenTabs>

            <!-- Action Buttons -->
            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mt-4" JustifyContent="JustifyContent.SpaceBetween">
                <RadzenButton Text="Back to Realm" Icon="arrow_back" ButtonStyle="ButtonStyle.Light" 
                            Click="@BackToRealm" />
                
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                    <RadzenButton Text="Reset to System Defaults" Icon="restore" ButtonStyle="ButtonStyle.Warning" 
                                Click="@(async () => await ResetToSystemDefaults())" />
                    <RadzenButton Text="Save Default Configuration" 
                                Icon="save" 
                                ButtonStyle="ButtonStyle.Primary" 
                                ButtonType="ButtonType.Submit" />
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    }
</RadzenCard>

@code {
    [Parameter] public string? Id { get; set; }

    private UpdateRealmDefaultsRequest model = new();
    private bool isLoading = false;
    private int selectedTabIndex = 0;
    
    // Dropdown data
    private List<DropdownItem<string>> sameSitePolicies = new();
    private List<DropdownItem<string>> availableMfaMethods = new();

    protected override async Task OnInitializedAsync()
    {
        InitializeDropdownData();
        await LoadRealmDefaults();
    }

    private void InitializeDropdownData()
    {
        sameSitePolicies = new()
        {
            new("None (Cross-site requests allowed)", "None"),
            new("Lax (Some cross-site requests)", "Lax"),
            new("Strict (No cross-site requests)", "Strict")
        };

        availableMfaMethods = new()
        {
            new("Time-based OTP (TOTP)", "totp"),
            new("SMS Verification", "sms"),
            new("Email Verification", "email"),
            new("Push Notifications", "push"),
            new("Hardware Token", "hardware"),
            new("Biometric", "biometric")
        };
    }

    private async Task LoadRealmDefaults()
    {
        isLoading = true;
        try
        {
            var realm = await RealmsApiService.GetRealmAsync(Id!);
            if (realm != null)
            {
                model = MapRealmToDefaultsRequest(realm);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading realm defaults {RealmId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load realm defaults");
        }
        finally
        {
            isLoading = false;
        }
    }

    private UpdateRealmDefaultsRequest MapRealmToDefaultsRequest(RealmDto realm)
    {
        return new UpdateRealmDefaultsRequest
        {
            // Map all realm default properties from the realm DTO
            DefaultSessionTimeoutHours = realm.DefaultSessionTimeoutHours,
            DefaultRememberMeDurationDays = realm.DefaultRememberMeDurationDays,
            DefaultUseSlidingSessionExpiration = realm.DefaultUseSlidingSessionExpiration,
            DefaultCookieSameSitePolicy = realm.DefaultCookieSameSitePolicy,
            DefaultRequireHttpsForCookies = realm.DefaultRequireHttpsForCookies,
            
            DefaultRequireConsent = realm.DefaultRequireConsent,
            DefaultAllowRememberConsent = realm.DefaultAllowRememberConsent,
            DefaultMaxRefreshTokensPerUser = realm.DefaultMaxRefreshTokensPerUser,
            DefaultUseOneTimeRefreshTokens = realm.DefaultUseOneTimeRefreshTokens,
            DefaultIncludeJwtId = realm.DefaultIncludeJwtId,
            
            DefaultRequireMfa = realm.DefaultRequireMfa,
            DefaultMfaGracePeriodMinutes = realm.DefaultMfaGracePeriodMinutes,
            DefaultAllowedMfaMethods = realm.DefaultAllowedMfaMethods,
            DefaultRememberMfaForSession = realm.DefaultRememberMfaForSession,
            
            DefaultRateLimitRequestsPerMinute = realm.DefaultRateLimitRequestsPerMinute,
            DefaultRateLimitRequestsPerHour = realm.DefaultRateLimitRequestsPerHour,
            DefaultRateLimitRequestsPerDay = realm.DefaultRateLimitRequestsPerDay,
            
            DefaultEnableDetailedErrors = realm.DefaultEnableDetailedErrors,
            DefaultLogSensitiveData = realm.DefaultLogSensitiveData,
            DefaultThemeName = realm.DefaultThemeName,
            RealmCustomCssUrl = realm.RealmCustomCssUrl,
            RealmLogoUri = realm.RealmLogoUri,
            RealmUri = realm.RealmUri,
            RealmPolicyUri = realm.RealmPolicyUri,
            RealmTosUri = realm.RealmTosUri
        };
    }

    private bool IsMethodSelected(string method)
    {
        if (string.IsNullOrEmpty(model.DefaultAllowedMfaMethods))
            return false;
            
        try
        {
            var methods = System.Text.Json.JsonSerializer.Deserialize<string[]>(model.DefaultAllowedMfaMethods);
            return methods?.Contains(method) == true;
        }
        catch
        {
            return false;
        }
    }

    private void ToggleMfaMethod(string method, bool selected)
    {
        var methods = new List<string>();
        
        if (!string.IsNullOrEmpty(model.DefaultAllowedMfaMethods))
        {
            try
            {
                var existing = System.Text.Json.JsonSerializer.Deserialize<string[]>(model.DefaultAllowedMfaMethods);
                if (existing != null)
                    methods.AddRange(existing);
            }
            catch { }
        }

        if (selected)
        {
            if (!methods.Contains(method))
                methods.Add(method);
        }
        else
        {
            methods.Remove(method);
        }

        model.DefaultAllowedMfaMethods = methods.Any() ? 
            System.Text.Json.JsonSerializer.Serialize(methods.ToArray()) : 
            null;
    }

    private async Task OnSave(UpdateRealmDefaultsRequest formModel)
    {
        await Task.Delay(1); // Satisfy async requirement
        
        try
        {
            // For now, we'll show a success message but note this functionality needs API implementation
            NotificationService.Notify(NotificationSeverity.Info, "Feature Coming Soon", 
                "Realm default configuration will be implemented in a future update");
            Navigation.NavigateTo($"/realms/edit/{Id}");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving realm defaults");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save realm default configuration");
        }
    }

    private async Task ResetToSystemDefaults()
    {
        var result = await DialogService.Confirm("Reset all realm defaults to system-wide defaults?", 
            "Reset to System Defaults", 
            new ConfirmOptions() { OkButtonText = "Reset", CancelButtonText = "Cancel" });
        
        if (result == true)
        {
            // Reset to system defaults
            model.DefaultSessionTimeoutHours = 8;
            model.DefaultRememberMeDurationDays = 30;
            model.DefaultUseSlidingSessionExpiration = true;
            model.DefaultCookieSameSitePolicy = "Lax";
            model.DefaultRequireHttpsForCookies = false;
            
            model.DefaultRequireConsent = false;
            model.DefaultAllowRememberConsent = true;
            model.DefaultMaxRefreshTokensPerUser = null;
            model.DefaultUseOneTimeRefreshTokens = false;
            model.DefaultIncludeJwtId = true;
            
            model.DefaultRequireMfa = false;
            model.DefaultMfaGracePeriodMinutes = null;
            model.DefaultAllowedMfaMethods = System.Text.Json.JsonSerializer.Serialize(new[] { "totp", "sms" });
            model.DefaultRememberMfaForSession = true;
            
            model.DefaultRateLimitRequestsPerMinute = null;
            model.DefaultRateLimitRequestsPerHour = null;
            model.DefaultRateLimitRequestsPerDay = null;
            
            model.DefaultEnableDetailedErrors = false;
            model.DefaultLogSensitiveData = false;
            model.DefaultThemeName = null;
            
            NotificationService.Notify(NotificationSeverity.Info, "Reset", "Configuration reset to system defaults");
            StateHasChanged();
        }
    }

    private void BackToRealm()
    {
        Navigation.NavigateTo($"/realms/edit/{Id}");
    }

    // Helper class for dropdown items
    private record DropdownItem<T>(string Text, T Value);

    // Model for realm defaults update
    public class UpdateRealmDefaultsRequest
    {
        public int DefaultSessionTimeoutHours { get; set; }
        public int DefaultRememberMeDurationDays { get; set; }
        public bool DefaultUseSlidingSessionExpiration { get; set; }
        public string DefaultCookieSameSitePolicy { get; set; } = string.Empty;
        public bool DefaultRequireHttpsForCookies { get; set; }
        
        public bool DefaultRequireConsent { get; set; }
        public bool DefaultAllowRememberConsent { get; set; }
        public int? DefaultMaxRefreshTokensPerUser { get; set; }
        public bool DefaultUseOneTimeRefreshTokens { get; set; }
        public bool DefaultIncludeJwtId { get; set; }
        
        public bool DefaultRequireMfa { get; set; }
        public int? DefaultMfaGracePeriodMinutes { get; set; }
        public string? DefaultAllowedMfaMethods { get; set; }
        public bool DefaultRememberMfaForSession { get; set; }
        
        public int? DefaultRateLimitRequestsPerMinute { get; set; }
        public int? DefaultRateLimitRequestsPerHour { get; set; }
        public int? DefaultRateLimitRequestsPerDay { get; set; }
        
        public bool DefaultEnableDetailedErrors { get; set; }
        public bool DefaultLogSensitiveData { get; set; }
        public string? DefaultThemeName { get; set; }
        public string? RealmCustomCssUrl { get; set; }
        public string? RealmLogoUri { get; set; }
        public string? RealmUri { get; set; }
        public string? RealmPolicyUri { get; set; }
        public string? RealmTosUri { get; set; }
    }
}