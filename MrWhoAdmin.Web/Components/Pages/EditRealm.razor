@page "/realms/add"
@page "/realms/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@inherits AuthenticatedComponentBase
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ILogger<EditRealm> PageLogger
@inject IRealmsApiService RealmsApi

<PageTitle>@(IsEdit ? "Edit Realm" : "Add Realm") - MrWho Admin</PageTitle>

@if (IsLoading)
{
    <div class="d-flex justify-content-center align-items-center" style="min-height: 50vh;">
        <div class="text-center">
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            <RadzenText class="rz-mt-2">Loading...</RadzenText>
        </div>
    </div>
}
else if (!IsAuthenticated)
{
    @RenderAuthenticationStatus()
}
else
{
    <RadzenStack>
        <RadzenBreadCrumb>
            <RadzenBreadCrumbItem Path="/realms" Text="Realms" />
            <RadzenBreadCrumbItem Text="@(IsEdit ? "Edit" : "Add")" />
        </RadzenBreadCrumb>

        <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
            <RadzenIcon Icon="@(IsEdit ? "edit" : "add_circle")" class="rz-me-1" />
            @(IsEdit ? "Edit Realm" : "Add New Realm")
        </RadzenText>
    </RadzenStack>

    <RadzenCard class="rz-my-4">
        @if (isLoading)
        {
            <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
            <RadzenText class="rz-mt-3">Loading realm data...</RadzenText>
        }
        else
        {
            <RadzenTemplateForm Data="@model" TItem="CreateRealmRequest" Submit="@OnSave">
                <RadzenStack Gap="2rem">
                    <!-- Basic Information -->
                    <RadzenStack Gap="0.75rem" class="rz-mb-2">
                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Basic Information</RadzenText>
                        <RadzenStack Gap="1rem">
                            <RadzenRow>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Realm Name" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.Name" 
                                                          Placeholder="Enter realm name (e.g., 'company-prod')" 
                                                          Style="width: 100%;" 
                                                          Disabled="@IsEdit" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                @(IsEdit ? "Realm name cannot be changed after creation" : "Use lowercase letters, numbers, and hyphens only")
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Display Name" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenTextBox @bind-Value="@model.DisplayName" 
                                                          Placeholder="Enter display name (e.g., 'Company Production')" 
                                                          Style="width: 100%;" />
                                        </ChildContent>
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                            
                            <RadzenFormField Text="Description" Variant="Variant.Outlined">
                                <ChildContent>
                                    <RadzenTextArea @bind-Value="@model.Description" 
                                                   Placeholder="Enter realm description..." 
                                                   Rows="3" Style="width: 100%;" />
                                </ChildContent>
                            </RadzenFormField>
                            
                            <RadzenFormField Text="Status" Variant="Variant.Outlined">
                                <Start>
                                    <RadzenCheckBox @bind-Value="@model.IsEnabled" Name="realmEnabled" />
                                </Start>
                                <ChildContent>
                                    <RadzenLabel Text="Realm is enabled" Component="realmEnabled" />
                                </ChildContent>
                                <Helper>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary rz-mt-1">
                                        Disabled realms cannot be used for authentication
                                    </RadzenText>
                                </Helper>
                            </RadzenFormField>
                        </RadzenStack>
                    </RadzenStack>

                    <!-- Token Lifetimes -->
                    <RadzenStack Gap="0.75rem" class="rz-mb-2">
                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Token Configuration</RadzenText>
                        <RadzenStack Gap="1rem">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-2">
                                Configure how long different types of tokens remain valid
                            </RadzenText>
                            
                            <RadzenRow>
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenFormField Text="Access Token Lifetime (minutes)" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenNumeric @bind-Value="@accessTokenMinutes" 
                                                          Min="1" Max="1440" 
                                                          Style="width: 100%;" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Recommended: 15-60 minutes
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenFormField Text="Refresh Token Lifetime (days)" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenNumeric @bind-Value="@refreshTokenDays" 
                                                          Min="1" Max="365" 
                                                          Style="width: 100%;" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Recommended: 7-30 days
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="4">
                                    <RadzenFormField Text="Authorization Code Lifetime (minutes)" Variant="Variant.Outlined">
                                        <ChildContent>
                                            <RadzenNumeric @bind-Value="@authCodeMinutes" 
                                                          Min="1" Max="60" 
                                                          Style="width: 100%;" />
                                        </ChildContent>
                                        <Helper>
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Recommended: 5-10 minutes
                                            </RadzenText>
                                        </Helper>
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                        </RadzenStack>
                    </RadzenStack>

                    <!-- Sticky Action Bar -->
                    <div style="position: sticky; bottom: 0; background: var(--rz-base-50); border-top: 1px solid var(--rz-border-color); padding: 0.75rem 1rem; z-index: 5;" class="rz-mt-4">
                        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem">
                            <div style="min-height: 1.25rem;">
                                <ValidationSummary />
                            </div>
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                                <RadzenButton Click="@Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Text="Cancel" />
                                @if (IsEdit)
                                {
                                    <RadzenButton Click="@(async () => await DeleteRealm())" Icon="delete" ButtonStyle="ButtonStyle.Danger" 
                                                 Text="Delete" Disabled="@isSaving" />
                                }
                                <RadzenButton ButtonType="ButtonType.Submit" Icon="save" ButtonStyle="ButtonStyle.Primary" 
                                             Text="@(IsEdit ? "Update Realm" : "Create Realm")" 
                                             IsBusy="@isSaving" Disabled="@isSaving" />
                            </RadzenStack>
                        </RadzenStack>
                    </div>
                </RadzenStack>
            </RadzenTemplateForm>
        }
    </RadzenCard>
}

@code {
    [Parameter] public string? Id { get; set; }

    private bool IsEdit => !string.IsNullOrEmpty(Id);
    private bool isLoading = false;
    private bool isSaving = false;
    
    private CreateRealmRequest model = new();
    private int accessTokenMinutes = 60;
    private int refreshTokenDays = 30;
    private int authCodeMinutes = 10;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        if (IsAuthenticated)
        {
            await OnAuthenticatedAsync();
        }
    }

    protected override async Task OnAuthenticatedAsync()
    {
        if (IsEdit)
        {
            await LoadRealm();
        }
        else
        {
            // Set defaults for new realm
            model.IsEnabled = true;
            model.AccessTokenLifetime = TimeSpan.FromMinutes(accessTokenMinutes);
            model.RefreshTokenLifetime = TimeSpan.FromDays(refreshTokenDays);
            model.AuthorizationCodeLifetime = TimeSpan.FromMinutes(authCodeMinutes);
        }
    }

    private async Task LoadRealm()
    {
        isLoading = true;
        try
        {
            var realm = await RealmsApi.GetRealmAsync(Id!);
            if (realm != null)
            {
                model.Name = realm.Name;
                model.DisplayName = realm.DisplayName;
                model.Description = realm.Description;
                model.IsEnabled = realm.IsEnabled;
                model.AccessTokenLifetime = realm.AccessTokenLifetime;
                model.RefreshTokenLifetime = realm.RefreshTokenLifetime;
                model.AuthorizationCodeLifetime = realm.AuthorizationCodeLifetime;

                // Convert to form values
                accessTokenMinutes = (int)realm.AccessTokenLifetime.TotalMinutes;
                refreshTokenDays = (int)realm.RefreshTokenLifetime.TotalDays;
                authCodeMinutes = (int)realm.AuthorizationCodeLifetime.TotalMinutes;

                PageLogger.LogInformation("Loaded realm {RealmName} for editing", realm.Name);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Realm not found or not accessible");
                // Stay on page to allow user to re-authenticate or navigate manually
            }
        }
        catch (Exception ex)
        {
            PageLogger.LogError(ex, "Error loading realm {RealmId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load realm data");
            // Stay on page to allow user to re-authenticate or navigate manually
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnSave(CreateRealmRequest args)
    {
        if (string.IsNullOrWhiteSpace(model.Name))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation Error", "Realm name is required");
            return;
        }

        isSaving = true;
        try
        {
            // Update TimeSpan values from form inputs
            model.AccessTokenLifetime = TimeSpan.FromMinutes(accessTokenMinutes);
            model.RefreshTokenLifetime = TimeSpan.FromDays(refreshTokenDays);
            model.AuthorizationCodeLifetime = TimeSpan.FromMinutes(authCodeMinutes);

            RealmDto? result;
            
            if (IsEdit)
            {
                result = await RealmsApi.UpdateRealmAsync(Id!, model);
            }
            else
            {
                result = await RealmsApi.CreateRealmAsync(model);
            }

            if (result != null)
            {
                var action = IsEdit ? "updated" : "created";
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Realm '{result.Name}' has been {action} successfully");
                Navigation.NavigateTo("/realms");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save realm");
            }
        }
        catch (Exception ex)
        {
            PageLogger.LogError(ex, "Error saving realm");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save realm");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteRealm()
    {
        var result = await DialogService.Confirm($"Are you sure you want to delete the realm '{model.Name}'?", "Delete Realm", new ConfirmOptions() { OkButtonText = "Delete", CancelButtonText = "Cancel" });
        
        if (result == true)
        {
            try
            {
                var deleteResult = await RealmsApi.DeleteRealmAsync(Id!);
                
                if (deleteResult)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Success", $"Realm '{model.Name}' has been deleted");
                    Navigation.NavigateTo("/realms");
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete realm");
                }
            }
            catch (Exception ex)
            {
                PageLogger.LogError(ex, "Error deleting realm");
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete realm");
            }
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/realms");
    }
}