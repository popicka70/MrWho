@page "/realms/add"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared.Models
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IRealmsApiService RealmsApiService
@inject ILogger<AddRealm> Logger

<PageTitle>Add Realm - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/realms" Text="Realms" />
        <RadzenBreadCrumbItem Text="Add" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="add_circle" class="rz-me-1" />
        Add New Realm
    </RadzenText>
</RadzenStack>

<RadzenCard class="rz-my-4">
    <RadzenTemplateForm Data="@form" TItem="RealmForm" Submit="@OnSave">
        <RadzenStack Gap="1rem">
            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Name" Variant="Variant.Outlined">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="form.Name" Style="width: 100%;" Placeholder="Enter unique realm name" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Unique identifier for the realm (e.g., production, staging, tenant-a)
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="6">
                    <RadzenFormField Text="Display Name" Variant="Variant.Outlined">
                        <ChildContent>
                            <RadzenTextBox @bind-Value="form.DisplayName" Style="width: 100%;" Placeholder="Human friendly name" />
                        </ChildContent>
                    </RadzenFormField>
                </RadzenColumn>
            </RadzenRow>

            <RadzenFormField Text="Description" Variant="Variant.Outlined">
                <ChildContent>
                    <RadzenTextArea @bind-Value="form.Description" Style="width: 100%; height: 80px;" Placeholder="Optional description" />
                </ChildContent>
            </RadzenFormField>

            <RadzenFormField Text="Status" Variant="Variant.Outlined">
                <Start>
                    <RadzenSwitch @bind-Value="form.IsEnabled" OnLabel="Enabled" OffLabel="Disabled" />
                </Start>
                <Helper>
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                        Toggle to enable or disable this realm
                    </RadzenText>
                </Helper>
            </RadzenFormField>

            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Token Lifetimes</RadzenText>
            <RadzenRow>
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenFormField Text="Access Token Lifetime (minutes)" Variant="Variant.Outlined">
                        <ChildContent>
                            <RadzenNumeric TValue="int" @bind-Value="form.AccessTokenLifetimeMinutes" Min="1" Max="1440" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Typical: 60 minutes
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenFormField Text="Refresh Token Lifetime (hours)" Variant="Variant.Outlined">
                        <ChildContent>
                            <RadzenNumeric TValue="int" @bind-Value="form.RefreshTokenLifetimeHours" Min="1" Max="(90 * 24)" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Typical: 30 days (720 hours)
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
                <RadzenColumn Size="12" SizeMD="4">
                    <RadzenFormField Text="Authorization Code Lifetime (minutes)" Variant="Variant.Outlined">
                        <ChildContent>
                            <RadzenNumeric TValue="int" @bind-Value="form.AuthorizationCodeLifetimeMinutes" Min="1" Max="30" Style="width: 100%;" />
                        </ChildContent>
                        <Helper>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Typical: 5 minutes
                            </RadzenText>
                        </Helper>
                    </RadzenFormField>
                </RadzenColumn>
            </RadzenRow>

            <div class="rz-mt-2" style="position: sticky; bottom: 0; background: var(--rz-base-background); border-top: 1px solid var(--rz-panel-border); padding: 0.75rem 1rem; z-index: 10;">
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                    <ValidationSummary />
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                        <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Click="@Cancel" />
                        <RadzenButton Text="Create Realm" Icon="add_circle" ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenCard>

@code {
    private RealmForm form = new();

    protected override void OnInitialized()
    {
        // Initialize defaults based on shared defaults
        var req = new CreateRealmRequest();
        form.IsEnabled = true;
        form.AccessTokenLifetimeMinutes = (int)req.AccessTokenLifetime.TotalMinutes;
        form.RefreshTokenLifetimeHours = (int)req.RefreshTokenLifetime.TotalHours;
        form.AuthorizationCodeLifetimeMinutes = (int)req.AuthorizationCodeLifetime.TotalMinutes;
    }

    private async Task OnSave(RealmForm _)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(form.Name))
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Validation", "Name is required");
                return;
            }

            var request = new CreateRealmRequest
            {
                Name = form.Name!.Trim(),
                DisplayName = string.IsNullOrWhiteSpace(form.DisplayName) ? null : form.DisplayName!.Trim(),
                Description = string.IsNullOrWhiteSpace(form.Description) ? null : form.Description!.Trim(),
                IsEnabled = form.IsEnabled,
                AccessTokenLifetime = TimeSpan.FromMinutes(Math.Max(1, form.AccessTokenLifetimeMinutes)),
                RefreshTokenLifetime = TimeSpan.FromHours(Math.Max(1, form.RefreshTokenLifetimeHours)),
                AuthorizationCodeLifetime = TimeSpan.FromMinutes(Math.Max(1, form.AuthorizationCodeLifetimeMinutes))
            };

            var created = await RealmsApiService.CreateRealmAsync(request);
            if (created is not null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Created", $"Realm '{created.Name}' was created");
                // Go to edit defaults for the new realm
                Navigation.NavigateTo($"/realms/edit/{created.Id}");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to create realm");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating realm");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to create realm");
        }
    }

    private void Cancel() => Navigation.NavigateTo("/realms");

    private class RealmForm
    {
        public string? Name { get; set; }
        public string? DisplayName { get; set; }
        public string? Description { get; set; }
        public bool IsEnabled { get; set; } = true;
        public int AccessTokenLifetimeMinutes { get; set; }
        public int RefreshTokenLifetimeHours { get; set; }
        public int AuthorizationCodeLifetimeMinutes { get; set; }
    }
}
