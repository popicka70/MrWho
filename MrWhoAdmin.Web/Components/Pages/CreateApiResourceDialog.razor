@inject IApiResourcesApiService ApiResourcesApi
@inject IScopesApiService ScopesApi
@inject IClaimTypesApiService ClaimTypesApi
@inject DialogService DialogService
@inject NotificationService NotificationService
@inject ILogger<CreateApiResourceDialog> Logger
@using MrWho.Shared.Models

<RadzenTemplateForm TItem="CreateApiResourceRequest" Data="@model" Submit="@OnSubmit">
    <RadzenStack Gap="1rem">
        <!-- Basic Information -->
        <RadzenStack Gap="0.75rem">
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Basic Information</RadzenText>
            <RadzenStack Gap="1rem">
                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Name" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="@model.Name" Name="Name" class="w-100" />
                            <RadzenRequiredValidator Component="Name" Text="Name is required" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Display Name" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="@model.DisplayName" Name="DisplayName" class="w-100" />
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
                <RadzenFormField Text="Description" Variant="Variant.Outlined">
                    <RadzenTextArea @bind-Value="@model.Description" Name="Description" class="w-100" Rows="3" />
                </RadzenFormField>
                <RadzenRow>
                    <RadzenColumn Size="12" SizeMD="6">
                        <RadzenFormField Text="Enabled" Variant="Variant.Outlined">
                            <Start>
                                <RadzenCheckBox @bind-Value="@model.IsEnabled" Name="IsEnabled" />
                            </Start>
                            <ChildContent>
                                <RadzenLabel Text="Enabled" Component="IsEnabled" />
                            </ChildContent>
                        </RadzenFormField>
                    </RadzenColumn>
                </RadzenRow>
            </RadzenStack>
        </RadzenStack>

        <!-- Claim Destinations -->
        <RadzenStack Gap="0.75rem">
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Claim Destinations</RadzenText>
            <RadzenStack Gap="0.5rem">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Select where claims for this API resource should appear.</RadzenText>
                <RadzenFormField Text="Access Token" Variant="Variant.Outlined">
                    <Start>
                        <RadzenCheckBox @bind-Value="accessTokenSelected" />
                    </Start>
                    <ChildContent>
                        <RadzenLabel Text="Include claims in access tokens" />
                    </ChildContent>
                </RadzenFormField>
                <RadzenFormField Text="ID Token" Variant="Variant.Outlined">
                    <Start>
                        <RadzenCheckBox @bind-Value="idTokenSelected" />
                    </Start>
                    <ChildContent>
                        <RadzenLabel Text="Include claims in ID tokens" />
                    </ChildContent>
                </RadzenFormField>
            </RadzenStack>
        </RadzenStack>

        <!-- Scopes -->
        <RadzenStack Gap="0.75rem">
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Scopes</RadzenText>
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Select scopes from registry (enabled only). You must register scopes first.</RadzenText>
                <RadzenRow>
                    <RadzenColumn Size="10">
                        <RadzenFormField Text="Add Scope" Variant="Variant.Outlined">
                            <RadzenDropDown Data="@filteredAvailableScopes" TextProperty="Name" ValueProperty="Name" @bind-Value="selectedScopeName" AllowClear="true" Filter="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select scope..." Style="width:100%" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="2">
                        <RadzenButton Click="@AddScopeFromSelection" Icon="add" ButtonStyle="ButtonStyle.Primary" class="w-100" Disabled="@string.IsNullOrWhiteSpace(selectedScopeName)" />
                    </RadzenColumn>
                </RadzenRow>
                @if (model.Scopes.Any())
                {
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                        @foreach (var scope in model.Scopes)
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Info" class="rz-p-2">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                    <RadzenText>@scope</RadzenText>
                                    <RadzenButton Click="@(() => RemoveScope(scope))" Icon="close" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" />
                                </RadzenStack>
                            </RadzenBadge>
                        }
                    </RadzenStack>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Size="AlertSize.Small">No scopes selected.</RadzenAlert>
                }
            </RadzenStack>
        </RadzenStack>

        <!-- User Claims -->
        <RadzenStack Gap="0.75rem">
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">User Claims</RadzenText>
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Select claim types from registry. You must register claim types first.</RadzenText>
                <RadzenRow>
                    <RadzenColumn Size="10">
                        <RadzenFormField Text="Add Claim Type" Variant="Variant.Outlined">
                            <RadzenDropDown Data="@filteredAvailableClaimTypes" TextProperty="Type" ValueProperty="Type" @bind-Value="selectedClaimType" AllowClear="true" Filter="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select claim type..." Style="width:100%" />
                        </RadzenFormField>
                    </RadzenColumn>
                    <RadzenColumn Size="2">
                        <RadzenButton Click="@AddClaimFromSelection" Icon="add" ButtonStyle="ButtonStyle.Primary" class="w-100" Disabled="@string.IsNullOrWhiteSpace(selectedClaimType)" />
                    </RadzenColumn>
                </RadzenRow>
                @if (model.UserClaims.Any())
                {
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                        @foreach (var claim in model.UserClaims)
                        {
                            <RadzenBadge BadgeStyle="BadgeStyle.Success" class="rz-p-2">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                    <RadzenText>@claim</RadzenText>
                                    <RadzenButton Click="@(() => RemoveClaim(claim))" Icon="close" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" />
                                </RadzenStack>
                            </RadzenBadge>
                        }
                    </RadzenStack>
                }
                else
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info" Size="AlertSize.Small">No claim types selected.</RadzenAlert>
                }
            </RadzenStack>
        </RadzenStack>

        <!-- Secrets -->
        <RadzenStack Gap="0.75rem">
            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">API Secrets (Optional)</RadzenText>
            <RadzenStack Gap="1rem">
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                    API secrets are used for token introspection and other server-to-server scenarios.
                </RadzenText>
                @if (newSecret != null)
                {
                    <RadzenCard class="rz-p-3" Style="background-color: var(--rz-base-50);">
                        <RadzenStack Gap="1rem">
                            <RadzenRow>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Description" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@newSecret.Description" class="w-100" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Secret Value" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@newSecret.Value" class="w-100" />
                                        <RadzenRequiredValidator Component="SecretValue" Text="Secret value is required" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                            <RadzenRow>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Expiration (Optional)" Variant="Variant.Outlined">
                                        <RadzenDatePicker @bind-Value="@newSecret.Expiration" class="w-100" ShowTime="true" />
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Type" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@newSecret.Type" class="w-100" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                <RadzenButton Click="@AddSecret" Icon="add" ButtonStyle="ButtonStyle.Success" Text="Add Secret" />
                                <RadzenButton Click="@CancelAddSecret" Icon="cancel" ButtonStyle="ButtonStyle.Light" Text="Cancel" />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenCard>
                }
                else
                {
                    <RadzenButton Click="@StartAddSecret" Icon="add" ButtonStyle="ButtonStyle.Secondary" Text="Add Secret" />
                }
                @if (model.Secrets.Any())
                {
                    <RadzenStack Gap="0.5rem">
                        @foreach (var secret in model.Secrets.Select((s, i) => new { Secret = s, Index = i }))
                        {
                            <RadzenCard class="rz-p-2">
                                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                    <RadzenStack Gap="0.25rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle2">@(string.IsNullOrEmpty(secret.Secret.Description) ? $"Secret {secret.Index + 1}" : secret.Secret.Description)</RadzenText>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Type: @secret.Secret.Type</RadzenText>
                                        @if (secret.Secret.Expiration.HasValue)
                                        {
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Expires: @secret.Secret.Expiration.Value.ToString("MMM dd, yyyy HH:mm")</RadzenText>
                                        }
                                    </RadzenStack>
                                    <RadzenButton Click="@(() => RemoveSecret(secret.Index))" Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" />
                                </RadzenStack>
                            </RadzenCard>
                        }
                    </RadzenStack>
                }
            </RadzenStack>
        </RadzenStack>
    </RadzenStack>

    <!-- Form Actions -->
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="0.5rem" class="rz-mt-6">
        <RadzenButton Click="@(() => DialogService.Close())" Text="Cancel" ButtonStyle="ButtonStyle.Light" />
        <RadzenButton ButtonType="ButtonType.Submit" Text="Create API Resource" ButtonStyle="ButtonStyle.Primary" IsBusy="@isSubmitting" />
    </RadzenStack>
</RadzenTemplateForm>

@code {
    private CreateApiResourceRequest model = new() { IsEnabled = true, ClaimDestinations = new List<string>{"access_token"} };
    private bool accessTokenSelected { get => HasDestination("access_token"); set => ToggleDestination("access_token", value); }
    private bool idTokenSelected { get => HasDestination("identity_token"); set => ToggleDestination("identity_token", value); }
    private bool isSubmitting = false;
    private string? selectedScopeName;
    private string? selectedClaimType;
    private List<ScopeDto> availableScopes = new();
    private List<ClaimTypeInfo> availableClaimTypes = new();
    private CreateApiSecretRequest? newSecret = null;

    private IEnumerable<ScopeDto> filteredAvailableScopes => availableScopes.Where(s => s.IsEnabled && !model.Scopes.Contains(s.Name)).OrderBy(s=>s.Name);
    private IEnumerable<ClaimTypeInfo> filteredAvailableClaimTypes => availableClaimTypes.Where(c => !model.UserClaims.Contains(c.Type)).OrderBy(c=>c.Type);

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var scopePage = await ScopesApi.GetScopesAsync(page:1, pageSize:500);
            if (scopePage?.Items != null) availableScopes = scopePage.Items;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed loading scopes for dropdown");
            NotificationService.Notify(NotificationSeverity.Warning, "Scopes", "Failed to load scope list");
        }
        try
        {
            var claimTypes = await ClaimTypesApi.GetAsync();
            if (claimTypes != null) availableClaimTypes = claimTypes.Where(c=>!string.IsNullOrWhiteSpace(c.Type)).ToList();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed loading claim types");
            NotificationService.Notify(NotificationSeverity.Warning, "Claim Types", "Failed to load claim types");
        }
    }

    private bool HasDestination(string dest) => model.ClaimDestinations.Contains(dest, StringComparer.OrdinalIgnoreCase);
    private void ToggleDestination(string dest, bool selected)
    {
        if (selected)
        {
            if (!HasDestination(dest)) model.ClaimDestinations.Add(dest);
        }
        else
        {
            model.ClaimDestinations.RemoveAll(d => string.Equals(d, dest, StringComparison.OrdinalIgnoreCase));
        }
    }

    private async Task OnSubmit(CreateApiResourceRequest formModel)
    {
        if (isSubmitting) return;
        if (!formModel.ClaimDestinations.Any()) formModel.ClaimDestinations.Add("access_token");
        isSubmitting = true;
        try
        {
            var result = await ApiResourcesApi.CreateApiResourceAsync(formModel);
            if (result != null)
            {
                DialogService.Close(result);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to create API resource");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating API resource");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to create API resource");
        }
        finally
        {
            isSubmitting = false;
        }
    }

    private void AddScopeFromSelection()
    {
        if (!string.IsNullOrWhiteSpace(selectedScopeName) && !model.Scopes.Contains(selectedScopeName))
        {
            model.Scopes.Add(selectedScopeName);
            selectedScopeName = null;
        }
    }

    private void RemoveScope(string scope) => model.Scopes.Remove(scope);

    private void AddClaimFromSelection()
    {
        if (!string.IsNullOrWhiteSpace(selectedClaimType) && !model.UserClaims.Contains(selectedClaimType))
        {
            model.UserClaims.Add(selectedClaimType);
            selectedClaimType = null;
        }
    }

    private void RemoveClaim(string claim) => model.UserClaims.Remove(claim);

    private void StartAddSecret() => newSecret = new CreateApiSecretRequest { Type = "SharedSecret" };
    private void AddSecret() { if (newSecret != null && !string.IsNullOrWhiteSpace(newSecret.Value)) { model.Secrets.Add(newSecret); newSecret = null; } }
    private void CancelAddSecret() => newSecret = null;
    private void RemoveSecret(int index) { if (index >= 0 && index < model.Secrets.Count) { model.Secrets.RemoveAt(index); } }
}