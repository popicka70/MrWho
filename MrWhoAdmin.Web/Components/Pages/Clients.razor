@page "/clients"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject ILogger<Clients> Logger
@inject IClientsApiService ClientsApi
@inject IRealmsApiService RealmsApi

<PageTitle>Clients - MrWho Admin</PageTitle>

<RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-8">
    <RadzenIcon Icon="apps" class="rz-me-1" />
    Clients Management
</RadzenText>

<RadzenCard class="rz-my-4">
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mb-4">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
            <RadzenTextBox @bind-Value="@searchTerm" Placeholder="Search clients..." Style="width: 300px;" />
            <RadzenDropDown @bind-Value="@selectedRealmId" Data="@realms" TextProperty="DisplayName" ValueProperty="Id" 
                           Placeholder="Filter by realm..." Style="width: 200px;" AllowClear="true" />
            <RadzenButton Click="@LoadClients" Icon="search" ButtonStyle="ButtonStyle.Secondary" />
        </RadzenStack>
        <RadzenButton Click="@(() => Navigation.NavigateTo("/clients/add"))" Icon="add" ButtonStyle="ButtonStyle.Primary" Text="Add Client" />
    </RadzenStack>

    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else if (clients.Any())
    {
        <RadzenDataGrid Data="@clients" TItem="ClientDto" AllowPaging="true" PageSize="10" AllowSorting="true">
            <Columns>
                <RadzenDataGridColumn TItem="ClientDto" Property="ClientId" Title="Client ID" Width="200px">
                    <Template Context="client">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="@GetClientTypeIcon(client.ClientType)" 
                                       Style="@($"color: {GetClientTypeColor(client.ClientType)}")" />
                            <RadzenText Text="@client.ClientId" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="ClientDto" Property="Name" Title="Name" />
                
                <RadzenDataGridColumn TItem="ClientDto" Property="RealmName" Title="Realm" Width="150px">
                    <Template Context="client">
                        <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="@client.RealmName" />
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="ClientDto" Property="ClientType" Title="Type" Width="120px">
                    <Template Context="client">
                        <RadzenBadge BadgeStyle="@GetClientTypeBadgeStyle(client.ClientType)" 
                                    Text="@GetClientTypeText(client.ClientType)" />
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="ClientDto" Property="IsEnabled" Title="Status" Width="100px">
                    <Template Context="client">
                        <RadzenBadge BadgeStyle="@(client.IsEnabled ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                    Text="@(client.IsEnabled ? "Enabled" : "Disabled")" />
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="ClientDto" Title="Flows" Width="120px">
                    <Template Context="client">
                        <RadzenStack Gap="0.2rem">
                            @if (client.AllowAuthorizationCodeFlow)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="Auth Code" Size="BadgeSize.ExtraSmall" />
                            }
                            @if (client.AllowClientCredentialsFlow)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Client Creds" Size="BadgeSize.ExtraSmall" />
                            }
                            @if (client.AllowRefreshTokenFlow)
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Primary" Text="Refresh" Size="BadgeSize.ExtraSmall" />
                            }
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="ClientDto" Title="Actions" Width="350px" Sortable="false">
                    <Template Context="client">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Click="@(() => EditClient(client.Id))" Icon="edit" Size="ButtonSize.Medium" 
                                         ButtonStyle="ButtonStyle.Light" Text="Edit" />
                            <RadzenButton Click="@(() => ViewDetails(client.Id))" Icon="visibility" Size="ButtonSize.Medium" 
                                         ButtonStyle="ButtonStyle.Info" Text="View" />
                            <RadzenButton Click="@(async () => await ToggleClientStatus(client))" Icon="@(client.IsEnabled ? "toggle_on" : "toggle_off")" 
                                         Size="ButtonSize.Medium" ButtonStyle="ButtonStyle.Warning" Text="Toggle" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Info">
            <RadzenText>No clients found. Click "Add Client" to create your first client.</RadzenText>
        </RadzenAlert>
    }
</RadzenCard>

@code {
    private List<ClientDto> clients = new();
    private List<RealmDto> realms = new();
    private bool isLoading = false;
    private string searchTerm = "";
    private string? selectedRealmId = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadRealms();
        await LoadClients();
    }

    private async Task LoadRealms()
    {
        try
        {
            var result = await RealmsApi.GetRealmsAsync(page: 1, pageSize: 100);
            if (result != null)
            {
                realms = result.Items;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading realms for filter");
            // Don't show error notification for this, just continue without realm filter
        }
    }

    private async Task LoadClients()
    {
        isLoading = true;
        try
        {
            var result = await ClientsApi.GetClientsAsync(page: 1, pageSize: 50, search: searchTerm, realmId: selectedRealmId);
            
            if (result != null)
            {
                clients = result.Items;
                Logger.LogInformation("Loaded {ClientCount} clients from API", clients.Count);
            }
            else
            {
                clients = new List<ClientDto>();
                NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Failed to load clients from API");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading clients from API");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load clients");
            clients = new List<ClientDto>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void EditClient(string clientId)
    {
        NotificationService.Notify(NotificationSeverity.Info, "Navigation", $"Navigating to edit client {clientId}");
        Navigation.NavigateTo($"/clients/edit/{clientId}");
    }

    private void ViewDetails(string clientId)
    {
        NotificationService.Notify(NotificationSeverity.Info, "Navigation", "Viewing client details");
        Navigation.NavigateTo($"/clients/details/{clientId}");
    }

    private async Task ToggleClientStatus(ClientDto client)
    {
        try
        {
            var result = await ClientsApi.ToggleClientAsync(client.Id);
            
            if (result != null)
            {
                // Update the local data with the API response
                client.IsEnabled = result.IsEnabled;
                client.UpdatedAt = result.UpdatedAt;
                
                var status = client.IsEnabled ? "enabled" : "disabled";
                NotificationService.Notify(NotificationSeverity.Success, "Client Updated", $"Client '{client.Name}' has been {status}");
                StateHasChanged();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to toggle client status");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling client status for {ClientId}", client.Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to toggle client status");
        }
    }

    private string GetClientTypeIcon(ClientType clientType)
    {
        return clientType switch
        {
            ClientType.Confidential => "security",
            ClientType.Public => "public",
            ClientType.Machine => "precision_manufacturing",
            _ => "apps"
        };
    }

    private string GetClientTypeColor(ClientType clientType)
    {
        return clientType switch
        {
            ClientType.Confidential => "var(--rz-success)",
            ClientType.Public => "var(--rz-info)",
            ClientType.Machine => "var(--rz-warning)",
            _ => "var(--rz-text-color)"
        };
    }

    private BadgeStyle GetClientTypeBadgeStyle(ClientType clientType)
    {
        return clientType switch
        {
            ClientType.Confidential => BadgeStyle.Success,
            ClientType.Public => BadgeStyle.Info,
            ClientType.Machine => BadgeStyle.Warning,
            _ => BadgeStyle.Secondary
        };
    }

    private string GetClientTypeText(ClientType clientType)
    {
        return clientType switch
        {
            ClientType.Confidential => "Confidential",
            ClientType.Public => "Public",
            ClientType.Machine => "M2M",
            _ => "Unknown"
        };
    }
}