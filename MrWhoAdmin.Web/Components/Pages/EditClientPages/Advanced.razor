@using MrWho.Shared
@using MrWho.Shared.Models

<RadzenStack Gap="0.75rem" class="rz-mb-4">
    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Protocol Configuration</RadzenText>
    <RadzenStack Gap="1rem">
        <RadzenFormField Text="Protocol Type" Variant="Variant.Outlined">
            <ChildContent>
                <RadzenTextBox @bind-Value="model.ProtocolType" Style="width: 100%;" Disabled="true" />
            </ChildContent>
            <Helper>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                    Protocol type (currently only OIDC is supported)
                </RadzenText>
            </Helper>
        </RadzenFormField>

        <RadzenFormField Text="Audiences / Resources" Variant="Variant.Outlined">
            <ChildContent>
                <RadzenTextArea @bind-Value="audiencesText" Style="width:100%; min-height:120px;" Placeholder="api1&#10;api2" Change="@(args => OnAudiencesChanged())" />
            </ChildContent>
            <Helper>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">One per line. Stored and used for aud claim emission.</RadzenText>
            </Helper>
        </RadzenFormField>

        <RadzenFormField Text="Audience Mode" Variant="Variant.Outlined">
            <ChildContent>
                <RadzenDropDown @bind-Value="model.AudienceMode" Data="audienceModeOptions" TextProperty="Text" ValueProperty="Value" Style="width:100%;" AllowClear="true" />
            </ChildContent>
            <Helper>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">How audiences are emitted: RequestedIntersection (default), AllConfigured, RequestedOrAll, RequestedOrPrimary, ErrorIfUnrequested, AccessTokenOnly, None.</RadzenText>
            </Helper>
        </RadzenFormField>

        <RadzenFormField Text="Primary Audience" Variant="Variant.Outlined">
            <ChildContent>
                <RadzenTextBox @bind-Value="model.PrimaryAudience" Style="width:100%;" Placeholder="primary-api" />
            </ChildContent>
            <Helper>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Used by RequestedOrPrimary; must match a listed audience.</RadzenText>
            </Helper>
        </RadzenFormField>

        <RadzenFormField Variant="Variant.Outlined">
            <Start>
                <RadzenCheckBox @bind-Value="model.IncludeAudInIdToken" TriState="true" Name="includeAudId" />
            </Start>
            <ChildContent>
                <RadzenLabel Text="Include audiences in ID token" Component="includeAudId" />
            </ChildContent>
            <Helper>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">If unchecked, aud only in access token (server enforcement pending).</RadzenText>
            </Helper>
        </RadzenFormField>

        <RadzenFormField Variant="Variant.Outlined">
            <Start>
                <RadzenCheckBox @bind-Value="model.RequireExplicitAudienceScope" TriState="true" Name="requireExplicitAud" />
            </Start>
            <ChildContent>
                <RadzenLabel Text="Require explicit audience scope" Component="requireExplicitAud" />
            </ChildContent>
            <Helper>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">When true and none requested: audiences omitted (future rejection option).</RadzenText>
            </Helper>
        </RadzenFormField>
    </RadzenStack>
</RadzenStack>

<RadzenStack Gap="0.75rem" class="rz-mt-4 rz-mb-4">
    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Custom Page URLs</RadzenText>
    <RadzenStack Gap="1rem">
        <RadzenFormField Text="Custom Login Page" Variant="Variant.Outlined">
            <ChildContent>
                <RadzenTextBox @bind-Value="model.CustomLoginPageUrl" Style="width: 100%;" Placeholder="https://custom.example.com/login" />
            </ChildContent>
            <Helper>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Override default login page for this client</RadzenText>
            </Helper>
        </RadzenFormField>
        <RadzenFormField Text="Custom Logout Page" Variant="Variant.Outlined">
            <ChildContent>
                <RadzenTextBox @bind-Value="model.CustomLogoutPageUrl" Style="width: 100%;" Placeholder="https://custom.example.com/logout" />
            </ChildContent>
            <Helper>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Override default logout page for this client</RadzenText>
            </Helper>
        </RadzenFormField>
        <RadzenFormField Text="Custom Error Page" Variant="Variant.Outlined">
            <ChildContent>
                <RadzenTextBox @bind-Value="model.CustomErrorPageUrl" Style="width: 100%;" Placeholder="https://custom.example.com/error" />
            </ChildContent>
            <Helper>
                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Override default error page for this client</RadzenText>
            </Helper>
        </RadzenFormField>
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public EditClient editClient { get; set; } = null!;
    private CreateClientRequest model => editClient.model;
    private string audiencesText { get; set; } = string.Empty;

    private IEnumerable<object> audienceModeOptions => Enum.GetValues(typeof(AudienceMode))
        .Cast<AudienceMode>()
        .Select(v => new { Text = v.ToString(), Value = (AudienceMode?)v });

    protected override void OnParametersSet()
    {
        audiencesText = string.Join("\n", editClient.SelectedAudiences);
    }

    private void OnAudiencesChanged()
    {
        var list = audiencesText.Split('\n', StringSplitOptions.RemoveEmptyEntries | StringSplitOptions.TrimEntries)
            .Distinct()
            .Where(a => a.Length <= 200)
            .ToList();
        editClient.SetAudiences(list);
    }
}
