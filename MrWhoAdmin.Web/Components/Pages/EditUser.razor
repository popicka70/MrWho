@page "/users/add"
@page "/users/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared.Models

<PageTitle>@(IsEdit ? "Edit User" : "Add User") - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/users" Text="Users" />
        <RadzenBreadCrumbItem Text="@(IsEdit ? "Edit" : "Add")" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="@(IsEdit ? "edit" : "person_add")" class="rz-me-1" />
        @(IsEdit ? "Edit User" : "Add New User")
    </RadzenText>
</RadzenStack>

@if (isLoading)
{
    <RadzenCard class="rz-my-4">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading user data...</RadzenText>
    </RadzenCard>
}
else
{
    <RadzenCard class="rz-my-4">
        <!-- Single form wrapping all tabs so actions are always visible -->
        <RadzenTemplateForm Data="@userModel" TItem="EditUser.UserEditModel" Submit="@OnSaveUser">
            <RadzenTabs @bind-SelectedIndex="selectedTabIndex" RenderMode="TabRenderMode.Client" TabPosition="TabPosition.Left">
                <Tabs>
                    <!-- Basic Information Tab -->
                    <RadzenTabsItem Text="Basic Information" Icon="person">
                        <MrWhoAdmin.Web.Components.Pages.EditUserPages.BasicInformation editUser="this" />
                    </RadzenTabsItem>

                    <!-- Claims Management Tab -->
                    @if (IsEdit)
                    {
                        <RadzenTabsItem Text="Claims" Icon="verified_user">
                            <MrWhoAdmin.Web.Components.Pages.EditUserPages.ClaimsTab editUser="this" />
                        </RadzenTabsItem>

                        <!-- Roles Management Tab -->
                        <RadzenTabsItem Text="Roles" Icon="group">
                            <MrWhoAdmin.Web.Components.Pages.EditUserPages.RolesTab editUser="this" />
                        </RadzenTabsItem>

                        <!-- Clients Tab -->
                        <RadzenTabsItem Text="Clients" Icon="apps">
                            <MrWhoAdmin.Web.Components.Pages.EditUserPages.ClientsTab editUser="this" />
                        </RadzenTabsItem>

                        <!-- Security Tab -->
                        <RadzenTabsItem Text="Security" Icon="security">
                            <MrWhoAdmin.Web.Components.Pages.EditUserPages.SecurityTab editUser="this" />
                        </RadzenTabsItem>
                    }
                </Tabs>
            </RadzenTabs>

            <!-- Global sticky action bar visible on all tabs -->
            <div class="rz-mt-4" style="position: sticky; bottom: 0; background: var(--rz-base-background); border-top: 1px solid var(--rz-panel-border); padding: 0.75rem 1rem; z-index: 10;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem">
                    <div style="min-height: 1.25rem;">
                        <ValidationSummary />
                    </div>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                        <RadzenButton Click="@Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Text="Cancel" />
                        @if (IsEdit)
                        {
                            <RadzenButton Click="@(async () => await DeleteUser())" Icon="delete" ButtonStyle="ButtonStyle.Danger" Text="Delete User" Disabled="@isSaving" IsBusy="@isDeleting" />
                        }
                        <RadzenButton ButtonType="ButtonType.Submit" Icon="save" ButtonStyle="ButtonStyle.Primary" Text="@(IsEdit ? "Update User" : "Create User")" IsBusy="@isSaving" Disabled="@isSaving" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        </RadzenTemplateForm>
    </RadzenCard>
}