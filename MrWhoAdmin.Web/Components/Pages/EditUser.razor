@page "/users/add"
@page "/users/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWho.Shared.Models

<PageTitle>@(IsEdit ? "Edit User" : "Add User") - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/users" Text="Users" />
        <RadzenBreadCrumbItem Text="@(IsEdit ? "Edit" : "Add")" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="@(IsEdit ? "edit" : "person_add")" class="rz-me-1" />
        @(IsEdit ? "Edit User" : "Add New User")
    </RadzenText>
</RadzenStack>

@if (isLoading)
{
    <RadzenCard class="rz-my-4">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading user data...</RadzenText>
    </RadzenCard>
}
else
{
    <RadzenCard class="rz-my-4">
        <!-- Single form wrapping all tabs so actions are always visible -->
        <RadzenTemplateForm Data="@userModel" TItem="EditUser.UserEditModel" Submit="@OnSaveUser">
            <RadzenTabs @bind-SelectedIndex="selectedTabIndex" RenderMode="TabRenderMode.Client" TabPosition="TabPosition.Left">
                <Tabs>
                    <!-- Basic Information Tab -->
                    <RadzenTabsItem Text="Basic Information" Icon="person">
                        <div style="padding: 1rem;">
                            <RadzenStack Gap="2rem">
                                <RadzenStack Gap="0.75rem" class="rz-mb-2">
                                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">User Information</RadzenText>
                                    <RadzenStack Gap="1rem">
                                        <RadzenRow>
                                            <RadzenColumn Size="12" SizeMD="6">
                                                <RadzenFormField Text="Email Address" Variant="Variant.Outlined">
                                                    <RadzenTextBox @bind-Value="@userModel.Email" Placeholder="user@example.com" Style="width: 100%;" Disabled="@IsEdit" />
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        @(IsEdit ? "Email cannot be changed after creation" : "This will be used for login")
                                                    </RadzenText>
                                                </RadzenFormField>
                                            </RadzenColumn>
                                            <RadzenColumn Size="12" SizeMD="6">
                                                <RadzenFormField Text="Username" Variant="Variant.Outlined">
                                                    <RadzenTextBox @bind-Value="@userModel.UserName" Placeholder="Enter username" Style="width: 100%;" Disabled="@IsEdit" />
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                        @(IsEdit ? "Username cannot be changed after creation" : "Leave blank to use email as username")
                                                    </RadzenText>
                                                </RadzenFormField>
                                            </RadzenColumn>
                                        </RadzenRow>

                                        @if (!IsEdit)
                                        {
                                            <RadzenRow>
                                                <RadzenColumn Size="12" SizeMD="6">
                                                    <RadzenFormField Text="Password" Variant="Variant.Outlined">
                                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Stretch">
                                                            <RadzenTextBox @bind-Value="@userModel.Password" Type="@(showPassword ? "text" : "password")" Placeholder="Enter password" Style="flex: 1;" />
                                                            <RadzenButton Icon="@(showPassword ? "visibility_off" : "visibility")" ButtonStyle="ButtonStyle.Light" Click="@(() => showPassword = !showPassword)" />
                                                            <RadzenButton Icon="refresh" ButtonStyle="ButtonStyle.Secondary" Text="Generate" Click="@GeneratePassword" />
                                                        </RadzenStack>
                                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Minimum 8 characters with mixed case, numbers, and symbols</RadzenText>
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="6">
                                                    <RadzenFormField Text="Confirm Password" Variant="Variant.Outlined">
                                                        <RadzenTextBox @bind-Value="@confirmPassword" Type="password" Placeholder="Confirm password" Style="width: 100%;" />
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                            </RadzenRow>
                                        }
                                        else
                                        {
                                            <RadzenRow>
                                                <RadzenColumn Size="12" SizeMD="6">
                                                    <RadzenFormField Text="User ID" Variant="Variant.Outlined">
                                                        <RadzenTextBox Value="@(currentUser?.Id ?? "")" ReadOnly="true" Style="width: 100%;" />
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="6">
                                                    <RadzenFormField Text="Phone Number" Variant="Variant.Outlined">
                                                        <RadzenTextBox @bind-Value="@userModel.PhoneNumber" Placeholder="+1 (555) 123-4567" Style="width: 100%;" />
                                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Optional - used for two-factor authentication</RadzenText>
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                            </RadzenRow>
                                        }

                                        @if (!IsEdit)
                                        {
                                            <RadzenFormField Text="Phone Number" Variant="Variant.Outlined">
                                                <RadzenTextBox @bind-Value="@userModel.PhoneNumber" Placeholder="+1 (555) 123-4567" Style="width: 100%;" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Optional - used for two-factor authentication</RadzenText>
                                            </RadzenFormField>
                                        }

                                        <RadzenStack Gap="0.75rem" class="rz-mt-2">
                                            <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Status</RadzenText>
                                            <RadzenRow Gap="1rem">
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Email Confirmation" Variant="Variant.Outlined">
                                                        <Start>
                                                            <RadzenCheckBox @bind-Value="@userModel.EmailConfirmed" Name="emailConfirmed" />
                                                        </Start>
                                                        <ChildContent>
                                                            <RadzenLabel Text="Email address is confirmed" Component="emailConfirmed" />
                                                        </ChildContent>
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Phone Confirmation" Variant="Variant.Outlined">
                                                        <Start>
                                                            <RadzenCheckBox @bind-Value="@userModel.PhoneNumberConfirmed" Name="phoneConfirmed" />
                                                        </Start>
                                                        <ChildContent>
                                                            <RadzenLabel Text="Phone number is confirmed" Component="phoneConfirmed" />
                                                        </ChildContent>
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Two-Factor Authentication" Variant="Variant.Outlined">
                                                        <Start>
                                                            <RadzenCheckBox @bind-Value="@userModel.TwoFactorEnabled" Name="twoFactor" />
                                                        </Start>
                                                        <ChildContent>
                                                            <RadzenLabel Text="Two-factor authentication is enabled" Component="twoFactor" />
                                                        </ChildContent>
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                            </RadzenRow>
                                        </RadzenStack>
                                    </RadzenStack>
                                </RadzenStack>

                                <!-- Removed per-tab sticky bar; global action bar is below the tabs -->
                            </RadzenStack>
                        </div>
                        <MrWhoAdmin.Web.Components.Pages.EditUserPages.BasicInformation editUser="this" />
                    </RadzenTabsItem>

                    <!-- Claims Management Tab -->
                    @if (IsEdit)
                    {
                        <RadzenTabsItem Text="Claims" Icon="verified_user">
                            <div style="padding: 1rem;">
                                <RadzenStack Gap="2rem">
                                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                        <RadzenText TextStyle="TextStyle.H6" Text="User Claims Management" />
                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="@($"{userClaims.Count} claims")" />
                                    </RadzenStack>

                                    <!-- Add New Claim Section -->
                                    <RadzenCard Style="background-color: var(--rz-base-50);">
                                        <RadzenStack Gap="1rem">
                                            <RadzenText TextStyle="TextStyle.Subtitle1" Text="Add New Claim" />

                                            <RadzenRow>
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Claim Type" Variant="Variant.Outlined">
                                                        <RadzenDropDown @bind-Value="@newClaimType" Data="@CommonClaimTypes.StandardClaims" TextProperty="DisplayName" ValueProperty="Type" AllowClear="true" Placeholder="Select or type custom claim type" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Style="width: 100%;" />
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Claim Value" Variant="Variant.Outlined">
                                                        <RadzenTextBox @bind-Value="@newClaimValue" Placeholder="Enter claim value" Style="width: 100%;" />
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Action" Variant="Variant.Outlined">
                                                        <RadzenButton Click="@(async () => await AddClaim())" Icon="add" ButtonStyle="ButtonStyle.Success" Text="Add Claim" Disabled="@(string.IsNullOrWhiteSpace(newClaimType) || string.IsNullOrWhiteSpace(newClaimValue))" IsBusy="@isAddingClaim" Style="width: 100%;" />
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                            </RadzenRow>

                                            @if (!string.IsNullOrWhiteSpace(newClaimType))
                                            {
                                                var claimInfo = CommonClaimTypes.StandardClaims.FirstOrDefault(c => c.Type == newClaimType);
                                                if (claimInfo != default)
                                                {
                                                    <RadzenAlert AlertStyle="AlertStyle.Info" Size="AlertSize.Small">
                                                        <RadzenText><strong>@claimInfo.DisplayName:</strong> @claimInfo.Description</RadzenText>
                                                    </RadzenAlert>
                                                }
                                            }
                                        </RadzenStack>
                                    </RadzenCard>

                                    <!-- Current Claims List -->
                                    <RadzenStack Gap="0.75rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Current Claims</RadzenText>
                                        @if (userClaims.Any())
                                        {
                                            <div style="max-height: 400px; overflow-y: auto;">
                                                <RadzenDataGrid Data="@userClaims" TItem="UserClaimDto" AllowPaging="false" AllowSorting="true">
                                                    <Columns>
                                                        <RadzenDataGridColumn TItem="UserClaimDto" Property="ClaimType" Title="Claim Type" Width="200px">
                                                            <Template Context="claim">
                                                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                                                    <RadzenIcon Icon="verified_user" Style="color: var(--rz-info); font-size: 16px;" />
                                                                    <RadzenText Text="@claim.ClaimType" />
                                                                </RadzenStack>
                                                            </Template>
                                                        </RadzenDataGridColumn>

                                                        <RadzenDataGridColumn TItem="UserClaimDto" Property="ClaimValue" Title="Value">
                                                            <Template Context="claim">
                                                                <RadzenText Text="@claim.ClaimValue" Style="word-break: break-all;" />
                                                            </Template>
                                                        </RadzenDataGridColumn>

                                                        <RadzenDataGridColumn TItem="UserClaimDto" Title="Actions" Width="120px" Sortable="false">
                                                            <Template Context="claim">
                                                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                                                    <RadzenButton Click="@(async () => await RemoveClaim(claim))" Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" />
                                                                </RadzenStack>
                                                            </Template>
                                                        </RadzenDataGridColumn>
                                                    </Columns>
                                                </RadzenDataGrid>
                                            </div>
                                        }
                                        else
                                        {
                                            <RadzenAlert AlertStyle="AlertStyle.Info">
                                                <RadzenText>No claims assigned to this user. Add claims above to provide additional user information.</RadzenText>
                                            </RadzenAlert>
                                        }
                                    </RadzenStack>
                                </RadzenStack>
                            </div>
                            <MrWhoAdmin.Web.Components.Pages.EditUserPages.ClaimsTab editUser="this" />
                        </RadzenTabsItem>

                        <!-- Roles Management Tab -->
                        <RadzenTabsItem Text="Roles" Icon="group">
                            <div style="padding: 1rem;">
                                <RadzenStack Gap="2rem">
                                    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                        <RadzenText TextStyle="TextStyle.H6" Text="User Roles" />
                                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="@($"{userRoles.Count} roles")" />
                                    </RadzenStack>

                                    <!-- Role Assignment Section -->
                                    <RadzenCard Style="background-color: var(--rz-base-50);">
                                        <RadzenStack Gap="1rem">
                                            <RadzenText TextStyle="TextStyle.Subtitle1" Text="Assign Role" />
                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                                Roles provide groups of permissions and appear in the 'role' claim when the roles scope is requested.
                                            </RadzenText>

                                            <RadzenRow>
                                                <RadzenColumn Size="12" SizeMD="8">
                                                    <RadzenFormField Text="Available Roles" Variant="Variant.Outlined">
                                                        <RadzenDropDown @bind-Value="@selectedRoleId" Data="@availableRoles" TextProperty="Name" ValueProperty="Id" Placeholder="Select a role to assign" Style="width: 100%;" />
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Action" Variant="Variant.Outlined">
                                                        <RadzenButton Click="@(async () => await AssignRole())" Icon="add" ButtonStyle="ButtonStyle.Success" Text="Assign Role" Disabled="@(string.IsNullOrWhiteSpace(selectedRoleId))" IsBusy="@isAssigningRole" Style="width: 100%;" />
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                            </RadzenRow>
                                        </RadzenStack>
                                    </RadzenCard>

                                    <!-- Current Roles List -->
                                    <RadzenStack Gap="0.75rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Assigned Roles</RadzenText>
                                        @if (userRoles.Any())
                                        {
                                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                                                @foreach (var role in userRoles)
                                                {
                                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" class="rz-p-3">
                                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                                            <RadzenIcon Icon="group" />
                                                            <RadzenText Text="@role.Name" />
                                                            <RadzenButton Click="@(async () => await RemoveRole(role.Id))" Icon="close" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" />
                                                        </RadzenStack>
                                                    </RadzenBadge>
                                                }
                                            </RadzenStack>
                                        }
                                        else
                                        {
                                            <RadzenAlert AlertStyle="AlertStyle.Info">
                                                <RadzenText>No roles assigned to this user. Assign roles above to grant permissions.</RadzenText>
                                            </RadzenAlert>
                                        }
                                    </RadzenStack>
                                </RadzenStack>
                            </div>
                            <MrWhoAdmin.Web.Components.Pages.EditUserPages.RolesTab editUser="this" />
                        </RadzenTabsItem>

                        <!-- Clients Tab -->
                        <RadzenTabsItem Text="Clients" Icon="apps">
                            <div style="padding: 1rem;">
                                <RadzenStack Gap="1.5rem">
                                    <RadzenText TextStyle="TextStyle.H6" Text="Client Assignments" />

                                    <RadzenCard Style="background-color: var(--rz-base-50);">
                                        <RadzenStack Gap="1rem">
                                            <RadzenText TextStyle="TextStyle.Subtitle1" Text="Assign to Client" />
                                            <RadzenRow>
                                                <RadzenColumn Size="12" SizeMD="8">
                                                    <RadzenFormField Text="Client" Variant="Variant.Outlined">
                                                        <RadzenDropDown @bind-Value="selectedClientId" Data="@availableClients" TextProperty="Name" ValueProperty="Id" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select a client" Style="width: 100%;" />
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="4">
                                                    <RadzenFormField Text="Action" Variant="Variant.Outlined">
                                                        <RadzenButton Click="@(async () => await AssignClient())" Icon="person_add" ButtonStyle="ButtonStyle.Primary" Text="Assign" Disabled="@string.IsNullOrWhiteSpace(selectedClientId)" IsBusy="@isAssigningClient" Style="width: 100%;" />
                                                    </RadzenFormField>
                                                </RadzenColumn>
                                            </RadzenRow>
                                        </RadzenStack>
                                    </RadzenCard>

                                    <RadzenStack Gap="0.75rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Assigned Clients</RadzenText>
                                        @if (assignedClients.Any())
                                        {
                                            <RadzenDataGrid Data="@assignedClients" TItem="UserClientDto" AllowPaging="true" PageSize="10" AllowSorting="true">
                                                <Columns>
                                                    <RadzenDataGridColumn TItem="UserClientDto" Property="ClientPublicId" Title="Client ID" />
                                                    <RadzenDataGridColumn TItem="UserClientDto" Property="ClientName" Title="Name" />
                                                    <RadzenDataGridColumn TItem="UserClientDto" Property="CreatedAt" Title="Assigned" />
                                                    <RadzenDataGridColumn TItem="UserClientDto" Title="Actions" Width="120px">
                                                        <Template Context="c">
                                                            <RadzenButton Click="@(async () => await RemoveClient(c))" Icon="delete" Size="ButtonSize.Small" ButtonStyle="ButtonStyle.Danger" Variant="Variant.Text" />
                                                        </Template>
                                                    </RadzenDataGridColumn>
                                                </Columns>
                                            </RadzenDataGrid>
                                        }
                                        else
                                        {
                                            <RadzenAlert AlertStyle="AlertStyle.Info">
                                                <RadzenText>This user is not assigned to any clients.</RadzenText>
                                            </RadzenAlert>
                                        }
                                    </RadzenStack>
                                </RadzenStack>
                            </div>
                            <MrWhoAdmin.Web.Components.Pages.EditUserPages.ClientsTab editUser="this" />
                        </RadzenTabsItem>

                        <!-- Security Tab -->
                        <RadzenTabsItem Text="Security" Icon="security">
                            <div style="padding: 1rem;">
                                <RadzenStack Gap="2rem">
                                    <RadzenText TextStyle="TextStyle.H6" Text="Security Management" />

                                    <RadzenStack Gap="0.75rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Profile Status</RadzenText>
                                        <RadzenCard>
                                            <RadzenStack Gap="1rem">
                                                <RadzenText TextStyle="TextStyle.Subtitle2">Current State</RadzenText>
                                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.75rem" AlignItems="AlignItems.Center">
                                                    @if (profileState?.State?.Equals("Active", StringComparison.OrdinalIgnoreCase) == true)
                                                    {
                                                        <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="ACTIVE" />
                                                    }
                                                    else if (profileState?.State?.Equals("Suspended", StringComparison.OrdinalIgnoreCase) == true)
                                                    {
                                                        <RadzenBadge BadgeStyle="BadgeStyle.Warning" Text="SUSPENDED" />
                                                    }
                                                    else if (profileState?.State?.Equals("Disabled", StringComparison.OrdinalIgnoreCase) == true)
                                                    {
                                                        <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="DISABLED" />
                                                    }
                                                    else
                                                    {
                                                        <RadzenBadge BadgeStyle="BadgeStyle.Info" Text="NEW" />
                                                    }
                                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Only users with state 'Active' can complete OIDC authorization.</RadzenText>
                                                </RadzenStack>

                                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                                    <RadzenButton Click="@(async () => await SetProfileState("Active"))" Icon="check_circle" ButtonStyle="ButtonStyle.Success" Text="Activate" />
                                                    <RadzenButton Click="@(async () => await SetProfileState("Suspended"))" Icon="pause_circle" ButtonStyle="ButtonStyle.Secondary" Text="Suspend" />
                                                    <RadzenButton Click="@(async () => await SetProfileState("Disabled"))" Icon="cancel" ButtonStyle="ButtonStyle.Danger" Text="Deactivate" />
                                                </RadzenStack>
                                            </RadzenStack>
                                        </RadzenCard>
                                    </RadzenStack>

                                    <RadzenStack Gap="0.75rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Account Lock Status</RadzenText>
                                        <RadzenStack Gap="1rem">
                                            <RadzenRow>
                                                <RadzenColumn Size="12" SizeMD="6">
                                                    <RadzenCard>
                                                        <RadzenStack Gap="1rem">
                                                            <RadzenText TextStyle="TextStyle.Subtitle1" Text="Account Lock Status" />
                                                            @if (IsUserLocked())
                                                            {
                                                                <RadzenBadge BadgeStyle="BadgeStyle.Danger" Text="LOCKED" />
                                                                <RadzenText TextStyle="TextStyle.Caption">Locked until: @(currentUser?.LockoutEnd?.ToString("yyyy-MM-dd HH:mm"))</RadzenText>
                                                                <RadzenButton Click="@(async () => await UnlockUser())" Icon="lock_open" ButtonStyle="ButtonStyle.Success" Text="Unlock Account" IsBusy="@isTogglingLock" />
                                                            }
                                                            else
                                                            {
                                                                <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="ACTIVE" />
                                                                <RadzenButton Click="@(async () => await LockUser())" Icon="lock" ButtonStyle="ButtonStyle.Warning" Text="Lock Account" IsBusy="@isTogglingLock" />
                                                            }
                                                        </RadzenStack>
                                                    </RadzenCard>
                                                </RadzenColumn>
                                                <RadzenColumn Size="12" SizeMD="6">
                                                    <RadzenCard>
                                                        <RadzenStack Gap="1rem">
                                                            <RadzenText TextStyle="TextStyle.Subtitle1" Text="Password Management" />
                                                            <RadzenButton Click="@(async () => await ResetPassword())" Icon="key" ButtonStyle="ButtonStyle.Primary" Text="Reset Password" IsBusy="@isResettingPassword" />
                                                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Generates a new temporary password and notifies the user</RadzenText>
                                                        </RadzenStack>
                                                    </RadzenCard>
                                                </RadzenColumn>
                                            </RadzenRow>
                                        </RadzenStack>
                                    </RadzenStack>

                                    <RadzenStack Gap="0.75rem">
                                        <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Session Management</RadzenText>
                                        <RadzenCard>
                                            <RadzenStack Gap="1rem">
                                                <RadzenText TextStyle="TextStyle.Subtitle1" Text="Active Sessions" />
                                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">Force logout will invalidate all active sessions for this user</RadzenText>
                                                <RadzenButton Click="@(async () => await ForceLogout())" Icon="logout" ButtonStyle="ButtonStyle.Danger" Text="Force Logout All Sessions" IsBusy="@isForcingLogout" />
                                            </RadzenStack>
                                        </RadzenCard>
                                    </RadzenStack>
                                </RadzenStack>
                            </div>
                            <MrWhoAdmin.Web.Components.Pages.EditUserPages.SecurityTab editUser="this" />
                        </RadzenTabsItem>
                    }
                </Tabs>
            </RadzenTabs>

            <!-- Global sticky action bar visible on all tabs -->
            <div class="rz-mt-4" style="position: sticky; bottom: 0; background: var(--rz-base-background); border-top: 1px solid var(--rz-panel-border); padding: 0.75rem 1rem; z-index: 10;">
                <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.SpaceBetween" Gap="1rem">
                    <div style="min-height: 1.25rem;">
                        <ValidationSummary />
                    </div>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                        <RadzenButton Click="@Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Text="Cancel" />
                        @if (IsEdit)
                        {
                            <RadzenButton Click="@(async () => await DeleteUser())" Icon="delete" ButtonStyle="ButtonStyle.Danger" Text="Delete User" Disabled="@isSaving" IsBusy="@isDeleting" />
                        }
                        <RadzenButton ButtonType="ButtonType.Submit" Icon="save" ButtonStyle="ButtonStyle.Primary" Text="@(IsEdit ? "Update User" : "Create User")" IsBusy="@isSaving" Disabled="@isSaving" />
                    </RadzenStack>
                </RadzenStack>
            </div>
        </RadzenTemplateForm>
    </RadzenCard>
}