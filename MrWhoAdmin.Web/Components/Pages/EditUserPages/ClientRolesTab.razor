@using MrWho.Shared.Models
@inject IClientRolesApiService ClientRolesApi
@inject IClientsApiService ClientsApi
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ILogger<ClientRolesTab> Logger

@if (!editUser.IsEdit)
{
    <RadzenAlert AlertStyle="AlertStyle.Info"><RadzenText>Save user first to manage client-scoped roles.</RadzenText></RadzenAlert>
}
else if (editUser.isLoading)
{
    <RadzenCard class="rz-my-4">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading client roles...</RadzenText>
    </RadzenCard>
}
else
{
    <div style="padding:1rem;">
        <RadzenStack Gap="1.5rem">
            <RadzenText TextStyle="TextStyle.H6" Text="Client Scoped Role Assignments" />
            <RadzenFormField Text="Client" Variant="Variant.Outlined">
                <RadzenDropDown Data="@clients" @bind-Value="selectedClientId" TextProperty="ClientId" ValueProperty="ClientId" AllowFiltering="true" FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive" Placeholder="Select client" Style="width:300px;" Change="@(async (_) => await OnClientChanged())" />
            </RadzenFormField>

            @if (string.IsNullOrWhiteSpace(selectedClientId))
            {
                <RadzenAlert AlertStyle="AlertStyle.Info"><RadzenText>Select a client to view and assign roles.</RadzenText></RadzenAlert>
            }
            else
            {
                <RadzenStack Gap="0.75rem">
                    <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Roles for @selectedClientId</RadzenText>
                    <RadzenDataGrid Data="@rows" TItem="ClientRoleAssignmentRow" AllowPaging="true" PageSize="15" AllowSorting="true" AllowFiltering="true">
                        <Columns>
                            <RadzenDataGridColumn TItem="ClientRoleAssignmentRow" Title="Assigned" Width="110px">
                                <Template Context="row">
                                    <RadzenCheckBox Value="@row.IsAssigned" Change="@(async (bool? value) => await OnAssignmentChanged(row, value == true))" />
                                </Template>
                            </RadzenDataGridColumn>
                            <RadzenDataGridColumn TItem="ClientRoleAssignmentRow" Property="Name" Title="Role" />
                            <RadzenDataGridColumn TItem="ClientRoleAssignmentRow" Property="UserCount" Title="Users" Width="110px" />
                        </Columns>
                    </RadzenDataGrid>
                    @if (!rows.Any())
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Info"><RadzenText>No roles defined for this client.</RadzenText></RadzenAlert>
                    }
                </RadzenStack>
            }
        </RadzenStack>
    </div>
}

@code {
    [Parameter] public EditUser editUser { get; set; } = null!;

    private List<ClientDto> clients = new();
    private List<ClientRoleDto> allRoles = new();
    private List<UserClientRoleView> userClientRoles = new();
    private string? selectedClientId;

    private List<ClientRoleAssignmentRow> rows = new();

    protected override Task OnInitializedAsync()
    {
        clients = editUser.aggregatedAllClients;
        allRoles = editUser.aggregatedAllClientRoles;
        userClientRoles = editUser.aggregatedUserClientRolesByClient
            .SelectMany(kvp => kvp.Value.Select(r => new UserClientRoleView { ClientId = kvp.Key, RoleName = r }))
            .OrderBy(x => x.ClientId).ThenBy(x => x.RoleName).ToList();
        selectedClientId = clients.FirstOrDefault()?.ClientId;
        BuildRows();
        return Task.CompletedTask;
    }

    private Task OnClientChanged()
    {
        BuildRows();
        return Task.CompletedTask;
    }

    private void BuildRows()
    {
        if (string.IsNullOrWhiteSpace(selectedClientId)) { rows = new(); return; }
        var rolesForClient = allRoles.Where(r => r.ClientId == selectedClientId).ToList();
        var assignedNames = userClientRoles.Where(r => r.ClientId == selectedClientId).Select(r => r.RoleName).ToHashSet(StringComparer.OrdinalIgnoreCase);
        rows = rolesForClient.Select(r => new ClientRoleAssignmentRow
        {
            ClientId = r.ClientId,
            Name = r.Name,
            UserCount = r.UserCount,
            IsAssigned = assignedNames.Contains(r.Name)
        }).OrderBy(r => r.Name, StringComparer.OrdinalIgnoreCase).ToList();
    }

    private async Task OnAssignmentChanged(ClientRoleAssignmentRow row, bool assign)
    {
        if (editUser.currentUser == null) return;
        var original = row.IsAssigned;
        row.IsAssigned = assign; // optimistic
        bool success;
        if (assign)
        {
            success = await ClientRolesApi.AssignRoleAsync(new AssignClientRoleRequest { UserId = editUser.currentUser.Id, ClientId = row.ClientId, RoleName = row.Name });
            if (success)
            {
                userClientRoles.Add(new UserClientRoleView { ClientId = row.ClientId, RoleName = row.Name });
                if (!editUser.aggregatedUserClientRolesByClient.TryGetValue(row.ClientId, out var list))
                {
                    list = new List<string>();
                    editUser.aggregatedUserClientRolesByClient[row.ClientId] = list;
                }
                if (!list.Contains(row.Name, StringComparer.OrdinalIgnoreCase)) list.Add(row.Name);
                NotificationService.Notify(NotificationSeverity.Success, "Assigned", $"Role '{row.Name}' assigned");
            }
        }
        else
        {
            success = await ClientRolesApi.RemoveRoleAsync(new RemoveClientRoleRequest { UserId = editUser.currentUser.Id, ClientId = row.ClientId, RoleName = row.Name });
            if (success)
            {
                userClientRoles.RemoveAll(r => r.ClientId == row.ClientId && string.Equals(r.RoleName, row.Name, StringComparison.OrdinalIgnoreCase));
                if (editUser.aggregatedUserClientRolesByClient.TryGetValue(row.ClientId, out var list))
                {
                    list.RemoveAll(n => string.Equals(n, row.Name, StringComparison.OrdinalIgnoreCase));
                    if (list.Count == 0) editUser.aggregatedUserClientRolesByClient.Remove(row.ClientId);
                }
                NotificationService.Notify(NotificationSeverity.Success, "Removed", "Role removed");
            }
        }
        if (!success)
        {
            row.IsAssigned = original; // revert
            NotificationService.Notify(NotificationSeverity.Error, "Error", assign ? "Failed to assign role" : "Failed to remove role");
        }
        BuildRows();
        StateHasChanged();
    }

    private class ClientRoleAssignmentRow
    {
        public string ClientId { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public int UserCount { get; set; }
        public bool IsAssigned { get; set; }
    }

    private class UserClientRoleView
    {
        public string ClientId { get; set; } = string.Empty;
        public string RoleName { get; set; } = string.Empty;
    }
}
