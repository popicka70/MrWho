@using MrWho.Shared.Models

@if (!editUser.IsEdit)
{
    <RadzenAlert AlertStyle="AlertStyle.Info"><RadzenText>Save user first to manage roles.</RadzenText></RadzenAlert>
}
else if (editUser.isLoading)
{
    <RadzenCard class="rz-my-4">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading roles...</RadzenText>
    </RadzenCard>
}
else
{
    <div style="padding: 1rem;">
        <RadzenStack Gap="1.5rem">
            <RadzenText TextStyle="TextStyle.H6" Text="Role Assignments" />
            <RadzenStack Gap="0.75rem">
                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Roles</RadzenText>
                <RadzenDataGrid Data="@rows" TItem="RoleAssignmentRow" AllowPaging="true" PageSize="15" AllowSorting="true" AllowFiltering="true">
                    <Columns>
                        <RadzenDataGridColumn TItem="RoleAssignmentRow" Title="Assigned" Width="110px">
                            <Template Context="row">
                                <RadzenCheckBox Value="@row.IsAssigned" Change="@(async (bool? value) => await OnAssignmentChanged(row, value == true))" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="RoleAssignmentRow" Property="Name" Title="Name" />
                        <RadzenDataGridColumn TItem="RoleAssignmentRow" Property="Description" Title="Description">
                            <Template Context="row">
                                @if (!string.IsNullOrWhiteSpace(row.Description))
                                {
                                    <RadzenText>@row.Description</RadzenText>
                                }
                                else
                                {
                                    <RadzenText class="rz-color-secondary">—</RadzenText>
                                }
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="RoleAssignmentRow" Property="IsEnabled" Title="Enabled" Width="110px">
                            <Template Context="row">
                                <RadzenBadge BadgeStyle="@(row.IsEnabled ? BadgeStyle.Success : BadgeStyle.Danger)" Text="@(row.IsEnabled ? "Yes" : "No")" />
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                @if (!rows.Any())
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info"><RadzenText>No roles found.</RadzenText></RadzenAlert>
                }
            </RadzenStack>
        </RadzenStack>
    </div>
}

@code {
    [Parameter] public EditUser editUser { get; set; } = null!;

    private List<RoleAssignmentRow> rows = new();

    protected override void OnParametersSet()
    {
        BuildRows();
    }

    private void BuildRows()
    {
        // Assigned roles
        var assigned = editUser.userRoles.Select(r => new RoleAssignmentRow
        {
            RoleId = r.Id,
            Name = r.Name,
            Description = r.Description,
            IsEnabled = r.IsEnabled,
            IsAssigned = true
        });
        // Available roles (not assigned)
        var available = editUser.availableRoles.Select(r => new RoleAssignmentRow
        {
            RoleId = r.Id,
            Name = r.Name,
            Description = r.Description,
            IsEnabled = r.IsEnabled,
            IsAssigned = false
        });
        rows = assigned.Concat(available)
            .OrderBy(r => r.Name, StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    private async Task OnAssignmentChanged(RoleAssignmentRow row, bool assign)
    {
        var original = row.IsAssigned;
        row.IsAssigned = assign; // optimistic
        bool success;
        if (assign)
        {
            editUser.selectedRoleId = row.RoleId; // use existing assign logic
            await editUser.AssignRole();
            success = editUser.userRoles.Any(r => r.Id == row.RoleId);
        }
        else
        {
            await editUser.RemoveRole(row.RoleId);
            success = !editUser.userRoles.Any(r => r.Id == row.RoleId);
        }
        if (!success)
        {
            row.IsAssigned = original; // revert
        }
        BuildRows();
        StateHasChanged();
    }

    private class RoleAssignmentRow
    {
        public string RoleId { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public bool IsEnabled { get; set; }
        public bool IsAssigned { get; set; }
    }
}
