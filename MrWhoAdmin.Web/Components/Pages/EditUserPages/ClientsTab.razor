@using MrWho.Shared.Models
@if (!editUser.IsEdit)
{
    <RadzenAlert AlertStyle="AlertStyle.Info"><RadzenText>Save user first to assign clients.</RadzenText></RadzenAlert>
}
else if (editUser.isLoading)
{
    <RadzenCard class="rz-my-4">
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading client data...</RadzenText>
    </RadzenCard>
}
else
{

    <div style="padding: 1rem;">
        <RadzenStack Gap="1.5rem">
            <RadzenText TextStyle="TextStyle.H6" Text="Client Assignments" />
            <RadzenStack Gap="0.75rem">
                <RadzenText TextStyle="TextStyle.Subtitle1" class="rz-font-weight-600">Clients</RadzenText>
                <RadzenDataGrid Data="@rows" TItem="ClientAssignmentRow" AllowPaging="true" PageSize="15" AllowSorting="true" AllowFiltering="true">
                    <Columns>
                        <RadzenDataGridColumn TItem="ClientAssignmentRow" Title="Assigned" Width="110px">
                            <Template Context="row">
                                <RadzenCheckBox Value="@row.IsAssigned" Change="@(async (bool? value) => await OnAssignmentChanged(row, value == true))" />
                            </Template>
                        </RadzenDataGridColumn>
                        <RadzenDataGridColumn TItem="ClientAssignmentRow" Property="ClientPublicId" Title="Client ID" />
                        <RadzenDataGridColumn TItem="ClientAssignmentRow" Property="Name" Title="Name" />
                        <RadzenDataGridColumn TItem="ClientAssignmentRow" Property="AssignedAt" Title="Assigned" Width="200px">
                            <Template Context="row">
                                @if (row.AssignedAt.HasValue)
                                {
                                    <RadzenText>@row.AssignedAt.Value.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</RadzenText>
                                }
                                else
                                {
                                    <RadzenText class="rz-color-secondary">—</RadzenText>
                                }
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
                @if (!rows.Any())
                {
                    <RadzenAlert AlertStyle="AlertStyle.Info"><RadzenText>No clients found.</RadzenText></RadzenAlert>
                }
            </RadzenStack>
        </RadzenStack>
    </div>
}

@code {
    [Parameter] public EditUser editUser { get; set; } = null!;

    private List<ClientAssignmentRow> rows = new();

    protected override void OnParametersSet()
    {
        BuildRows();
    }

    private void BuildRows()
    {
        // Merge assigned and available clients into a single list with assignment state
        var assigned = editUser.assignedClients
            .Select(a => new ClientAssignmentRow
            {
                ClientDbId = a.ClientId,
                ClientPublicId = a.ClientPublicId,
                Name = a.ClientName,
                IsAssigned = true,
                AssignedAt = a.CreatedAt
            });
        var available = editUser.availableClients
            .Where(c => !editUser.assignedClients.Any(a => a.ClientId == c.Id))
            .Select(c => new ClientAssignmentRow
            {
                ClientDbId = c.Id,
                ClientPublicId = c.ClientId,
                Name = c.Name,
                IsAssigned = false,
                AssignedAt = null
            });
        rows = assigned.Concat(available)
            .OrderBy(r => r.ClientPublicId, StringComparer.OrdinalIgnoreCase)
            .ToList();
    }

    private async Task OnAssignmentChanged(ClientAssignmentRow row, bool assign)
    {
        var original = row.IsAssigned;
        row.IsAssigned = assign; // optimistic
        var success = await editUser.SetClientAssignment(row.ClientDbId, assign);
        if (!success)
        {
            row.IsAssigned = original; // revert
        }
        BuildRows();
        StateHasChanged();
    }

    private class ClientAssignmentRow
    {
        public string ClientDbId { get; set; } = string.Empty; // DB PK
        public string ClientPublicId { get; set; } = string.Empty; // public id
        public string Name { get; set; } = string.Empty;
        public bool IsAssigned { get; set; }
        public DateTime? AssignedAt { get; set; }
    }
}
