@inherits LayoutComponentBase
@inject IJSRuntime JSRuntime

<RadzenComponents @rendermode="InteractiveServer" />

<RadzenLayout>
    <RadzenHeader>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0" class="rz-px-4">
            <RadzenSidebarToggle Click="@(() => sidebarExpanded = !sidebarExpanded)" />
            <RadzenLabel Text="MrWho Administration" class="rz-font-weight-bold rz-font-size-h5 rz-color-primary rz-m-0" />
            <div style="flex-grow: 1;"></div>
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="12px">
                <AuthorizeView>
                    <Authorized>
                        <!-- Quick Actions Dropdown (hidden on mobile) -->
                        <RadzenDropDown TValue="string" class="rz-display-none rz-display-md-inline-flex"
                                        Style="width: 200px;" Placeholder="Quick Actions" AllowClear="true"
                                        Change="@OnQuickActionChange">
                            <RadzenDropDownItem TValue="string" Text="Add New User" Value="add-user" />
                            <RadzenDropDownItem TValue="string" Text="View Reports" Value="reports" />
                            <RadzenDropDownItem TValue="string" Text="System Health" Value="health" />
                            <RadzenDropDownItem TValue="string" Text="API Documentation" Value="api-docs" />
                        </RadzenDropDown>
                        
                        <!-- Notifications Button -->
                        <RadzenButton Icon="notifications" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text" 
                                      Click="@ShowNotifications" class="rz-border-radius-50 rz-p-2" />
                        
                        <!-- User Profile Menu - Clean and improved visibility -->
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <div style="background-color: rgba(255, 255, 255, 0.15); border: 1px solid rgba(255, 255, 255, 0.25); padding: 8px 12px; border-radius: 6px; display: flex; align-items: center; gap: 8px;">
                                <RadzenIcon Icon="person" style="color: white; font-size: 16px;" />
                                <RadzenText Text="@GetUserDisplayName(context.User)" 
                                          style="color: white; font-weight: 600; font-size: 14px; text-shadow: 0 1px 2px rgba(0,0,0,0.5); margin: 0;" 
                                          class="rz-text-nowrap" />
                            </div>
                            <a href="/profile" class="rz-button rz-button-sm rz-variant-filled rz-primary rz-shade-default" 
                               style="display: inline-flex; align-items: center; gap: 4px; text-decoration: none; color: white; padding: 8px 12px; border-radius: 4px; font-size: 14px; font-weight: 500;">
                                <i class="rz-icon material-icons" style="font-size: 16px;">Profile</i>
                            </a>
                            <a href="/auth/logout?clearAll=true" class="rz-button rz-button-sm rz-variant-filled rz-danger rz-shade-default"
                               style="display: inline-flex; align-items: center; gap: 4px; text-decoration: none; color: white; padding: 8px 12px; border-radius: 4px; font-size: 14px; font-weight: 500;">
                                <i class="rz-icon material-icons" style="font-size: 16px;">logout</i>
                            </a>
                        </RadzenStack>
                    </Authorized>
                    <NotAuthorized>
                        <RadzenButton Text="Login" Icon="login" ButtonStyle="ButtonStyle.Primary" 
                                      Click="@(() => Navigation.NavigateTo("/login"))" />
                    </NotAuthorized>
                </AuthorizeView>
            </RadzenStack>
        </RadzenStack>
    </RadzenHeader>
    
    <RadzenSidebar @bind-Expanded="sidebarExpanded" Responsive="true" style="width: 300px;">
        <NavMenu @rendermode="InteractiveServer" />
    </RadzenSidebar>
    
    <RadzenBody>
        <RadzenContentContainer Name="main" class="rz-p-4">
            <AuthErrorNotification />
            <div class="content px-4">
                @Body
            </div>
        </RadzenContentContainer>
    </RadzenBody>
    
    <RadzenFooter>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" 
                     JustifyContent="JustifyContent.SpaceBetween" class="rz-px-4 rz-py-2">
            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                © @DateTime.Now.Year MrWho Administration. All rights reserved.
            </RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="16px" class="rz-display-none rz-display-md-flex">
                <RadzenLink Text="Privacy Policy" Path="/privacy" class="rz-font-size-sm" />
                <RadzenLink Text="Terms of Service" Path="/terms" class="rz-font-size-sm" />
                <RadzenLink Text="Support" Path="/support" class="rz-font-size-sm" />
            </RadzenStack>
        </RadzenStack>
    </RadzenFooter>
</RadzenLayout>

@code {
    private bool sidebarExpanded = true;

    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private NotificationService NotificationService { get; set; } = default!;
    [Inject] private ContextMenuService ContextMenuService { get; set; } = default!;

    private string GetUserDisplayName(System.Security.Claims.ClaimsPrincipal user)
    {
        // Try claims in priority order for the best user experience
        var displayName = user.FindFirst("name")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(displayName))
            return displayName;

        // Fallback to combining given and family names
        var givenName = user.FindFirst("given_name")?.Value?.Trim();
        var familyName = user.FindFirst("family_name")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(givenName) && !string.IsNullOrWhiteSpace(familyName))
            return $"{givenName} {familyName}";
        
        // Single name fallbacks
        if (!string.IsNullOrWhiteSpace(givenName))
            return givenName;
        if (!string.IsNullOrWhiteSpace(familyName))
            return familyName;

        // Username and email fallbacks
        var preferredUsername = user.FindFirst("preferred_username")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(preferredUsername))
            return preferredUsername;

        var email = user.FindFirst("email")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(email))
        {
            // Extract friendly name from email (before @)
            var emailLocal = email.Split('@')[0];
            if (!string.IsNullOrWhiteSpace(emailLocal))
            {
                // Convert "john.doe" to "John Doe"
                var friendlyName = emailLocal
                    .Replace(".", " ")
                    .Replace("_", " ")
                    .Replace("-", " ");
                
                if (!string.IsNullOrWhiteSpace(friendlyName))
                {
                    var words = friendlyName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                    var capitalizedWords = words.Select(word => 
                        char.ToUpper(word[0]) + (word.Length > 1 ? word.Substring(1).ToLower() : string.Empty));
                    return string.Join(" ", capitalizedWords);
                }
            }
            return email; // Return full email as last resort
        }

        // Technical fallbacks
        var subject = user.FindFirst("sub")?.Value?.Trim() ?? 
                     user.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(subject))
        {
            // If it's a GUID, show a user-friendly format
            if (Guid.TryParse(subject, out _))
                return "User";
            return subject;
        }

        var identityName = user.Identity?.Name?.Trim();
        if (!string.IsNullOrWhiteSpace(identityName))
            return identityName;

        return "Admin User";
    }

    private string GetUserEmail(System.Security.Claims.ClaimsPrincipal user)
    {
        return user.FindFirst("email")?.Value ??
               user.FindFirst("preferred_username")?.Value ??
               "admin@mrwho.com";
    }

    private void ShowNotifications()
    {
        NotificationService.Notify(NotificationSeverity.Info, "Notifications", 
            "You have no new notifications at this time.", duration: 4000);
    }

    private void OnQuickActionChange(object value)
    {
        if (value?.ToString() is string action)
        {
            switch (action)
            {
                case "add-user":
                    Navigation.NavigateTo("/users/add");
                    break;
                case "reports":
                    Navigation.NavigateTo("/reports");
                    break;
                case "health":
                    Navigation.NavigateTo("/system/health");
                    break;
                case "api-docs":
                    Navigation.NavigateTo("/dev/api-docs");
                    break;
            }
        }
    }

    private void ShowUserContextMenu(MouseEventArgs args)
    {
        ContextMenuService.Open(args, new List<ContextMenuItem>
        {
            new ContextMenuItem() { Text = "My Profile", Icon = "person", Value = "profile" },
            new ContextMenuItem() { Text = "Account Settings", Icon = "settings", Value = "settings" },
            new ContextMenuItem() { Text = "Change Password", Icon = "lock", Value = "change-password" },
            new ContextMenuItem() { Text = "Help & Support", Icon = "help", Value = "help" },
            new ContextMenuItem() { Text = "About", Icon = "info", Value = "about" },
            new ContextMenuItem() { Text = "Logout", Icon = "logout", Value = "logout" }
        }, OnContextMenuClick);
    }

    private void OnContextMenuClick(MenuItemEventArgs args)
    {
        ContextMenuService.Close();
        
        switch (args.Value?.ToString())
        {
            case "profile":
                Navigation.NavigateTo("/profile");
                break;
            case "settings":
                Navigation.NavigateTo("/account/settings");
                break;
            case "help":
                Navigation.NavigateTo("/help");
                break;
            case "about":
                Navigation.NavigateTo("/about");
                break;
            case "logout":
                // This will now be handled by the HTML anchor tag in the layout
                break;
        }
    }
}
