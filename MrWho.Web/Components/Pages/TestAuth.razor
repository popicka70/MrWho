@page "/test-auth"
@rendermode InteractiveServer
@attribute [Authorize]
@inject ILogger<TestAuth> Logger

<PageTitle>Authentication Test - MrWho</PageTitle>

<div class="container mt-4">
    <RadzenCard>
        <RadzenText TextStyle="TextStyle.H3" Class="mb-4">Authentication Test Page</RadzenText>
        
        <RadzenAlert AlertStyle="AlertStyle.Success" Class="mb-4">
            <RadzenText TextStyle="TextStyle.Body1">
                <strong>? Authentication Working!</strong><br />
                If you can see this page, authentication is functioning correctly.
            </RadzenText>
        </RadzenAlert>

        <AuthorizeView>
            <Authorized>
                <RadzenFieldset Text="Current User Information" Class="mb-4">
                    <div class="row">
                        <div class="col-md-6">
                            <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-1">Name</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1" Class="mb-3">
                                @(context.User.FindFirst("name")?.Value ?? 
                                  context.User.FindFirst(ClaimTypes.Name)?.Value ?? 
                                  "Not available")
                            </RadzenText>
                            
                            <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-1">Email</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1" Class="mb-3">
                                @(context.User.FindFirst("email")?.Value ?? 
                                  context.User.FindFirst(ClaimTypes.Email)?.Value ?? 
                                  "Not available")
                            </RadzenText>
                        </div>
                        <div class="col-md-6">
                            <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-1">Username</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1" Class="mb-3">
                                @(context.User.FindFirst("preferred_username")?.Value ?? "Not available")
                            </RadzenText>
                            
                            <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-1">Role</RadzenText>
                            <RadzenText TextStyle="TextStyle.Body1" Class="mb-3">
                                @(context.User.FindFirst("role")?.Value ?? 
                                  context.User.FindFirst(ClaimTypes.Role)?.Value ?? 
                                  "Not available")
                            </RadzenText>
                        </div>
                    </div>
                </RadzenFieldset>

                <RadzenFieldset Text="All Claims" Class="mb-4">
                    <RadzenDataList Data="@context.User.Claims.ToList()" TItem="Claim">
                        <Template Context="claim">
                            <div class="d-flex justify-content-between p-2 border-bottom">
                                <strong>@claim.Type</strong>
                                <span>@claim.Value</span>
                            </div>
                        </Template>
                    </RadzenDataList>
                </RadzenFieldset>
                
                <div class="d-flex gap-2">
                    <RadzenButton Text="Go to Home" 
                                ButtonStyle="ButtonStyle.Primary"
                                Icon="home"
                                Click="@(() => Navigation.NavigateTo("/"))" />
                    
                    <RadzenButton Text="Go to Users" 
                                ButtonStyle="ButtonStyle.Secondary"
                                Icon="people"
                                Click="@(() => Navigation.NavigateTo("/users"))" />
                    
                    <RadzenButton Text="Sign Out" 
                                ButtonStyle="ButtonStyle.Light"
                                Icon="logout"
                                Click="@(() => Navigation.NavigateTo("/account/logout"))" />
                </div>
            </Authorized>
            <NotAuthorized>
                <RadzenAlert AlertStyle="AlertStyle.Warning">
                    <RadzenText TextStyle="TextStyle.Body1">
                        You are not authenticated. This shouldn't happen on this page.
                    </RadzenText>
                </RadzenAlert>
            </NotAuthorized>
        </AuthorizeView>
    </RadzenCard>
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    
    protected override void OnInitialized()
    {
        Logger.LogInformation("Authentication test page accessed");
    }
}