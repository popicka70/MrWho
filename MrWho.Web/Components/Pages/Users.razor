@page "/users"
@rendermode InteractiveServer
@inject IUserApiClient UserApiClient
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ILogger<Users> Logger

<PageTitle>User Management - MrWho</PageTitle>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <RadzenCard Class="mt-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1">
                        User Management
                    </RadzenText>
                    <RadzenButton Text="Register New User" 
                                ButtonStyle="ButtonStyle.Primary" 
                                Icon="person_add"
                                Click="@(() => Navigation.NavigateTo("/register"))" />
                </div>

                <RadzenDataGrid @ref="usersGrid" 
                              Data="@users" 
                              TItem="UserRegistrationResponse"
                              AllowPaging="true" 
                              PageSize="10"
                              AllowSorting="true"
                              AllowFiltering="true"
                              FilterMode="FilterMode.Simple"
                              IsLoading="@isLoading"
                              Class="w-100">
                    
                    <Columns>
                        <RadzenDataGridColumn TItem="UserRegistrationResponse" 
                                            Property="FirstName" 
                                            Title="First Name"
                                            Width="150px">
                            <Template Context="user">
                                <RadzenText TextStyle="TextStyle.Body1">@user.FirstName</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="UserRegistrationResponse" 
                                            Property="LastName" 
                                            Title="Last Name"
                                            Width="150px">
                            <Template Context="user">
                                <RadzenText TextStyle="TextStyle.Body1">@user.LastName</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="UserRegistrationResponse" 
                                            Property="Email" 
                                            Title="Email"
                                            Width="250px">
                            <Template Context="user">
                                <RadzenText TextStyle="TextStyle.Body1">@user.Email</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="UserRegistrationResponse" 
                                            Property="UserName" 
                                            Title="Username"
                                            Width="200px">
                            <Template Context="user">
                                <RadzenText TextStyle="TextStyle.Body1">@user.UserName</RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="UserRegistrationResponse" 
                                            Property="CreatedAt" 
                                            Title="Created"
                                            Width="180px"
                                            FormatString="{0:MMM dd, yyyy}">
                            <Template Context="user">
                                <RadzenText TextStyle="TextStyle.Body2">
                                    @user.CreatedAt.ToString("MMM dd, yyyy")
                                </RadzenText>
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="UserRegistrationResponse" 
                                            Property="IsActive" 
                                            Title="Status"
                                            Width="120px"
                                            Sortable="false"
                                            Filterable="false">
                            <Template Context="user">
                                <RadzenBadge Variant="Variant.Filled" 
                                           BadgeStyle="@(user.IsActive ? BadgeStyle.Success : BadgeStyle.Danger)"
                                           Text="@(user.IsActive ? "Active" : "Inactive")" />
                            </Template>
                        </RadzenDataGridColumn>

                        <RadzenDataGridColumn TItem="UserRegistrationResponse" 
                                            Title="Actions"
                                            Width="150px"
                                            Sortable="false"
                                            Filterable="false">
                            <Template Context="user">
                                <div class="d-flex gap-1">
                                    <RadzenButton ButtonStyle="ButtonStyle.Light" 
                                                Icon="edit"
                                                Style="padding: 4px 8px;"
                                                Click="@(() => EditUser(user))"
                                                Title="Edit User" />
                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" 
                                                Icon="delete"
                                                Style="padding: 4px 8px;"
                                                Click="@(() => DeleteUser(user))"
                                                Title="Delete User" />
                                </div>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>

                @if (!users.Any() && !isLoading)
                {
                    <div class="text-center mt-4">
                        <RadzenText TextStyle="TextStyle.Body1" Class="text-muted">
                            No users found. <RadzenLink Path="/register" Text="Register the first user" />.
                        </RadzenText>
                    </div>
                }
            </RadzenCard>
        </div>
    </div>
</div>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;
    
    private RadzenDataGrid<UserRegistrationResponse>? usersGrid;
    private List<UserRegistrationResponse> users = new();
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            Logger.LogInformation("Loading users...");
            var result = await UserApiClient.GetUsersAsync(0, 100);
            users = result.ToList();
            Logger.LogInformation("Loaded {Count} users", users.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading users");
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = "Failed to load users. Please try again.",
                Duration = 4000
            });
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task EditUser(UserRegistrationResponse user)
    {
        try
        {
            Logger.LogInformation("Opening edit dialog for user {UserId}", user.Id);
            
            var result = await DialogService.OpenAsync<SimpleUserEditDialog>("Edit User", 
                new Dictionary<string, object>
                {
                    { "User", user }
                },
                new DialogOptions
                {
                    Width = "800px",
                    Height = "600px",
                    Resizable = true,
                    Draggable = true
                });

            // If a user was returned from the dialog, it means it was updated
            if (result is UserRegistrationResponse updatedUser)
            {
                Logger.LogInformation("User updated, refreshing grid");
                // Find and update the user in our list
                var index = users.FindIndex(u => u.Id == updatedUser.Id);
                if (index >= 0)
                {
                    users[index] = updatedUser;
                    StateHasChanged();
                    await usersGrid!.Reload();
                }
            }
            else
            {
                Logger.LogInformation("Dialog closed without update");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error opening edit dialog for user {UserId}", user.Id);
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Dialog Error",
                Detail = "Failed to open user edit dialog. Please try again.",
                Duration = 4000
            });
        }
    }

    private async Task DeleteUser(UserRegistrationResponse user)
    {
        var confirmed = await DialogService.Confirm(
            $"Are you sure you want to delete user '{user.Email}'? This action cannot be undone.",
            "Confirm Delete",
            new ConfirmOptions
            {
                OkButtonText = "Delete",
                CancelButtonText = "Cancel"
            });

        if (confirmed == true)
        {
            try
            {
                Logger.LogInformation("Attempting to delete user: {UserId}", user.Id);
                var success = await UserApiClient.DeleteUserAsync(user.Id);
                
                if (success)
                {
                    users.Remove(user);
                    await usersGrid!.Reload();
                    
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Success,
                        Summary = "User Deleted",
                        Detail = $"User '{user.Email}' has been deleted successfully.",
                        Duration = 4000
                    });
                    
                    Logger.LogInformation("User deleted successfully: {UserId}", user.Id);
                }
                else
                {
                    NotificationService.Notify(new NotificationMessage
                    {
                        Severity = NotificationSeverity.Error,
                        Summary = "Delete Failed",
                        Detail = "Failed to delete the user. Please try again.",
                        Duration = 4000
                    });
                    
                    Logger.LogWarning("Failed to delete user: {UserId}", user.Id);
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Exception while deleting user: {UserId}", user.Id);
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Delete Error",
                    Detail = "An error occurred while deleting the user.",
                    Duration = 4000
                });
            }
        }
    }
}