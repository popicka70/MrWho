@inject DialogService DialogService
@inject IUserApiClient UserApiClient
@inject NotificationService NotificationService
@inject ILogger<UserEditDialog> Logger

<RadzenTabs @bind-SelectedIndex="selectedTabIndex" Class="user-edit-tabs">
    <Tabs>
        <!-- Profile Tab -->
        <RadzenTabsItem Text="Profile">
            <div class="p-3">
                <EditForm Model="@profileModel" OnValidSubmit="@UpdateProfile">
                    <DataAnnotationsValidator />
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <RadzenFormField Text="First Name" Variant="Variant.Outlined">
                                <RadzenTextBox @bind-Value="@profileModel.FirstName" 
                                             Placeholder="Enter first name"
                                             MaxLength="50"
                                             Style="width: 100%;" />
                            </RadzenFormField>
                            <ValidationMessage For="@(() => profileModel.FirstName)" class="text-danger small" />
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <RadzenFormField Text="Last Name" Variant="Variant.Outlined">
                                <RadzenTextBox @bind-Value="@profileModel.LastName" 
                                             Placeholder="Enter last name"
                                             MaxLength="50"
                                             Style="width: 100%;" />
                            </RadzenFormField>
                            <ValidationMessage For="@(() => profileModel.LastName)" class="text-danger small" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <RadzenFormField Text="Email Address" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="@profileModel.Email" 
                                         Placeholder="Enter email address"
                                         MaxLength="256"
                                         Style="width: 100%;" />
                        </RadzenFormField>
                        <ValidationMessage For="@(() => profileModel.Email)" class="text-danger small" />
                    </div>

                    <div class="mb-3">
                        <RadzenCheckBox @bind-Value="@profileModel.IsActive" Name="IsActive" />
                        <RadzenLabel Text="Account Active" Component="IsActive" Class="ms-2" />
                    </div>

                    <div class="mb-3">
                        <RadzenFieldset Text="Account Information" Class="bg-light">
                            <div class="row">
                                <div class="col-md-6">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-1">Username</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted">@User?.UserName</RadzenText>
                                </div>
                                <div class="col-md-6">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-1">User ID</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2" Class="text-muted font-monospace small">@User?.Id</RadzenText>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-1">Created</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">@User?.CreatedAt.ToString("MMM dd, yyyy HH:mm")</RadzenText>
                                </div>
                                <div class="col-md-6">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Class="mb-1">Last Updated</RadzenText>
                                    <RadzenText TextStyle="TextStyle.Body2">@(User?.UpdatedAt?.ToString("MMM dd, yyyy HH:mm") ?? "Never")</RadzenText>
                                </div>
                            </div>
                        </RadzenFieldset>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <RadzenButton Text="Cancel" 
                                    ButtonStyle="ButtonStyle.Light" 
                                    Click="@(() => DialogService.Close())" />
                        <RadzenButton Text="Save Changes" 
                                    ButtonType="ButtonType.Submit"
                                    ButtonStyle="ButtonStyle.Primary"
                                    IsBusy="@isUpdatingProfile"
                                    Disabled="@isUpdatingProfile" />
                    </div>
                </EditForm>
            </div>
        </RadzenTabsItem>

        <!-- Password Tab -->
        <RadzenTabsItem Text="Reset Password">
            <div class="p-3">
                <RadzenAlert AlertStyle="AlertStyle.Info" Class="mb-3">
                    <RadzenText TextStyle="TextStyle.Body2">
                        <strong>Admin Password Reset</strong><br />
                        As an administrator, you can reset this user's password without knowing their current password.
                        The user will need to use the new password for their next login.
                    </RadzenText>
                </RadzenAlert>

                <EditForm Model="@passwordModel" OnValidSubmit="@ResetPassword">
                    <DataAnnotationsValidator />
                    
                    <div class="mb-3">
                        <RadzenFormField Text="New Password" Variant="Variant.Outlined">
                            <RadzenPassword @bind-Value="@passwordModel.NewPassword" 
                                          Placeholder="Enter new password"
                                          MaxLength="100"
                                          Style="width: 100%;" />
                        </RadzenFormField>
                        <ValidationMessage For="@(() => passwordModel.NewPassword)" class="text-danger small" />
                        <RadzenText TextStyle="TextStyle.Caption" Class="text-muted">
                            Password must contain at least one uppercase letter, one lowercase letter, and one number
                        </RadzenText>
                    </div>

                    <div class="mb-4">
                        <RadzenFormField Text="Confirm New Password" Variant="Variant.Outlined">
                            <RadzenPassword @bind-Value="@passwordModel.ConfirmPassword" 
                                          Placeholder="Confirm new password"
                                          MaxLength="100"
                                          Style="width: 100%;" />
                        </RadzenFormField>
                        <ValidationMessage For="@(() => passwordModel.ConfirmPassword)" class="text-danger small" />
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <RadzenButton Text="Cancel" 
                                    ButtonStyle="ButtonStyle.Light" 
                                    Click="@(() => DialogService.Close())" />
                        <RadzenButton Text="Reset Password" 
                                    ButtonType="ButtonType.Submit"
                                    ButtonStyle="ButtonStyle.Danger"
                                    IsBusy="@isResettingPassword"
                                    Disabled="@isResettingPassword" />
                    </div>
                </EditForm>
            </div>
        </RadzenTabsItem>
    </Tabs>
</RadzenTabs>

<style>
    .user-edit-tabs .rz-tabview-panels {
        padding: 0;
    }
    
    .font-monospace {
        font-family: 'Courier New', Courier, monospace;
    }
    
    .bg-light {
        background-color: #f8f9fa !important;
    }
</style>

@code {
    [Parameter] public UserRegistrationResponse? User { get; set; }

    private UpdateUserModel profileModel = new();
    private AdminResetPasswordModel passwordModel = new();
    private int selectedTabIndex = 0;
    private bool isUpdatingProfile = false;
    private bool isResettingPassword = false;

    protected override void OnInitialized()
    {
        Logger.LogInformation("UserEditDialog initialized for user {UserId}", User?.Id ?? "null");
        
        if (User != null)
        {
            profileModel = new UpdateUserModel
            {
                FirstName = User.FirstName ?? string.Empty,
                LastName = User.LastName ?? string.Empty,
                Email = User.Email,
                IsActive = User.IsActive
            };
            
            Logger.LogInformation("Profile model initialized with data for {Email}", User.Email);
        }
        else
        {
            Logger.LogWarning("UserEditDialog initialized with null user");
        }
    }

    private async Task UpdateProfile()
    {
        if (isUpdatingProfile || User == null) return;

        isUpdatingProfile = true;
        
        try
        {
            Logger.LogInformation("Updating profile for user {UserId}", User.Id);
            
            var updatedUser = await UserApiClient.UpdateUserAsync(User.Id, profileModel);
            
            if (updatedUser != null)
            {
                Logger.LogInformation("User profile updated successfully for {UserId}", User.Id);
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Profile Updated",
                    Detail = $"Profile for {updatedUser.FirstName} {updatedUser.LastName} has been updated successfully.",
                    Duration = 4000
                });

                // Close dialog and return updated user
                DialogService.Close(updatedUser);
            }
            else
            {
                Logger.LogWarning("Failed to update user profile for {UserId}", User.Id);
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Update Failed",
                    Detail = "Failed to update user profile. Please try again.",
                    Duration = 4000
                });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Exception occurred while updating user profile for {UserId}", User.Id);
            
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Update Error",
                Detail = "An error occurred while updating the profile.",
                Duration = 4000
            });
        }
        finally
        {
            isUpdatingProfile = false;
        }
    }

    private async Task ResetPassword()
    {
        if (isResettingPassword || User == null) return;

        isResettingPassword = true;
        
        try
        {
            Logger.LogInformation("Resetting password for user {UserId}", User.Id);
            
            var success = await UserApiClient.AdminResetPasswordAsync(User.Id, passwordModel);
            
            if (success)
            {
                Logger.LogInformation("Password reset successful for user {UserId}", User.Id);
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Password Reset",
                    Detail = $"Password has been reset for {User.FirstName} {User.LastName}. They can now use the new password to sign in.",
                    Duration = 5000
                });

                // Reset the form and switch back to profile tab
                passwordModel = new AdminResetPasswordModel();
                selectedTabIndex = 0;
            }
            else
            {
                Logger.LogWarning("Failed to reset password for user {UserId}", User.Id);
                
                NotificationService.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Reset Failed",
                    Detail = "Failed to reset password. Please try again.",
                    Duration = 4000
                });
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Exception occurred while resetting password for user {UserId}", User.Id);
            
            NotificationService.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Reset Error",
                Detail = "An error occurred while resetting the password.",
                Duration = 4000
            });
        }
        finally
        {
            isResettingPassword = false;
        }
    }
}