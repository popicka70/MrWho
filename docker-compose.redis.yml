# ============================================================================
# MrWhoOidc - High-Performance Configuration with Redis Caching
# ============================================================================
# This extends the basic docker-compose.yml with Redis caching
# Performance: 30-50% faster response times, 60-80% reduction in database load
# Suitable for: Production deployments, performance testing, medium-to-large scale
#
# Usage:
#   docker compose -f docker-compose.yml -f docker-compose.redis.yml up -d
#
# This file is an OVERLAY - it extends docker-compose.yml
# ============================================================================

services:
  # ============================================================================
  # MrWhoOidc OIDC Provider - Redis Configuration Override
  # ============================================================================
  mrwho-oidc:
    # Update service dependencies to include Redis
    depends_on:
      mrwho-postgres:
        condition: service_healthy
      mrwho-redis:
        condition: service_healthy  # Wait for Redis before starting
    
    # ============================================================================
    # Environment Variables - Redis Configuration
    # ============================================================================
    environment:
      # -------------------------------------------------------------------------
      # Redis Caching Configuration
      # -------------------------------------------------------------------------
      
      # Enable Redis caching
      # true: Activates distributed caching for sessions, tokens, and data
      # Performance impact: 30-50% faster response, 60-80% less DB load
      Redis__Enabled: ${REDIS_ENABLED:-true}
      
      # Redis connection string
      # Format: host:port[,host:port],option1=value1,option2=value2
      # abortConnect=false: Allows app to start even if Redis is temporarily unavailable
      # This prevents cascading failures during Redis restarts
      Redis__ConnectionString: ${REDIS_CONNECTION_STRING:-mrwho-redis:6379,abortConnect=false}
      
      # Redis database number (0-15, default: 0)
      # Allows logical separation if sharing Redis instance
      Redis__Database: ${REDIS_DATABASE:-0}
      
      # Redis key prefix for this instance
      # Useful for multi-instance deployments sharing Redis
      # Example: "prod-" for production, "staging-" for staging
      Redis__InstanceName: ${REDIS_INSTANCE_NAME:-mrwho}
      
      # -------------------------------------------------------------------------
      # Cache Configuration
      # -------------------------------------------------------------------------
      
      # Session cache duration in minutes
      # Default: 60 minutes (1 hour)
      # Recommendation: Balance between performance and memory usage
      Cache__SessionDuration: ${CACHE_SESSION_DURATION:-60}
      
      # Token cache duration in minutes
      # Should align with token expiration times
      # Default: 30 minutes
      Cache__TokenDuration: ${CACHE_TOKEN_DURATION:-30}
      
      # Discovery document cache duration in minutes
      # Discovery docs rarely change, safe to cache longer
      # Default: 1440 minutes (24 hours)
      Cache__DiscoveryDuration: ${CACHE_DISCOVERY_DURATION:-1440}

  # ============================================================================
  # Redis Cache Service
  # ============================================================================
  mrwho-redis:
    image: redis:7.2-alpine
    container_name: mrwho-redis
    
    # ============================================================================
    # Redis Command Configuration
    # ============================================================================
    # --save 60 1: Save to disk if at least 1 key changed in 60 seconds
    #              Provides persistence while minimizing disk I/O
    # --loglevel warning: Reduce log verbosity (only warnings and errors)
    # --maxmemory 512mb: Limit memory usage (adjust based on deployment size)
    # --maxmemory-policy allkeys-lru: Evict least recently used keys when memory full
    command: redis-server --save 60 1 --loglevel warning --maxmemory 512mb --maxmemory-policy allkeys-lru
    
    # ============================================================================
    # Data Persistence
    # ============================================================================
    volumes:
      # Persist Redis data across container restarts
      # Contains RDB snapshots (point-in-time backups)
      - redis-data:/data
    
    # ============================================================================
    # Health Check
    # ============================================================================
    healthcheck:
      # Verify Redis responds to PING command
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    
    # Restart policy
    restart: unless-stopped
    
    # ============================================================================
    # Network Configuration
    # ============================================================================
    networks:
      - internal  # Internal-only network (not exposed externally)
    
    # ============================================================================
    # Resource Limits (Optional)
    # ============================================================================
    # Uncomment to set resource limits for Redis
    # deploy:
    #   resources:
    #     limits:
    #       cpus: '0.5'      # Maximum 50% of one CPU core
    #       memory: 512M     # Maximum 512MB RAM (matches --maxmemory)
    #     reservations:
    #       cpus: '0.25'     # Reserved 25% of one CPU core
    #       memory: 256M     # Reserved 256MB RAM

# ============================================================================
# Volumes - Persistent Data Storage
# ============================================================================
volumes:
  # Redis data volume for RDB snapshots
  # Data persists across container recreation
  # To clear cache: docker compose down -v (WARNING: removes all cached data)
  redis-data:
    driver: local

# ============================================================================
# Configuration Notes
# ============================================================================
#
# Performance Benefits:
# - 30-50% faster response times for token validation and user lookups
# - 60-80% reduction in database load
# - Improved scalability with distributed caching
# - Better user experience with faster page loads
#
# When to Use Redis:
# - Production deployments with >100 active users
# - High-traffic scenarios with frequent token validation
# - Multi-instance deployments requiring shared session state
# - Performance-critical applications
#
# When NOT to Use Redis:
# - Development/testing with single developer
# - Small deployments with <50 users
# - Resource-constrained environments
# - Quick evaluation or proof-of-concept
#
# Memory Sizing Guidelines:
# - Small (<1000 users): 256MB
# - Medium (1000-10000 users): 512MB (default)
# - Large (>10000 users): 1-2GB
# - Adjust --maxmemory in command line above
#
# Cache Invalidation:
# - Cache entries automatically expire based on duration settings
# - Manual invalidation: docker compose exec mrwho-redis redis-cli FLUSHDB
# - Restart Redis to clear all cache: docker compose restart mrwho-redis
#
# Monitoring:
# - Check Redis stats: docker compose exec mrwho-redis redis-cli INFO stats
# - Monitor memory: docker compose exec mrwho-redis redis-cli INFO memory
# - View keys: docker compose exec mrwho-redis redis-cli KEYS "mrwho:*"
#
# Troubleshooting:
# - Redis not connecting: Check REDIS_CONNECTION_STRING in .env
# - Memory issues: Increase --maxmemory or adjust eviction policy
# - Performance not improved: Verify Redis__Enabled=true in .env
# - Connection errors: Check health status with docker compose ps
#
# Security:
# - Redis is isolated in internal network (no external access)
# - No authentication required for internal-only deployment
# - For multi-tenant: Use separate Redis instances or database numbers
# - For sensitive data: Consider Redis encryption (requirepass, TLS)
#
# ============================================================================
