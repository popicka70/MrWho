@inherits LayoutComponentBase

<RadzenLayout>
    <RadzenHeader>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0" class="rz-px-4">
            <RadzenSidebarToggle Click="@(() => sidebarExpanded = !sidebarExpanded)" />
            <RadzenLabel Text="MrWho Administration" class="rz-font-weight-bold rz-font-size-h5 rz-color-primary rz-m-0" />
            <div style="flex-grow: 1;"></div> @* Replace RadzenSpacer with simple div *@
            <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="12px">
                <AuthorizeView>
                    <Authorized>
                        <!-- Quick Actions Dropdown (hidden on mobile) -->
                        <RadzenDropDown TValue="string" class="rz-display-none rz-display-md-inline-flex"
                                        Style="width: 200px;" Placeholder="Quick Actions" AllowClear="true"
                                        Change="@OnQuickActionChange">
                            <RadzenDropDownItem TValue="string" Text="Add New User" Value="add-user" />
                            <RadzenDropDownItem TValue="string" Text="View Reports" Value="reports" />
                            <RadzenDropDownItem TValue="string" Text="System Health" Value="health" />
                            <RadzenDropDownItem TValue="string" Text="API Documentation" Value="api-docs" />
                        </RadzenDropDown>
                        
                        <!-- Notifications Button -->
                        <RadzenButton Icon="notifications" ButtonStyle="ButtonStyle.Light" Variant="Variant.Text" 
                                      Click="@ShowNotifications" class="rz-border-radius-50 rz-p-2" />
                        
                        <!-- User Profile Menu - Replaced with standard Radzen components -->
                        <RadzenDropDown TValue="string" Style="width: auto; min-width: 150px;" 
                                        Placeholder="@GetUserDisplayName(context.User)"
                                        Change="@OnProfileMenuChange">
                            <RadzenDropDownItem TValue="string" Text="My Profile" Value="profile" />
                            <RadzenDropDownItem TValue="string" Text="Account Settings" Value="settings" />
                            <RadzenDropDownItem TValue="string" Text="Change Password" Value="change-password" />
                            <RadzenDropDownItem TValue="string" Text="Help & Support" Value="help" />
                            <RadzenDropDownItem TValue="string" Text="About" Value="about" />
                            <RadzenDropDownItem TValue="string" Text="Logout" Value="logout" />
                        </RadzenDropDown>
                    </Authorized>
                    <NotAuthorized>
                        <RadzenButton Text="Login" Icon="login" ButtonStyle="ButtonStyle.Primary" 
                                      Click="@(() => Navigation.NavigateTo("/login"))" />
                    </NotAuthorized>
                </AuthorizeView>
            </RadzenStack>
        </RadzenStack>
    </RadzenHeader>
    
    <RadzenSidebar @bind-Expanded="sidebarExpanded" Responsive="true" style="width: 300px;">
        <NavMenu @rendermode="InteractiveServer" />
    </RadzenSidebar>
    
    <RadzenBody>
        <RadzenContentContainer Name="main" class="rz-p-4">
            @Body
        </RadzenContentContainer>
    </RadzenBody>
    
    <RadzenFooter>
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" 
                     JustifyContent="JustifyContent.SpaceBetween" class="rz-px-4 rz-py-2">
            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                © @DateTime.Now.Year MrWho Administration. All rights reserved.
            </RadzenText>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="16px" class="rz-display-none rz-display-md-flex">
                <RadzenLink Text="Privacy Policy" Path="/privacy" class="rz-font-size-sm" />
                <RadzenLink Text="Terms of Service" Path="/terms" class="rz-font-size-sm" />
                <RadzenLink Text="Support" Path="/support" class="rz-font-size-sm" />
            </RadzenStack>
        </RadzenStack>
    </RadzenFooter>
</RadzenLayout>

@code {
    private bool sidebarExpanded = true;

    [Inject] private NavigationManager Navigation { get; set; } = default!;
    [Inject] private NotificationService NotificationService { get; set; } = default!;

    private string GetUserDisplayName(System.Security.Claims.ClaimsPrincipal user)
    {
        return user.FindFirst("name")?.Value ??
               user.FindFirst("preferred_username")?.Value ??
               user.FindFirst("given_name")?.Value ??
               user.FindFirst("email")?.Value ??
               user.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value ??
               user.Identity?.Name ??
               "Admin User";
    }

    private string GetUserEmail(System.Security.Claims.ClaimsPrincipal user)
    {
        return user.FindFirst("email")?.Value ??
               user.FindFirst("preferred_username")?.Value ??
               "admin@mrwho.com";
    }

    private void ShowNotifications()
    {
        NotificationService.Notify(NotificationSeverity.Info, "Notifications", 
            "You have no new notifications at this time.", duration: 4000);
    }

    private void OnQuickActionChange(object value)
    {
        if (value?.ToString() is string action)
        {
            switch (action)
            {
                case "add-user":
                    Navigation.NavigateTo("/users/add");
                    break;
                case "reports":
                    Navigation.NavigateTo("/reports");
                    break;
                case "health":
                    Navigation.NavigateTo("/system/health");
                    break;
                case "api-docs":
                    Navigation.NavigateTo("/dev/api-docs");
                    break;
            }
        }
    }

    private void OnProfileMenuChange(object value)
    {
        if (value?.ToString() is string action)
        {
            switch (action)
            {
                case "profile":
                    Navigation.NavigateTo("/profile");
                    break;
                case "settings":
                    Navigation.NavigateTo("/account/settings");
                    break;
                case "change-password":
                    Navigation.NavigateTo("/account/change-password");
                    break;
                case "help":
                    Navigation.NavigateTo("/help");
                    break;
                case "about":
                    Navigation.NavigateTo("/about");
                    break;
                case "logout":
                    Navigation.NavigateTo("/logout");
                    break;
            }
        }
    }
}
