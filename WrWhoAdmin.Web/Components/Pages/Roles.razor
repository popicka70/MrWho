@page "/users/roles"
@attribute [Authorize]
@rendermode InteractiveServer
@using MrWhoAdmin.Web.Models
@using MrWhoAdmin.Web.Services
@inject NavigationManager Navigation
@inject ILogger<Roles> Logger
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject IRolesApiService RolesApi

<PageTitle>Roles - MrWho Admin</PageTitle>

<RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-8">
    <RadzenIcon Icon="security" class="rz-me-1" />
    Roles Management
</RadzenText>

<RadzenCard class="rz-my-4">
    <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mb-4">
        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
            <RadzenTextBox @bind-Value="@searchTerm" Placeholder="Search roles..." Style="width: 300px;" />
            <RadzenButton Click="@LoadRoles" Icon="search" ButtonStyle="ButtonStyle.Secondary" />
        </RadzenStack>
        <RadzenButton Click="@ShowCreateRoleForm" Icon="add_circle" ButtonStyle="ButtonStyle.Primary" Text="Add Role" />
    </RadzenStack>

    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
    }
    else if (roles.Any())
    {
        <RadzenDataGrid Data="@roles" TItem="RoleDto" AllowPaging="true" PageSize="10" AllowSorting="true">
            <Columns>
                <RadzenDataGridColumn TItem="RoleDto" Property="Name" Title="Role Name" Width="200px">
                    <Template Context="role">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenIcon Icon="security" Style="color: var(--rz-primary);" />
                            <RadzenText Text="@role.Name" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="RoleDto" Property="Description" Title="Description">
                    <Template Context="role">
                        <RadzenText Text="@(role.Description ?? "No description")" />
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="RoleDto" Property="IsEnabled" Title="Status" Width="120px">
                    <Template Context="role">
                        <RadzenBadge BadgeStyle="@(role.IsEnabled ? BadgeStyle.Success : BadgeStyle.Danger)" 
                                    Text="@(role.IsEnabled ? "Enabled" : "Disabled")" />
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="RoleDto" Property="CreatedAt" Title="Created" Width="150px">
                    <Template Context="role">
                        <RadzenText Text="@role.CreatedAt.ToString("MMM dd, yyyy")" />
                    </Template>
                </RadzenDataGridColumn>
                
                <RadzenDataGridColumn TItem="RoleDto" Title="Actions" Width="350px" Sortable="false">
                    <Template Context="role">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                            <RadzenButton Click="@(() => EditRole(role))" Icon="edit" Size="ButtonSize.Medium" 
                                         ButtonStyle="ButtonStyle.Light" Text="Edit" Style="min-width: 80px;" />
                            <RadzenButton Click="@(() => ViewRoleUsers(role.Id))" Icon="people" Size="ButtonSize.Medium" 
                                         ButtonStyle="ButtonStyle.Info" Text="Users" Style="min-width: 80px;" />
                            <RadzenButton Click="@(async () => await DeleteRole(role))" Icon="delete" Size="ButtonSize.Medium" 
                                         ButtonStyle="ButtonStyle.Danger" Text="Delete" Style="min-width: 80px;" />
                        </RadzenStack>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    }
    else
    {
        <RadzenAlert AlertStyle="AlertStyle.Info">
            <RadzenText>No roles found. Click "Add Role" to create your first role.</RadzenText>
        </RadzenAlert>
    }
</RadzenCard>

@if (showCreateForm)
{
    <RadzenCard class="rz-my-4">
        <RadzenText TextStyle="TextStyle.H6">Create New Role</RadzenText>
        <RadzenStack Gap="1rem" class="rz-mt-3">
            <RadzenFormField Text="Role Name">
                <RadzenTextBox @bind-Value="@newRoleName" Style="width: 100%;" />
            </RadzenFormField>
            <RadzenFormField Text="Description">
                <RadzenTextArea @bind-Value="@newRoleDescription" Style="width: 100%;" />
            </RadzenFormField>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                <RadzenButton Click="@CreateRole" Icon="save" ButtonStyle="ButtonStyle.Primary" Text="Create Role" IsBusy="@isCreating" />
                <RadzenButton Click="@CancelCreate" Icon="cancel" ButtonStyle="ButtonStyle.Secondary" Text="Cancel" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
}

@if (showEditForm)
{
    <RadzenCard class="rz-my-4">
        <RadzenText TextStyle="TextStyle.H6">Edit Role: @editingRole?.Name</RadzenText>
        <RadzenStack Gap="1rem" class="rz-mt-3">
            <RadzenFormField Text="Role Name">
                <RadzenTextBox @bind-Value="@editRoleName" Style="width: 100%;" />
            </RadzenFormField>
            <RadzenFormField Text="Description">
                <RadzenTextArea @bind-Value="@editRoleDescription" Style="width: 100%;" />
            </RadzenFormField>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center" class="rz-my-2">
                <RadzenText>Status:</RadzenText>
                <RadzenCheckBox @bind-Value="@editRoleEnabled" />
                <RadzenLabel Text="Role is enabled" />
            </RadzenStack>
            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                <RadzenButton Click="@UpdateRole" Icon="save" ButtonStyle="ButtonStyle.Primary" Text="Update Role" IsBusy="@isUpdating" />
                <RadzenButton Click="@CancelEdit" Icon="cancel" ButtonStyle="ButtonStyle.Secondary" Text="Cancel" />
            </RadzenStack>
        </RadzenStack>
    </RadzenCard>
}

@if (showUsersModal)
{
    <RadzenDialog>
        <RadzenStack Gap="1rem">
            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                <RadzenText TextStyle="TextStyle.H6">
                    Users with Role: @selectedRoleForUsers?.Name
                </RadzenText>
                <RadzenButton Click="@CloseUsersModal" Icon="close" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" />
            </RadzenStack>

            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mb-3">
                <RadzenTextBox @bind-Value="@userSearchTerm" Placeholder="Search users..." Style="width: 300px;" />
                <RadzenButton Click="@(async () => await LoadRoleUsers())" Icon="search" ButtonStyle="ButtonStyle.Secondary" />
            </RadzenStack>

            @if (isLoadingUsers)
            {
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
                <RadzenText>Loading users...</RadzenText>
            }
            else if (roleUsers.Any())
            {
                <RadzenDataGrid Data="@roleUsers" TItem="UserDto" AllowPaging="true" PageSize="5" AllowSorting="true" Style="height: 400px;">
                    <Columns>
                        <RadzenDataGridColumn TItem="UserDto" Property="UserName" Title="Username" Width="200px">
                            <Template Context="user">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                    <RadzenIcon Icon="person" Style="color: var(--rz-primary);" />
                                    <RadzenText Text="@user.UserName" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                        
                        <RadzenDataGridColumn TItem="UserDto" Property="Email" Title="Email" />
                        
                        <RadzenDataGridColumn TItem="UserDto" Property="EmailConfirmed" Title="Status" Width="120px">
                            <Template Context="user">
                                <RadzenBadge BadgeStyle="@(user.EmailConfirmed ? BadgeStyle.Success : BadgeStyle.Warning)" 
                                            Text="@(user.EmailConfirmed ? "Confirmed" : "Pending")" />
                            </Template>
                        </RadzenDataGridColumn>
                        
                        <RadzenDataGridColumn TItem="UserDto" Title="Actions" Width="150px" Sortable="false">
                            <Template Context="user">
                                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem">
                                    <RadzenButton Click="@(() => ViewUserDetails(user.Id))" Icon="visibility" Size="ButtonSize.Small" 
                                                 ButtonStyle="ButtonStyle.Light" Text="View" />
                                    <RadzenButton Click="@(async () => await RemoveUserFromRole(user, selectedRoleForUsers!))" Icon="remove" Size="ButtonSize.Small" 
                                                 ButtonStyle="ButtonStyle.Danger" Text="Remove" />
                                </RadzenStack>
                            </Template>
                        </RadzenDataGridColumn>
                    </Columns>
                </RadzenDataGrid>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info">
                    <RadzenText>No users found with this role.</RadzenText>
                </RadzenAlert>
            }

            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.End" Gap="1rem">
                <RadzenButton Click="@CloseUsersModal" Icon="close" ButtonStyle="ButtonStyle.Secondary" Text="Close" />
            </RadzenStack>
        </RadzenStack>
    </RadzenDialog>
}

@code {
    private List<RoleDto> roles = new();
    private bool isLoading = false;
    private string searchTerm = "";
    private bool showCreateForm = false;
    private bool showEditForm = false;
    private bool isCreating = false;
    private bool isUpdating = false;
    private string newRoleName = "";
    private string newRoleDescription = "";
    private RoleDto? editingRole;
    private string editRoleName = "";
    private string editRoleDescription = "";
    private bool editRoleEnabled = true;

    private List<UserDto> roleUsers = new();
    private bool isLoadingUsers = false;
    private string userSearchTerm = "";
    private bool showUsersModal = false;
    private RoleDto? selectedRoleForUsers = null;

    protected override async Task OnInitializedAsync()
    {
        await LoadRoles();
    }

    private async Task LoadRoles()
    {
        isLoading = true;
        try
        {
            var result = await RolesApi.GetRolesAsync(page: 1, pageSize: 100, search: searchTerm);
            
            if (result != null)
            {
                roles = result.Items;
                Logger.LogInformation("Loaded {RoleCount} roles from API", roles.Count);
            }
            else
            {
                roles = new List<RoleDto>();
                NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Failed to load roles from API");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading roles");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load roles");
            roles = new List<RoleDto>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ShowCreateRoleForm()
    {
        showCreateForm = true;
        showEditForm = false;
        newRoleName = "";
        newRoleDescription = "";
    }

    private void CancelCreate()
    {
        showCreateForm = false;
        newRoleName = "";
        newRoleDescription = "";
    }

    private async Task CreateRole()
    {
        if (string.IsNullOrWhiteSpace(newRoleName))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Role name is required");
            return;
        }

        isCreating = true;
        try
        {
            var request = new CreateRoleRequest
            {
                Name = newRoleName,
                Description = newRoleDescription,
                IsEnabled = true
            };

            var result = await RolesApi.CreateRoleAsync(request);
            
            if (result != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Role '{result.Name}' created successfully");
                await LoadRoles();
                CancelCreate();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to create role");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error creating role");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to create role");
        }
        finally
        {
            isCreating = false;
        }
    }

    private void EditRole(RoleDto role)
    {
        editingRole = role;
        editRoleName = role.Name;
        editRoleDescription = role.Description ?? "";
        editRoleEnabled = role.IsEnabled;
        showEditForm = true;
        showCreateForm = false;
        StateHasChanged();
    }

    private void CancelEdit()
    {
        showEditForm = false;
        editingRole = null;
        editRoleName = "";
        editRoleDescription = "";
        editRoleEnabled = true;
    }

    private async Task UpdateRole()
    {
        if (editingRole == null || string.IsNullOrWhiteSpace(editRoleName))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Role name is required");
            return;
        }

        isUpdating = true;
        try
        {
            var request = new UpdateRoleRequest
            {
                Name = editRoleName,
                Description = editRoleDescription,
                IsEnabled = editRoleEnabled
            };

            var result = await RolesApi.UpdateRoleAsync(editingRole.Id, request);
            
            if (result != null)
            {
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Role '{result.Name}' updated successfully");
                await LoadRoles();
                CancelEdit();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update role");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating role");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update role");
        }
        finally
        {
            isUpdating = false;
        }
    }

    private async Task ViewRoleUsers(string roleId)
    {
        var role = roles.FirstOrDefault(r => r.Id == roleId);
        if (role == null)
        {
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Role not found");
            return;
        }

        selectedRoleForUsers = role;
        userSearchTerm = "";
        showUsersModal = true;
        await LoadRoleUsers();
        StateHasChanged();
    }

    private async Task LoadRoleUsers()
    {
        if (selectedRoleForUsers == null) return;

        isLoadingUsers = true;
        try
        {
            var result = await RolesApi.GetRoleUsersAsync(selectedRoleForUsers.Id, page: 1, pageSize: 50, search: userSearchTerm);
            
            if (result != null)
            {
                roleUsers = result.Items;
                Logger.LogInformation("Loaded {UserCount} users for role '{RoleName}'", roleUsers.Count, selectedRoleForUsers.Name);
            }
            else
            {
                roleUsers = new List<UserDto>();
                NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Failed to load users for this role");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading users for role {RoleId}", selectedRoleForUsers.Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load role users");
            roleUsers = new List<UserDto>();
        }
        finally
        {
            isLoadingUsers = false;
            StateHasChanged();
        }
    }

    private void CloseUsersModal()
    {
        showUsersModal = false;
        selectedRoleForUsers = null;
        roleUsers.Clear();
        userSearchTerm = "";
        StateHasChanged();
    }

    private void ViewUserDetails(string userId)
    {
        CloseUsersModal();
        Navigation.NavigateTo($"/users/edit/{userId}");
    }

    private async Task RemoveUserFromRole(UserDto user, RoleDto role)
    {
        var result = await DialogService.Confirm(
            $"Are you sure you want to remove user '{user.UserName}' from role '{role.Name}'?", 
            "Remove User from Role", 
            new ConfirmOptions() { 
                OkButtonText = "Remove", 
                CancelButtonText = "Cancel" 
            });
        
        if (result == true)
        {
            try
            {
                var success = await RolesApi.RemoveRoleAsync(user.Id, role.Id);
                
                if (success)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "User Removed", 
                        $"User '{user.UserName}' has been removed from role '{role.Name}'");
                    await LoadRoleUsers(); // Refresh the list
                }
                else
                {
                    NotificationService.Notify(NotificationSeverity.Error, "Error", 
                        $"Failed to remove user '{user.UserName}' from role '{role.Name}'");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error removing user {UserId} from role {RoleId}", user.Id, role.Id);
                NotificationService.Notify(NotificationSeverity.Error, "Error", 
                    $"An error occurred while removing user from role: {ex.Message}");
            }
        }
    }

    private async Task DeleteRole(RoleDto role)
    {
        // Prevent deletion of critical system roles
        var protectedRoles = new[] { "Administrator", "User" };
        if (protectedRoles.Contains(role.Name))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Cannot Delete", 
                $"The '{role.Name}' role is protected and cannot be deleted as it's required for system operation.");
            return;
        }

        var result = await DialogService.Confirm(
            $"Are you sure you want to delete the role '{role.Name}'?\n\nThis action cannot be undone and will remove the role from all users who have it assigned.", 
            "Delete Role", 
            new ConfirmOptions() { 
                OkButtonText = "Delete", 
                CancelButtonText = "Cancel" 
            });
        
        if (result == true)
        {
            try
            {
                Logger.LogInformation("Attempting to delete role '{RoleName}' with ID '{RoleId}'", role.Name, role.Id);
                
                var success = await RolesApi.DeleteRoleAsync(role.Id);
                
                if (success)
                {
                    NotificationService.Notify(NotificationSeverity.Success, "Role Deleted", 
                        $"Role '{role.Name}' has been deleted successfully");
                    Logger.LogInformation("Successfully deleted role '{RoleName}'", role.Name);
                    await LoadRoles();
                }
                else
                {
                    Logger.LogWarning("API returned false when attempting to delete role '{RoleName}'", role.Name);
                    NotificationService.Notify(NotificationSeverity.Error, "Delete Failed", 
                        $"Failed to delete role '{role.Name}'. The role might be in use by existing users or there was a server error.");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Exception occurred while deleting role '{RoleName}' with ID '{RoleId}'", role.Name, role.Id);
                NotificationService.Notify(NotificationSeverity.Error, "Delete Error", 
                    $"An error occurred while deleting role '{role.Name}': {ex.Message}");
            }
        }
        else
        {
            Logger.LogInformation("User cancelled deletion of role '{RoleName}'", role.Name);
        }
    }
}