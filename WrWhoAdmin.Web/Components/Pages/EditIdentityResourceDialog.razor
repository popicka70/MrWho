@inject IIdentityResourcesApiService IdentityResourcesApi
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ILogger<EditIdentityResourceDialog> Logger

<RadzenStack Gap="1rem">
    <RadzenFormField Text="Name" Variant="Variant.Outlined">
        <RadzenTextBox Value="@IdentityResource.Name" Disabled="true" Style="width: 100%;" />
        <RadzenText TextStyle="TextStyle.Caption" class="rz-text-disabled-color">Name cannot be changed</RadzenText>
    </RadzenFormField>

    <RadzenFormField Text="Display Name" Variant="Variant.Outlined">
        <RadzenTextBox @bind-Value="@request.DisplayName" MaxLength="200" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenFormField Text="Description" Variant="Variant.Outlined">
        <RadzenTextArea @bind-Value="@request.Description" MaxLength="1000" Rows="3" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenRow Gap="1rem">
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@isEnabled" Name="isEnabled" />
            <RadzenLabel Text="Enabled" Component="isEnabled" Style="margin-left: 8px;" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@isRequired" Name="isRequired" />
            <RadzenLabel Text="Required" Component="isRequired" Style="margin-left: 8px;" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@showInDiscoveryDocument" Name="showInDiscovery" />
            <RadzenLabel Text="Show in Discovery" Component="showInDiscovery" Style="margin-left: 8px;" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@emphasize" Name="emphasize" />
            <RadzenLabel Text="Emphasize" Component="emphasize" Style="margin-left: 8px;" />
        </RadzenColumn>
    </RadzenRow>

    <RadzenFieldset Text="User Claims">
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenTextBox @bind-Value="@newClaim" Placeholder="Enter claim type (e.g., email, name)" Style="width: 300px;" />
                <RadzenButton Text="Add Claim" Icon="add" ButtonStyle="ButtonStyle.Light" 
                            Click="@(async () => await AddClaim())" Disabled="@string.IsNullOrWhiteSpace(newClaim)" />
            </RadzenStack>

            @if (userClaims?.Any() == true)
            {
                <RadzenDataList Data="@userClaims" TItem="string" WrapItems="true">
                    <Template Context="claim">
                        <RadzenCard class="rz-p-2" Style="margin: 4px;">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenText Text="@claim" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" 
                                            Click="@(async () => await RemoveClaim(claim))" />
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="false">
                    <RadzenText>No claims added yet. Add claims that will be included in this identity resource.</RadzenText>
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenFieldset>

    <RadzenFieldset Text="Properties">
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenTextBox @bind-Value="@newPropertyKey" Placeholder="Property key" Style="width: 200px;" />
                <RadzenTextBox @bind-Value="@newPropertyValue" Placeholder="Property value" Style="width: 200px;" />
                <RadzenButton Text="Add Property" Icon="add" ButtonStyle="ButtonStyle.Light" 
                            Click="@(async () => await AddProperty())" 
                            Disabled="@(string.IsNullOrWhiteSpace(newPropertyKey) || string.IsNullOrWhiteSpace(newPropertyValue))" />
            </RadzenStack>

            @if (properties?.Any() == true)
            {
                <RadzenDataList Data="@properties" TItem="KeyValuePair<string, string>" WrapItems="true">
                    <Template Context="property">
                        <RadzenCard class="rz-p-2" Style="margin: 4px;">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenText Text="@($"{property.Key}: {property.Value}")" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" 
                                            Click="@(async () => await RemoveProperty(property.Key))" />
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="false">
                    <RadzenText>No properties added yet. Properties are optional metadata for this identity resource.</RadzenText>
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenFieldset>

    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mt-4">
        <RadzenButton Text="Update" Icon="save" ButtonStyle="ButtonStyle.Primary" 
                    Click="@(async () => await UpdateIdentityResource())" IsBusy="@isUpdating" />
        <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Secondary" 
                    Click="@(async () => await Cancel())" />
    </RadzenStack>
</RadzenStack>

@code {
    [Parameter] public IdentityResourceDto IdentityResource { get; set; } = new();

    private UpdateIdentityResourceRequest request = new();
    private List<string> userClaims = new();
    private Dictionary<string, string> properties = new();
    private string newClaim = string.Empty;
    private string newPropertyKey = string.Empty;
    private string newPropertyValue = string.Empty;
    private bool isUpdating = false;

    // Individual properties for checkboxes
    private bool isEnabled;
    private bool isRequired;
    private bool showInDiscoveryDocument;
    private bool emphasize;

    protected override void OnInitialized()
    {
        request = new UpdateIdentityResourceRequest
        {
            DisplayName = IdentityResource.DisplayName,
            Description = IdentityResource.Description
        };

        userClaims = new List<string>(IdentityResource.UserClaims ?? new List<string>());
        properties = new Dictionary<string, string>(IdentityResource.Properties ?? new Dictionary<string, string>());

        isEnabled = IdentityResource.IsEnabled;
        isRequired = IdentityResource.IsRequired;
        showInDiscoveryDocument = IdentityResource.ShowInDiscoveryDocument;
        emphasize = IdentityResource.Emphasize;
    }

    private async Task AddClaim()
    {
        if (!string.IsNullOrWhiteSpace(newClaim) && userClaims != null && !userClaims.Contains(newClaim))
        {
            userClaims.Add(newClaim.Trim());
            newClaim = string.Empty;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task RemoveClaim(string claim)
    {
        userClaims?.Remove(claim);
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task AddProperty()
    {
        if (!string.IsNullOrWhiteSpace(newPropertyKey) && !string.IsNullOrWhiteSpace(newPropertyValue) 
            && properties != null && !properties.ContainsKey(newPropertyKey.Trim()))
        {
            properties[newPropertyKey.Trim()] = newPropertyValue.Trim();
            newPropertyKey = string.Empty;
            newPropertyValue = string.Empty;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task RemoveProperty(string key)
    {
        properties?.Remove(key);
        StateHasChanged();
        await Task.CompletedTask;
    }

    private async Task UpdateIdentityResource()
    {
        try
        {
            // Validate required services
            if (IdentityResourcesApi == null)
            {
                Logger?.LogError("IdentityResourcesApi service is null");
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Service Error",
                    Detail = "Identity Resources API service is not available",
                    Duration = 5000
                });
                return;
            }

            if (request == null)
            {
                Logger?.LogError("Request object is null");
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Request data is not initialized",
                    Duration = 5000
                });
                return;
            }

            isUpdating = true;
            StateHasChanged();

            // Update the request with current values
            request.IsEnabled = isEnabled;
            request.IsRequired = isRequired;
            request.ShowInDiscoveryDocument = showInDiscoveryDocument;
            request.Emphasize = emphasize;
            request.UserClaims = userClaims;
            request.Properties = properties;

            var result = await IdentityResourcesApi.UpdateIdentityResourceAsync(IdentityResource.Id, request);
            if (result != null)
            {
                DialogService?.Close(true);
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Identity resource updated successfully",
                    Duration = 5000
                });
            }
            else
            {
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Failed to update identity resource - API returned null",
                    Duration = 5000
                });
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error updating identity resource");
            NotificationService?.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to update identity resource: {ex.Message}",
                Duration = 5000
            });
        }
        finally
        {
            isUpdating = false;
            StateHasChanged();
        }
    }

    private async Task Cancel()
    {
        DialogService?.Close(false);
        await Task.CompletedTask;
    }
}