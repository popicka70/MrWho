@page "/"
@attribute [Authorize]
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject IRealmsApiService RealmsApi
@inject IClientsApiService ClientsApi
@inject IUsersApiService UsersApi
@inject ILogger<Home> Logger

<PageTitle>Dashboard - MrWho Administration</PageTitle>

<RadzenText TextStyle="TextStyle.H2" class="rz-mb-4">
    <RadzenIcon Icon="dashboard" class="rz-me-2" />
    MrWho Administration Dashboard
</RadzenText>

<RadzenRow Gap="2rem">
    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
        <RadzenCard class="rz-text-align-center rz-p-4" Style="min-height: 150px;">
            <RadzenIcon Icon="domain" class="rz-color-primary" Style="font-size: 3rem;" />
            <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">@totalRealms</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Active Realms</RadzenText>
            <RadzenButton Click="@(() => Navigation.NavigateTo("/realms"))" 
                         ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                         Text="Manage" class="rz-mt-2" />
        </RadzenCard>
    </RadzenColumn>
    
    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
        <RadzenCard class="rz-text-align-center rz-p-4" Style="min-height: 150px;">
            <RadzenIcon Icon="apps" class="rz-color-success" Style="font-size: 3rem;" />
            <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">@totalClients</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">OIDC Clients</RadzenText>
            <RadzenButton Click="@(() => Navigation.NavigateTo("/clients"))" 
                         ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                         Text="Manage" class="rz-mt-2" />
        </RadzenCard>
    </RadzenColumn>
    
    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
        <RadzenCard class="rz-text-align-center rz-p-4" Style="min-height: 150px;">
            <RadzenIcon Icon="people" class="rz-color-info" Style="font-size: 3rem;" />
            <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">@totalUsers</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">Registered Users</RadzenText>
            <RadzenButton Click="@(() => Navigation.NavigateTo("/users"))" 
                         ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                         Text="Manage" class="rz-mt-2" />
        </RadzenCard>
    </RadzenColumn>
    
    <RadzenColumn Size="12" SizeMD="6" SizeLG="3">
        <RadzenCard class="rz-text-align-center rz-p-4" Style="min-height: 150px;">
            <RadzenIcon Icon="verified_user" class="rz-color-warning" Style="font-size: 3rem;" />
            <RadzenText TextStyle="TextStyle.H4" class="rz-mt-2">Online</RadzenText>
            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">System Status</RadzenText>
            <RadzenButton Click="@(() => Navigation.NavigateTo("/debug-api"))" 
                         ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" 
                         Text="Debug API" class="rz-mt-2" />
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

<RadzenRow Gap="2rem" class="rz-mt-4">
    <RadzenColumn Size="12" SizeMD="8">
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">
                <RadzenIcon Icon="timeline" class="rz-me-1" />
                Recent Activity
            </RadzenText>
            
            @if (isLoadingActivity)
            {
                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                <RadzenText class="rz-ml-2">Loading recent activity...</RadzenText>
            }
            else if (hasApiError)
            {
                <RadzenAlert AlertStyle="AlertStyle.Warning">
                    <RadzenText>Unable to load recent activity. API connection may be unavailable.</RadzenText>
                    <RadzenButton Click="@LoadDashboardData" Text="Retry" ButtonStyle="ButtonStyle.Light" Size="ButtonSize.Small" class="rz-mt-2" />
                </RadzenAlert>
            }
            else
            {
                <RadzenDataList Data="@recentActivity" TItem="ActivityItem">
                    <Template>
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.Center" class="rz-py-2">
                            <RadzenIcon Icon="@context.Icon" Style="@($"color: {context.Color}")" />
                            <RadzenStack Gap="0.2rem">
                                <RadzenText>@context.Description</RadzenText>
                                <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">@context.Timestamp.ToString("MMM dd, yyyy HH:mm")</RadzenText>
                            </RadzenStack>
                        </RadzenStack>
                    </Template>
                </RadzenDataList>
            }
        </RadzenCard>
    </RadzenColumn>
    
    <RadzenColumn Size="12" SizeMD="4">
        <RadzenCard>
            <RadzenText TextStyle="TextStyle.H6" class="rz-mb-3">
                <RadzenIcon Icon="info" class="rz-me-1" />
                System Information
            </RadzenText>
            
            <RadzenStack Gap="1rem">
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText>API Status:</RadzenText>
                    <RadzenBadge BadgeStyle="@(hasApiError ? BadgeStyle.Danger : BadgeStyle.Success)" 
                                Text="@(hasApiError ? "Offline" : "Online")" />
                </RadzenStack>
                
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText>Version:</RadzenText>
                    <RadzenText>1.0.0</RadzenText>
                </RadzenStack>
                
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween">
                    <RadzenText>Environment:</RadzenText>
                    <RadzenText>Development</RadzenText>
                </RadzenStack>
            </RadzenStack>
        </RadzenCard>
    </RadzenColumn>
</RadzenRow>

@code {
    private int totalRealms = 0;
    private int totalClients = 0;
    private int totalUsers = 0;
    private bool isLoadingActivity = true;
    private bool hasApiError = false;
    private List<ActivityItem> recentActivity = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        isLoadingActivity = true;
        hasApiError = false;
        
        try
        {
            // Load dashboard statistics from APIs
            var realmsTask = RealmsApi.GetRealmsAsync(page: 1, pageSize: 1);
            var clientsTask = ClientsApi.GetClientsAsync(page: 1, pageSize: 1);
            var usersTask = UsersApi.GetUsersAsync(page: 1, pageSize: 1);

            await Task.WhenAll(realmsTask, clientsTask, usersTask);

            var realmsResult = await realmsTask;
            var clientsResult = await clientsTask;
            var usersResult = await usersTask;

            if (realmsResult != null)
                totalRealms = realmsResult.TotalCount;
            else
                hasApiError = true;

            if (clientsResult != null)
                totalClients = clientsResult.TotalCount;
            else
                hasApiError = true;

            if (usersResult != null)
                totalUsers = usersResult.TotalCount;
            else
                hasApiError = true;

            // Generate some mock recent activity for now
            recentActivity = new List<ActivityItem>
            {
                new() { Icon = "domain", Color = "var(--rz-primary)", Description = $"Loaded {totalRealms} realms from API", Timestamp = DateTime.Now.AddMinutes(-5) },
                new() { Icon = "apps", Color = "var(--rz-success)", Description = $"Found {totalClients} OIDC clients", Timestamp = DateTime.Now.AddMinutes(-10) },
                new() { Icon = "people", Color = "var(--rz-info)", Description = $"{totalUsers} users in system", Timestamp = DateTime.Now.AddMinutes(-15) },
                new() { Icon = "login", Color = "var(--rz-warning)", Description = "Admin user logged in", Timestamp = DateTime.Now.AddMinutes(-20) }
            };

            Logger.LogInformation("Dashboard loaded - Realms: {Realms}, Clients: {Clients}, Users: {Users}, HasError: {HasError}", 
                totalRealms, totalClients, totalUsers, hasApiError);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading dashboard data");
            hasApiError = true;
            
            // Set fallback values
            totalRealms = 0;
            totalClients = 0;
            totalUsers = 0;
            
            recentActivity = new List<ActivityItem>
            {
                new() { Icon = "error", Color = "var(--rz-danger)", Description = "Failed to load data from API", Timestamp = DateTime.Now }
            };
        }
        finally
        {
            isLoadingActivity = false;
            StateHasChanged();
        }
    }

    private class ActivityItem
    {
        public string Icon { get; set; } = "";
        public string Color { get; set; } = "";
        public string Description { get; set; } = "";
        public DateTime Timestamp { get; set; }
    }
}
