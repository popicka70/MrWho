@page "/users/add"
@page "/users/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject NotificationService NotificationService  
@inject DialogService DialogService
@inject IUsersApiService UsersApiService
@inject IRolesApiService RolesApiService
@inject ILogger<EditUser> Logger

<PageTitle>@(IsEdit ? "Edit User" : "Add User") - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/users" Text="Users" />
        <RadzenBreadCrumbItem Text="@(IsEdit ? "Edit" : "Add")" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="@(IsEdit ? "edit" : "person_add")" class="rz-me-1" />
        @(IsEdit ? "Edit User" : "Add New User")
    </RadzenText>
</RadzenStack>

<RadzenCard class="rz-my-4">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading user data...</RadzenText>
    }
    else
    {
        <RadzenTemplateForm Data="@model" TItem="CreateUserRequest" Submit="@OnSave">
            <RadzenStack Gap="2rem">
                <!-- Basic Information -->
                <RadzenFieldset Text="Basic Information">
                    <RadzenStack Gap="1rem">
                        <RadzenRow>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Email Address" Variant="Variant.Outlined">
                                    <RadzenTextBox @bind-Value="@model.Email" 
                                                  Placeholder="user@example.com" 
                                                  Style="width: 100%;" 
                                                  Disabled="@IsEdit" />
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        @(IsEdit ? "Email cannot be changed after creation" : "This will be used for login")
                                    </RadzenText>
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Username" Variant="Variant.Outlined">
                                    <RadzenTextBox @bind-Value="@model.UserName" 
                                                  Placeholder="Enter username" 
                                                  Style="width: 100%;" 
                                                  Disabled="@IsEdit" />
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        @(IsEdit ? "Username cannot be changed after creation" : "Leave blank to use email as username")
                                    </RadzenText>
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>

                        @if (!IsEdit)
                        {
                            <RadzenRow>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Password" Variant="Variant.Outlined">
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Stretch">
                                            <RadzenTextBox @bind-Value="@model.Password" 
                                                          Type="@(showPassword ? "text" : "password")"
                                                          Placeholder="Enter password" 
                                                          Style="flex: 1;" />
                                            <RadzenButton Icon="@(showPassword ? "visibility_off" : "visibility")" 
                                                         ButtonStyle="ButtonStyle.Light" 
                                                         Click="@(() => showPassword = !showPassword)" />
                                            <RadzenButton Icon="refresh" 
                                                         ButtonStyle="ButtonStyle.Secondary" 
                                                         Text="Generate" 
                                                         Click="@GeneratePassword" />
                                        </RadzenStack>
                                        <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                            Minimum 8 characters with mixed case, numbers, and symbols
                                        </RadzenText>
                                    </RadzenFormField>
                                </RadzenColumn>
                                <RadzenColumn Size="12" SizeMD="6">
                                    <RadzenFormField Text="Confirm Password" Variant="Variant.Outlined">
                                        <RadzenTextBox @bind-Value="@confirmPassword" 
                                                      Type="password"
                                                      Placeholder="Confirm password" 
                                                      Style="width: 100%;" />
                                    </RadzenFormField>
                                </RadzenColumn>
                            </RadzenRow>
                        }

                        <RadzenFormField Text="Phone Number" Variant="Variant.Outlined">
                            <RadzenTextBox @bind-Value="@model.PhoneNumber" 
                                          Placeholder="+1 (555) 123-4567" 
                                          Style="width: 100%;" />
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Optional - used for two-factor authentication
                            </RadzenText>
                        </RadzenFormField>
                    </RadzenStack>
                </RadzenFieldset>

                <!-- Account Settings -->
                <RadzenFieldset Text="Account Settings">
                    <RadzenStack Gap="1rem">
                        <RadzenRow>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenLabel Text="Email Status" class="rz-text-align-left" />
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                        <RadzenCheckBox @bind-Value="@emailConfirmed" />
                                        <RadzenLabel Text="Email is confirmed" class="rz-ml-1" />
                                    </RadzenStack>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Confirmed users can receive email notifications
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenStack Gap="0.5rem">
                                    <RadzenLabel Text="Phone Status" class="rz-text-align-left" />
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                        <RadzenCheckBox @bind-Value="@phoneConfirmed" />
                                        <RadzenLabel Text="Phone number is confirmed" class="rz-ml-1" />
                                    </RadzenStack>
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Required for SMS-based two-factor authentication
                                    </RadzenText>
                                </RadzenStack>
                            </RadzenColumn>
                        </RadzenRow>

                        <RadzenStack Gap="0.5rem">
                            <RadzenLabel Text="Two-Factor Authentication" class="rz-text-align-left" />
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenCheckBox @bind-Value="@twoFactorEnabled" />
                                <RadzenLabel Text="Enable two-factor authentication" class="rz-ml-1" />
                            </RadzenStack>
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                Requires additional verification during login
                            </RadzenText>
                        </RadzenStack>
                    </RadzenStack>
                </RadzenFieldset>

                @if (IsEdit)
                {
                    <!-- User Roles Management -->
                    <RadzenFieldset Text="User Roles">
                        <RadzenStack Gap="1rem">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                Manage roles assigned to this user
                            </RadzenText>
                            
                            @if (isLoadingRoles)
                            {
                                <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" Size="ProgressBarCircularSize.Small" />
                                <RadzenText TextStyle="TextStyle.Caption">Loading user roles...</RadzenText>
                            }
                            else
                            {
                                <!-- Current User Roles -->
                                <RadzenStack Gap="1rem">
                                    <RadzenText TextStyle="TextStyle.H6">Current Roles</RadzenText>
                                    @if (userRoles.Any())
                                    {
                                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" Wrap="FlexWrap.Wrap">
                                            @foreach (var role in userRoles)
                                            {
                                                <RadzenBadge BadgeStyle="BadgeStyle.Success" class="rz-p-2">
                                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                                        <RadzenIcon Icon="security" />
                                                        <RadzenText Text="@role.Name" />
                                                        <RadzenButton Icon="close" Size="ButtonSize.ExtraSmall" ButtonStyle="ButtonStyle.Danger" 
                                                                     Click="@(async () => await RemoveRoleFromUser(role.Id))" 
                                                                     Disabled="@isManagingRoles" />
                                                    </RadzenStack>
                                                </RadzenBadge>
                                            }
                                        </RadzenStack>
                                    }
                                    else
                                    {
                                        <RadzenAlert AlertStyle="AlertStyle.Info">
                                            <RadzenText>This user has no roles assigned.</RadzenText>
                                        </RadzenAlert>
                                    }
                                </RadzenStack>

                                <!-- Assign New Role -->
                                <RadzenStack Gap="1rem">
                                    <RadzenText TextStyle="TextStyle.H6">Assign New Role</RadzenText>
                                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" AlignItems="AlignItems.End">
                                        <RadzenStack Gap="0.5rem" Style="flex: 1;">
                                            <RadzenLabel Text="Select Role" />
                                            <RadzenDropDown @bind-Value="@selectedRoleId" 
                                                           Data="@availableRoles" 
                                                           TextProperty="Name" 
                                                           ValueProperty="Id" 
                                                           Placeholder="Select a role to assign..."
                                                           Style="width: 100%;"
                                                           Disabled="@isManagingRoles" />
                                        </RadzenStack>
                                        <RadzenButton Icon="add" ButtonStyle="ButtonStyle.Primary" Text="Assign Role" 
                                                     Click="@(async () => await AssignRoleToUser())" 
                                                     Disabled="@(string.IsNullOrEmpty(selectedRoleId) || isManagingRoles)"
                                                     IsBusy="@isManagingRoles" />
                                    </RadzenStack>
                                </RadzenStack>
                            }
                        </RadzenStack>
                    </RadzenFieldset>

                    <!-- Security Actions (Edit Mode Only) -->
                    <RadzenFieldset Text="Security Actions">
                        <RadzenStack Gap="1rem">
                            <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary">
                                Administrative actions for user account management
                            </RadzenText>
                            
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" Wrap="FlexWrap.Wrap">
                                <RadzenButton Icon="lock_reset" ButtonStyle="ButtonStyle.Warning" Text="Reset Password" 
                                             Click="@ResetPassword" IsBusy="@isResettingPassword" />
                                <RadzenButton Icon="email" ButtonStyle="ButtonStyle.Info" Text="Send Confirmation Email" 
                                             Click="@SendConfirmationEmail" IsBusy="@isSendingEmail" />
                                <RadzenButton Icon="@(isLocked ? "lock_open" : "lock")" 
                                             ButtonStyle="@(isLocked ? ButtonStyle.Success : ButtonStyle.Danger)" 
                                             Text="@(isLocked ? "Unlock Account" : "Lock Account")" 
                                             Click="@ToggleLockAccount" IsBusy="@isTogglingLock" />
                                <RadzenButton Icon="logout" ButtonStyle="ButtonStyle.Secondary" Text="Force Logout" 
                                             Click="@ForceLogout" IsBusy="@isForcingLogout" />
                            </RadzenStack>
                        </RadzenStack>
                    </RadzenFieldset>
                }

                <!-- Action Buttons -->
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mt-4">
                    <RadzenButton Click="@Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Text="Cancel" />
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                        @if (IsEdit)
                        {
                            <RadzenButton Click="@DeleteUser" Icon="delete" ButtonStyle="ButtonStyle.Danger" 
                                         Text="Delete User" Disabled="@isSaving" IsBusy="@isDeleting" />
                        }
                        <RadzenButton ButtonType="ButtonType.Submit" Icon="save" ButtonStyle="ButtonStyle.Primary" 
                                     Text="@(IsEdit ? "Update User" : "Create User")" 
                                     IsBusy="@isSaving" Disabled="@isSaving" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    }
</RadzenCard>

@code {
    [Parameter] public string? Id { get; set; }

    private bool IsEdit => !string.IsNullOrEmpty(Id);
    private bool isLoading = false;
    private bool isSaving = false;
    private bool isDeleting = false;
    private bool isResettingPassword = false;
    private bool isSendingEmail = false;
    private bool isTogglingLock = false;
    private bool isForcingLogout = false;
    private bool showPassword = false;
    private bool isLocked = false;
    
    // Role management fields
    private bool isLoadingRoles = false;
    private bool isManagingRoles = false;
    private List<RoleDto> userRoles = new();
    private List<RoleDto> availableRoles = new();
    private string selectedRoleId = "";
    
    private CreateUserRequest model = new();
    private string confirmPassword = "";
    private bool emailConfirmed = false;
    private bool phoneConfirmed = false;
    private bool twoFactorEnabled = false;

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            await LoadUser();
            await LoadUserRoles();
            await LoadAvailableRoles();
        }
        else
        {
            // Set defaults for new user
            emailConfirmed = false;
            phoneConfirmed = false;
            twoFactorEnabled = false;
        }
    }

    private async Task LoadUser()
    {
        isLoading = true;
        try
        {
            var user = await UsersApiService.GetUserAsync(Id!);
            
            if (user != null)
            {
                model.Email = user.Email;
                model.UserName = user.UserName;
                model.PhoneNumber = user.PhoneNumber;
                emailConfirmed = user.EmailConfirmed;
                phoneConfirmed = user.PhoneNumberConfirmed;
                twoFactorEnabled = user.TwoFactorEnabled;
                isLocked = user.LockoutEnd.HasValue && user.LockoutEnd > DateTimeOffset.UtcNow;
                
                Logger.LogInformation("Loaded user {UserId} from API", Id);
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", $"User with ID '{Id}' not found");
                Navigation.NavigateTo("/users");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading user {UserId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load user data");
            Navigation.NavigateTo("/users");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadUserRoles()
    {
        if (!IsEdit) return;

        isLoadingRoles = true;
        try
        {
            var roles = await RolesApiService.GetUserRolesAsync(Id!);
            userRoles = roles ?? new List<RoleDto>();
            
            Logger.LogInformation("Loaded {RoleCount} roles for user {UserId}", userRoles.Count, Id);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading roles for user {UserId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load user roles");
            userRoles = new List<RoleDto>();
        }
        finally
        {
            isLoadingRoles = false;
        }
    }

    private async Task LoadAvailableRoles()
    {
        if (!IsEdit) return;

        try
        {
            var result = await RolesApiService.GetRolesAsync(page: 1, pageSize: 100);
            var allRoles = result?.Items ?? new List<RoleDto>();
            
            // Filter out roles already assigned to the user
            availableRoles = allRoles.Where(r => !userRoles.Any(ur => ur.Id == r.Id)).ToList();
            
            Logger.LogInformation("Loaded {AvailableRoleCount} available roles for assignment", availableRoles.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading available roles");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load available roles");
            availableRoles = new List<RoleDto>();
        }
    }

    private async Task OnSave(CreateUserRequest args)
    {
        if (string.IsNullOrWhiteSpace(model.Email))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation Error", "Email address is required");
            return;
        }

        if (!IsEdit)
        {
            if (string.IsNullOrWhiteSpace(model.Password))
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Validation Error", "Password is required for new users");
                return;
            }

            if (model.Password != confirmPassword)
            {
                NotificationService.Notify(NotificationSeverity.Warning, "Validation Error", "Passwords do not match");
                return;
            }
        }

        isSaving = true;
        try
        {
            // Set username to email if not provided
            if (string.IsNullOrWhiteSpace(model.UserName))
            {
                model.UserName = model.Email;
            }

            // Set confirmation statuses
            model.EmailConfirmed = emailConfirmed;
            model.PhoneNumberConfirmed = phoneConfirmed;
            model.TwoFactorEnabled = twoFactorEnabled;

            if (IsEdit)
            {
                var updateRequest = new UpdateUserRequest
                {
                    Email = model.Email,
                    UserName = model.UserName,
                    PhoneNumber = model.PhoneNumber,
                    EmailConfirmed = emailConfirmed,
                    PhoneNumberConfirmed = phoneConfirmed,
                    TwoFactorEnabled = twoFactorEnabled
                };

                var updatedUser = await UsersApiService.UpdateUserAsync(Id!, updateRequest);
                if (updatedUser == null)
                {
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to update user");
                    return;
                }
            }
            else
            {
                var createdUser = await UsersApiService.CreateUserAsync(model);
                if (createdUser == null)
                {
                    NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to create user");
                    return;
                }
            }

            var action = IsEdit ? "updated" : "created";
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"User '{model.Email}' has been {action} successfully");
            
            Navigation.NavigateTo("/users");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving user");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save user");
        }
        finally
        {
            isSaving = false;
        }
    }

    private void GeneratePassword()
    {
        var random = new Random();
        var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*";
        model.Password = new string(Enumerable.Repeat(chars, 16)
            .Select(s => s[random.Next(s.Length)]).ToArray());
        confirmPassword = model.Password;
        
        NotificationService.Notify(NotificationSeverity.Info, "Generated", "New password generated");
    }

    private async Task ResetPassword()
    {
        if (!IsEdit) return;

        var result = await DialogService.Confirm("Are you sure you want to reset this user's password?", "Reset Password", 
            new ConfirmOptions() { OkButtonText = "Reset", CancelButtonText = "Cancel" });
        
        if (result != true) return;

        isResettingPassword = true;
        try
        {
            // Generate a temporary password
            var tempPassword = GenerateTemporaryPassword();
            var success = await UsersApiService.ResetPasswordAsync(Id!, tempPassword);
            
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, 
                    $"Password has been reset. Temporary password: {tempPassword}");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to reset password");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error resetting password for user {UserId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to reset password");
        }
        finally
        {
            isResettingPassword = false;
        }
    }

    private async Task SendConfirmationEmail()
    {
        if (!IsEdit) return;
        
        isSendingEmail = true;
        try
        {
            var success = await UsersApiService.SendConfirmationEmailAsync(Id!);
            
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, 
                    "Confirmation email has been sent to the user");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to send confirmation email");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error sending confirmation email for user {UserId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to send confirmation email");
        }
        finally
        {
            isSendingEmail = false;
        }
    }

    private async Task ToggleLockAccount()
    {
        if (!IsEdit) return;

        var action = isLocked ? "unlock" : "lock";
        var result = await DialogService.Confirm($"Are you sure you want to {action} this user's account?", 
            $"{char.ToUpper(action[0])}{action[1..]} Account", 
            new ConfirmOptions() { OkButtonText = char.ToUpper(action[0]) + action[1..], CancelButtonText = "Cancel" });
        
        if (result != true) return;

        isTogglingLock = true;
        try
        {
            var lockoutEnd = isLocked ? (DateTimeOffset?)null : DateTimeOffset.UtcNow.AddYears(1);
            var success = await UsersApiService.SetLockoutAsync(Id!, lockoutEnd);
            
            if (success)
            {
                isLocked = !isLocked;
                NotificationService.Notify(NotificationSeverity.Success, 
                    $"User account has been {(isLocked ? "locked" : "unlocked")}");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, $"Failed to {action} account");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error toggling lockout for user {UserId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, $"Failed to {action} account");
        }
        finally
        {
            isTogglingLock = false;
        }
    }

    private async Task ForceLogout()
    {
        if (!IsEdit) return;

        var result = await DialogService.Confirm("Are you sure you want to force logout all sessions for this user?", 
            "Force Logout", new ConfirmOptions() { OkButtonText = "Force Logout", CancelButtonText = "Cancel" });
        
        if (result != true) return;

        isForcingLogout = true;
        try
        {
            var success = await UsersApiService.ForceLogoutAsync(Id!);
            
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, 
                    "All user sessions have been terminated");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to force logout");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error forcing logout for user {UserId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to force logout");
        }
        finally
        {
            isForcingLogout = false;
        }
    }

    private async Task DeleteUser()
    {
        if (!IsEdit) return;

        var result = await DialogService.Confirm($"Are you sure you want to delete the user '{model.Email}'?", 
            "Delete User", new ConfirmOptions() { OkButtonText = "Delete", CancelButtonText = "Cancel" });
        
        if (result != true) return;

        isDeleting = true;
        try
        {
            var success = await UsersApiService.DeleteUserAsync(Id!);
            
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, 
                    $"User '{model.Email}' has been deleted");
                Navigation.NavigateTo("/users");
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete user");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error deleting user {UserId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete user");
        }
        finally
        {
            isDeleting = false;
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/users");
    }

    private string GenerateTemporaryPassword()
    {
        var random = new Random();
        var chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        return new string(Enumerable.Repeat(chars, 12)
            .Select(s => s[random.Next(s.Length)]).ToArray());
    }

    private async Task AssignRoleToUser()
    {
        if (string.IsNullOrEmpty(selectedRoleId) || !IsEdit) return;

        var selectedRole = availableRoles.FirstOrDefault(r => r.Id == selectedRoleId);
        if (selectedRole == null)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Please select a valid role");
            return;
        }

        isManagingRoles = true;
        try
        {
            var success = await RolesApiService.AssignRoleAsync(Id!, selectedRoleId);
            
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, 
                    $"Role '{selectedRole.Name}' assigned to user successfully");
                
                // Refresh the role lists
                await LoadUserRoles();
                await LoadAvailableRoles();
                selectedRoleId = "";
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to assign role to user");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error assigning role {RoleId} to user {UserId}", selectedRoleId, Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to assign role to user");
        }
        finally
        {
            isManagingRoles = false;
        }
    }

    private async Task RemoveRoleFromUser(string roleId)
    {
        if (!IsEdit) return;

        var role = userRoles.FirstOrDefault(r => r.Id == roleId);
        if (role == null)
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Warning", "Role not found");
            return;
        }

        var result = await DialogService.Confirm($"Are you sure you want to remove the role '{role.Name}' from this user?", 
            "Remove Role", new ConfirmOptions() { OkButtonText = "Remove", CancelButtonText = "Cancel" });
        
        if (result != true) return;

        isManagingRoles = true;
        try
        {
            var success = await RolesApiService.RemoveRoleAsync(Id!, roleId);
            
            if (success)
            {
                NotificationService.Notify(NotificationSeverity.Success, 
                    $"Role '{role.Name}' removed from user successfully");
                
                // Refresh the role lists
                await LoadUserRoles();
                await LoadAvailableRoles();
            }
            else
            {
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to remove role from user");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error removing role {RoleId} from user {UserId}", roleId, Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to remove role from user");
        }
        finally
        {
            isManagingRoles = false;
        }
    }
}