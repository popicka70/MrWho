@inject IIdentityResourcesApiService IdentityResourcesApi
@inject IUsersApiService UsersApi
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ILogger<CreateIdentityResourceDialog> Logger
@using MrWho.Shared.Models

<RadzenStack Gap="1rem">
    <RadzenFormField Text="Name" Variant="Variant.Outlined">
        <RadzenTextBox @bind-Value="@request.Name" MaxLength="200" Style="width: 100%;" />
        <RadzenRequiredValidator Component="Name" Text="Name is required" />
    </RadzenFormField>

    <RadzenFormField Text="Display Name" Variant="Variant.Outlined">
        <RadzenTextBox @bind-Value="@request.DisplayName" MaxLength="200" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenFormField Text="Description" Variant="Variant.Outlined">
        <RadzenTextArea @bind-Value="@request.Description" MaxLength="1000" Rows="3" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenRow Gap="1rem">
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@request.IsEnabled" Name="isEnabled" />
            <RadzenLabel Text="Enabled" Component="isEnabled" Style="margin-left: 8px;" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@request.IsRequired" Name="isRequired" />
            <RadzenLabel Text="Required" Component="isRequired" Style="margin-left: 8px;" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@request.ShowInDiscoveryDocument" Name="showInDiscovery" />
            <RadzenLabel Text="Show in Discovery" Component="showInDiscovery" Style="margin-left: 8px;" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@request.Emphasize" Name="emphasize" />
            <RadzenLabel Text="Emphasize" Component="emphasize" Style="margin-left: 8px;" />
        </RadzenColumn>
    </RadzenRow>

    <RadzenFieldset Text="User Claims">
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenDropDown @bind-Value="@selectedClaimType" Data="@availableClaimTypes" 
                               Placeholder="@(isLoadingClaimTypes ? "Loading claim types..." : "Select a claim type...")" 
                               Style="width: 400px;" AllowClear="true" AllowFiltering="true" 
                               FilterCaseSensitivity="FilterCaseSensitivity.CaseInsensitive"
                               Disabled="@isLoadingClaimTypes">
                    <Template Context="item">
                        <RadzenStack Gap="0.25rem">
                            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                                <RadzenText Text="@($"{item.Type}")" Style="font-weight: 500; font-family: monospace;" />
                                @if (IsCustomClaimType(item))
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="Custom" />
                                }
                                else
                                {
                                    <RadzenBadge BadgeStyle="BadgeStyle.Success" Text="Standard" />
                                }
                            </RadzenStack>
                            <RadzenText Text="@item.DisplayName" TextStyle="TextStyle.Caption" class="rz-text-secondary-color" />
                        </RadzenStack>
                    </Template>
                    <ValueTemplate Context="item">
                        <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                            <RadzenText Text="@($"{item?.Type}")" Style="font-family: monospace;" />
                            @if (item != null && IsCustomClaimType(item))
                            {
                                <RadzenBadge BadgeStyle="BadgeStyle.Secondary" Text="Custom" Size="BadgeSize.ExtraSmall" />
                            }
                        </RadzenStack>
                    </ValueTemplate>
                </RadzenDropDown>
                <RadzenButton Text="Add Claim" Icon="add" ButtonStyle="ButtonStyle.Light" 
                            Click="@(async () => await AddSelectedClaim())" 
                            Disabled="@(isLoadingClaimTypes || selectedClaimType == null || (request?.UserClaims?.Contains(selectedClaimType?.Type ?? "") == true))" />
            </RadzenStack>
            
            @if (isLoadingClaimTypes)
            {
                <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                    <RadzenProgressBarCircular Value="100" ShowValue="false" Size="ProgressBarCircularSize.Small" />
                    <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color">
                        Loading claim types from database...
                    </RadzenText>
                </RadzenStack>
            }
            else
            {
                <RadzenText TextStyle="TextStyle.Caption" class="rz-text-secondary-color">
                    @if (selectedClaimType != null)
                    {
                        @selectedClaimType.Description
                    }
                    else
                    {
                        <text>Select a claim type to see its description. Showing @availableClaimTypes.Count available claim types.</text>
                    }
                </RadzenText>
            }

            <!-- Custom claim input for advanced users -->
            <RadzenCollapsible>
                <HeaderTemplate>
                    <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" Gap="0.5rem">
                        <RadzenIcon Icon="code" />
                        <RadzenText Text="Add Custom Claim Type" />
                    </RadzenStack>
                </HeaderTemplate>
                <ChildContent>
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center" class="rz-mt-2">
                        <RadzenTextBox @bind-Value="@customClaimType" Placeholder="Enter custom claim type" Style="width: 300px;" />
                        <RadzenButton Text="Add Custom" Icon="add" ButtonStyle="ButtonStyle.Light" 
                                    Click="@(async () => await AddCustomClaim())" 
                                    Disabled="@(string.IsNullOrWhiteSpace(customClaimType) || (request?.UserClaims?.Contains(customClaimType) == true))" />
                    </RadzenStack>
                </ChildContent>
            </RadzenCollapsible>

            @if (request?.UserClaims?.Any() == true)
            {
                <RadzenDataList Data="@request.UserClaims" TItem="string" WrapItems="true">
                    <Template Context="claim">
                        <RadzenCard class="rz-p-2" Style="margin: 4px;">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenStack Gap="0.25rem">
                                    <RadzenText Text="@claim" Style="font-weight: 500; font-family: monospace;" />
                                    <RadzenText Text="@GetClaimDescription(claim)" TextStyle="TextStyle.Caption" 
                                               class="rz-text-secondary-color" />
                                </RadzenStack>
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" 
                                            Click="@(async () => await RemoveClaim(claim))" />
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="false">
                    <RadzenText>No claims added yet. Add claims that will be included in this identity resource.</RadzenText>
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenFieldset>

    <RadzenFieldset Text="Properties">
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenTextBox @bind-Value="@newPropertyKey" Placeholder="Property key" Style="width: 200px;" />
                <RadzenTextBox @bind-Value="@newPropertyValue" Placeholder="Property value" Style="width: 200px;" />
                <RadzenButton Text="Add Property" Icon="add" ButtonStyle="ButtonStyle.Light" 
                            Click="@(async () => await AddProperty())" 
                            Disabled="@(string.IsNullOrWhiteSpace(newPropertyKey) || string.IsNullOrWhiteSpace(newPropertyValue))" />
            </RadzenStack>

            @if (request?.Properties?.Any() == true)
            {
                <RadzenDataList Data="@request.Properties" TItem="KeyValuePair<string, string>" WrapItems="true">
                    <Template Context="property">
                        <RadzenCard class="rz-p-2" Style="margin: 4px;">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenText Text="@($"{property.Key}: {property.Value}")" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" 
                                            Click="@(async () => await RemoveProperty(property.Key))" />
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="false">
                    <RadzenText>No properties added yet. Properties are optional metadata for this identity resource.</RadzenText>
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenFieldset>

    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mt-4">
        <RadzenButton Text="Create" Icon="save" ButtonStyle="ButtonStyle.Primary" 
                    Click="@(async () => await CreateIdentityResource())" IsBusy="@isCreating" />
        <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Secondary" 
                    Click="@(async () => await Cancel())" />
    </RadzenStack>
</RadzenStack>

@code {
    private CreateIdentityResourceRequest request = new();
    private string newPropertyKey = string.Empty;
    private string newPropertyValue = string.Empty;
    private bool isCreating = false;

    // Claim type selection
    private ClaimTypeInfo? selectedClaimType;
    private string customClaimType = string.Empty;
    private List<ClaimTypeInfo> availableClaimTypes = new();
    private bool isLoadingClaimTypes = true;

    protected override void OnInitialized()
    {
        // Initialize request with proper default values
        request = new CreateIdentityResourceRequest
        {
            Name = string.Empty,
            DisplayName = null,
            Description = null,
            IsEnabled = true,
            IsRequired = false,
            ShowInDiscoveryDocument = true,
            Emphasize = false,
            UserClaims = new List<string>(),
            Properties = new Dictionary<string, string>()
        };

        // Load available claim types from database
        _ = LoadClaimTypesAsync();
    }

    private async Task LoadClaimTypesAsync()
    {
        try
        {
            isLoadingClaimTypes = true;
            StateHasChanged();

            var claimTypes = await UsersApi.GetDistinctClaimTypesAsync();
            if (claimTypes != null)
            {
                availableClaimTypes = claimTypes;
            }
            else
            {
                // Fallback to standard claims if API call fails
                availableClaimTypes = CommonClaimTypes.StandardClaims.ToList();
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error loading claim types");
            // Fallback to standard claims if error occurs
            availableClaimTypes = CommonClaimTypes.StandardClaims.ToList();
        }
        finally
        {
            isLoadingClaimTypes = false;
            StateHasChanged();
        }
    }

    private async Task AddSelectedClaim()
    {
        if (selectedClaimType != null && request?.UserClaims != null && !request.UserClaims.Contains(selectedClaimType.Type))
        {
            request.UserClaims.Add(selectedClaimType.Type);
            selectedClaimType = null; // Clear selection
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task AddCustomClaim()
    {
        if (!string.IsNullOrWhiteSpace(customClaimType) && request?.UserClaims != null && !request.UserClaims.Contains(customClaimType.Trim()))
        {
            request.UserClaims.Add(customClaimType.Trim());
            customClaimType = string.Empty;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task RemoveClaim(string claim)
    {
        if (request?.UserClaims != null)
        {
            request.UserClaims.Remove(claim);
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private string GetClaimDescription(string claimType)
    {
        var claimInfo = availableClaimTypes.FirstOrDefault(c => c.Type == claimType);
        return claimInfo?.Description ?? "Custom claim type";
    }

    private bool IsCustomClaimType(ClaimTypeInfo claimType)
    {
        return !CommonClaimTypes.StandardClaims.Any(s => s.Type == claimType.Type);
    }

    private async Task AddProperty()
    {
        if (!string.IsNullOrWhiteSpace(newPropertyKey) && !string.IsNullOrWhiteSpace(newPropertyValue) 
            && request?.Properties != null && !request.Properties.ContainsKey(newPropertyKey.Trim()))
        {
            request.Properties[newPropertyKey.Trim()] = newPropertyValue.Trim();
            newPropertyKey = string.Empty;
            newPropertyValue = string.Empty;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task RemoveProperty(string key)
    {
        if (request?.Properties != null)
        {
            request.Properties.Remove(key);
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task CreateIdentityResource()
    {
        try
        {
            // Validate required services
            if (IdentityResourcesApi == null)
            {
                Logger?.LogError("IdentityResourcesApi service is null");
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Service Error",
                    Detail = "Identity Resources API service is not available",
                    Duration = 5000
                });
                return;
            }

            if (request == null)
            {
                Logger?.LogError("Request object is null");
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Request data is not initialized",
                    Duration = 5000
                });
                return;
            }

            if (string.IsNullOrWhiteSpace(request.Name))
            {
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Validation Error",
                    Detail = "Identity resource name is required",
                    Duration = 5000
                });
                return;
            }

            isCreating = true;
            StateHasChanged();

            var result = await IdentityResourcesApi.CreateIdentityResourceAsync(request);
            
            if (result != null)
            {
                DialogService?.Close(true);
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Identity resource created successfully",
                    Duration = 5000
                });
            }
            else
            {
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Failed to create identity resource - API returned null",
                    Duration = 5000
                });
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error creating identity resource");
            NotificationService?.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to create identity resource: {ex.Message}",
                Duration = 5000
            });
        }
        finally
        {
            isCreating = false;
            StateHasChanged();
        }
    }

    private async Task Cancel()
    {
        DialogService?.Close(false);
        await Task.CompletedTask;
    }
}