@inject IIdentityResourcesApiService IdentityResourcesApi
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ILogger<CreateIdentityResourceDialog> Logger

<RadzenStack Gap="1rem">
    <RadzenFormField Text="Name" Variant="Variant.Outlined">
        <RadzenTextBox @bind-Value="@request.Name" MaxLength="200" Style="width: 100%;" />
        <RadzenRequiredValidator Component="Name" Text="Name is required" />
    </RadzenFormField>

    <RadzenFormField Text="Display Name" Variant="Variant.Outlined">
        <RadzenTextBox @bind-Value="@request.DisplayName" MaxLength="200" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenFormField Text="Description" Variant="Variant.Outlined">
        <RadzenTextArea @bind-Value="@request.Description" MaxLength="1000" Rows="3" Style="width: 100%;" />
    </RadzenFormField>

    <RadzenRow Gap="1rem">
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@request.IsEnabled" Name="isEnabled" />
            <RadzenLabel Text="Enabled" Component="isEnabled" Style="margin-left: 8px;" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@request.IsRequired" Name="isRequired" />
            <RadzenLabel Text="Required" Component="isRequired" Style="margin-left: 8px;" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@request.ShowInDiscoveryDocument" Name="showInDiscovery" />
            <RadzenLabel Text="Show in Discovery" Component="showInDiscovery" Style="margin-left: 8px;" />
        </RadzenColumn>
        <RadzenColumn Size="3">
            <RadzenCheckBox @bind-Value="@request.Emphasize" Name="emphasize" />
            <RadzenLabel Text="Emphasize" Component="emphasize" Style="margin-left: 8px;" />
        </RadzenColumn>
    </RadzenRow>

    <RadzenFieldset Text="User Claims">
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenTextBox @bind-Value="@newClaim" Placeholder="Enter claim type (e.g., email, name)" Style="width: 300px;" />
                <RadzenButton Text="Add Claim" Icon="add" ButtonStyle="ButtonStyle.Light" 
                            Click="@(async () => await AddClaim())" Disabled="@string.IsNullOrWhiteSpace(newClaim)" />
            </RadzenStack>

            @if (request?.UserClaims?.Any() == true)
            {
                <RadzenDataList Data="@request.UserClaims" TItem="string" WrapItems="true">
                    <Template Context="claim">
                        <RadzenCard class="rz-p-2" Style="margin: 4px;">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenText Text="@claim" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" 
                                            Click="@(async () => await RemoveClaim(claim))" />
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="false">
                    <RadzenText>No claims added yet. Add claims that will be included in this identity resource.</RadzenText>
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenFieldset>

    <RadzenFieldset Text="Properties">
        <RadzenStack Gap="0.5rem">
            <RadzenStack Orientation="Orientation.Horizontal" Gap="0.5rem" AlignItems="AlignItems.Center">
                <RadzenTextBox @bind-Value="@newPropertyKey" Placeholder="Property key" Style="width: 200px;" />
                <RadzenTextBox @bind-Value="@newPropertyValue" Placeholder="Property value" Style="width: 200px;" />
                <RadzenButton Text="Add Property" Icon="add" ButtonStyle="ButtonStyle.Light" 
                            Click="@(async () => await AddProperty())" 
                            Disabled="@(string.IsNullOrWhiteSpace(newPropertyKey) || string.IsNullOrWhiteSpace(newPropertyValue))" />
            </RadzenStack>

            @if (request?.Properties?.Any() == true)
            {
                <RadzenDataList Data="@request.Properties" TItem="KeyValuePair<string, string>" WrapItems="true">
                    <Template Context="property">
                        <RadzenCard class="rz-p-2" Style="margin: 4px;">
                            <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" AlignItems="AlignItems.Center">
                                <RadzenText Text="@($"{property.Key}: {property.Value}")" />
                                <RadzenButton Icon="delete" ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.ExtraSmall" 
                                            Click="@(async () => await RemoveProperty(property.Key))" />
                            </RadzenStack>
                        </RadzenCard>
                    </Template>
                </RadzenDataList>
            }
            else
            {
                <RadzenAlert AlertStyle="AlertStyle.Info" ShowIcon="false">
                    <RadzenText>No properties added yet. Properties are optional metadata for this identity resource.</RadzenText>
                </RadzenAlert>
            }
        </RadzenStack>
    </RadzenFieldset>

    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem" class="rz-mt-4">
        <RadzenButton Text="Create" Icon="save" ButtonStyle="ButtonStyle.Primary" 
                    Click="@(async () => await CreateIdentityResource())" IsBusy="@isCreating" />
        <RadzenButton Text="Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Secondary" 
                    Click="@(async () => await Cancel())" />
    </RadzenStack>
</RadzenStack>

@code {
    private CreateIdentityResourceRequest request = new();
    private string newClaim = string.Empty;
    private string newPropertyKey = string.Empty;
    private string newPropertyValue = string.Empty;
    private bool isCreating = false;

    protected override void OnInitialized()
    {
        // Initialize request with proper default values
        request = new CreateIdentityResourceRequest
        {
            Name = string.Empty,
            DisplayName = null,
            Description = null,
            IsEnabled = true,
            IsRequired = false,
            ShowInDiscoveryDocument = true,
            Emphasize = false,
            UserClaims = new List<string>(),
            Properties = new Dictionary<string, string>()
        };
    }

    private async Task AddClaim()
    {
        if (!string.IsNullOrWhiteSpace(newClaim) && request?.UserClaims != null && !request.UserClaims.Contains(newClaim))
        {
            request.UserClaims.Add(newClaim.Trim());
            newClaim = string.Empty;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task RemoveClaim(string claim)
    {
        if (request?.UserClaims != null)
        {
            request.UserClaims.Remove(claim);
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task AddProperty()
    {
        if (!string.IsNullOrWhiteSpace(newPropertyKey) && !string.IsNullOrWhiteSpace(newPropertyValue) 
            && request?.Properties != null && !request.Properties.ContainsKey(newPropertyKey.Trim()))
        {
            request.Properties[newPropertyKey.Trim()] = newPropertyValue.Trim();
            newPropertyKey = string.Empty;
            newPropertyValue = string.Empty;
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task RemoveProperty(string key)
    {
        if (request?.Properties != null)
        {
            request.Properties.Remove(key);
            StateHasChanged();
        }
        await Task.CompletedTask;
    }

    private async Task CreateIdentityResource()
    {
        try
        {
            // Validate required services
            if (IdentityResourcesApi == null)
            {
                Logger?.LogError("IdentityResourcesApi service is null");
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Service Error",
                    Detail = "Identity Resources API service is not available",
                    Duration = 5000
                });
                return;
            }

            if (request == null)
            {
                Logger?.LogError("Request object is null");
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Request data is not initialized",
                    Duration = 5000
                });
                return;
            }

            if (string.IsNullOrWhiteSpace(request.Name))
            {
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Warning,
                    Summary = "Validation Error",
                    Detail = "Identity resource name is required",
                    Duration = 5000
                });
                return;
            }

            isCreating = true;
            StateHasChanged();

            var result = await IdentityResourcesApi.CreateIdentityResourceAsync(request);
            
            if (result != null)
            {
                DialogService?.Close(true);
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Success,
                    Summary = "Success",
                    Detail = "Identity resource created successfully",
                    Duration = 5000
                });
            }
            else
            {
                NotificationService?.Notify(new NotificationMessage
                {
                    Severity = NotificationSeverity.Error,
                    Summary = "Error",
                    Detail = "Failed to create identity resource - API returned null",
                    Duration = 5000
                });
            }
        }
        catch (Exception ex)
        {
            Logger?.LogError(ex, "Error creating identity resource");
            NotificationService?.Notify(new NotificationMessage
            {
                Severity = NotificationSeverity.Error,
                Summary = "Error",
                Detail = $"Failed to create identity resource: {ex.Message}",
                Duration = 5000
            });
        }
        finally
        {
            isCreating = false;
            StateHasChanged();
        }
    }

    private async Task Cancel()
    {
        DialogService?.Close(false);
        await Task.CompletedTask;
    }
}