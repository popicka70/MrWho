@page "/realms/add"
@page "/realms/edit/{Id}"
@attribute [Authorize]
@rendermode InteractiveServer
@inject NavigationManager Navigation
@inject NotificationService NotificationService
@inject DialogService DialogService
@inject ILogger<EditRealm> Logger

<PageTitle>@(IsEdit ? "Edit Realm" : "Add Realm") - MrWho Admin</PageTitle>

<RadzenStack>
    <RadzenBreadCrumb>
        <RadzenBreadCrumbItem Path="/realms" Text="Realms" />
        <RadzenBreadCrumbItem Text="@(IsEdit ? "Edit" : "Add")" />
    </RadzenBreadCrumb>

    <RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
        <RadzenIcon Icon="@(IsEdit ? "edit" : "add_circle")" class="rz-me-1" />
        @(IsEdit ? "Edit Realm" : "Add New Realm")
    </RadzenText>
</RadzenStack>

<RadzenCard class="rz-my-4">
    @if (isLoading)
    {
        <RadzenProgressBarCircular ShowValue="false" Mode="ProgressBarMode.Indeterminate" />
        <RadzenText class="rz-mt-3">Loading realm data...</RadzenText>
    }
    else
    {
        <RadzenTemplateForm Data="@model" TItem="CreateRealmRequest" Submit="@OnSave">
            <RadzenStack Gap="2rem">
                <!-- Basic Information -->
                <RadzenFieldset Text="Basic Information">
                    <RadzenStack Gap="1rem">
                        <RadzenRow>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Realm Name" Variant="Variant.Outlined">
                                    <RadzenTextBox @bind-Value="@model.Name" 
                                                  Placeholder="Enter realm name (e.g., 'company-prod')" 
                                                  Style="width: 100%;" 
                                                  Disabled="@IsEdit" />
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        @(IsEdit ? "Realm name cannot be changed after creation" : "Use lowercase letters, numbers, and hyphens only")
                                    </RadzenText>
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="6">
                                <RadzenFormField Text="Display Name" Variant="Variant.Outlined">
                                    <RadzenTextBox @bind-Value="@model.DisplayName" 
                                                  Placeholder="Enter display name (e.g., 'Company Production')" 
                                                  Style="width: 100%;" />
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>
                        
                        <RadzenFormField Text="Description" Variant="Variant.Outlined">
                            <RadzenTextArea @bind-Value="@model.Description" 
                                           Placeholder="Enter realm description..." 
                                           Rows="3" Style="width: 100%;" />
                        </RadzenFormField>
                        
                        <RadzenFormField Text="Status" Variant="Variant.Outlined">
                            <RadzenCheckBox @bind-Value="@model.IsEnabled" />
                            <RadzenLabel Text="Realm is enabled" class="rz-ml-2" />
                            <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary rz-mt-1">
                                Disabled realms cannot be used for authentication
                            </RadzenText>
                        </RadzenFormField>
                    </RadzenStack>
                </RadzenFieldset>

                <!-- Token Lifetimes -->
                <RadzenFieldset Text="Token Configuration">
                    <RadzenStack Gap="1rem">
                        <RadzenText TextStyle="TextStyle.Body2" class="rz-color-secondary rz-mb-2">
                            Configure how long different types of tokens remain valid
                        </RadzenText>
                        
                        <RadzenRow>
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenFormField Text="Access Token Lifetime (minutes)" Variant="Variant.Outlined">
                                    <RadzenNumeric @bind-Value="@accessTokenMinutes" 
                                                  Min="1" Max="1440" 
                                                  Style="width: 100%;" />
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Recommended: 15-60 minutes
                                    </RadzenText>
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenFormField Text="Refresh Token Lifetime (days)" Variant="Variant.Outlined">
                                    <RadzenNumeric @bind-Value="@refreshTokenDays" 
                                                  Min="1" Max="365" 
                                                  Style="width: 100%;" />
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Recommended: 7-30 days
                                    </RadzenText>
                                </RadzenFormField>
                            </RadzenColumn>
                            <RadzenColumn Size="12" SizeMD="4">
                                <RadzenFormField Text="Authorization Code Lifetime (minutes)" Variant="Variant.Outlined">
                                    <RadzenNumeric @bind-Value="@authCodeMinutes" 
                                                  Min="1" Max="60" 
                                                  Style="width: 100%;" />
                                    <RadzenText TextStyle="TextStyle.Caption" class="rz-color-secondary">
                                        Recommended: 5-10 minutes
                                    </RadzenText>
                                </RadzenFormField>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>
                </RadzenFieldset>

                <!-- Action Buttons -->
                <RadzenStack Orientation="Orientation.Horizontal" JustifyContent="JustifyContent.SpaceBetween" class="rz-mt-4">
                    <RadzenButton Click="@Cancel" Icon="cancel" ButtonStyle="ButtonStyle.Light" Text="Cancel" />
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                        @if (IsEdit)
                        {
                            <RadzenButton Click="@DeleteRealm" Icon="delete" ButtonStyle="ButtonStyle.Danger" 
                                         Text="Delete" Disabled="@isSaving" />
                        }
                        <RadzenButton ButtonType="ButtonType.Submit" Icon="save" ButtonStyle="ButtonStyle.Primary" 
                                     Text="@(IsEdit ? "Update Realm" : "Create Realm")" 
                                     IsBusy="@isSaving" Disabled="@isSaving" />
                    </RadzenStack>
                </RadzenStack>
            </RadzenStack>
        </RadzenTemplateForm>
    }
</RadzenCard>

@code {
    [Parameter] public string? Id { get; set; }

    private bool IsEdit => !string.IsNullOrEmpty(Id);
    private bool isLoading = false;
    private bool isSaving = false;
    
    private CreateRealmRequest model = new();
    private int accessTokenMinutes = 60;
    private int refreshTokenDays = 30;
    private int authCodeMinutes = 10;

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit)
        {
            await LoadRealm();
        }
        else
        {
            // Set defaults for new realm
            model.IsEnabled = true;
            model.AccessTokenLifetime = TimeSpan.FromMinutes(accessTokenMinutes);
            model.RefreshTokenLifetime = TimeSpan.FromDays(refreshTokenDays);
            model.AuthorizationCodeLifetime = TimeSpan.FromMinutes(authCodeMinutes);
        }
    }

    private async Task LoadRealm()
    {
        isLoading = true;
        try
        {
            // Mock data - in real implementation, call API service
            await Task.Delay(500);
            
            // Simulate loading realm data based on Id
            var mockRealm = GetMockRealm(Id!);
            if (mockRealm != null)
            {
                model.Name = mockRealm.Name;
                model.DisplayName = mockRealm.DisplayName;
                model.Description = mockRealm.Description;
                model.IsEnabled = mockRealm.IsEnabled;
                model.AccessTokenLifetime = mockRealm.AccessTokenLifetime;
                model.RefreshTokenLifetime = mockRealm.RefreshTokenLifetime;
                model.AuthorizationCodeLifetime = mockRealm.AuthorizationCodeLifetime;

                // Convert to form values
                accessTokenMinutes = (int)mockRealm.AccessTokenLifetime.TotalMinutes;
                refreshTokenDays = (int)mockRealm.RefreshTokenLifetime.TotalDays;
                authCodeMinutes = (int)mockRealm.AuthorizationCodeLifetime.TotalMinutes;
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading realm {RealmId}", Id);
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to load realm data");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task OnSave(CreateRealmRequest args)
    {
        if (string.IsNullOrWhiteSpace(model.Name))
        {
            NotificationService.Notify(NotificationSeverity.Warning, "Validation Error", "Realm name is required");
            return;
        }

        isSaving = true;
        try
        {
            // Update TimeSpan values from form inputs
            model.AccessTokenLifetime = TimeSpan.FromMinutes(accessTokenMinutes);
            model.RefreshTokenLifetime = TimeSpan.FromDays(refreshTokenDays);
            model.AuthorizationCodeLifetime = TimeSpan.FromMinutes(authCodeMinutes);

            // Simulate API call
            await Task.Delay(1000);

            var action = IsEdit ? "updated" : "created";
            NotificationService.Notify(NotificationSeverity.Success, "Success", $"Realm '{model.Name}' has been {action} successfully");
            
            Navigation.NavigateTo("/realms");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving realm");
            NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to save realm");
        }
        finally
        {
            isSaving = false;
        }
    }

    private async Task DeleteRealm()
    {
        var result = await DialogService.Confirm($"Are you sure you want to delete the realm '{model.Name}'?", "Delete Realm", new ConfirmOptions() { OkButtonText = "Delete", CancelButtonText = "Cancel" });
        
        if (result == true)
        {
            try
            {
                // Simulate API call
                await Task.Delay(500);
                
                NotificationService.Notify(NotificationSeverity.Success, "Success", $"Realm '{model.Name}' has been deleted");
                Navigation.NavigateTo("/realms");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error deleting realm");
                NotificationService.Notify(NotificationSeverity.Error, "Error", "Failed to delete realm");
            }
        }
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/realms");
    }

    // Mock data method - replace with actual API call
    private RealmDto? GetMockRealm(string id)
    {
        var mockRealms = new Dictionary<string, RealmDto>
        {
            ["1"] = new() { 
                Id = "1", Name = "admin", DisplayName = "MrWho Administration", 
                Description = "Administrative realm for MrWho OIDC server management", 
                IsEnabled = true, ClientCount = 1,
                AccessTokenLifetime = TimeSpan.FromMinutes(60),
                RefreshTokenLifetime = TimeSpan.FromDays(30),
                AuthorizationCodeLifetime = TimeSpan.FromMinutes(10)
            },
            ["2"] = new() { 
                Id = "2", Name = "default", DisplayName = "Default Realm", 
                Description = "Default realm for OIDC clients", 
                IsEnabled = true, ClientCount = 3,
                AccessTokenLifetime = TimeSpan.FromMinutes(30),
                RefreshTokenLifetime = TimeSpan.FromDays(14),
                AuthorizationCodeLifetime = TimeSpan.FromMinutes(5)
            }
        };

        return mockRealms.TryGetValue(id, out var realm) ? realm : null;
    }
}