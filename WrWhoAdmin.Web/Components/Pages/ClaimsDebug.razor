@page "/debug/claims"
@attribute [Authorize]
@rendermode InteractiveServer

<PageTitle>Claims Debug - MrWho Admin</PageTitle>

<RadzenText TextStyle="TextStyle.H3" TagName="TagName.H1" class="rz-pt-4">
    <RadzenIcon Icon="bug_report" class="rz-me-1" />
    Claims Debug Information
</RadzenText>

<RadzenCard class="rz-my-4">
    <RadzenStack Gap="2rem">
        <AuthorizeView>
            <Authorized>
                <RadzenFieldset Text="Current Display Name Logic">
                    <RadzenStack Gap="1rem">
                        <RadzenFormField Text="Computed Display Name" Variant="Variant.Outlined">
                            <RadzenTextBox Value="@GetUserDisplayName(context.User)" ReadOnly="true" Style="width: 100%; font-weight: bold; color: green;" />
                        </RadzenFormField>
                        
                        <RadzenFormField Text="Step-by-Step Logic" Variant="Variant.Outlined">
                            <RadzenTextArea Value="@GetDisplayNameSteps(context.User)" ReadOnly="true" Style="width: 100%; height: 120px;" />
                        </RadzenFormField>
                    </RadzenStack>
                </RadzenFieldset>

                <RadzenFieldset Text="Raw Claims Data">
                    <RadzenText TextStyle="TextStyle.Body1" class="rz-mb-3">
                        Total Claims: <strong>@context.User.Claims.Count()</strong>
                    </RadzenText>
                    
                    @if (context.User.Claims.Any())
                    {
                        <RadzenDataGrid Data="@context.User.Claims.OrderBy(c => c.Type)" TItem="System.Security.Claims.Claim" 
                                       PageSize="20" AllowPaging="true" AllowSorting="true" AllowFiltering="true">
                            <Columns>
                                <RadzenDataGridColumn TItem="System.Security.Claims.Claim" Property="Type" Title="Claim Type" Width="250px">
                                    <Template Context="claim">
                                        <RadzenText Text="@claim.Type" Style="font-family: monospace; font-weight: bold;" />
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="System.Security.Claims.Claim" Property="Value" Title="Value">
                                    <Template Context="claim">
                                        <RadzenText Text="@claim.Value" Style="font-family: monospace; word-break: break-all;" />
                                    </Template>
                                </RadzenDataGridColumn>
                                <RadzenDataGridColumn TItem="System.Security.Claims.Claim" Property="Issuer" Title="Issuer" Width="150px">
                                    <Template Context="claim">
                                        <RadzenText Text="@claim.Issuer" Style="font-size: 12px; color: var(--rz-text-secondary-color);" />
                                    </Template>
                                </RadzenDataGridColumn>
                            </Columns>
                        </RadzenDataGrid>
                    }
                    else
                    {
                        <RadzenAlert AlertStyle="AlertStyle.Warning">
                            No claims found for the current user.
                        </RadzenAlert>
                    }
                </RadzenFieldset>

                <RadzenFieldset Text="Key Claims Check">
                    <RadzenStack Gap="1rem">
                        <RadzenRow>
                            <RadzenColumn Size="6">
                                <div style="padding: 12px; border: 1px solid var(--rz-border-color); border-radius: 4px;">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Text="Name Claims" />
                                    <ul style="margin: 8px 0 0 20px; font-family: monospace; font-size: 13px;">
                                        <li><strong>name:</strong> @(context.User.FindFirst("name")?.Value ?? "? Not found")</li>
                                        <li><strong>given_name:</strong> @(context.User.FindFirst("given_name")?.Value ?? "? Not found")</li>
                                        <li><strong>family_name:</strong> @(context.User.FindFirst("family_name")?.Value ?? "? Not found")</li>
                                        <li><strong>preferred_username:</strong> @(context.User.FindFirst("preferred_username")?.Value ?? "? Not found")</li>
                                    </ul>
                                </div>
                            </RadzenColumn>
                            <RadzenColumn Size="6">
                                <div style="padding: 12px; border: 1px solid var(--rz-border-color); border-radius: 4px;">
                                    <RadzenText TextStyle="TextStyle.Subtitle2" Text="Identity Claims" />
                                    <ul style="margin: 8px 0 0 20px; font-family: monospace; font-size: 13px;">
                                        <li><strong>sub:</strong> @(context.User.FindFirst("sub")?.Value ?? "? Not found")</li>
                                        <li><strong>email:</strong> @(context.User.FindFirst("email")?.Value ?? "? Not found")</li>
                                        <li><strong>Identity.Name:</strong> @(context.User.Identity?.Name ?? "? Not found")</li>
                                        <li><strong>IsAuthenticated:</strong> @(context.User.Identity?.IsAuthenticated ?? false)</li>
                                    </ul>
                                </div>
                            </RadzenColumn>
                        </RadzenRow>
                    </RadzenStack>
                </RadzenFieldset>

                <RadzenFieldset Text="Actions">
                    <RadzenStack Orientation="Orientation.Horizontal" Gap="1rem">
                        <RadzenButton Icon="refresh" ButtonStyle="ButtonStyle.Primary" Text="Refresh Page" 
                                     Click="@(() => Navigation.Refresh(forceReload: true))" />
                        <RadzenButton Icon="logout" ButtonStyle="ButtonStyle.Secondary" Text="Force Re-login" 
                                     Click="@(() => Navigation.NavigateTo("/logout"))" />
                    </RadzenStack>
                </RadzenFieldset>
            </Authorized>
            <NotAuthorized>
                <RadzenAlert AlertStyle="AlertStyle.Warning">
                    You must be logged in to view claims information.
                </RadzenAlert>
            </NotAuthorized>
        </AuthorizeView>
    </RadzenStack>
</RadzenCard>

@code {
    [Inject] private NavigationManager Navigation { get; set; } = default!;

    private string GetUserDisplayName(System.Security.Claims.ClaimsPrincipal user)
    {
        // Try claims in priority order for the best user experience
        var displayName = user.FindFirst("name")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(displayName))
            return displayName;

        // Fallback to combining given and family names
        var givenName = user.FindFirst("given_name")?.Value?.Trim();
        var familyName = user.FindFirst("family_name")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(givenName) && !string.IsNullOrWhiteSpace(familyName))
            return $"{givenName} {familyName}";
        
        // Single name fallbacks
        if (!string.IsNullOrWhiteSpace(givenName))
            return givenName;
        if (!string.IsNullOrWhiteSpace(familyName))
            return familyName;

        // Username and email fallbacks
        var preferredUsername = user.FindFirst("preferred_username")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(preferredUsername))
            return preferredUsername;

        var email = user.FindFirst("email")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(email))
        {
            // Extract friendly name from email (before @)
            var emailLocal = email.Split('@')[0];
            if (!string.IsNullOrWhiteSpace(emailLocal))
            {
                // Convert "john.doe" to "John Doe"
                var friendlyName = emailLocal
                    .Replace(".", " ")
                    .Replace("_", " ")
                    .Replace("-", " ");
                
                if (!string.IsNullOrWhiteSpace(friendlyName))
                {
                    var words = friendlyName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
                    var capitalizedWords = words.Select(word => 
                        char.ToUpper(word[0]) + (word.Length > 1 ? word.Substring(1).ToLower() : string.Empty));
                    return string.Join(" ", capitalizedWords);
                }
            }
            return email; // Return full email as last resort
        }

        // Technical fallbacks
        var subject = user.FindFirst("sub")?.Value?.Trim() ?? 
                     user.FindFirst("http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier")?.Value?.Trim();
        if (!string.IsNullOrWhiteSpace(subject))
        {
            // If it's a GUID, show a user-friendly format
            if (Guid.TryParse(subject, out _))
                return "User";
            return subject;
        }

        var identityName = user.Identity?.Name?.Trim();
        if (!string.IsNullOrWhiteSpace(identityName))
            return identityName;

        return "Admin User";
    }

    private string GetDisplayNameSteps(System.Security.Claims.ClaimsPrincipal user)
    {
        var steps = new List<string>();
        
        var name = user.FindFirst("name")?.Value?.Trim();
        steps.Add($"1. 'name' claim: {(string.IsNullOrWhiteSpace(name) ? "? Not found" : $"? Found: '{name}'")}");
        
        if (!string.IsNullOrWhiteSpace(name))
        {
            steps.Add($"   ? Using 'name' claim: '{name}'");
            return string.Join("\n", steps);
        }

        var givenName = user.FindFirst("given_name")?.Value?.Trim();
        var familyName = user.FindFirst("family_name")?.Value?.Trim();
        steps.Add($"2. 'given_name' + 'family_name': {(string.IsNullOrWhiteSpace(givenName) ? "?" : $"? '{givenName}'")} + {(string.IsNullOrWhiteSpace(familyName) ? "?" : $"? '{familyName}'")}");
        
        if (!string.IsNullOrWhiteSpace(givenName) && !string.IsNullOrWhiteSpace(familyName))
        {
            steps.Add($"   ? Using combined names: '{givenName} {familyName}'");
            return string.Join("\n", steps);
        }

        if (!string.IsNullOrWhiteSpace(givenName))
        {
            steps.Add($"   ? Using given name only: '{givenName}'");
            return string.Join("\n", steps);
        }

        if (!string.IsNullOrWhiteSpace(familyName))
        {
            steps.Add($"   ? Using family name only: '{familyName}'");
            return string.Join("\n", steps);
        }

        var preferredUsername = user.FindFirst("preferred_username")?.Value?.Trim();
        steps.Add($"3. 'preferred_username': {(string.IsNullOrWhiteSpace(preferredUsername) ? "? Not found" : $"? Found: '{preferredUsername}'")}");
        
        if (!string.IsNullOrWhiteSpace(preferredUsername))
        {
            steps.Add($"   ? Using preferred username: '{preferredUsername}'");
            return string.Join("\n", steps);
        }

        var email = user.FindFirst("email")?.Value?.Trim();
        steps.Add($"4. 'email' claim: {(string.IsNullOrWhiteSpace(email) ? "? Not found" : $"? Found: '{email}'")}");
        
        if (!string.IsNullOrWhiteSpace(email))
        {
            var emailLocal = email.Split('@')[0];
            var friendlyName = emailLocal.Replace(".", " ").Replace("_", " ").Replace("-", " ");
            var words = friendlyName.Split(' ', StringSplitOptions.RemoveEmptyEntries);
            var capitalizedWords = words.Select(word => 
                char.ToUpper(word[0]) + (word.Length > 1 ? word.Substring(1).ToLower() : string.Empty));
            var result = string.Join(" ", capitalizedWords);
            steps.Add($"   ? Converting email to friendly name: '{email}' ? '{result}'");
            return string.Join("\n", steps);
        }

        steps.Add("5. Falling back to technical identifiers or default...");
        return string.Join("\n", steps);
    }
}