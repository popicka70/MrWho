@model LoginViewModel
@{
    ViewData["Title"] = "Login";
    var clientId = ViewData["ClientId"] as string;
    var clientName = ViewData["ClientName"] as string;
    var recaptchaSiteKey = ViewData["RecaptchaSiteKey"] as string; // Provided by controller
    var externalProviders = ViewBag.ExternalProviders as IEnumerable<dynamic> ?? Array.Empty<object>();
}

<div class="row justify-content-center">
    <div class="col-md-6 col-lg-4">
        <!-- MrWho Logo -->
        <div class="text-center mb-4">
            <img src="~/images/AuthMrWho.jpeg" alt="MrWho Identity Server" class="mrwho-logo" />
        </div>
        
        <div class="card">
            <div class="card-header">
                @if (!string.IsNullOrEmpty(clientName))
                {
                    <h4 class="text-center">Sign In to @clientName</h4>
                    @if (!string.IsNullOrEmpty(clientId) && clientId != clientName)
                    {
                        <p class="text-center text-muted small mb-0">Client ID: @clientId</p>
                    }
                }
                else
                {
                    <h4 class="text-center">Sign In</h4>
                }
            </div>
            <div class="card-body">
                @* Display error messages based on query parameters *@
                @if (!string.IsNullOrEmpty(Context.Request.Query["error"]))
                {
                    var error = Context.Request.Query["error"].ToString();
                    <div class="alert alert-warning mb-3" role="alert">
                        @if (error == "access_denied")
                        {
                            <strong>Access Denied</strong><br/>
                            <span>You do not have permission to access this application. Please contact your administrator or try a different account.</span>
                        }
                        else
                        {
                            <strong>Authentication Required</strong><br/>
                            <span>Please sign in to continue.</span>
                        }
                    </div>
                }
                
                <form id="loginForm" method="post">
                    @Html.AntiForgeryToken()
                    <div asp-validation-summary="All" class="text-danger"></div>
                    <input type="hidden" id="recaptchaToken" name="recaptchaToken" />
                    
                    @if (!string.IsNullOrEmpty(ViewData["ReturnUrl"] as string))
                    {
                        <input type="hidden" name="returnUrl" value="@ViewData["ReturnUrl"]" />
                    }
                    
                    @if (!string.IsNullOrEmpty(ViewData["ClientId"] as string))
                    {
                        <input type="hidden" name="clientId" value="@ViewData["ClientId"]" />
                    }
                    
                    <input type="hidden" asp-for="UseCode" />
                    <div class="mb-3">
                        <label asp-for="Email" class="form-label">Email</label>
                        <input asp-for="Email" class="form-control" type="email" placeholder="Enter your email" required />
                        <span asp-validation-for="Email" class="text-danger"></span>
                    </div>

                    @if (Model.UseCode)
                    {
                        <div class="mb-3">
                            <label asp-for="Code" class="form-label">Authenticator code</label>
                            <input asp-for="Code" class="form-control" type="text" inputmode="numeric" autocomplete="one-time-code" placeholder="123 456" />
                            <span asp-validation-for="Code" class="text-danger"></span>
                        </div>
                    }
                    else
                    {
                        <div class="mb-3">
                            <label asp-for="Password" class="form-label">Password</label>
                            <input asp-for="Password" class="form-control" type="password" placeholder="Enter your password" />
                            <span asp-validation-for="Password" class="text-danger"></span>
                        </div>
                    }
                    
                    <div class="mb-3 form-check">
                        <input asp-for="RememberMe" class="form-check-input" type="checkbox" />
                        <label asp-for="RememberMe" class="form-check-label">Remember me</label>
                    </div>
                    
                    <div class="d-grid mb-3">
                        <button id="btnLogin" type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
                        </button>
                    </div>
                    
                    <!-- Alternative Authentication Methods -->
                    <div class="d-grid gap-2">
                        @{
                            var qs = new Dictionary<string, string?>
                            {
                                { "returnUrl", ViewData["ReturnUrl"] as string },
                                { "clientId", ViewData["ClientId"] as string },
                                { "mode", Model.UseCode ? null : "code" }
                            };
                            var query = string.Join("&", qs.Where(kv => !string.IsNullOrEmpty(kv.Value))
                                                         .Select(kv => kv.Key + "=" + Uri.EscapeDataString(kv.Value!)));
                            var toggleHref = string.IsNullOrEmpty(query) ? "/connect/login" : ($"/connect/login?{query}");
                            var qrQuery = string.Join("&", new[]{ ViewData["ReturnUrl"] as string is string ru && !string.IsNullOrEmpty(ru) ? $"returnUrl={Uri.EscapeDataString(ru)}" : null,
                                                                   ViewData["ClientId"] as string is string cid && !string.IsNullOrEmpty(cid) ? $"clientId={Uri.EscapeDataString(cid)}" : null }
                                                                   .Where(s => s != null));
                            var qrHref = string.IsNullOrEmpty(qrQuery) ? "/qr-login/start" : ($"/qr-login/start?{qrQuery}");
                            var enhancedQrHref = string.IsNullOrEmpty(qrQuery) ? "/qr-login/start?persistent=true" : ($"/qr-login/start?persistent=true&{qrQuery}");
                        }
                        
                        @if (Model.UseCode)
                        {
                            <a href="@toggleHref" class="btn btn-outline-secondary auth-button">
                                <i class="bi bi-key me-2"></i>Use password instead
                            </a>
                        }
                        else
                        {
                            <a href="@toggleHref" class="btn btn-outline-secondary auth-button">
                                <i class="bi bi-shield-check me-2"></i>Use authenticator code instead
                            </a>
                        }

                        <!-- Passkey Login -->
                        <button id="btn-passkey" type="button" class="btn btn-outline-primary">
                            <i class="bi bi-fingerprint me-2"></i>Sign in with a passkey
                        </button>
                        
                        <!-- QR Login Options with Clear Distinction -->
                        <hr class="my-3">
                        <h6 class="text-center text-muted mb-3">
                            <i class="bi bi-qr-code me-1"></i>QR Code Login Options
                        </h6>
                        
                        <a href="@qrHref" class="btn auth-button qr-login-quick">
                            <div class="qr-mode-badge quick">
                                <i class="bi bi-lightning-fill"></i>
                            </div>
                            <div class="d-flex flex-column text-start">
                                <div>
                                    <i class="bi bi-qr-code me-2"></i><strong>Quick QR Login</strong>
                                </div>
                                <small class="text-muted">Session-based • Any authenticated device • Fast</small>
                            </div>
                        </a>
                        
                        <a href="@enhancedQrHref" class="btn auth-button qr-login-secure">
                            <div class="qr-mode-badge secure">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div class="d-flex flex-column text-start">
                                <div>
                                    <i class="bi bi-qr-code-scan me-2"></i><strong>Secure QR Login</strong>
                                </div>
                                <small class="text-muted">Device management • Enhanced security • Audit trail</small>
                            </div>
                        </a>

                        <!-- External Identity Providers -->
                        @if (externalProviders.Any())
                        {
                            <hr class="my-3">
                            <h6 class="text-center text-muted mb-3">
                                <i class="bi bi-box-arrow-in-right me-1"></i>Or sign in with
                            </h6>
                            <div class="d-grid gap-2">
                                @foreach (var p in externalProviders)
                                {
                                    var name = (string)p.Name;
                                    var display = (string)p.DisplayName;
                                    var icon = p.IconUri as string;
                                    <a href="@($"/connect/external/login/{Uri.EscapeDataString(name)}")" class="btn btn-outline-dark d-flex align-items-center justify-content-center">
                                        @if (!string.IsNullOrWhiteSpace(icon))
                                        {
                                            <img src="@icon" alt="@display" style="height: 18px; width: 18px; object-fit: contain;" class="me-2" />
                                        }
                                        else
                                        {
                                            <i class="bi bi-shield-lock me-2"></i>
                                        }
                                        <span>Sign in with @display</span>
                                    </a>
                                }
                            </div>
                        }
                        
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="bi bi-info-circle"></i> 
                                Choose <strong>Quick</strong> for immediate access or <strong>Secure</strong> for enhanced security with device tracking.
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <partial name="_LoginPartial" />
    @if (!string.IsNullOrWhiteSpace(recaptchaSiteKey))
    {
        <script src="https://www.google.com/recaptcha/api.js?render=@recaptchaSiteKey"></script>
        <script>
            (function(){
                const form = document.getElementById('loginForm');
                if(!form || !window.grecaptcha) return;
                form.addEventListener('submit', function(e){
                    const existing = document.getElementById('recaptchaToken').value;
                    if(existing) return; // already have token
                    e.preventDefault();
                    const btn = document.getElementById('btnLogin');
                    if(btn){ btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span> Verifying...'; }
                    grecaptcha.ready(function(){
                        grecaptcha.execute('@recaptchaSiteKey', { action: 'login' }).then(function(token){
                            document.getElementById('recaptchaToken').value = token;
                            form.submit();
                        }).catch(function(){
                            if(btn){ btn.disabled = false; btn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Sign In'; }
                        });
                    });
                });
            })();
        </script>
    }
    <script>
        (function(){
            const passkeyBtn = document.getElementById('btn-passkey');
            if(!passkeyBtn || !window.PublicKeyCredential) return;
            passkeyBtn.addEventListener('click', async () => {
                try {
                    const urlParams = new URLSearchParams(window.location.search);
                    const returnUrl = urlParams.get('returnUrl') || '';
                    const clientId = urlParams.get('clientId') || '';

                    const res = await fetch('/webauthn/login/options' + (document.querySelector('[name="Email"]').value ? ('?email=' + encodeURIComponent(document.querySelector('[name="Email"]').value)) : ''));
                    if(!res.ok){ alert('Failed to start passkey'); return; }
                    const options = await res.json();

                    // Convert challenge
                    options.challenge = base64urlToBuffer(options.challenge);

                    // Ensure allowCredentials is either a sequence or omitted entirely
                    if (!Array.isArray(options.allowCredentials) || options.allowCredentials.length === 0) {
                        delete options.allowCredentials; // let authenticator use discoverable credentials
                    } else {
                        options.allowCredentials = options.allowCredentials.map(c => ({
                            ...c,
                            id: base64urlToBuffer(c.id)
                        }));
                    }

                    const assertion = await navigator.credentials.get({ publicKey: options });

                    const data = {
                        id: bufferToBase64Url(assertion.rawId),
                        rawId: bufferToBase64Url(assertion.rawId),
                        type: assertion.type,
                        extensions: assertion.getClientExtensionResults ? assertion.getClientExtensionResults() : {},
                        response: {
                            clientDataJSON: bufferToBase64Url(assertion.response.clientDataJSON),
                            authenticatorData: bufferToBase64Url(assertion.response.authenticatorData),
                            signature: bufferToBase64Url(assertion.response.signature),
                            userHandle: assertion.response.userHandle ? bufferToBase64Url(assertion.response.userHandle) : null
                        }
                    };

                    const verifyRes = await fetch(`/webauthn/login/verify?${new URLSearchParams({ returnUrl, clientId })}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(data)
                    });

                    if (verifyRes.redirected) {
                        window.location.href = verifyRes.url;
                    } else if (verifyRes.ok) {
                        window.location.href = returnUrl || '/';
                    } else {
                        const msg = await verifyRes.text();
                        alert('Passkey sign-in failed: ' + msg);
                    }
                } catch (e) {
                    console.error(e);
                    alert('Passkey sign-in error: ' + e);
                }
            });

            function base64urlToBuffer(base64url) {
                const base64 = base64url.replace(/-/g, '+').replace(/_/g, '/');
                const pad = base64.length % 4 === 0 ? 0 : 4 - (base64.length % 4);
                const base64Padded = base64 + '='.repeat(pad);
                const str = atob(base64Padded);
                const buffer = new ArrayBuffer(str.length);
                const view = new Uint8Array(buffer);
                for (let i = 0; i < str.length; i++) view[i] = str.charCodeAt(i);
                return buffer;
            }
            function bufferToBase64Url(buffer) {
                const bytes = new Uint8Array(buffer);
                let str = '';
                for (let i = 0; i < bytes.byteLength; i++) str += String.fromCharCode(bytes[i]);
                return btoa(str).replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/g, '');
            }
        })();
    </script>
}
