@{
    ViewData["Title"] = "QR Login";
    var token = ViewData["Token"] as string;
    var csrf = ViewData["Csrf"] as string;
    var expires = (DateTime?)ViewData["ExpiresAt"];
}
<div class="container mt-5">
  <div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
      <div class="card shadow-sm">
        <div class="card-header bg-primary text-white">
          <h4 class="mb-0"><i class="bi bi-qr-code-scan"></i> Scan to Approve Login</h4>
        </div>
        <div class="card-body text-center">
          <p class="text-muted mb-2">Use an already authenticated device (phone, another browser) to scan this QR code and approve the login.</p>
          <div class="p-3 d-inline-block border rounded bg-white">
            <img src="/qr/code/@(token).png?csrf=@(csrf)" alt="QR Code" width="240" height="240" />
          </div>
          <div class="mt-3 small text-muted">
            Token: <code>@token</code><br />
            Expires: @expires?.ToLocalTime().ToString("HH:mm:ss")
          </div>
          <div id="qr-status" class="alert alert-info mt-3 py-2 px-3 small">Waiting for approval...</div>
          <form id="completeForm" method="post" action="/qr/complete" class="d-none">
            <input type="hidden" name="token" value="@token" />
            <input type="hidden" name="csrf" value="@csrf" />
          </form>
        </div>
      </div>
    </div>
  </div>
</div>
<script>
  (function(){
    const token = '@token';
    const statusEl = document.getElementById('qr-status');
    const form = document.getElementById('completeForm');
    let done=false;
    async function poll(){
      if(done) return;
      try{
        const r = await fetch(`/qr/status/${token}`);
        if(r.status===404){ statusEl.className='alert alert-danger small'; statusEl.textContent='Session expired.'; done=true; return;} 
        const js = await r.json();
        if(js.status==='Approved'){
          statusEl.className='alert alert-success small';
          statusEl.textContent='Approved. Finalizing...';
          // submit completion
          form.submit();
          done=true;return;
        } else if(js.status==='Rejected' || js.status==='Expired' || js.status==='Failed'){
          statusEl.className='alert alert-danger small';
          statusEl.textContent='Session ' + js.status.toLowerCase()+'.';
          done=true;return;
        }
      }catch(e){ console.log(e); }
      setTimeout(poll, 2000);
    }
    setTimeout(poll, 2000);
  })();
</script>