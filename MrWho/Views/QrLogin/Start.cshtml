@{
    ViewData["Title"] = "Sign in with phone";
    var token = (string)ViewData["Token"]!;
    var clientId = ViewData["ClientId"] as string;
    var returnUrl = ViewData["ReturnUrl"] as string;
}

<div class="row justify-content-center">
  <div class="col-md-6 col-lg-5">
    <div class="card">
      <div class="card-header text-center">
        <h4>Scan with your phone</h4>
      </div>
      <div class="card-body text-center">
        <img src="@Url.Action("QrPng", new { token })" alt="QR code" class="img-fluid mb-3" />
        <p class="text-muted">Open MrWho on your phone and scan this QR.</p>
        <form method="post" action="@Url.Action("Complete")">
          @Html.AntiForgeryToken()
          <input type="hidden" name="token" value="@token" />
          <button class="btn btn-primary" type="submit">I approved on my phone</button>
        </form>
        <div class="mt-3">
          <a class="btn btn-link" href="/connect/login@(string.IsNullOrEmpty(returnUrl) && string.IsNullOrEmpty(clientId) ? string.Empty : $"?{string.Join("&", new[]{ string.IsNullOrEmpty(returnUrl) ? null : $"returnUrl={Uri.EscapeDataString(returnUrl)}", string.IsNullOrEmpty(clientId) ? null : $"clientId={Uri.EscapeDataString(clientId)}" }.Where(s => s != null))}")">Back to login</a>
        </div>
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script>
  (function poll(){
    const token = '@token';
    fetch(`/qr-login/status?token=${encodeURIComponent(token)}`, { cache: 'no-store' })
      .then(r => r.ok ? r.json() : { approved:false })
      .then(j => { if (j.approved) { document.querySelector('form').submit(); } else { setTimeout(poll, 1500); } });
  })();
</script>
}
