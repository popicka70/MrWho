@{
    ViewData["Title"] = "Sign in with phone";
    var token = (string)ViewData["Token"]!;
    var clientId = ViewData["ClientId"] as string;
    var returnUrl = ViewData["ReturnUrl"] as string;
    var isPersistent = (bool)(ViewData["IsPersistent"] ?? false);
}

<div class="row justify-content-center">
  <div class="col-md-6 col-lg-5">
    <div class="card">
      <div class="card-header text-center">
        <h4>Scan with your phone</h4>
        @if (isPersistent)
        {
          <small class="text-muted">Enhanced QR Login with Device Management</small>
        }
        else
        {
          <small class="text-muted">Quick Session-Based Login</small>
        }
      </div>
      <div class="card-body text-center">
        <img src="@Url.Action("QrPng", new { token, persistent = isPersistent })" alt="QR code" class="img-fluid mb-3" />
        
        @if (isPersistent)
        {
          <div class="alert alert-info text-start">
            <h6><i class="bi bi-info-circle"></i> Enhanced QR Login</h6>
            <ul class="mb-0 small">
              <li>Use any of your registered devices to approve</li>
              <li>More secure with device tracking</li>
              <li>Activity is logged for security monitoring</li>
              <li>Can reject unwanted login attempts</li>
            </ul>
          </div>
          <p class="text-muted">Open MrWho on your registered device and scan this QR code, or visit the approval link if prompted.</p>
        }
        else
        {
          <p class="text-muted">Open MrWho on your phone and scan this QR.</p>
        }
        
        <form method="post" action="@Url.Action("Complete")">
          @Html.AntiForgeryToken()
          <input type="hidden" name="token" value="@token" />
          <button class="btn btn-primary" type="submit">I approved on my phone</button>
        </form>
        <div class="mt-3">
          <a class="btn btn-link" href="/connect/login@(string.IsNullOrEmpty(returnUrl) && string.IsNullOrEmpty(clientId) ? string.Empty : $"?{string.Join("&", new[]{ string.IsNullOrEmpty(returnUrl) ? null : $"returnUrl={Uri.EscapeDataString(returnUrl)}", string.IsNullOrEmpty(clientId) ? null : $"clientId={Uri.EscapeDataString(clientId)}" }.Where(s => s != null))}")">Back to login</a>
        </div>
        
        @if (!isPersistent)
        {
          <div class="mt-3">
            <a href="@Url.Action("Start", new { returnUrl, clientId, persistent = true })" class="btn btn-outline-secondary btn-sm">
              <i class="bi bi-shield-check"></i> Use Enhanced QR Login
            </a>
          </div>
        }
      </div>
    </div>
  </div>
</div>

@section Scripts {
<script>
  (function poll(){
    const token = '@token';
    fetch(`/qr-login/status?token=${encodeURIComponent(token)}`, { cache: 'no-store' })
      .then(r => r.ok ? r.json() : { approved:false })
      .then(j => { 
        if (j.approved) { 
          document.querySelector('form').submit(); 
        } else { 
          setTimeout(poll, 1500); 
        } 
        
        // Update status display if we have enhanced information
        if (j.deviceName) {
          const statusElement = document.getElementById('approval-status');
          if (statusElement) {
            statusElement.innerHTML = `<small class="text-success">Approved by: ${j.deviceName}</small>`;
          }
        }
      });
  })();
</script>
}

<div id="approval-status" class="text-center mt-2"></div>
