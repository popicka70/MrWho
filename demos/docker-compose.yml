# ============================================================================
# MrWhoOidc - Basic Docker Compose Configuration
# ============================================================================
# Quick Start configuration for evaluation and development
# Includes: PostgreSQL database, MrWhoOidc OIDC Provider
# Performance: Suitable for development and small-scale production (<1000 users)
# For high-performance deployments, see docker-compose.redis.yml
# For production-hardened deployments, see docker-compose.production.yml
# ============================================================================

services:
  # ============================================================================
  # MrWhoOidc OIDC Provider - Authorization Server
  # ============================================================================
  mrwho-oidc:
    image: ghcr.io/popicka70/mrwhooidc:latest
    container_name: mrwho-oidc
    
    # Wait for PostgreSQL to be healthy before starting
    depends_on:
      mrwho-postgres:
        condition: service_healthy
    
    # ============================================================================
    # Environment Variables - Core Configuration
    # See .env.example for complete documentation of all variables
    # ============================================================================
    environment:
      # -------------------------------------------------------------------------
      # [REQUIRED] Core Configuration
      # -------------------------------------------------------------------------
      
      # ASP.NET Core Environment (Development, Staging, Production)
      # Development: Enables detailed error pages, developer exception page
      # Production: Secure defaults, minimal error details
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Production}
      
      # URLs the application listens on
      # HTTPS (8443) is primary, HTTP (8080) redirects to HTTPS
      ASPNETCORE_URLS: https://+:8443;http://+:8080
      
      # Database Connection String
      # Format: Host=hostname;Port=5432;Database=dbname;Username=user;Password=pass
      # [REQUIRED] POSTGRES_PASSWORD must be set in .env file
      ConnectionStrings__authdb: Host=mrwho-postgres;Port=5432;Database=authdb;Username=oidc;Password=${POSTGRES_PASSWORD};Include Error Detail=false
      
      # -------------------------------------------------------------------------
      # [REQUIRED] TLS/HTTPS Certificate Configuration
      # -------------------------------------------------------------------------
      
      # Path to PFX certificate file inside container
      # Certificate is mounted from ./certs directory (see volumes section)
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      
      # Certificate password
      # [REQUIRED] Set CERT_PASSWORD in .env file
      # Generate certificate: ./scripts/generate-cert.sh localhost yourpassword
      ASPNETCORE_Kestrel__Certificates__Default__Password: ${CERT_PASSWORD}
      
      # -------------------------------------------------------------------------
      # [REQUIRED] OIDC Configuration
      # -------------------------------------------------------------------------
      
      # Public base URL where users access the OIDC provider
      # MUST match the URL users use in their browsers
      # Examples:
      #   - Local development: https://localhost:8443
      #   - Production with domain: https://auth.example.com
      # [REQUIRED] Set OIDC_PUBLIC_BASE_URL in .env file
      Oidc__PublicBaseUrl: ${OIDC_PUBLIC_BASE_URL}
      
      # -------------------------------------------------------------------------
      # [OPTIONAL] Multi-Tenancy Configuration
      # -------------------------------------------------------------------------
      
      # Enable multi-tenant mode for supporting multiple organizations
      # false: Single tenant mode (simpler, recommended for most deployments)
      # true: Multi-tenant mode (requires tenant management)
      MultiTenant__Enabled: ${MULTITENANT_ENABLED:-false}
      
      # Default tenant slug when multi-tenancy is disabled
      # Used as identifier for the single tenant
      MultiTenant__DefaultTenantSlug: ${MULTITENANT_DEFAULT_TENANT_SLUG:-default}
      
      # -------------------------------------------------------------------------
      # [OPTIONAL] Redis Caching (Disabled in Basic Configuration)
      # -------------------------------------------------------------------------
      
      # Redis is disabled in this basic configuration
      # For 30-50% performance improvement, use docker-compose.redis.yml
      Redis__Enabled: false
      
      # -------------------------------------------------------------------------
      # [OPTIONAL] Email/SMTP Configuration
      # -------------------------------------------------------------------------
      
      # Enable email notifications (password reset, account verification, etc.)
      # Requires SMTP server configuration when enabled
      Mail__Enabled: ${MAIL_ENABLED:-false}
      Mail__SmtpHost: ${MAIL_SMTP_HOST}
      Mail__SmtpPort: ${MAIL_SMTP_PORT:-587}
      Mail__UseSsl: ${MAIL_SMTP_USE_SSL:-true}
      Mail__FromAddress: ${MAIL_FROM_ADDRESS}
      Mail__FromName: ${MAIL_FROM_NAME:-MrWhoOidc}
      Mail__SmtpUsername: ${MAIL_SMTP_USERNAME}
      Mail__SmtpPassword: ${MAIL_SMTP_PASSWORD}
      
      # -------------------------------------------------------------------------
      # [OPTIONAL] Logging Configuration
      # -------------------------------------------------------------------------
      
      # Log level for application logs
      # Trace, Debug, Information, Warning, Error, Critical
      # Recommendation: Information for production, Debug for troubleshooting
      Logging__LogLevel__Default: ${LOGGING_LEVEL:-Information}
      Logging__LogLevel__Microsoft.AspNetCore: ${LOGGING_LEVEL_ASPNETCORE:-Warning}
      
      # -------------------------------------------------------------------------
      # [OPTIONAL] Admin UI Configuration
      # -------------------------------------------------------------------------
      
      # Enable admin UI for managing clients, users, and configuration
      # Disable in production if using API-based management
      AdminUI__Enabled: ${ADMIN_UI_ENABLED:-true}
      
    # ============================================================================
    # Port Mapping
    # ============================================================================
    ports:
      # HTTPS port (primary endpoint for OIDC)
      - "${OIDC_HTTPS_PORT:-8443}:8443"
      
      # HTTP port (redirects to HTTPS)
      # Mapped to 8081 on host to avoid conflicts with common web servers
      - "${OIDC_HTTP_PORT:-8081}:8080"
    
    # ============================================================================
    # Volume Mounts
    # ============================================================================
    volumes:
      # Mount TLS certificate directory (read-only)
      # Certificate must be generated first: ./scripts/generate-cert.sh
      - ./certs:/https:ro
    
    # ============================================================================
    # Health Check
    # ============================================================================
    healthcheck:
      # Check the /health endpoint every 30 seconds
      test: ["CMD-SHELL", "curl -f -k https://localhost:8443/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Restart policy
    restart: unless-stopped
    
    # ============================================================================
    # Network Configuration
    # ============================================================================
    networks:
      - edge      # External-facing network (for user/client access)
      - internal  # Internal-only network (for database communication)

  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  mrwho-postgres:
    image: postgres:16-alpine
    container_name: mrwho-postgres
    
    # ============================================================================
    # PostgreSQL Configuration
    # ============================================================================
    environment:
      # Database name for OIDC data
      POSTGRES_DB: authdb
      
      # Database user
      POSTGRES_USER: oidc
      
      # Database password
      # [REQUIRED] Set POSTGRES_PASSWORD in .env file
      # Use strong password in production (min 16 chars, mixed case, numbers, symbols)
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    
    # ============================================================================
    # Data Persistence
    # ============================================================================
    volumes:
      # Persist database data across container restarts
      # Data stored in Docker volume: mrwho-postgres-data
      - postgres-data:/var/lib/postgresql/data
    
    # ============================================================================
    # Health Check
    # ============================================================================
    healthcheck:
      # Verify PostgreSQL is ready to accept connections
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    # Restart policy
    restart: unless-stopped
    
    # ============================================================================
    # Network Configuration
    # ============================================================================
    networks:
      - internal  # Internal-only network (not exposed to external access)

# ============================================================================
# Volumes - Persistent Data Storage
# ============================================================================
volumes:
  # PostgreSQL data volume
  # Data persists across container recreation and system restarts
  # To reset database: docker compose down -v (WARNING: destroys all data)
  postgres-data:
    driver: local

# ============================================================================
# Networks - Network Isolation
# ============================================================================
networks:
  # edge - External-facing network for user/client access
  # Connected to: mrwho-oidc
  edge:
    driver: bridge
  
  # internal - Internal-only network for backend services
  # Connected to: mrwho-oidc, mrwho-postgres
  # No external access allowed
  internal:
    driver: bridge
    internal: true  # Blocks external network access for security
