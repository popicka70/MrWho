# ============================================================================
# MrWhoOidc - Demo Docker Compose Configuration
# ============================================================================
# Quick Start configuration for demos and evaluation
# Includes: PostgreSQL database, MrWhoOidc OIDC Provider
# 
# NOTE: This demo uses port 9443 to avoid conflicts with e2e tests on 8443
# All secrets have defaults for demo purposes - DO NOT use in production!
# ============================================================================

services:
  # ============================================================================
  # MrWhoOidc OIDC Provider - Authorization Server
  # ============================================================================
  mrwho-oidc:
    image: ghcr.io/popicka70/mrwhooidc:latest
    container_name: mrwho-oidc-demo
    
    # Wait for PostgreSQL to be healthy before starting
    depends_on:
      mrwho-postgres:
        condition: service_healthy
    
    # ============================================================================
    # Environment Variables - Core Configuration
    # ============================================================================
    environment:
      # -------------------------------------------------------------------------
      # Core Configuration (with demo defaults)
      # -------------------------------------------------------------------------
      
      # ASP.NET Core Environment (Development, Staging, Production)
      # Using Development for demo to get detailed error pages
      ASPNETCORE_ENVIRONMENT: ${ASPNETCORE_ENVIRONMENT:-Development}
      
      # URLs the application listens on
      # HTTPS (8443) is primary inside container, mapped to 9443 on host
      ASPNETCORE_URLS: https://+:8443;http://+:8080
      
      # Tell ASP.NET Core what the external HTTPS port is for proper redirects
      ASPNETCORE_HTTPS_PORT: 9443
      
      # Security setting - require HTTPS
      Security__RequireHttps: "true"
      
      # Database Connection String
      # Format: Host=hostname;Port=5432;Database=dbname;Username=user;Password=pass
      ConnectionStrings__authdb: Host=mrwho-postgres;Port=5432;Database=authdb;Username=oidc;Password=${POSTGRES_PASSWORD:-DemoPassword123!};Include Error Detail=true
      
      # -------------------------------------------------------------------------
      # TLS/HTTPS Certificate Configuration (with demo defaults)
      # -------------------------------------------------------------------------
      
      # Path to PFX certificate file inside container
      # Certificate is mounted from MrWhoOidc/certs directory (see volumes section)
      ASPNETCORE_Kestrel__Certificates__Default__Path: /https/aspnetapp.pfx
      
      # Certificate password (demo default: changeit)
      ASPNETCORE_Kestrel__Certificates__Default__Password: ${CERT_PASSWORD:-changeit}
      
      # -------------------------------------------------------------------------
      # OIDC Configuration (with demo defaults)
      # -------------------------------------------------------------------------
      
      # Public base URL where users access the OIDC provider
      # MUST match the URL users use in their browsers
      # Demo default uses port 9443 to avoid e2e conflicts
      Oidc__PublicBaseUrl: ${OIDC_PUBLIC_BASE_URL:-https://localhost:9443}
      
      # -------------------------------------------------------------------------
      # Multi-Tenancy Configuration (Optional)
      # -------------------------------------------------------------------------
      
      # Enable multi-tenant mode for supporting multiple organizations
      # false: Single tenant mode (simpler, recommended for demos)
      MultiTenant__Enabled: ${MULTITENANT_ENABLED:-false}
      
      # Default tenant slug when multi-tenancy is disabled
      MultiTenant__DefaultTenantSlug: ${MULTITENANT_DEFAULT_TENANT_SLUG:-default}
      
      # -------------------------------------------------------------------------
      # Redis Caching (Disabled for demo simplicity)
      # -------------------------------------------------------------------------
      
      # Redis is disabled in this demo configuration
      Redis__Enabled: false
      
      # -------------------------------------------------------------------------
      # Logging Configuration (verbose for demo)
      # -------------------------------------------------------------------------
      
      Logging__LogLevel__Default: ${LOGGING_LEVEL:-Information}
      Logging__LogLevel__Microsoft.AspNetCore: ${LOGGING_LEVEL_ASPNETCORE:-Information}
      
      # -------------------------------------------------------------------------
      # Admin UI Configuration
      # -------------------------------------------------------------------------
      
      # Enable admin UI for managing clients, users, and configuration
      AdminUI__Enabled: ${ADMIN_UI_ENABLED:-true}
      
    # ============================================================================
    # Port Mapping - Using 9443 to avoid e2e conflicts
    # ============================================================================
    ports:
      # HTTPS port (primary endpoint for OIDC) - mapped to 9443 on host
      - "${OIDC_HTTPS_PORT:-9443}:8443"
      
      # HTTP port (redirects to HTTPS) - mapped to 9080 on host
      - "${OIDC_HTTP_PORT:-9080}:8080"
    
    # ============================================================================
    # Volume Mounts
    # ============================================================================
    volumes:
      # Mount TLS certificate directory from MrWhoOidc (read-only)
      # Using shared certs from MrWhoOidc project
      - ../../MrWhoOidc/certs:/https:ro
    
    # ============================================================================
    # Health Check
    # ============================================================================
    healthcheck:
      # Check the /health endpoint every 30 seconds
      test: ["CMD-SHELL", "curl -f -k https://localhost:8443/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Restart policy
    restart: unless-stopped
    
    # ============================================================================
    # Network Configuration
    # ============================================================================
    networks:
      - edge      # External-facing network (for user/client access)
      - internal  # Internal-only network (for database communication)

  # ============================================================================
  # PostgreSQL Database
  # ============================================================================
  mrwho-postgres:
    image: postgres:16-alpine
    container_name: mrwho-postgres-demo
    
    # ============================================================================
    # PostgreSQL Configuration
    # ============================================================================
    environment:
      # Database name for OIDC data
      POSTGRES_DB: authdb
      
      # Database user
      POSTGRES_USER: oidc
      
      # Database password (demo default for simplicity)
      # DO NOT use this in production!
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-DemoPassword123!}
    
    # ============================================================================
    # Data Persistence
    # ============================================================================
    volumes:
      # Persist database data across container restarts
      # Using demo-specific volume name to avoid conflicts
      - demo-postgres-data:/var/lib/postgresql/data
    
    # ============================================================================
    # Health Check
    # ============================================================================
    healthcheck:
      # Verify PostgreSQL is ready to accept connections
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    
    # Restart policy
    restart: unless-stopped
    
    # ============================================================================
    # Network Configuration
    # ============================================================================
    networks:
      - internal  # Internal-only network (not exposed to external access)

# ============================================================================
# Volumes - Persistent Data Storage
# ============================================================================
volumes:
  # PostgreSQL data volume (demo-specific name to avoid conflicts)
  # Data persists across container recreation and system restarts
  # To reset database: docker compose down -v (WARNING: destroys all data)
  demo-postgres-data:
    driver: local

# ============================================================================
# Networks - Network Isolation
# ============================================================================
networks:
  # edge - External-facing network for user/client access
  # Connected to: mrwho-oidc
  edge:
    driver: bridge
  
  # internal - Internal-only network for backend services
  # Connected to: mrwho-oidc, mrwho-postgres
  # No external access allowed
  internal:
    driver: bridge
    internal: true  # Blocks external network access for security
